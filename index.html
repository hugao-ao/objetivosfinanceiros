<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Financeiro V9 - Avan√ßado</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002d26;
      color: white;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    .saldo-positivo {
         color: #1976d2; /* Azul n√£o brilhante */
    }
    .saldo-negativo {
        color: #c62828; /* Vermelho n√£o brilhante */
    }
    h1 {
      margin: 0 0 20px;
    }
    .cartao-laranja {
        color: #f57c00; /* Laranja n√£o brilhante */
    }
    .conta-amarela {
        color: #fbc02d; /* Amarelo n√£o brilhante */
    }
    
    /* Container principal expandido para 3 se√ß√µes */
    .container-principal {
      display: flex;
      width: 300%; /* Expandido para 3 se√ß√µes */
      transition: transform 0.5s ease;
    }

    .container-resumo-ativo {
      transform: translateX(-33.33%); /* Para mostrar o resumo */
    }

    .container-mensagens-ativo {
      transform: translateX(-66.66%); /* Para mostrar as mensagens */
    }

    /* Se√ß√µes do container */
    .secao-lancamentos {
      width: 33.33%; /* 1/3 do container */
      padding-right: 20px;
      box-sizing: border-box;
    }

    .secao-resumo {
      width: 33.33%; /* 1/3 do container */
      padding: 0 20px;
      box-sizing: border-box;
    }

    .secao-mensagens {
      width: 33.33%; /* 1/3 do container */
      padding-left: 20px;
      box-sizing: border-box;
    }

    /* Estilos para o Modal */
    .modal {
      display: none;
      position: fixed; 
      z-index: 100; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      padding-top: 60px;
    }

    .modal-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 10px;
      position: relative;
    }

    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #ffd700;
      text-decoration: none;
      cursor: pointer;
    }

    /* Formul√°rio dentro do Modal */
    .form-section-modal {
      padding: 0; 
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .botoes-formulario {
      grid-column: 1 / -1; 
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .table-container {
      background-color: #014034;
      border-radius: 10px;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #006a56;
      text-align: center;
    }

    th {
      background-color: #006a56;
      color: #ffd700;
      position: sticky;
      top: 0;
      z-index: 5; 
    }
    
    th.descricao-header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        padding-right: 5px; 
    }

    .botao-abrir-modal {
        background-color: #ffd700;
        color: #002d26;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 18px;
        font-weight: bold;
        line-height: 24px; 
        text-align: center;
        cursor: pointer;
        margin-left: 10px;
        padding: 0;
    }

    .botao-abrir-modal:hover {
        background-color: #ffc400;
    }

    .receita { color: #4caf50; }
    .fixa { color: #f44336; }
    .variavel { color: #ff9800; }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }

    .botao-lancar {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-lancar:hover {
      background-color: #ffc400;
    }

    /* Bot√µes de navega√ß√£o fixos */
    .botao-navegacao-fixo {
      position: fixed;
      top: 20px;
      z-index: 50;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: opacity 0.3s ease, visibility 0.3s ease;
      opacity: 1;
      visibility: visible;
    }

    .botao-resumo-fixo {
      right: 20px;
      background-color: #2196F3;
    }

    .botao-mensagens-fixo {
      right: 200px;
      background-color: #9c27b0;
    }

    .botao-resumo-fixo:hover {
      background-color: #0b7dda;
    }

    .botao-mensagens-fixo:hover {
      background-color: #7b1fa2;
    }

    /* Esconde bot√µes quando n√£o aplic√°vel */
    .container-resumo-ativo ~ .botao-resumo-fixo {
        opacity: 0;
        visibility: hidden;
    }

    .container-mensagens-ativo ~ .botao-resumo-fixo,
    .container-mensagens-ativo ~ .botao-mensagens-fixo {
        opacity: 0;
        visibility: hidden;
    }

    .botao-voltar {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .botao-voltar:hover {
      background-color: #e68a00;
    }

    .delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }
    
    .hidden-id {
      display: none;
    }

    .resumo-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }

    .mensagens-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }
    
    /* Congelar a primeira coluna (Categoria) - Tabela Resumo */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaResumo thead tr th:first-child {
      background-color: #006a56; 
      z-index: 20; 
    }
    #tabelaResumo tbody tr td:first-child {
      font-weight: bold; 
    }

    /* Congelar a coluna Descri√ß√£o - Tabela Lan√ßamentos */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: #006a56; 
      z-index: 20;
    }
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; 
    }

    /* Estilo para c√©lulas edit√°veis */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: #014034;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 14px;
      box-sizing: border-box;
    }
    .edit-input:focus {
      outline: 2px solid #ffd700;
    }
    
    /* Estilos para os gr√°ficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .grafico-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      width: calc(50% - 40px);
      min-width: 400px;
      box-sizing: border-box;
    }
    .grafico-titulo {
      text-align: center;
      margin-bottom: 15px;
      color: #ffd700;
      font-size: 16px;
    }
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    .seletor-mes {
      text-align: center;
      margin-bottom: 20px;
    }
    .seletor-mes select {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
      font-weight: bold;
    }
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      width: 100%;
    }
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 14px;
      width: 100%;
    }
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .valor-legenda {
      margin-left: 5px;
      font-weight: bold;
    }
    .descricao-legenda {
      min-width: 120px;
    }
    
    /* Linha de espa√ßamento na tabela de resumo */
    .spacer-row td {
        height: 10px;
        padding: 0;
        border: none;
        background-color: #002d26;
    }

    /* Estilos para subcategorias e cart√µes */
    .categoria-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .categoria-select {
      flex: 1;
    }

    .botao-gerenciar {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .botao-gerenciar:hover {
      background-color: #45a049;
    }

    /* Campo de cart√£o inicialmente oculto, mas com transi√ß√£o suave */
    .cartao-container {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .cartao-container.show {
      display: block;
      opacity: 1;
    }

    /* Modal de gerenciamento gen√©rico */
    .modal-gerenciamento {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      padding-top: 60px;
    }

    .modal-gerenciamento-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 60%;
      max-width: 500px;
      border-radius: 10px;
      position: relative;
    }

    .lista-gerenciamento {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .item-gerenciamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      background-color: #006a56;
      border-radius: 5px;
    }

    .item-gerenciamento-info {
      display: flex;
      flex-direction: column;
    }

    .item-gerenciamento-nome {
      font-weight: bold;
    }

    .item-gerenciamento-detalhe {
      font-size: 12px;
      color: #b0bec5;
    }

    .botoes-item-gerenciamento button {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }

    .botoes-item-gerenciamento button.excluir {
      background-color: #c62828;
    }

    .botoes-item-gerenciamento button:hover {
      opacity: 0.8;
    }

    .novo-item-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .novo-item-input {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
      min-width: 150px;
    }

    .novo-item-input.dia {
      flex: 0 0 80px;
    }

    .botao-adicionar-item {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-adicionar-item:hover {
      background-color: #45a049;
    }

    /* Cores aleat√≥rias para subcategorias */
    .subcategoria-cor-1 { color: #e91e63; }
    .subcategoria-cor-2 { color: #9c27b0; }
    .subcategoria-cor-3 { color: #673ab7; }
    .subcategoria-cor-4 { color: #3f51b5; }
    .subcategoria-cor-5 { color: #2196f3; }
    .subcategoria-cor-6 { color: #00bcd4; }
    .subcategoria-cor-7 { color: #009688; }
    .subcategoria-cor-8 { color: #8bc34a; }
    .subcategoria-cor-9 { color: #cddc39; }
    .subcategoria-cor-10 { color: #ffeb3b; }
    .subcategoria-cor-11 { color: #ff5722; }
    .subcategoria-cor-12 { color: #795548; }

    /* Linha clic√°vel na tabela principal */
    #tabelaLancamentos tbody tr {
      cursor: pointer;
    }
    #tabelaLancamentos tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Linha clic√°vel na tabela de resumo */
    #tabelaResumo tbody tr {
      cursor: pointer;
    }
    #tabelaResumo tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Modal de detalhamento */
    .modal-detalhamento {
      display: none;
      position: fixed;
      z-index: 150;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      padding-top: 60px;
    }

    .modal-detalhamento-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 70%;
      max-width: 900px;
      border-radius: 10px;
      position: relative;
    }

    .lista-detalhamento {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .item-detalhamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      background-color: #006a56;
      border-radius: 5px;
    }

    .item-detalhamento-info {
      flex: 1;
      text-align: left;
    }

    .item-detalhamento-valores {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    .item-detalhamento-valor {
      font-weight: bold;
      font-size: 16px;
    }

    .item-detalhamento-media {
      font-size: 14px;
      color: #b0bec5;
    }

    .item-detalhamento-percentual {
      color: #ffd700;
      font-size: 14px;
    }

    /* Destaque para campo de cart√£o quando obrigat√≥rio */
    .cartao-container.obrigatorio {
      border: 2px solid #ffd700;
      padding: 10px;
      border-radius: 5px;
      background-color: rgba(255, 215, 0, 0.1);
    }

    /* Estilos para se√ß√£o de insights */
    .insights-container {
      margin-top: 30px;
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
    }

    .insights-titulo {
      text-align: center;
      margin-bottom: 20px;
      color: #ffd700;
      font-size: 18px;
    }

    .insight-item {
      background-color: #006a56;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #ffd700;
    }

    .insight-tipo {
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 5px;
    }

    .insight-texto {
      line-height: 1.5;
    }

    .insight-valor {
      font-weight: bold;
      color: #4caf50;
    }

    .insight-alerta {
      color: #f44336;
    }

    /* Estilos para se√ß√£o de mensagens */
    .simulador-container {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .simulador-titulo {
      color: #ffd700;
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
    }

    .simulador-controles {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .simulador-controles label {
      font-weight: bold;
    }

    .simulador-controles input,
    .simulador-controles select {
      padding: 8px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
    }

    .botao-simular {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-simular:hover {
      background-color: #ffc400;
    }

    .mensagens-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .mensagem-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      border-left: 4px solid;
    }

    .mensagem-hoje {
      border-left-color: #4caf50;
    }

    .mensagem-semana {
      border-left-color: #ff9800;
    }

    .mensagem-mes {
      border-left-color: #2196f3;
    }

    .mensagem-titulo {
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .mensagem-lista {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .mensagem-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mensagem-item:last-child {
      border-bottom: none;
    }

    .mensagem-descricao {
      flex: 1;
    }

    .mensagem-valor {
      font-weight: bold;
      margin-left: 10px;
    }

    .mensagem-data {
      font-size: 12px;
      color: #b0bec5;
      margin-left: 10px;
    }

    .mensagem-vazia {
      text-align: center;
      color: #b0bec5;
      font-style: italic;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Controle Financeiro</h1>
  
  <!-- Container Principal (Lan√ßamentos, Resumo e Mensagens) -->
  <div class="container-principal" id="containerPrincipal">
    <!-- Se√ß√£o da Tabela de Lan√ßamentos -->
    <div class="secao-lancamentos">
      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descri√ß√£o</span>
                <button id="botaoAbrirModal" class="botao-abrir-modal" onclick="abrirModal()">+</button>
              </th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>M√©dia</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lan√ßamentos ser√£o inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Se√ß√£o do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">‚Üê Voltar para Lan√ßamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>M√©dia</th>
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo ser√° inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Se√ß√£o dos Gr√°ficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o m√™s: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="-2">M√©dias Mensais</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Mar√ßo</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <button class="botao-lancar" onclick="mostrarMensagens()" style="margin-left: 20px;">Ver Mensagens ‚Üí</button>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribui√ß√£o de Despesas e Poupan√ßa</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Rela√ß√£o √†s Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>

        <!-- Novos Gr√°ficos -->
        <div class="grafico-card">
          <div class="grafico-titulo">Distribui√ß√£o por Cart√µes de Cr√©dito</div>
          <div class="grafico">
            <canvas id="graficoCartoes"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaCartoes"></div>
        </div>

        <div class="grafico-card">
          <div class="grafico-titulo">An√°lise de Subcategorias</div>
          <div class="grafico">
            <canvas id="graficoSubcategorias"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaSubcategorias"></div>
        </div>
      </div>

      <!-- Se√ß√£o de Insights -->
      <div class="insights-container">
        <div class="insights-titulo">üí° Insights Inteligentes</div>
        <div id="insightsContent">
          <!-- Insights ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <!-- Se√ß√£o de Mensagens -->
    <div class="secao-mensagens">
      <button class="botao-voltar" onclick="voltarParaResumo()">‚Üê Voltar para Resumo</button>
      
      <div class="mensagens-titulo">üì± Central de Mensagens</div>

      <!-- Simulador de Data -->
      <div class="simulador-container">
        <div class="simulador-titulo">üóìÔ∏è Simulador de Data</div>
        <div class="simulador-controles">
          <label>
            <input type="radio" name="tipoData" value="hoje" checked onchange="atualizarSimulador()"> Hoje
          </label>
          <label>
            <input type="radio" name="tipoData" value="especifica" onchange="atualizarSimulador()"> Data Espec√≠fica:
          </label>
          <input type="date" id="dataEspecifica" onchange="atualizarSimulador()" disabled>
          <button class="botao-simular" onclick="gerarMensagens()">Gerar Mensagens</button>
        </div>
      </div>

      <!-- Container das Mensagens -->
      <div class="mensagens-container" id="mensagensContainer">
        <!-- Mensagens ser√£o inseridas aqui -->
      </div>
    </div>
  </div>
  
  <!-- Bot√µes de Navega√ß√£o Fixos -->
  <button class="botao-navegacao-fixo botao-resumo-fixo" onclick="mostrarResumo()">Ver Resumo e An√°lises</button>
  <button class="botao-navegacao-fixo botao-mensagens-fixo" onclick="mostrarMensagens()">Ver Mensagens</button>

  <!-- Modal do Formul√°rio de Adi√ß√£o -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2>Novo Lan√ßamento</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descri√ß√£o:</label>
          <input type="text" id="descricao" placeholder="Ex: Sal√°rio, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lan√ßamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Vari√°vel</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento" onchange="toggleCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cart√£o de Cr√©dito</option>
          </select>

          <label for="subcategoria">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoria" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cart√£o (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainer">
            <label for="cartaoCredito">Cart√£o de Cr√©dito:</label>
            <div class="categoria-container">
              <select id="cartaoCredito" class="categoria-select">
                <option value="">Selecione o cart√£o</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cart√µes</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequ√™ncia:</label>
          <select id="frequenciaTipo">
            <option value="unico">n√£o se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias √∫teis</option>
            <option value="segunda">segunda</option>
            <option value="terca">ter√ßa</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lan√ßar Item</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Formul√°rio de Edi√ß√£o -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
      <h2>Editar Lan√ßamento</h2>
      <input type="hidden" id="editLancamentoId">
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricaoEdicao">Descri√ß√£o:</label>
          <input type="text" id="descricaoEdicao" placeholder="Ex: Sal√°rio, Luz" />

          <label for="valorEdicao">Valor (R$):</label>
          <input type="text" id="valorEdicao" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamentoEdicao">Tipo de Lan√ßamento:</label>
          <select id="tipoLancamentoEdicao">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Vari√°vel</option>
          </select>

          <label for="formaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="formaPagamentoEdicao" onchange="toggleCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cart√£o de Cr√©dito</option>
          </select>

          <label for="subcategoriaEdicao">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoriaEdicao" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cart√£o Edi√ß√£o (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainerEdicao">
            <label for="cartaoCreditoEdicao">Cart√£o de Cr√©dito:</label>
            <div class="categoria-container">
              <select id="cartaoCreditoEdicao" class="categoria-select">
                <option value="">Selecione o cart√£o</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cart√µes</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValorEdicao">A cada:</label>
          <input type="number" id="frequenciaValorEdicao" min="1" value="1" />

          <label for="frequenciaTipoEdicao">Unidade de Frequ√™ncia:</label>
          <select id="frequenciaTipoEdicao">
            <option value="unico">n√£o se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias √∫teis</option>
            <option value="segunda">segunda</option>
            <option value="terca">ter√ßa</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicialEdicao">Data Inicial:</label>
          <input type="date" id="dataInicialEdicao" />

          <label for="dataFinalEdicao">Data Final:</label>
          <input type="date" id="dataFinalEdicao" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="salvarEdicao()">Salvar Edi√ß√£o</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento Gen√©rico (Subcategorias e Cart√µes) -->
  <div id="modalGerenciamento" class="modal-gerenciamento">
    <div class="modal-gerenciamento-content">
      <span class="close-button" onclick="fecharModalGerenciamento()">&times;</span>
      <h2 id="tituloModalGerenciamento">Gerenciar</h2>
      
      <div id="formNovoItem">
        <!-- Formul√°rio para adicionar novo item (subcategoria ou cart√£o) -->
      </div>
      
      <div class="lista-gerenciamento" id="listaGerenciamento">
        <!-- Lista de itens ser√° inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalGerenciamento()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhamento -->
  <div id="modalDetalhamento" class="modal-detalhamento">
    <div class="modal-detalhamento-content">
      <span class="close-button" onclick="fecharModalDetalhamento()">&times;</span>
      <h2 id="tituloDetalhamento">Detalhamento da Categoria</h2>
      
      <div class="lista-detalhamento" id="listaDetalhamento">
        <!-- Lista de itens ser√° inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalDetalhamento()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Vari√°veis globais
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let graficoCartoes = null;
    let graficoSubcategorias = null;
    let dadosResumo = null;
    let lancamentos = [];
    let subcategorias = [];
    let cartoes = [];
    let tipoGerenciamentoAtual = null;
    const modal = document.getElementById("modalFormulario");
    const modalEdicao = document.getElementById("modalEdicao");
    const modalGerenciamento = document.getElementById("modalGerenciamento");
    const modalDetalhamento = document.getElementById("modalDetalhamento");
    const containerPrincipal = document.getElementById("containerPrincipal");

    // Fun√ß√£o para mostrar/esconder campo de cart√£o
    function toggleCartaoContainer() {
      const formaPagamento = document.getElementById("formaPagamento").value;
      const cartaoContainer = document.getElementById("cartaoContainer");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        document.getElementById("cartaoCredito").value = "";
      }
    }

    // Fun√ß√£o para mostrar/esconder campo de cart√£o na edi√ß√£o
    function toggleCartaoContainerEdicao() {
      const formaPagamento = document.getElementById("formaPagamentoEdicao").value;
      const cartaoContainer = document.getElementById("cartaoContainerEdicao");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        document.getElementById("cartaoCreditoEdicao").value = "";
      }
    }

    // Fun√ß√µes de navega√ß√£o
    function mostrarResumo() {
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.add("container-resumo-ativo");
    }

    function mostrarMensagens() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.add("container-mensagens-ativo");
      gerarMensagens(); // Gera mensagens automaticamente
    }

    function voltarParaLancamentos() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-mensagens-ativo");
    }

    function voltarParaResumo() {
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.add("container-resumo-ativo");
    }

    // Fun√ß√µes de Gerenciamento (Subcategorias e Cart√µes)
    function carregarDadosGerenciamento() {
      subcategorias = JSON.parse(localStorage.getItem("subcategorias") || "[]");
      cartoes = JSON.parse(localStorage.getItem("cartoes") || "[]");
      atualizarSelects();
    }

    function atualizarSelects() {
      atualizarSelect("subcategoria", subcategorias, "Nenhuma");
      atualizarSelect("subcategoriaEdicao", subcategorias, "Nenhuma");
      atualizarSelect("cartaoCredito", cartoes, "Selecione o cart√£o");
      atualizarSelect("cartaoCreditoEdicao", cartoes, "Selecione o cart√£o");
    }

    function atualizarSelect(selectId, dados, placeholder) {
      const select = document.getElementById(selectId);
      const valorAtual = select.value;
      select.innerHTML = `<option value="">${placeholder}</option>`;
      
      dados.forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.nome;
        select.appendChild(option);
      });
      
      if (valorAtual && dados.find(d => d.id == valorAtual)) {
        select.value = valorAtual;
      }
    }

    function abrirModalGerenciamento(tipo) {
      tipoGerenciamentoAtual = tipo;
      const tituloModal = document.getElementById("tituloModalGerenciamento");
      const formNovoItem = document.getElementById("formNovoItem");
      const listaGerenciamento = document.getElementById("listaGerenciamento");

      listaGerenciamento.innerHTML = "";

      if (tipo === "subcategorias") {
        tituloModal.textContent = "Gerenciar Subcategorias";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome da nova subcategoria" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        subcategorias.forEach(sub => adicionarItemNaLista(sub));
      } else if (tipo === "cartoes") {
        tituloModal.textContent = "Gerenciar Cart√µes de Cr√©dito";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome do Cart√£o (Ex: Nubank)" />
            <input type="number" id="novoDiaVencimento" class="novo-item-input dia" placeholder="Venc." min="1" max="31" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        cartoes.forEach(cartao => adicionarItemNaLista(cartao));
      }

      modalGerenciamento.style.display = "block";
    }

    function fecharModalGerenciamento() {
      modalGerenciamento.style.display = "none";
      tipoGerenciamentoAtual = null;
    }

    function adicionarItemNaLista(item) {
      const lista = document.getElementById("listaGerenciamento");
      const divItem = document.createElement("div");
      divItem.className = "item-gerenciamento";
      divItem.dataset.id = item.id;

      let detalhes = "";
      if (tipoGerenciamentoAtual === "cartoes") {
        detalhes = `<div class="item-gerenciamento-detalhe">Vencimento: dia ${item.diaVencimento} / Fechamento: dia ${item.diaFechamento}</div>`;
      }

      divItem.innerHTML = `
        <div class="item-gerenciamento-info">
          <span class="item-gerenciamento-nome">${item.nome}</span>
          ${detalhes}
        </div>
        <div class="botoes-item-gerenciamento">
          <button onclick="editarItemGerenciamento(${item.id})">Editar</button>
          <button class="excluir" onclick="excluirItemGerenciamento(${item.id})">Excluir</button>
        </div>
      `;
      lista.appendChild(divItem);
    }

    function adicionarItemGerenciamento() {
      const nomeInput = document.getElementById("novoNomeItem");
      const nome = nomeInput.value.trim();
      if (!nome) {
        alert("Digite o nome.");
        return;
      }

      let novoItem;
      let listaDados;
      let storageKey;

      if (tipoGerenciamentoAtual === "subcategorias") {
        if (subcategorias.find(s => s.nome.toLowerCase() === nome.toLowerCase())) {
          alert("J√° existe uma subcategoria com este nome.");
          return;
        }
        const novoId = subcategorias.length > 0 ? Math.max(...subcategorias.map(s => s.id)) + 1 : 1;
        novoItem = { id: novoId, nome: nome };
        subcategorias.push(novoItem);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      } else if (tipoGerenciamentoAtual === "cartoes") {
        const diaVencimentoInput = document.getElementById("novoDiaVencimento");
        const diaVencimento = parseInt(diaVencimentoInput.value);
        if (!diaVencimento || diaVencimento < 1 || diaVencimento > 31) {
          alert("Digite um dia de vencimento v√°lido (1-31).");
          return;
        }
        if (cartoes.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
          alert("J√° existe um cart√£o com este nome.");
          return;
        }
        const novoId = cartoes.length > 0 ? Math.max(...cartoes.map(c => c.id)) + 1 : 1;
        const diaFechamento = calcularDiaFechamento(diaVencimento);
        novoItem = { id: novoId, nome: nome, diaVencimento: diaVencimento, diaFechamento: diaFechamento };
        cartoes.push(novoItem);
        listaDados = cartoes;
        storageKey = "cartoes";
        diaVencimentoInput.value = "";
      }

      if (novoItem) {
        localStorage.setItem(storageKey, JSON.stringify(listaDados));
        adicionarItemNaLista(novoItem);
        atualizarSelects();
        nomeInput.value = "";
      }
    }

    function editarItemGerenciamento(id) {
      let item, listaDados, storageKey;
      if (tipoGerenciamentoAtual === "subcategorias") {
        item = subcategorias.find(s => s.id === id);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      } else if (tipoGerenciamentoAtual === "cartoes") {
        item = cartoes.find(c => c.id === id);
        listaDados = cartoes;
        storageKey = "cartoes";
      }
      if (!item) return;

      const novoNome = prompt(`Editar ${tipoGerenciamentoAtual === 'subcategorias' ? 'subcategoria' : 'cart√£o'}:`, item.nome);
      if (novoNome === null) return;
      const nomeFormatado = novoNome.trim();
      if (!nomeFormatado) {
        alert("Nome n√£o pode estar vazio.");
        return;
      }
      if (listaDados.find(i => i.id !== id && i.nome.toLowerCase() === nomeFormatado.toLowerCase())) {
        alert(`J√° existe ${tipoGerenciamentoAtual === 'subcategorias' ? 'uma subcategoria' : 'um cart√£o'} com este nome.`);
        return;
      }
      item.nome = nomeFormatado;

      if (tipoGerenciamentoAtual === "cartoes") {
        const novoDiaVencimentoStr = prompt("Novo dia de vencimento (1-31):", item.diaVencimento);
        if (novoDiaVencimentoStr === null) return;
        const novoDiaVencimento = parseInt(novoDiaVencimentoStr);
        if (!novoDiaVencimento || novoDiaVencimento < 1 || novoDiaVencimento > 31) {
          alert("Dia de vencimento inv√°lido.");
          return;
        }
        item.diaVencimento = novoDiaVencimento;
        item.diaFechamento = calcularDiaFechamento(novoDiaVencimento);
      }

      localStorage.setItem(storageKey, JSON.stringify(listaDados));
      const itemElement = document.querySelector(`.item-gerenciamento[data-id="${id}"]`);
      if (itemElement) {
        itemElement.querySelector(".item-gerenciamento-nome").textContent = item.nome;
        if (tipoGerenciamentoAtual === "cartoes") {
          itemElement.querySelector(".item-gerenciamento-detalhe").textContent = `Vencimento: dia ${item.diaVencimento} / Fechamento: dia ${item.diaFechamento}`;
        }
      }
      atualizarSelects();
    }

    function excluirItemGerenciamento(id) {
      let item, listaDados, storageKey;
      if (tipoGerenciamentoAtual === "subcategorias") {
        item = subcategorias.find(s => s.id === id);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      } else if (tipoGerenciamentoAtual === "cartoes") {
        item = cartoes.find(c => c.id === id);
        listaDados = cartoes;
        storageKey = "cartoes";
      }
      if (!item) return;

      if (!confirm(`Tem certeza que deseja excluir "${item.nome}"?`)) return;

      if (tipoGerenciamentoAtual === "subcategorias") {
        subcategorias = subcategorias.filter(s => s.id !== id);
      } else if (tipoGerenciamentoAtual === "cartoes") {
        cartoes = cartoes.filter(c => c.id !== id);
      }

      localStorage.setItem(storageKey, JSON.stringify(tipoGerenciamentoAtual === "subcategorias" ? subcategorias : cartoes));
      
      const itemElement = document.querySelector(`.item-gerenciamento[data-id="${id}"]`);
      if (itemElement) {
        itemElement.remove();
      }
      
      atualizarSelects();
    }

    // Fun√ß√£o para calcular dia de fechamento (7 dias antes do vencimento)
    function calcularDiaFechamento(diaVencimento) {
      let diaFechamento = diaVencimento - 7;
      if (diaFechamento <= 0) {
        diaFechamento += 30;
      }
      return diaFechamento;
    }

    // Continua na pr√≥xima parte...


    // Fun√ß√µes de Modal
    function abrirModal() {
      modal.style.display = "block";
      document.getElementById("dataInicial").value = new Date().toISOString().split('T')[0];
      document.getElementById("dataFinal").value = new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0];
    }

    function fecharModal() {
      modal.style.display = "none";
      limparFormulario();
    }

    function fecharModalEdicao() {
      modalEdicao.style.display = "none";
    }

    function fecharModalDetalhamento() {
      modalDetalhamento.style.display = "none";
    }

    function limparFormulario() {
      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("tipoLancamento").value = "receita";
      document.getElementById("formaPagamento").value = "conta";
      document.getElementById("subcategoria").value = "";
      document.getElementById("cartaoCredito").value = "";
      document.getElementById("frequenciaValor").value = "1";
      document.getElementById("frequenciaTipo").value = "meses";
      toggleCartaoContainer();
    }

    // Fun√ß√£o para adicionar lan√ßamento
    function adicionarLancamento() {
      const descricao = document.getElementById("descricao").value.trim();
      const valorStr = document.getElementById("valor").value.trim();
      const tipoLancamento = document.getElementById("tipoLancamento").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const subcategoriaId = document.getElementById("subcategoria").value;
      const cartaoCreditoId = document.getElementById("cartaoCredito").value;
      const frequenciaValor = parseInt(document.getElementById("frequenciaValor").value);
      const frequenciaTipo = document.getElementById("frequenciaTipo").value;
      const dataInicial = document.getElementById("dataInicial").value;
      const dataFinal = document.getElementById("dataFinal").value;

      if (!descricao || !valorStr || !dataInicial || !dataFinal) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
      }

      if (tipoLancamento !== "receita" && formaPagamento === "credito" && !cartaoCreditoId) {
        alert("Selecione um cart√£o de cr√©dito para despesas pagas no cart√£o.");
        return;
      }

      if (tipoLancamento === "receita" && formaPagamento === "credito") {
        alert("Receitas s√≥ podem ser lan√ßadas como 'Conta'.");
        return;
      }

      const valor = parseFloat(valorStr.replace(",", "."));
      if (isNaN(valor) || valor <= 0) {
        alert("Digite um valor v√°lido.");
        return;
      }

      const novoId = lancamentos.length > 0 ? Math.max(...lancamentos.map(l => l.id)) + 1 : 1;
      
      const subcategoriaNome = subcategoriaId ? subcategorias.find(s => s.id == subcategoriaId)?.nome || "" : "";
      const cartaoNome = cartaoCreditoId ? cartoes.find(c => c.id == cartaoCreditoId)?.nome || "" : "";

      const novoLancamento = {
        id: novoId,
        descricao: descricao,
        valor: valor,
        tipo: tipoLancamento,
        formaPagamento: formaPagamento,
        subcategoria: subcategoriaNome,
        cartao: cartaoNome,
        frequenciaValor: frequenciaValor,
        frequenciaTipo: frequenciaTipo,
        dataInicial: dataInicial,
        dataFinal: dataFinal,
        valores: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
      };

      calcularValoresMensais(novoLancamento);
      lancamentos.push(novoLancamento);
      salvarDados();
      atualizarTabela();
      fecharModal();
    }

    // Fun√ß√£o para calcular valores mensais baseado na recorr√™ncia
    function calcularValoresMensais(lancamento) {
      const dataInicio = new Date(lancamento.dataInicial);
      const dataFim = new Date(lancamento.dataFinal);
      const valores = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

      let dataAtual = new Date(dataInicio);
      
      while (dataAtual <= dataFim) {
        const mes = dataAtual.getMonth();
        
        // L√≥gica para cart√£o de cr√©dito - considera data de fechamento
        if (lancamento.formaPagamento === "credito" && lancamento.cartao) {
          const cartao = cartoes.find(c => c.nome === lancamento.cartao);
          if (cartao) {
            const dataFechamento = new Date(dataAtual.getFullYear(), mes, cartao.diaFechamento);
            const dataVencimento = new Date(dataAtual.getFullYear(), mes, cartao.diaVencimento);
            
            // Se a compra foi ap√≥s o fechamento, vai para o pr√≥ximo m√™s
            if (dataAtual.getDate() > cartao.diaFechamento) {
              const proximoMes = mes === 11 ? 0 : mes + 1;
              if (proximoMes < 12) {
                valores[proximoMes] += lancamento.valor;
              }
            } else {
              valores[mes] += lancamento.valor;
            }
          } else {
            valores[mes] += lancamento.valor;
          }
        } else {
          valores[mes] += lancamento.valor;
        }

        // Calcular pr√≥xima data baseada na frequ√™ncia
        switch (lancamento.frequenciaTipo) {
          case "unico":
            dataAtual = new Date(dataFim.getTime() + 1);
            break;
          case "dias":
            dataAtual.setDate(dataAtual.getDate() + lancamento.frequenciaValor);
            break;
          case "dias_uteis":
            for (let i = 0; i < lancamento.frequenciaValor; i++) {
              do {
                dataAtual.setDate(dataAtual.getDate() + 1);
              } while (dataAtual.getDay() === 0 || dataAtual.getDay() === 6);
            }
            break;
          case "segunda":
          case "terca":
          case "quarta":
          case "quinta":
          case "sexta":
            const diasSemana = { segunda: 1, terca: 2, quarta: 3, quinta: 4, sexta: 5 };
            const diaAlvo = diasSemana[lancamento.frequenciaTipo];
            dataAtual.setDate(dataAtual.getDate() + (7 * lancamento.frequenciaValor));
            break;
          case "semanas":
            dataAtual.setDate(dataAtual.getDate() + (7 * lancamento.frequenciaValor));
            break;
          case "quinzenas":
            dataAtual.setDate(dataAtual.getDate() + (15 * lancamento.frequenciaValor));
            break;
          case "meses":
            dataAtual.setMonth(dataAtual.getMonth() + lancamento.frequenciaValor);
            break;
          case "anos":
            dataAtual.setFullYear(dataAtual.getFullYear() + lancamento.frequenciaValor);
            break;
        }
      }

      lancamento.valores = valores;
    }

    // Fun√ß√£o para editar lan√ßamento
    function editarLancamento(id) {
      const lancamento = lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      document.getElementById("editLancamentoId").value = id;
      document.getElementById("descricaoEdicao").value = lancamento.descricao;
      document.getElementById("valorEdicao").value = lancamento.valor.toString().replace(".", ",");
      document.getElementById("tipoLancamentoEdicao").value = lancamento.tipo;
      document.getElementById("formaPagamentoEdicao").value = lancamento.formaPagamento;
      
      const subcategoriaId = subcategorias.find(s => s.nome === lancamento.subcategoria)?.id || "";
      document.getElementById("subcategoriaEdicao").value = subcategoriaId;
      
      const cartaoId = cartoes.find(c => c.nome === lancamento.cartao)?.id || "";
      document.getElementById("cartaoCreditoEdicao").value = cartaoId;
      
      document.getElementById("frequenciaValorEdicao").value = lancamento.frequenciaValor;
      document.getElementById("frequenciaTipoEdicao").value = lancamento.frequenciaTipo;
      document.getElementById("dataInicialEdicao").value = lancamento.dataInicial;
      document.getElementById("dataFinalEdicao").value = lancamento.dataFinal;

      toggleCartaoContainerEdicao();
      modalEdicao.style.display = "block";
    }

    function salvarEdicao() {
      const id = parseInt(document.getElementById("editLancamentoId").value);
      const lancamento = lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      const descricao = document.getElementById("descricaoEdicao").value.trim();
      const valorStr = document.getElementById("valorEdicao").value.trim();
      const tipoLancamento = document.getElementById("tipoLancamentoEdicao").value;
      const formaPagamento = document.getElementById("formaPagamentoEdicao").value;
      const subcategoriaId = document.getElementById("subcategoriaEdicao").value;
      const cartaoCreditoId = document.getElementById("cartaoCreditoEdicao").value;
      const frequenciaValor = parseInt(document.getElementById("frequenciaValorEdicao").value);
      const frequenciaTipo = document.getElementById("frequenciaTipoEdicao").value;
      const dataInicial = document.getElementById("dataInicialEdicao").value;
      const dataFinal = document.getElementById("dataFinalEdicao").value;

      if (!descricao || !valorStr || !dataInicial || !dataFinal) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
      }

      if (tipoLancamento !== "receita" && formaPagamento === "credito" && !cartaoCreditoId) {
        alert("Selecione um cart√£o de cr√©dito para despesas pagas no cart√£o.");
        return;
      }

      if (tipoLancamento === "receita" && formaPagamento === "credito") {
        alert("Receitas s√≥ podem ser lan√ßadas como 'Conta'.");
        return;
      }

      const valor = parseFloat(valorStr.replace(",", "."));
      if (isNaN(valor) || valor <= 0) {
        alert("Digite um valor v√°lido.");
        return;
      }

      const subcategoriaNome = subcategoriaId ? subcategorias.find(s => s.id == subcategoriaId)?.nome || "" : "";
      const cartaoNome = cartaoCreditoId ? cartoes.find(c => c.id == cartaoCreditoId)?.nome || "" : "";

      lancamento.descricao = descricao;
      lancamento.valor = valor;
      lancamento.tipo = tipoLancamento;
      lancamento.formaPagamento = formaPagamento;
      lancamento.subcategoria = subcategoriaNome;
      lancamento.cartao = cartaoNome;
      lancamento.frequenciaValor = frequenciaValor;
      lancamento.frequenciaTipo = frequenciaTipo;
      lancamento.dataInicial = dataInicial;
      lancamento.dataFinal = dataFinal;

      calcularValoresMensais(lancamento);
      salvarDados();
      atualizarTabela();
      fecharModalEdicao();
    }

    // Fun√ß√£o para excluir lan√ßamento
    function excluirLancamento(id) {
      if (confirm("Tem certeza que deseja excluir este lan√ßamento?")) {
        lancamentos = lancamentos.filter(l => l.id !== id);
        salvarDados();
        atualizarTabela();
      }
    }

    // Fun√ß√£o para atualizar tabela
    function atualizarTabela() {
      const tbody = document.getElementById("tabelaBody");
      tbody.innerHTML = "";

      lancamentos.forEach(lancamento => {
        const row = tbody.insertRow();
        row.onclick = () => editarLancamento(lancamento.id);

        const cellId = row.insertCell(0);
        cellId.textContent = lancamento.id;
        cellId.className = "hidden-id";

        const cellDescricao = row.insertCell(1);
        cellDescricao.textContent = lancamento.descricao;

        for (let i = 0; i < 12; i++) {
          const cell = row.insertCell(i + 2);
          const valor = lancamento.valores[i];
          if (valor !== 0) {
            cell.textContent = `R$ ${valor.toFixed(2).replace(".", ",")}`;
            if (lancamento.tipo === "receita") {
              cell.className = "receita";
            } else if (lancamento.tipo === "fixa") {
              cell.className = "fixa";
            } else {
              cell.className = "variavel";
            }
            if (lancamento.formaPagamento === "credito") {
              cell.classList.add("cartao-credito");
            }
          } else {
            cell.textContent = "";
          }
        }

        const cellTotal = row.insertCell(14);
        const total = lancamento.valores.reduce((sum, val) => sum + val, 0);
        cellTotal.textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;
        if (lancamento.tipo === "receita") {
          cellTotal.className = "receita";
        } else if (lancamento.tipo === "fixa") {
          cellTotal.className = "fixa";
        } else {
          cellTotal.className = "variavel";
        }

        const cellMedia = row.insertCell(15);
        const mesesComValor = lancamento.valores.filter(v => v > 0).length;
        const media = mesesComValor > 0 ? total / mesesComValor : 0;
        cellMedia.textContent = `R$ ${media.toFixed(2).replace(".", ",")}`;

        const cellAcoes = row.insertCell(16);
        cellAcoes.innerHTML = `<button class="delete-btn" onclick="event.stopPropagation(); excluirLancamento(${lancamento.id})">Excluir</button>`;
        cellAcoes.onclick = (e) => e.stopPropagation();
      });

      atualizarResumo();
    }

    // Fun√ß√£o para atualizar resumo
    function atualizarResumo() {
      const resumoBody = document.getElementById("resumoBody");
      resumoBody.innerHTML = "";

      const categorias = {
        "Receitas": { valores: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], classe: "receita" },
        "Despesas Fixas": { valores: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], classe: "fixa" },
        "Despesas Vari√°veis": { valores: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], classe: "variavel" }
      };

      // Calcular totais por categoria
      lancamentos.forEach(lancamento => {
        for (let i = 0; i < 12; i++) {
          if (lancamento.tipo === "receita") {
            categorias["Receitas"].valores[i] += lancamento.valores[i];
          } else if (lancamento.tipo === "fixa") {
            categorias["Despesas Fixas"].valores[i] += lancamento.valores[i];
          } else {
            categorias["Despesas Vari√°veis"].valores[i] += lancamento.valores[i];
          }
        }
      });

      // Adicionar linhas das categorias
      Object.keys(categorias).forEach(categoria => {
        const row = resumoBody.insertRow();
        row.onclick = () => mostrarDetalhamento(categoria);

        const cellCategoria = row.insertCell(0);
        cellCategoria.textContent = categoria;
        cellCategoria.className = categorias[categoria].classe;

        for (let i = 0; i < 12; i++) {
          const cell = row.insertCell(i + 1);
          const valor = categorias[categoria].valores[i];
          if (valor !== 0) {
            cell.textContent = `R$ ${valor.toFixed(2).replace(".", ",")}`;
            cell.className = categorias[categoria].classe;
          } else {
            cell.textContent = "";
          }
        }

        const cellTotal = row.insertCell(13);
        const total = categorias[categoria].valores.reduce((sum, val) => sum + val, 0);
        cellTotal.textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;
        cellTotal.className = categorias[categoria].classe;

        const cellMedia = row.insertCell(14);
        const mesesComValor = categorias[categoria].valores.filter(v => v > 0).length;
        const media = mesesComValor > 0 ? total / mesesComValor : 0;
        cellMedia.textContent = `R$ ${media.toFixed(2).replace(".", ",")}`;
        cellMedia.className = categorias[categoria].classe;
      });

      // Linha de espa√ßamento
      const spacerRow = resumoBody.insertRow();
      spacerRow.className = "spacer-row";
      for (let i = 0; i < 15; i++) {
        spacerRow.insertCell(i);
      }

      // Linha de saldo
      const saldoRow = resumoBody.insertRow();
      const cellSaldoCategoria = saldoRow.insertCell(0);
      cellSaldoCategoria.textContent = "Saldo";
      cellSaldoCategoria.style.fontWeight = "bold";

      for (let i = 0; i < 12; i++) {
        const cell = saldoRow.insertCell(i + 1);
        const saldo = categorias["Receitas"].valores[i] - categorias["Despesas Fixas"].valores[i] - categorias["Despesas Vari√°veis"].valores[i];
        if (saldo !== 0) {
          cell.textContent = `R$ ${saldo.toFixed(2).replace(".", ",")}`;
          cell.className = saldo >= 0 ? "saldo-positivo" : "saldo-negativo";
        } else {
          cell.textContent = "";
        }
      }

      const cellSaldoTotal = saldoRow.insertCell(13);
      const saldoTotal = categorias["Receitas"].valores.reduce((sum, val) => sum + val, 0) - 
                        categorias["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0) - 
                        categorias["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0);
      cellSaldoTotal.textContent = `R$ ${saldoTotal.toFixed(2).replace(".", ",")}`;
      cellSaldoTotal.className = saldoTotal >= 0 ? "saldo-positivo" : "saldo-negativo";
      cellSaldoTotal.style.fontWeight = "bold";

      const cellSaldoMedia = saldoRow.insertCell(14);
      const mesesComSaldo = 12;
      const saldoMedio = saldoTotal / mesesComSaldo;
      cellSaldoMedia.textContent = `R$ ${saldoMedio.toFixed(2).replace(".", ",")}`;
      cellSaldoMedia.className = saldoMedio >= 0 ? "saldo-positivo" : "saldo-negativo";

      dadosResumo = categorias;
      atualizarGraficos();
      gerarInsights();
    }

    // Fun√ß√µes de Detalhamento
    function mostrarDetalhamento(categoria) {
      const tituloDetalhamento = document.getElementById("tituloDetalhamento");
      const listaDetalhamento = document.getElementById("listaDetalhamento");
      
      tituloDetalhamento.textContent = `Detalhamento: ${categoria}`;
      listaDetalhamento.innerHTML = "";

      let tipoFiltro;
      if (categoria === "Receitas") tipoFiltro = "receita";
      else if (categoria === "Despesas Fixas") tipoFiltro = "fixa";
      else if (categoria === "Despesas Vari√°veis") tipoFiltro = "variavel";

      const lancamentosFiltrados = lancamentos.filter(l => l.tipo === tipoFiltro);

      if (lancamentosFiltrados.length === 0) {
        listaDetalhamento.innerHTML = '<div class="mensagem-vazia">Nenhum lan√ßamento encontrado para esta categoria.</div>';
      } else {
        lancamentosFiltrados.forEach(lancamento => {
          const divItem = document.createElement("div");
          divItem.className = "item-detalhamento";

          const total = lancamento.valores.reduce((sum, val) => sum + val, 0);
          const mesesComValor = lancamento.valores.filter(v => v > 0).length;
          const media = mesesComValor > 0 ? total / mesesComValor : 0;
          const totalGeral = dadosResumo[categoria].valores.reduce((sum, val) => sum + val, 0);
          const percentual = totalGeral > 0 ? (total / totalGeral * 100) : 0;

          let infoAdicional = "";
          if (lancamento.subcategoria) {
            infoAdicional += ` ‚Ä¢ ${lancamento.subcategoria}`;
          }
          if (lancamento.cartao) {
            infoAdicional += ` ‚Ä¢ ${lancamento.cartao}`;
          }

          divItem.innerHTML = `
            <div class="item-detalhamento-info">
              <strong>${lancamento.descricao}</strong>${infoAdicional}
              <div style="font-size: 12px; color: #b0bec5; margin-top: 5px;">
                ${lancamento.frequenciaTipo !== 'unico' ? `A cada ${lancamento.frequenciaValor} ${lancamento.frequenciaTipo}` : 'Lan√ßamento √∫nico'} 
                ‚Ä¢ ${lancamento.dataInicial} at√© ${lancamento.dataFinal}
              </div>
            </div>
            <div class="item-detalhamento-valores">
              <div class="item-detalhamento-valor">R$ ${total.toFixed(2).replace(".", ",")}</div>
              <div class="item-detalhamento-media">M√©dia: R$ ${media.toFixed(2).replace(".", ",")}</div>
              <div class="item-detalhamento-percentual">${percentual.toFixed(1)}% do total</div>
            </div>
          `;
          listaDetalhamento.appendChild(divItem);
        });
      }

      modalDetalhamento.style.display = "block";
    }

    // Fun√ß√µes dos Gr√°ficos
    function atualizarGraficos() {
      if (!dadosResumo) return;

      const mesSelecionado = parseInt(document.getElementById("mesSelecionado").value);
      
      atualizarGraficoDespesasPoupanca(mesSelecionado);
      atualizarGraficoDespesasReceitas(mesSelecionado);
      atualizarGraficoCartoes(mesSelecionado);
      atualizarGraficoSubcategorias(mesSelecionado);
    }

    function atualizarGraficoDespesasPoupanca(mesSelecionado) {
      const ctx = document.getElementById("graficoDespesasPoupanca").getContext("2d");
      const legenda = document.getElementById("legendaDespesasPoupanca");

      if (graficoDespesasPoupanca) {
        graficoDespesasPoupanca.destroy();
      }

      let receitas, despesasFixas, despesasVariaveis;

      if (mesSelecionado === -1) {
        receitas = dadosResumo["Receitas"].valores.reduce((sum, val) => sum + val, 0);
        despesasFixas = dadosResumo["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0);
        despesasVariaveis = dadosResumo["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0);
      } else if (mesSelecionado === -2) {
        const mesesComReceita = dadosResumo["Receitas"].valores.filter(v => v > 0).length;
        const mesesComFixa = dadosResumo["Despesas Fixas"].valores.filter(v => v > 0).length;
        const mesesComVariavel = dadosResumo["Despesas Vari√°veis"].valores.filter(v => v > 0).length;
        
        receitas = mesesComReceita > 0 ? dadosResumo["Receitas"].valores.reduce((sum, val) => sum + val, 0) / mesesComReceita : 0;
        despesasFixas = mesesComFixa > 0 ? dadosResumo["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0) / mesesComFixa : 0;
        despesasVariaveis = mesesComVariavel > 0 ? dadosResumo["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0) / mesesComVariavel : 0;
      } else {
        receitas = dadosResumo["Receitas"].valores[mesSelecionado];
        despesasFixas = dadosResumo["Despesas Fixas"].valores[mesSelecionado];
        despesasVariaveis = dadosResumo["Despesas Vari√°veis"].valores[mesSelecionado];
      }

      const poupanca = Math.max(0, receitas - despesasFixas - despesasVariaveis);
      const dados = [];
      const labels = [];
      const cores = [];

      if (despesasFixas > 0) {
        dados.push(despesasFixas);
        labels.push("Despesas Fixas");
        cores.push("#f44336");
      }
      if (despesasVariaveis > 0) {
        dados.push(despesasVariaveis);
        labels.push("Despesas Vari√°veis");
        cores.push("#ff9800");
      }
      if (poupanca > 0) {
        dados.push(poupanca);
        labels.push("Poupan√ßa");
        cores.push("#4caf50");
      }

      if (dados.length === 0) {
        legenda.innerHTML = '<div class="mensagem-vazia">Sem despesas para exibir neste per√≠odo.</div>';
        return;
      }

      graficoDespesasPoupanca = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            data: dados,
            backgroundColor: cores,
            borderWidth: 2,
            borderColor: "#002d26"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Atualizar legenda
      legenda.innerHTML = "";
      labels.forEach((label, index) => {
        const item = document.createElement("div");
        item.className = "item-legenda";
        item.innerHTML = `
          <div class="cor-legenda" style="background-color: ${cores[index]}"></div>
          <span class="descricao-legenda">${label}:</span>
          <span class="valor-legenda">R$ ${dados[index].toFixed(2).replace(".", ",")}</span>
        `;
        legenda.appendChild(item);
      });
    }

    function atualizarGraficoDespesasReceitas(mesSelecionado) {
      const ctx = document.getElementById("graficoDespesasReceitas").getContext("2d");
      const legenda = document.getElementById("legendaDespesasReceitas");

      if (graficoDespesasReceitas) {
        graficoDespesasReceitas.destroy();
      }

      let receitas, despesas;

      if (mesSelecionado === -1) {
        receitas = dadosResumo["Receitas"].valores.reduce((sum, val) => sum + val, 0);
        despesas = dadosResumo["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0) + 
                   dadosResumo["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0);
      } else if (mesSelecionado === -2) {
        const mesesComReceita = dadosResumo["Receitas"].valores.filter(v => v > 0).length;
        const totalDespesasFixas = dadosResumo["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0);
        const totalDespesasVariaveis = dadosResumo["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0);
        const mesesComDespesa = Math.max(
          dadosResumo["Despesas Fixas"].valores.filter(v => v > 0).length,
          dadosResumo["Despesas Vari√°veis"].valores.filter(v => v > 0).length
        );
        
        receitas = mesesComReceita > 0 ? dadosResumo["Receitas"].valores.reduce((sum, val) => sum + val, 0) / mesesComReceita : 0;
        despesas = mesesComDespesa > 0 ? (totalDespesasFixas + totalDespesasVariaveis) / mesesComDespesa : 0;
      } else {
        receitas = dadosResumo["Receitas"].valores[mesSelecionado];
        despesas = dadosResumo["Despesas Fixas"].valores[mesSelecionado] + 
                   dadosResumo["Despesas Vari√°veis"].valores[mesSelecionado];
      }

      const dados = [];
      const labels = [];
      const cores = [];

      if (receitas > 0) {
        dados.push(receitas);
        labels.push("Receitas");
        cores.push("#4caf50");
      }
      if (despesas > 0) {
        dados.push(despesas);
        labels.push("Despesas");
        cores.push("#f44336");
      }

      if (dados.length === 0) {
        legenda.innerHTML = '<div class="mensagem-vazia">Sem dados para exibir neste per√≠odo.</div>';
        return;
      }

      graficoDespesasReceitas = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            data: dados,
            backgroundColor: cores,
            borderWidth: 2,
            borderColor: "#002d26"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: "#ffffff" },
              grid: { color: "rgba(255,255,255,0.1)" }
            },
            x: {
              ticks: { color: "#ffffff" },
              grid: { color: "rgba(255,255,255,0.1)" }
            }
          }
        }
      });

      // Atualizar legenda
      legenda.innerHTML = "";
      labels.forEach((label, index) => {
        const item = document.createElement("div");
        item.className = "item-legenda";
        item.innerHTML = `
          <div class="cor-legenda" style="background-color: ${cores[index]}"></div>
          <span class="descricao-legenda">${label}:</span>
          <span class="valor-legenda">R$ ${dados[index].toFixed(2).replace(".", ",")}</span>
        `;
        legenda.appendChild(item);
      });
    }

    function atualizarGraficoCartoes(mesSelecionado) {
      const ctx = document.getElementById("graficoCartoes").getContext("2d");
      const legenda = document.getElementById("legendaCartoes");

      if (graficoCartoes) {
        graficoCartoes.destroy();
      }

      // Calcular gastos por cart√£o
      const gastosPorCartao = {};
      
      lancamentos.forEach(lancamento => {
        if (lancamento.formaPagamento === "credito" && lancamento.cartao) {
          if (!gastosPorCartao[lancamento.cartao]) {
            gastosPorCartao[lancamento.cartao] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
          }
          for (let i = 0; i < 12; i++) {
            gastosPorCartao[lancamento.cartao][i] += lancamento.valores[i];
          }
        }
      });

      const dados = [];
      const labels = [];
      const cores = ["#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#00bcd4", "#009688", "#4caf50"];

      Object.keys(gastosPorCartao).forEach((cartao, index) => {
        let valor;
        if (mesSelecionado === -1) {
          valor = gastosPorCartao[cartao].reduce((sum, val) => sum + val, 0);
        } else if (mesSelecionado === -2) {
          const mesesComGasto = gastosPorCartao[cartao].filter(v => v > 0).length;
          valor = mesesComGasto > 0 ? gastosPorCartao[cartao].reduce((sum, val) => sum + val, 0) / mesesComGasto : 0;
        } else {
          valor = gastosPorCartao[cartao][mesSelecionado];
        }

        if (valor > 0) {
          dados.push(valor);
          labels.push(cartao);
        }
      });

      if (dados.length === 0) {
        legenda.innerHTML = '<div class="mensagem-vazia">Nenhum gasto no cart√£o neste per√≠odo.</div>';
        return;
      }

      graficoCartoes = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: dados,
            backgroundColor: cores.slice(0, dados.length),
            borderWidth: 2,
            borderColor: "#002d26"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Atualizar legenda
      legenda.innerHTML = "";
      labels.forEach((label, index) => {
        const item = document.createElement("div");
        item.className = "item-legenda";
        item.innerHTML = `
          <div class="cor-legenda" style="background-color: ${cores[index]}"></div>
          <span class="descricao-legenda">${label}:</span>
          <span class="valor-legenda">R$ ${dados[index].toFixed(2).replace(".", ",")}</span>
        `;
        legenda.appendChild(item);
      });
    }

    function atualizarGraficoSubcategorias(mesSelecionado) {
      const ctx = document.getElementById("graficoSubcategorias").getContext("2d");
      const legenda = document.getElementById("legendaSubcategorias");

      if (graficoSubcategorias) {
        graficoSubcategorias.destroy();
      }

      // Calcular gastos por subcategoria
      const gastosPorSubcategoria = {};
      
      lancamentos.forEach(lancamento => {
        if (lancamento.subcategoria && lancamento.tipo !== "receita") {
          if (!gastosPorSubcategoria[lancamento.subcategoria]) {
            gastosPorSubcategoria[lancamento.subcategoria] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
          }
          for (let i = 0; i < 12; i++) {
            gastosPorSubcategoria[lancamento.subcategoria][i] += lancamento.valores[i];
          }
        }
      });

      const dados = [];
      const labels = [];
      const cores = ["#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#00bcd4", "#009688", "#8bc34a", "#cddc39", "#ffeb3b", "#ff5722", "#795548"];

      Object.keys(gastosPorSubcategoria).forEach((subcategoria, index) => {
        let valor;
        if (mesSelecionado === -1) {
          valor = gastosPorSubcategoria[subcategoria].reduce((sum, val) => sum + val, 0);
        } else if (mesSelecionado === -2) {
          const mesesComGasto = gastosPorSubcategoria[subcategoria].filter(v => v > 0).length;
          valor = mesesComGasto > 0 ? gastosPorSubcategoria[subcategoria].reduce((sum, val) => sum + val, 0) / mesesComGasto : 0;
        } else {
          valor = gastosPorSubcategoria[subcategoria][mesSelecionado];
        }

        if (valor > 0) {
          dados.push(valor);
          labels.push(subcategoria);
        }
      });

      if (dados.length === 0) {
        legenda.innerHTML = '<div class="mensagem-vazia">Nenhuma subcategoria com gastos neste per√≠odo.</div>';
        return;
      }

      graficoSubcategorias = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            data: dados,
            backgroundColor: cores.slice(0, dados.length),
            borderWidth: 2,
            borderColor: "#002d26"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Atualizar legenda
      legenda.innerHTML = "";
      labels.forEach((label, index) => {
        const item = document.createElement("div");
        item.className = "item-legenda";
        item.innerHTML = `
          <div class="cor-legenda" style="background-color: ${cores[index]}"></div>
          <span class="descricao-legenda">${label}:</span>
          <span class="valor-legenda">R$ ${dados[index].toFixed(2).replace(".", ",")}</span>
        `;
        legenda.appendChild(item);
      });
    }

    // Fun√ß√£o para gerar insights
    function gerarInsights() {
      const insightsContent = document.getElementById("insightsContent");
      insightsContent.innerHTML = "";

      if (!dadosResumo) return;

      const insights = [];

      // Calcular totais anuais
      const totalReceitas = dadosResumo["Receitas"].valores.reduce((sum, val) => sum + val, 0);
      const totalDespesasFixas = dadosResumo["Despesas Fixas"].valores.reduce((sum, val) => sum + val, 0);
      const totalDespesasVariaveis = dadosResumo["Despesas Vari√°veis"].valores.reduce((sum, val) => sum + val, 0);
      const totalDespesas = totalDespesasFixas + totalDespesasVariaveis;
      const saldoAnual = totalReceitas - totalDespesas;

      // Insight 1: An√°lise do saldo
      if (saldoAnual > 0) {
        insights.push({
          tipo: "üí∞ Situa√ß√£o Financeira",
          texto: `Parab√©ns! Voc√™ tem um saldo positivo de <span class="insight-valor">R$ ${saldoAnual.toFixed(2).replace(".", ",")}</span> no ano. Isso representa ${((saldoAnual / totalReceitas) * 100).toFixed(1)}% das suas receitas sendo poupadas.`
        });
      } else if (saldoAnual < 0) {
        insights.push({
          tipo: "‚ö†Ô∏è Aten√ß√£o",
          texto: `Voc√™ est√° gastando <span class="insight-alerta">R$ ${Math.abs(saldoAnual).toFixed(2).replace(".", ",")}</span> a mais do que ganha. √â importante revisar seus gastos para equilibrar o or√ßamento.`
        });
      }

      // Insight 2: Distribui√ß√£o de despesas
      if (totalDespesas > 0) {
        const percentualFixas = (totalDespesasFixas / totalDespesas) * 100;
        const percentualVariaveis = (totalDespesasVariaveis / totalDespesas) * 100;
        
        insights.push({
          tipo: "üìä Distribui√ß√£o de Gastos",
          texto: `Suas despesas se dividem em ${percentualFixas.toFixed(1)}% fixas e ${percentualVariaveis.toFixed(1)}% vari√°veis. ${percentualFixas > 70 ? 'Considere revisar gastos fixos para ter mais flexibilidade.' : 'Boa distribui√ß√£o entre gastos fixos e vari√°veis.'}`
        });
      }

      // Insight 3: An√°lise de cart√µes
      const gastosCartao = lancamentos
        .filter(l => l.formaPagamento === "credito")
        .reduce((sum, l) => sum + l.valores.reduce((s, v) => s + v, 0), 0);
      
      if (gastosCartao > 0 && totalDespesas > 0) {
        const percentualCartao = (gastosCartao / totalDespesas) * 100;
        insights.push({
          tipo: "üí≥ Uso do Cart√£o",
          texto: `${percentualCartao.toFixed(1)}% dos seus gastos s√£o feitos no cart√£o de cr√©dito (<span class="insight-valor">R$ ${gastosCartao.toFixed(2).replace(".", ",")}</span>). ${percentualCartao > 50 ? 'Monitore os gastos no cart√£o para evitar surpresas na fatura.' : 'Uso moderado do cart√£o de cr√©dito.'}`
        });
      }

      // Insight 4: Maior categoria de gasto
      if (totalDespesasFixas > totalDespesasVariaveis) {
        insights.push({
          tipo: "üéØ Foco de Otimiza√ß√£o",
          texto: `Suas despesas fixas representam a maior parte dos gastos. Considere renegociar contratos ou buscar alternativas mais econ√¥micas para reduzir custos fixos.`
        });
      } else if (totalDespesasVariaveis > totalDespesasFixas) {
        insights.push({
          tipo: "üéØ Foco de Otimiza√ß√£o",
          texto: `Suas despesas vari√°veis s√£o maiores que as fixas. Isso oferece mais flexibilidade para ajustar o or√ßamento conforme necess√°rio.`
        });
      }

      // Insight 5: Proje√ß√£o anual
      const mediaReceitas = totalReceitas / 12;
      const mediaDespesas = totalDespesas / 12;
      const projecaoSaldo = (mediaReceitas - mediaDespesas) * 12;
      
      if (Math.abs(projecaoSaldo - saldoAnual) < 100) {
        insights.push({
          tipo: "üìà Proje√ß√£o",
          texto: `Mantendo o padr√£o atual, voc√™ ter√° um saldo de <span class="${projecaoSaldo >= 0 ? 'insight-valor' : 'insight-alerta'}">R$ ${projecaoSaldo.toFixed(2).replace(".", ",")}</span> ao final do ano.`
        });
      }

      // Renderizar insights
      insights.forEach(insight => {
        const insightDiv = document.createElement("div");
        insightDiv.className = "insight-item";
        insightDiv.innerHTML = `
          <div class="insight-tipo">${insight.tipo}</div>
          <div class="insight-texto">${insight.texto}</div>
        `;
        insightsContent.appendChild(insightDiv);
      });

      if (insights.length === 0) {
        insightsContent.innerHTML = '<div class="mensagem-vazia">Adicione alguns lan√ßamentos para ver insights personalizados.</div>';
      }
    }

    // Fun√ß√µes do Sistema de Mensagens
    function atualizarSimulador() {
      const tipoData = document.querySelector('input[name="tipoData"]:checked').value;
      const dataEspecifica = document.getElementById("dataEspecifica");
      
      if (tipoData === "especifica") {
        dataEspecifica.disabled = false;
        if (!dataEspecifica.value) {
          dataEspecifica.value = new Date().toISOString().split('T')[0];
        }
      } else {
        dataEspecifica.disabled = true;
      }
    }

    function gerarMensagens() {
      const tipoData = document.querySelector('input[name="tipoData"]:checked').value;
      let dataReferencia;
      
      if (tipoData === "hoje") {
        dataReferencia = new Date();
      } else {
        const dataEspecifica = document.getElementById("dataEspecifica").value;
        if (!dataEspecifica) {
          alert("Selecione uma data espec√≠fica.");
          return;
        }
        dataReferencia = new Date(dataEspecifica);
      }

      const mensagensContainer = document.getElementById("mensagensContainer");
      mensagensContainer.innerHTML = "";

      // Gerar mensagens para hoje, semana e m√™s
      const mensagemHoje = gerarMensagemPeriodo(dataReferencia, "hoje");
      const mensagemSemana = gerarMensagemPeriodo(dataReferencia, "semana");
      const mensagemMes = gerarMensagemPeriodo(dataReferencia, "mes");

      mensagensContainer.appendChild(mensagemHoje);
      mensagensContainer.appendChild(mensagemSemana);
      mensagensContainer.appendChild(mensagemMes);
    }

    function gerarMensagemPeriodo(dataReferencia, periodo) {
      const mensagemCard = document.createElement("div");
      mensagemCard.className = `mensagem-card mensagem-${periodo}`;

      let titulo, itens;
      
      if (periodo === "hoje") {
        titulo = `üìÖ Hoje (${dataReferencia.toLocaleDateString('pt-BR')})`;
        itens = calcularItensHoje(dataReferencia);
      } else if (periodo === "semana") {
        const inicioSemana = new Date(dataReferencia);
        inicioSemana.setDate(dataReferencia.getDate() - dataReferencia.getDay());
        const fimSemana = new Date(inicioSemana);
        fimSemana.setDate(inicioSemana.getDate() + 6);
        titulo = `üìÜ Esta Semana (${inicioSemana.toLocaleDateString('pt-BR')} - ${fimSemana.toLocaleDateString('pt-BR')})`;
        itens = calcularItensSemana(dataReferencia);
      } else {
        titulo = `üóìÔ∏è Este M√™s (${dataReferencia.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })})`;
        itens = calcularItensMes(dataReferencia);
      }

      mensagemCard.innerHTML = `
        <div class="mensagem-titulo">${titulo}</div>
        <ul class="mensagem-lista" id="lista-${periodo}">
          ${itens.length > 0 ? itens.map(item => `
            <li class="mensagem-item">
              <span class="mensagem-descricao">${item.descricao}</span>
              <span class="mensagem-valor ${item.tipo === 'receita' ? 'receita' : (item.tipo === 'fixa' ? 'fixa' : 'variavel')}">R$ ${item.valor.toFixed(2).replace(".", ",")}</span>
              <span class="mensagem-data">${item.data}</span>
            </li>
          `).join('') : '<li class="mensagem-vazia">Nenhum lan√ßamento previsto para este per√≠odo.</li>'}
        </ul>
      `;

      return mensagemCard;
    }

    function calcularItensHoje(dataReferencia) {
      const itens = [];
      const hoje = new Date(dataReferencia);
      
      lancamentos.forEach(lancamento => {
        const datasOcorrencia = calcularDatasOcorrencia(lancamento, hoje.getFullYear());
        
        datasOcorrencia.forEach(data => {
          if (data.toDateString() === hoje.toDateString()) {
            // Para cart√£o de cr√©dito, considerar data de vencimento da fatura
            let dataExibicao = data.toLocaleDateString('pt-BR');
            if (lancamento.formaPagamento === "credito" && lancamento.cartao) {
              const cartao = cartoes.find(c => c.nome === lancamento.cartao);
              if (cartao) {
                const dataVencimento = new Date(data.getFullYear(), data.getMonth(), cartao.diaVencimento);
                if (data.getDate() > cartao.diaFechamento) {
                  dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                }
                dataExibicao = `Venc: ${dataVencimento.toLocaleDateString('pt-BR')}`;
              }
            }
            
            itens.push({
              descricao: `${lancamento.descricao}${lancamento.cartao ? ` (${lancamento.cartao})` : ''}${lancamento.subcategoria ? ` ‚Ä¢ ${lancamento.subcategoria}` : ''}`,
              valor: lancamento.valor,
              tipo: lancamento.tipo,
              data: dataExibicao
            });
          }
        });
      });

      return itens.sort((a, b) => b.valor - a.valor);
    }

    function calcularItensSemana(dataReferencia) {
      const itens = [];
      const inicioSemana = new Date(dataReferencia);
      inicioSemana.setDate(dataReferencia.getDate() - dataReferencia.getDay());
      const fimSemana = new Date(inicioSemana);
      fimSemana.setDate(inicioSemana.getDate() + 6);
      
      lancamentos.forEach(lancamento => {
        const datasOcorrencia = calcularDatasOcorrencia(lancamento, dataReferencia.getFullYear());
        
        datasOcorrencia.forEach(data => {
          if (data >= inicioSemana && data <= fimSemana) {
            let dataExibicao = data.toLocaleDateString('pt-BR');
            if (lancamento.formaPagamento === "credito" && lancamento.cartao) {
              const cartao = cartoes.find(c => c.nome === lancamento.cartao);
              if (cartao) {
                const dataVencimento = new Date(data.getFullYear(), data.getMonth(), cartao.diaVencimento);
                if (data.getDate() > cartao.diaFechamento) {
                  dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                }
                dataExibicao = `Venc: ${dataVencimento.toLocaleDateString('pt-BR')}`;
              }
            }
            
            itens.push({
              descricao: `${lancamento.descricao}${lancamento.cartao ? ` (${lancamento.cartao})` : ''}${lancamento.subcategoria ? ` ‚Ä¢ ${lancamento.subcategoria}` : ''}`,
              valor: lancamento.valor,
              tipo: lancamento.tipo,
              data: dataExibicao
            });
          }
        });
      });

      return itens.sort((a, b) => new Date(a.data.replace('Venc: ', '')) - new Date(b.data.replace('Venc: ', '')));
    }

    function calcularItensMes(dataReferencia) {
      const itens = [];
      const inicioMes = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
      const fimMes = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth() + 1, 0);
      
      lancamentos.forEach(lancamento => {
        const datasOcorrencia = calcularDatasOcorrencia(lancamento, dataReferencia.getFullYear());
        
        datasOcorrencia.forEach(data => {
          if (data >= inicioMes && data <= fimMes) {
            let dataExibicao = data.toLocaleDateString('pt-BR');
            if (lancamento.formaPagamento === "credito" && lancamento.cartao) {
              const cartao = cartoes.find(c => c.nome === lancamento.cartao);
              if (cartao) {
                const dataVencimento = new Date(data.getFullYear(), data.getMonth(), cartao.diaVencimento);
                if (data.getDate() > cartao.diaFechamento) {
                  dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                }
                dataExibicao = `Venc: ${dataVencimento.toLocaleDateString('pt-BR')}`;
              }
            }
            
            itens.push({
              descricao: `${lancamento.descricao}${lancamento.cartao ? ` (${lancamento.cartao})` : ''}${lancamento.subcategoria ? ` ‚Ä¢ ${lancamento.subcategoria}` : ''}`,
              valor: lancamento.valor,
              tipo: lancamento.tipo,
              data: dataExibicao
            });
          }
        });
      });

      return itens.sort((a, b) => new Date(a.data.replace('Venc: ', '')) - new Date(b.data.replace('Venc: ', '')));
    }

    function calcularDatasOcorrencia(lancamento, ano) {
      const datas = [];
      const dataInicio = new Date(lancamento.dataInicial);
      const dataFim = new Date(lancamento.dataFinal);
      
      // Ajustar para o ano espec√≠fico se necess√°rio
      if (dataInicio.getFullYear() !== ano) {
        dataInicio.setFullYear(ano);
      }
      if (dataFim.getFullYear() !== ano) {
        dataFim.setFullYear(ano);
      }

      let dataAtual = new Date(dataInicio);
      
      while (dataAtual <= dataFim && dataAtual.getFullYear() === ano) {
        datas.push(new Date(dataAtual));

        // Calcular pr√≥xima data baseada na frequ√™ncia
        switch (lancamento.frequenciaTipo) {
          case "unico":
            dataAtual = new Date(dataFim.getTime() + 1);
            break;
          case "dias":
            dataAtual.setDate(dataAtual.getDate() + lancamento.frequenciaValor);
            break;
          case "dias_uteis":
            for (let i = 0; i < lancamento.frequenciaValor; i++) {
              do {
                dataAtual.setDate(dataAtual.getDate() + 1);
              } while (dataAtual.getDay() === 0 || dataAtual.getDay() === 6);
            }
            break;
          case "segunda":
          case "terca":
          case "quarta":
          case "quinta":
          case "sexta":
            dataAtual.setDate(dataAtual.getDate() + (7 * lancamento.frequenciaValor));
            break;
          case "semanas":
            dataAtual.setDate(dataAtual.getDate() + (7 * lancamento.frequenciaValor));
            break;
          case "quinzenas":
            dataAtual.setDate(dataAtual.getDate() + (15 * lancamento.frequenciaValor));
            break;
          case "meses":
            dataAtual.setMonth(dataAtual.getMonth() + lancamento.frequenciaValor);
            break;
          case "anos":
            dataAtual.setFullYear(dataAtual.getFullYear() + lancamento.frequenciaValor);
            break;
        }
      }

      return datas;
    }

    // Fun√ß√µes de persist√™ncia
    function salvarDados() {
      localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
    }

    function carregarDados() {
      const dadosSalvos = localStorage.getItem("lancamentos");
      if (dadosSalvos) {
        lancamentos = JSON.parse(dadosSalvos);
      }
      carregarDadosGerenciamento();
      atualizarTabela();
    }

    // Inicializa√ß√£o
    window.onload = function() {
      carregarDados();
      atualizarSimulador();
      
      // Fechar modais clicando fora
      window.onclick = function(event) {
        if (event.target === modal) {
          fecharModal();
        }
        if (event.target === modalEdicao) {
          fecharModalEdicao();
        }
        if (event.target === modalGerenciamento) {
          fecharModalGerenciamento();
        }
        if (event.target === modalDetalhamento) {
          fecharModalDetalhamento();
        }
      };
    };
  </script>
</body>
</html>

