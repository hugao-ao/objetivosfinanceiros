<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Objetivos Financeiros</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      margin: 20px auto;
      padding: 20px;
      max-width: 1200px;
      line-height: 1.6;
    }
    
    h1 {
      color: var(--dourado);
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2rem;
      font-weight: 600;
    }
    
    .form-container {
      background-color: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    .form-section {
      margin-bottom: 25px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .form-section-title {
      font-size: 1.2rem;
      color: var(--verde-esmeralda);
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .row > div {
      flex: 1;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--verde-esmeralda);
      box-shadow: 0 0 0 2px rgba(4, 108, 78, 0.2);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    button {
      margin-top: 25px;
      padding: 14px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      font-size: 1.1rem;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #035a41;
    }
    
    .status-message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      display: none;
    }
    
    .status-success {
      background-color: rgba(40, 167, 69, 0.1);
      border: 1px solid rgba(40, 167, 69, 0.3);
      color: #218838;
    }
    
    .status-error {
      background-color: rgba(220, 53, 69, 0.1);
      border: 1px solid rgba(220, 53, 69, 0.3);
      color: #dc3545;
    }
    
    .status-info {
      background-color: rgba(0, 123, 255, 0.1);
      border: 1px solid rgba(0, 123, 255, 0.3);
      color: #0069d9;
    }
    
    .result {
      margin-top: 30px;
      padding: 25px;
      border: 2px solid var(--dourado);
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .recommendation {
      margin: 30px 0;
      padding: 25px;
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .recommendation h3 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 15px;
      font-size: 1.4rem;
    }
    
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 30px 0;
      background-color: #25D366;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }
    
    .whatsapp-button:hover {
      background-color: #128C7E;
    }
    
    .chart-container {
      margin-top: 40px;
      position: relative;
      border: 1px solid var(--dourado-claro);
      border-radius: 12px;
      padding: 25px;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--verde-esmeralda);
      font-size: 1.3rem;
    }
    
    .chart-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .chart-nav button {
      padding: 10px 20px;
      margin-top: 0;
      width: auto;
      font-size: 0.9rem;
      background-color: var(--verde-medio);
    }
    
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 450px;
    }
    
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    
    .table-slide {
      flex: 0 0 100%;
      overflow-y: auto;
      padding: 10px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: right;
    }
    
    .data-table th {
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      text-align: center;
      position: sticky;
      top: 0;
      font-weight: 600;
    }
    
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .data-table tr:hover {
      background-color: #f1f1f1;
    }
    
    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      border: 1px solid #ffcdd2;
      display: none;
    }
    
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .chart-content {
        height: 350px;
      }
    }
  </style>
</head>
<body>
  <h1>Calculadora de Objetivos Financeiros</h1>
  
  <div class="form-container">
    <form id="savingsForm">
      <div class="form-section">
        <div class="form-section-title">Sobre seu objetivo</div>
        <label for="goalDescription">Qual é o seu objetivo financeiro e por que ele é importante para você?</label>
        <textarea id="goalDescription" placeholder="Ex: Comprar um imóvel para ter segurança e estabilidade para minha família, ou fazer uma viagem internacional para conhecer novas culturas..."></textarea>
        
        <div class="row">
          <div>
            <label for="goal">Valor do Objetivo (R$):</label>
            <input type="text" id="goal" required oninput="formatCurrency(this)">
          </div>
          <div>
            <label for="period">Prazo (em meses):</label>
            <input type="number" id="period" required min="1">
          </div>
        </div>
      </div>
      
      <div id="taxasStatus" class="status-message"></div>
      <div id="errorMessage" class="error-message"></div>
      
      <div class="form-section">
        <div class="form-section-title">Taxas e rendimentos</div>
        
        <label>Você sabe a taxa de juros?</label>
        <div class="row">
          <div>
            <select id="knowsRate" onchange="toggleRateInput()">
              <option value="no">Não</option>
              <option value="yes">Sim</option>
            </select>
          </div>
          <div>
            <input type="text" id="rate" placeholder="10,00 %" oninput="formatPercentage(this)">
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="rateType">Tipo de Taxa:</label>
            <select id="rateType">
              <option value="annual">Anual</option>
              <option value="monthly">Mensal</option>
            </select>
          </div>
        </div>
        
        <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
        <div class="row">
          <div>
            <select id="knowsTax" onchange="toggleTaxInput('tax', '15,00 %')">
              <option value="no">Não</option>
              <option value="yes">Sim</option>
            </select>
          </div>
          <div>
            <input type="text" id="tax" placeholder="15,00 %" oninput="formatPercentage(this)">
          </div>
        </div>
        
        <label>Você sabe a taxa de inflação dos últimos 12 meses?</label>
        <div class="row">
          <div>
            <select id="knowsInflation" onchange="toggleInflationInput()">
              <option value="no">Não</option>
              <option value="yes">Sim</option>
            </select>
          </div>
          <div>
            <input type="text" id="inflation" placeholder="5,00 %" oninput="formatPercentage(this)">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="form-section-title">Situação atual</div>
        
        <div class="row">
          <div>
            <label for="currentSavings">Valor já Guardado (R$):</label>
            <input type="text" id="currentSavings" required oninput="formatCurrency(this)">
          </div>
          <div>
            <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
            <input type="text" id="currentContribution" required oninput="formatCurrency(this)">
          </div>
        </div>
      </div>
      
      <button type="button" onclick="calculateSavings()">Calcular</button>
    </form>
  </div>
  
  <div id="result" class="result" style="display: none;"></div>
  
  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>
  
  <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
    Avançar para análise personalizada
  </a>
  
  <div id="chartUnicoContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Investimento Único</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Unico', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Unico', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartUnicoSlide" class="chart-slide">
        <canvas id="chartUnico"></canvas>
      </div>
      <div id="tableUnicoSlide" class="table-slide" style="display: none;">
        <table id="tableUnico" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartIdealContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Plano Ideal</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Ideal', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Ideal', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartIdealSlide" class="chart-slide">
        <canvas id="chartIdeal"></canvas>
      </div>
      <div id="tableIdealSlide" class="table-slide" style="display: none;">
        <table id="tableIdeal" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartAtualContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Poupança Atual</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Atual', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Atual', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartAtualSlide" class="chart-slide">
        <canvas id="chartAtual"></canvas>
      </div>
      <div id="tableAtualSlide" class="table-slide" style="display: none;">
        <table id="tableAtual" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartRentabilidadeContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Rentabilidade Necessária</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Rentabilidade', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Rentabilidade', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartRentabilidadeSlide" class="chart-slide">
        <canvas id="chartRentabilidade"></canvas>
      </div>
      <div id="tableRentabilidadeSlide" class="table-slide" style="display: none;">
        <table id="tableRentabilidade" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais para armazenar os resultados e textos
    let goalDescriptionText = '';
    let resultText = '';
    
    // Função para formatar valores monetários
    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, '');
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = 'R$ ' + value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.').replace(/\.(\d{2})$/, ',$1');
    }

    // Função para formatar valores percentuais
    function formatPercentage(input) {
      let value = input.value.replace(/\D/g, '');
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = value.replace('.', ',') + ' %';
    }

    // Função para alternar a entrada de taxa de imposto
    function toggleTaxInput(id, defaultValue) {
      const select = document.getElementById(id === 'tax' ? 'knowsTax' : 'knowsInflation');
      const input = document.getElementById(id);
      input.disabled = select.value !== 'yes';
      input.value = select.value === 'yes' ? '' : defaultValue;
    }
    
    // Função para alternar a entrada de taxa de juros
    function toggleRateInput() {
      const select = document.getElementById('knowsRate');
      const input = document.getElementById('rate');
      input.disabled = select.value !== 'yes';
      
      if (select.value === 'no') {
        showStatusMessage('Buscando taxa CDI atual...', 'info');
        preencherCDIAtual();
      } else {
        input.value = '';
        input.focus();
      }
    }
    
    // Função para alternar a entrada de taxa de inflação
    function toggleInflationInput() {
      const select = document.getElementById('knowsInflation');
      const input = document.getElementById('inflation');
      input.disabled = select.value !== 'yes';
      
      if (select.value === 'no') {
        showStatusMessage('Buscando IPCA dos últimos 12 meses...', 'info');
        preencherIPCAUltimos12Meses();
      } else {
        input.value = '';
        input.focus();
      }
    }

    // Função para analisar valores monetários
    function parseCurrency(value) {
      if (!value) return 0;
      return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    // Função para analisar valores percentuais
    function parsePercentage(value) {
      if (!value) return 0;
      return parseFloat(value.replace(/[%\s]/g, '').replace(',', '.')) / 100 || 0;
    }

    // Função para formatar valores monetários com sempre duas casas decimais
    function formatMoney(value) {
      return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Função para exibir mensagens de status
    function showStatusMessage(message, type) {
      const statusElement = document.getElementById('taxasStatus');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      
      if (type === 'success') {
        statusElement.classList.add('status-success');
      } else if (type === 'error') {
        statusElement.classList.add('status-error');
      } else {
        statusElement.classList.add('status-info');
      }
      
      statusElement.style.display = 'block';
      
      // Esconde a mensagem após 5 segundos se for sucesso ou informação
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }
    
    // Função para exibir mensagens de erro
    function showErrorMessage(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      
      // Rolar até a mensagem de erro
      errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Esconde a mensagem após 8 segundos
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 8000);
    }

    // Função para alternar entre visualização de gráfico e tabela
    function showChartSlide(chartId, slideType) {
      const chartSlide = document.getElementById(`chart${chartId}Slide`);
      const tableSlide = document.getElementById(`table${chartId}Slide`);
      
      if (slideType === 'chart') {
        chartSlide.style.display = 'block';
        tableSlide.style.display = 'none';
      } else {
        chartSlide.style.display = 'none';
        tableSlide.style.display = 'block';
      }
    }

    // Função para abrir o WhatsApp com a mensagem personalizada
    function openWhatsAppChat() {
      // Obter o texto do objetivo e da caixa de resposta
      const goalText = goalDescriptionText;
      const resultBoxText = resultText;
      
      // Criar a mensagem para o WhatsApp
      const message = `Oi Hugo, queria tua ajuda com o meu objetivo:
${goalText}

Segue o resumo:
${resultBoxText}`;
      
      // Codificar a mensagem para URL
      const encodedMessage = encodeURIComponent(message);
      
      // Criar o link do WhatsApp usando a API correta
      const whatsappUrl = `https://api.whatsapp.com/send?phone=5581994297920&text=${encodedMessage}`;
      
      // Abrir o link em uma nova janela
      window.open(whatsappUrl, '_blank');
    }

    // Função para preencher a tabela de dados
    function fillDataTable(tableId, data, goal, inflation) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      
      // Começar do mês 1 (não do mês 0)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const tr = document.createElement('tr');
        
        // Mês
        const tdMes = document.createElement('td');
        tdMes.textContent = row.month;
        tr.appendChild(tdMes);
        
        // Total Investido
        const tdInvestido = document.createElement('td');
        tdInvestido.textContent = `R$ ${formatMoney(row.totalInvestido)}`;
        tr.appendChild(tdInvestido);
        
        // Juros
        const tdJuros = document.createElement('td');
        tdJuros.textContent = `R$ ${formatMoney(row.juros)}`;
        tr.appendChild(tdJuros);
        
        // Total Juros
        const tdTotalJuros = document.createElement('td');
        tdTotalJuros.textContent = `R$ ${formatMoney(row.totalJuros)}`;
        tr.appendChild(tdTotalJuros);
        
        // Total Acumulado
        const tdAcumulado = document.createElement('td');
        tdAcumulado.textContent = `R$ ${formatMoney(row.totalAcumulado)}`;
        tr.appendChild(tdAcumulado);
        
        // Imposto
        const tdImposto = document.createElement('td');
        tdImposto.textContent = `R$ ${formatMoney(row.imposto)}`;
        tr.appendChild(tdImposto);
        
        // Valor Líquido
        const tdLiquido = document.createElement('td');
        tdLiquido.textContent = `R$ ${formatMoney(row.valorLiquido)}`;
        tr.appendChild(tdLiquido);
        
        // Objetivo Corrigido
        const tdObjetivo = document.createElement('td');
        tdObjetivo.textContent = `R$ ${formatMoney(row.objetivoCorrigido)}`;
        tr.appendChild(tdObjetivo);
        
        tbody.appendChild(tr);
      }
    }

    // Função para desenhar gráficos
    function drawChart(ctx, bruto, liquido, investido, corBruto, corLiquido, corInvestido) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: bruto.map(item => item.month),
          datasets: [
            {
              label: 'Valor Bruto',
              data: bruto.map(item => item.totalAcumulado),
              borderColor: corBruto,
              backgroundColor: corBruto + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            },
            {
              label: 'Valor Líquido',
              data: liquido.map(item => item.valorLiquido),
              borderColor: corLiquido,
              backgroundColor: corLiquido + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            },
            {
              label: 'Total Investido',
              data: investido.map(item => item.totalInvestido),
              borderColor: corInvestido,
              backgroundColor: corInvestido + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }
              }
            }
          }
        }
      });
    }

    // Função para calcular o valor futuro com juros compostos
    function calcularValorFuturo(principal, taxa, periodo, aporte = 0) {
      let valorFuturo = principal;
      let totalInvestido = principal;
      let totalJuros = 0;
      let dados = [];
      
      // Mês 0 (inicial)
      dados.push({
        month: 0,
        totalInvestido: totalInvestido,
        juros: 0,
        totalJuros: 0,
        totalAcumulado: valorFuturo,
        imposto: 0,
        valorLiquido: valorFuturo,
        objetivoCorrigido: 0
      });
      
      for (let i = 1; i <= periodo; i++) {
        const juros = valorFuturo * taxa;
        valorFuturo = valorFuturo + juros + aporte;
        totalInvestido += aporte;
        totalJuros += juros;
        
        dados.push({
          month: i,
          totalInvestido: totalInvestido,
          juros: juros,
          totalJuros: totalJuros,
          totalAcumulado: valorFuturo,
          imposto: 0, // Será calculado depois
          valorLiquido: 0, // Será calculado depois
          objetivoCorrigido: 0 // Será calculado depois
        });
      }
      
      return dados;
    }

    // Função para calcular a poupança necessária
    function calcularPoupancaNecessaria(objetivo, taxa, periodo, valorInicial) {
      // Fórmula: PMT = (FV - PV * (1 + r)^n) / (((1 + r)^n - 1) / r)
      const taxaDecimal = taxa;
      const fv = objetivo;
      const pv = valorInicial;
      
      const parte1 = fv - pv * Math.pow(1 + taxaDecimal, periodo);
      const parte2 = (Math.pow(1 + taxaDecimal, periodo) - 1) / taxaDecimal;
      
      return parte1 / parte2;
    }

    // Função para aplicar imposto sobre o rendimento
    function aplicarImposto(dados, taxaImposto) {
      for (let i = 0; i < dados.length; i++) {
        const imposto = dados[i].totalJuros * taxaImposto;
        dados[i].imposto = imposto;
        dados[i].valorLiquido = dados[i].totalAcumulado - imposto;
      }
      return dados;
    }

    // Função para aplicar correção pela inflação
    function aplicarInflacao(dados, objetivo, taxaInflacao) {
      let objetivoCorrigido = objetivo;
      
      for (let i = 0; i < dados.length; i++) {
        dados[i].objetivoCorrigido = objetivoCorrigido;
        objetivoCorrigido *= (1 + taxaInflacao);
      }
      
      return dados;
    }

    // Função para calcular a taxa necessária
    function calcularTaxaNecessaria(objetivo, periodo, valorInicial, aporteMensal) {
      // Usar método de aproximação para encontrar a taxa
      let taxaMin = 0;
      let taxaMax = 1; // 100% ao mês seria um limite superior razoável
      let taxaAtual = 0.01; // Começar com 1% ao mês
      let valorFuturo = 0;
      const precisao = 0.0000001;
      
      for (let i = 0; i < 100; i++) { // Limite de iterações
        valorFuturo = valorInicial;
        for (let j = 0; j < periodo; j++) {
          valorFuturo = valorFuturo * (1 + taxaAtual) + aporteMensal;
        }
        
        if (Math.abs(valorFuturo - objetivo) < precisao) {
          break;
        }
        
        if (valorFuturo < objetivo) {
          taxaMin = taxaAtual;
        } else {
          taxaMax = taxaAtual;
        }
        
        taxaAtual = (taxaMin + taxaMax) / 2;
      }
      
      return taxaAtual;
    }

    // Função para validar os campos do formulário
    function validarFormulario() {
      // Obter valores do formulário
      const goalDescription = document.getElementById('goalDescription').value.trim();
      const goalValue = parseCurrency(document.getElementById('goal').value);
      const period = parseInt(document.getElementById('period').value);
      const rateValue = parsePercentage(document.getElementById('rate').value);
      const taxValue = parsePercentage(document.getElementById('tax').value);
      const inflationValue = parsePercentage(document.getElementById('inflation').value);
      const currentSavings = parseCurrency(document.getElementById('currentSavings').value);
      const currentContribution = parseCurrency(document.getElementById('currentContribution').value);
      
      // Verificar se todos os campos estão preenchidos
      if (!goalDescription) {
        showErrorMessage('Por favor, descreva seu objetivo financeiro.');
        return false;
      }
      
      if (!goalValue || goalValue <= 0) {
        showErrorMessage('Por favor, informe um valor válido para o objetivo.');
        return false;
      }
      
      if (!period || period <= 0) {
        showErrorMessage('Por favor, informe um prazo válido em meses.');
        return false;
      }
      
      if (!rateValue || rateValue <= 0) {
        showErrorMessage('Por favor, informe uma taxa de juros válida.');
        return false;
      }
      
      if (!taxValue && taxValue !== 0) {
        showErrorMessage('Por favor, informe uma alíquota de imposto válida.');
        return false;
      }
      
      if (!inflationValue && inflationValue !== 0) {
        showErrorMessage('Por favor, informe uma taxa de inflação válida.');
        return false;
      }
      
      if (!currentSavings && currentSavings !== 0) {
        showErrorMessage('Por favor, informe o valor já guardado.');
        return false;
      }
      
      if (!currentContribution && currentContribution !== 0) {
        showErrorMessage('Por favor, informe quanto você poupa atualmente por mês.');
        return false;
      }
      
      return true;
    }

    // Função para calcular as poupanças
    function calculateSavings() {
      // Validar formulário
      if (!validarFormulario()) {
        return;
      }
      
      // Obter valores do formulário
      goalDescriptionText = document.getElementById('goalDescription').value;
      const goalValue = parseCurrency(document.getElementById('goal').value);
      const period = parseInt(document.getElementById('period').value);
      const rateValue = parsePercentage(document.getElementById('rate').value);
      const rateType = document.getElementById('rateType').value;
      const taxValue = parsePercentage(document.getElementById('tax').value);
      const inflationValue = parsePercentage(document.getElementById('inflation').value);
      const currentSavings = parseCurrency(document.getElementById('currentSavings').value);
      const currentContribution = parseCurrency(document.getElementById('currentContribution').value);
      
      // Converter taxa anual para mensal se necessário
      const monthlyRate = rateType === 'annual' ? Math.pow(1 + rateValue, 1/12) - 1 : rateValue;
      const monthlyInflation = Math.pow(1 + inflationValue, 1/12) - 1;
      
      // Calcular valor único necessário
      const valorUnico = goalValue / Math.pow(1 + monthlyRate, period);
      
      // Calcular aporte mensal ideal
      const aporteIdeal = calcularPoupancaNecessaria(goalValue, monthlyRate, period, currentSavings);
      
      // Calcular com aporte atual
      const dadosAtual = calcularValorFuturo(currentSavings, monthlyRate, period, currentContribution);
      const valorFinalAtual = dadosAtual[period].totalAcumulado;
      
      // Calcular taxa necessária para atingir o objetivo com o aporte atual
      const taxaNecessaria = calcularTaxaNecessaria(goalValue, period, currentSavings, currentContribution);
      
      // Calcular dados para os diferentes cenários
      let dadosUnico = calcularValorFuturo(valorUnico, monthlyRate, period);
      let dadosIdeal = calcularValorFuturo(currentSavings, monthlyRate, period, aporteIdeal);
      let dadosRentabilidade = calcularValorFuturo(currentSavings, taxaNecessaria, period, currentContribution);
      
      // Aplicar imposto sobre o rendimento
      dadosUnico = aplicarImposto(dadosUnico, taxValue);
      dadosIdeal = aplicarImposto(dadosIdeal, taxValue);
      dadosAtual = aplicarImposto(dadosAtual, taxValue);
      dadosRentabilidade = aplicarImposto(dadosRentabilidade, taxValue);
      
      // Aplicar correção pela inflação
      dadosUnico = aplicarInflacao(dadosUnico, goalValue, monthlyInflation);
      dadosIdeal = aplicarInflacao(dadosIdeal, goalValue, monthlyInflation);
      dadosAtual = aplicarInflacao(dadosAtual, goalValue, monthlyInflation);
      dadosRentabilidade = aplicarInflacao(dadosRentabilidade, goalValue, monthlyInflation);
      
      // Calcular diferença entre valor final e objetivo
      const diferencaAtual = valorFinalAtual - goalValue;
      const atingeObjetivo = diferencaAtual >= 0;
      
      // Preparar texto do resultado
      const taxaAnual = (Math.pow(1 + monthlyRate, 12) - 1) * 100;
      const taxaNecessariaAnual = (Math.pow(1 + taxaNecessaria, 12) - 1) * 100;
      
      let resultHtml = `
        <h3>Resultado da Simulação</h3>
        <p><strong>Objetivo:</strong> R$ ${formatMoney(goalValue)} em ${period} meses</p>
        <p><strong>Taxa de juros:</strong> ${rateValue.toFixed(2)}% ${rateType === 'annual' ? 'ao ano' : 'ao mês'} (${taxaAnual.toFixed(2)}% ao ano)</p>
        <p><strong>Inflação:</strong> ${inflationValue.toFixed(2)}% ao ano</p>
        <p><strong>Imposto:</strong> ${taxValue.toFixed(2)}%</p>
        <p><strong>Valor já guardado:</strong> R$ ${formatMoney(currentSavings)}</p>
        <p><strong>Aporte mensal atual:</strong> R$ ${formatMoney(currentContribution)}</p>
        <hr>
        <p><strong>Investimento único necessário:</strong> R$ ${formatMoney(valorUnico)}</p>
        <p><strong>Aporte mensal ideal:</strong> R$ ${formatMoney(aporteIdeal)}</p>
        <p><strong>Valor final com aporte atual:</strong> R$ ${formatMoney(valorFinalAtual)} (${atingeObjetivo ? 'atinge o objetivo' : 'não atinge o objetivo'})</p>
        <p><strong>Diferença para o objetivo:</strong> R$ ${formatMoney(Math.abs(diferencaAtual))} ${atingeObjetivo ? 'acima' : 'abaixo'}</p>
        <p><strong>Rentabilidade necessária:</strong> ${taxaNecessariaAnual.toFixed(2)}% ao ano</p>
      `;
      
      // Exibir resultado
      const resultElement = document.getElementById('result');
      resultElement.innerHTML = resultHtml;
      resultElement.style.display = 'block';
      
      // Armazenar texto do resultado para WhatsApp
      resultText = `Objetivo: R$ ${formatMoney(goalValue)} em ${period} meses
Taxa de juros: ${rateValue.toFixed(2)}% ${rateType === 'annual' ? 'ao ano' : 'ao mês'} (${taxaAnual.toFixed(2)}% ao ano)
Inflação: ${inflationValue.toFixed(2)}% ao ano
Imposto: ${taxValue.toFixed(2)}%
Valor já guardado: R$ ${formatMoney(currentSavings)}
Aporte mensal atual: R$ ${formatMoney(currentContribution)}

Investimento único necessário: R$ ${formatMoney(valorUnico)}
Aporte mensal ideal: R$ ${formatMoney(aporteIdeal)}
Valor final com aporte atual: R$ ${formatMoney(valorFinalAtual)} (${atingeObjetivo ? 'atinge o objetivo' : 'não atinge o objetivo'})
Diferença para o objetivo: R$ ${formatMoney(Math.abs(diferencaAtual))} ${atingeObjetivo ? 'acima' : 'abaixo'}
Rentabilidade necessária: ${taxaNecessariaAnual.toFixed(2)}% ao ano`;
      
      // Preparar recomendação
      let recommendationText = '';
      
      if (atingeObjetivo) {
        recommendationText = `
          <p>Parabéns! Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você conseguirá atingir seu objetivo de R$ ${formatMoney(goalValue)} em ${period} meses, e ainda terá um excedente de R$ ${formatMoney(diferencaAtual)}.</p>
          <p>Recomendações:</p>
          <ul>
            <li>Considere aumentar seu objetivo financeiro</li>
            <li>Você pode reduzir seu aporte mensal para R$ ${formatMoney(aporteIdeal)} e ainda assim atingir seu objetivo</li>
            <li>Alternativamente, você pode reduzir o prazo para alcançar seu objetivo mais rapidamente</li>
          </ul>
        `;
      } else {
        recommendationText = `
          <p>Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você não conseguirá atingir seu objetivo de R$ ${formatMoney(goalValue)} em ${period} meses. Faltarão aproximadamente R$ ${formatMoney(Math.abs(diferencaAtual))}.</p>
          <p>Recomendações:</p>
          <ul>
            <li>Aumente seu aporte mensal para R$ ${formatMoney(aporteIdeal)}</li>
            <li>Busque investimentos com rentabilidade de pelo menos ${taxaNecessariaAnual.toFixed(2)}% ao ano</li>
            <li>Considere estender o prazo para atingir seu objetivo</li>
          </ul>
        `;
      }
      
      // Exibir recomendação
      document.getElementById('recommendationText').innerHTML = recommendationText;
      document.getElementById('recommendation').style.display = 'block';
      
      // Exibir botão do WhatsApp
      document.getElementById('whatsappButton').style.display = 'block';
      
      // Desenhar gráficos
      document.getElementById('chartUnicoContainer').style.display = 'block';
      document.getElementById('chartIdealContainer').style.display = 'block';
      document.getElementById('chartAtualContainer').style.display = 'block';
      document.getElementById('chartRentabilidadeContainer').style.display = 'block';
      
      // Preencher tabelas
      fillDataTable('tableUnico', dadosUnico, goalValue, inflationValue);
      fillDataTable('tableIdeal', dadosIdeal, goalValue, inflationValue);
      fillDataTable('tableAtual', dadosAtual, goalValue, inflationValue);
      fillDataTable('tableRentabilidade', dadosRentabilidade, goalValue, inflationValue);
      
      // Desenhar gráficos
      drawChart(
        document.getElementById('chartUnico').getContext('2d'),
        dadosUnico,
        dadosUnico,
        dadosUnico,
        '#046c4e',
        '#28a745',
        '#d4af37'
      );
      
      drawChart(
        document.getElementById('chartIdeal').getContext('2d'),
        dadosIdeal,
        dadosIdeal,
        dadosIdeal,
        '#046c4e',
        '#28a745',
        '#d4af37'
      );
      
      drawChart(
        document.getElementById('chartAtual').getContext('2d'),
        dadosAtual,
        dadosAtual,
        dadosAtual,
        '#046c4e',
        '#28a745',
        '#d4af37'
      );
      
      drawChart(
        document.getElementById('chartRentabilidade').getContext('2d'),
        dadosRentabilidade,
        dadosRentabilidade,
        dadosRentabilidade,
        '#046c4e',
        '#28a745',
        '#d4af37'
      );
      
      // Rolar para o resultado
      document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
    }

    // Função para buscar a taxa CDI atual
    async function buscarCDIAtual() {
      try {
        // Busca os últimos valores do CDI diário (código 12)
        const url = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/20?formato=json';
        
        // Faz a requisição à API
        const response = await fetch(url);
        
        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
          throw new Error(`Erro ao buscar dados do CDI atual: ${response.status}`);
        }
        
        // Converte a resposta para JSON
        const dados = await response.json();
        
        // Verifica se há dados
        if (dados.length === 0) {
          throw new Error('Nenhum dado encontrado para o CDI atual');
        }
        
        // Obtém o valor mais recente do CDI
        const taxaCDIAtual = parseFloat(dados[dados.length - 1].valor);
        
        // Calcula a taxa anual equivalente (considerando 252 dias úteis por ano)
        // Fórmula: ((1 + taxa diária)^252) - 1
        const taxaAnual = (Math.pow(1 + taxaCDIAtual / 100, 252) - 1) * 100;
        
        // Retorna a taxa anual
        return taxaAnual;
      } catch (erro) {
        console.error('Erro ao buscar taxa CDI atual:', erro);
        return null;
      }
    }

    // Função para buscar a inflação (IPCA) acumulada dos últimos 12 meses
    async function buscarIPCAUltimos12Meses() {
      try {
        // Calcula as datas para os últimos 12 meses
        const dataFinal = new Date();
        const dataInicial = new Date();
        dataInicial.setMonth(dataInicial.getMonth() - 12);
        
        // Formata as datas no padrão dd/MM/aaaa exigido pela API
        const dataInicialFormatada = `${String(dataInicial.getDate()).padStart(2, '0')}/${String(dataInicial.getMonth() + 1).padStart(2, '0')}/${dataInicial.getFullYear()}`;
        const dataFinalFormatada = `${String(dataFinal.getDate()).padStart(2, '0')}/${String(dataFinal.getMonth() + 1).padStart(2, '0')}/${dataFinal.getFullYear()}`;
        
        // Monta a URL da API do Banco Central para o IPCA (código 433)
        const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json&dataInicial=${dataInicialFormatada}&dataFinal=${dataFinalFormatada}`;
        
        // Faz a requisição à API
        const response = await fetch(url);
        
        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
          throw new Error(`Erro ao buscar dados do IPCA: ${response.status}`);
        }
        
        // Converte a resposta para JSON
        const dados = await response.json();
        
        // Verifica se há dados no período
        if (dados.length === 0) {
          throw new Error('Nenhum dado encontrado para o IPCA nos últimos 12 meses');
        }
        
        // Calcula a inflação acumulada nos últimos 12 meses (produto dos fatores mensais)
        let inflacaoAcumulada = 1;
        for (const item of dados) {
          // O IPCA é fornecido em percentual ao mês, precisamos converter para fator
          const taxaMensal = parseFloat(item.valor) / 100;
          inflacaoAcumulada *= (1 + taxaMensal);
        }
        
        // Converte para percentual anual
        const taxaAnual = (inflacaoAcumulada - 1) * 100;
        
        // Retorna a taxa anual
        return taxaAnual;
      } catch (erro) {
        console.error('Erro ao buscar IPCA dos últimos 12 meses:', erro);
        return null;
      }
    }

    // Função para preencher a taxa de juros com o CDI atual
    async function preencherCDIAtual() {
      try {
        // Busca o CDI atual
        const taxaCDI = await buscarCDIAtual();
        
        // Verifica se a taxa foi encontrada
        if (taxaCDI === null) {
          throw new Error('Não foi possível obter a taxa CDI atual');
        }
        
        // Formata a taxa para exibição
        const taxaCDIFormatada = taxaCDI.toFixed(2).replace('.', ',') + ' %';
        
        // Atualiza o campo de taxa de juros
        document.getElementById('rate').value = taxaCDIFormatada;
        
        // Atualiza a mensagem de status
        showStatusMessage(`Taxa CDI atual: ${taxaCDIFormatada}`, 'success');
        
        return true;
      } catch (erro) {
        console.error('Erro ao preencher CDI atual:', erro);
        
        // Exibe mensagem de erro
        showStatusMessage(`Erro: ${erro.message}. Por favor, informe a taxa manualmente.`, 'error');
        
        return false;
      }
    }

    // Função para preencher a taxa de inflação com o IPCA dos últimos 12 meses
    async function preencherIPCAUltimos12Meses() {
      try {
        // Busca o IPCA dos últimos 12 meses
        const taxaIPCA = await buscarIPCAUltimos12Meses();
        
        // Verifica se a taxa foi encontrada
        if (taxaIPCA === null) {
          throw new Error('Não foi possível obter o IPCA dos últimos 12 meses');
        }
        
        // Formata a taxa para exibição
        const taxaIPCAFormatada = taxaIPCA.toFixed(2).replace('.', ',') + ' %';
        
        // Atualiza o campo de inflação
        document.getElementById('inflation').value = taxaIPCAFormatada;
        
        // Atualiza a mensagem de status
        showStatusMessage(`IPCA dos últimos 12 meses: ${taxaIPCAFormatada}`, 'success');
        
        return true;
      } catch (erro) {
        console.error('Erro ao preencher IPCA dos últimos 12 meses:', erro);
        
        // Exibe mensagem de erro
        showStatusMessage(`Erro: ${erro.message}. Por favor, informe a taxa manualmente.`, 'error');
        
        return false;
      }
    }

    // Inicialização quando o documento estiver carregado
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializa os estados dos inputs
      toggleRateInput();
      toggleTaxInput('tax', '15,00 %');
      toggleInflationInput();
      
      // Preenche automaticamente as taxas se os seletores estiverem como "Não"
      const knowsRateSelect = document.getElementById('knowsRate');
      const knowsInflationSelect = document.getElementById('knowsInflation');
      
      if (knowsRateSelect && knowsRateSelect.value === 'no') {
        preencherCDIAtual();
      }
      
      if (knowsInflationSelect && knowsInflationSelect.value === 'no') {
        preencherIPCAUltimos12Meses();
      }
    });
  </script>
</body>
</html>
