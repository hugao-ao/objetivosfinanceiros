<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Controle Financeiro V9 - Registro de Gastos Reais</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ===== VARIÁVEIS E RESET ===== */
    :root {
      /* Paleta de cores original - Verde esmeralda escuro + Dourado */
      --color-primary: #014034;         /* Verde esmeralda escuro */
      --color-primary-light: #006a56;   /* Verde esmeralda médio */
      --color-primary-dark: #002d26;    /* Verde esmeralda muito escuro */
      
      /* Cores secundárias - Dourado */
      --color-accent: #ffd700;          /* Dourado */
      --color-accent-light: #ffec8b;    /* Dourado claro */
      --color-accent-dark: #ffc400;     /* Dourado escuro */
      
      /* Cores de fundo - Tons escuros */
      --color-bg-dark: #002d26;         /* Fundo principal escuro */
      --color-bg-medium: #014034;       /* Fundo secundário */
      --color-bg-light: #006a56;        /* Fundo para cards e elementos */
      
      /* Cores de texto */
      --color-text: #ffffff;            /* Texto principal */
      --color-text-muted: #b0bec5;      /* Texto secundário */
      --color-text-accent: #ffd700;     /* Texto destacado */
      
      /* Cores de status */
      --color-success: #4caf50;         /* Verde - sucesso */
      --color-warning: #ff9800;         /* Laranja - alerta */
      --color-danger: #f44336;          /* Vermelho - erro */
      --color-info: #2196F3;            /* Azul - informação */
      
      /* Espaçamentos */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      /* Bordas e sombras */
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      
      /* Transições */
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }
    
    /* Reset básico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--color-bg-dark);
      color: var(--color-text);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* ===== LAYOUT PRINCIPAL COM NAVEGAÇÃO LATERAL ===== */
    .container-principal {
      display: flex;
      width: 400vw; /* 4 seções lado a lado */
      height: 100vh;
      transition: transform var(--transition-slow);
    }
    
    .secao-lancamentos,
    .secao-resumo,
    .secao-mensagens,
    .secao-gastos-reais {
      width: 100vw;
      height: 100vh;
      overflow-y: auto;
      padding: var(--spacing-md);
      box-sizing: border-box;
    }
    
    /* Estados de navegação */
    .container-principal.mostrar-lancamentos {
      transform: translateX(0);
    }
    
    .container-principal.mostrar-resumo {
      transform: translateX(-100vw);
    }
    
    .container-principal.mostrar-mensagens {
      transform: translateX(-200vw);
    }
    
    .container-principal.mostrar-gastos-reais {
      transform: translateX(-300vw);
    }
    
    /* ===== COMPONENTES ===== */
    
    /* Títulos */
    h1 {
      font-size: 1.8rem;
      margin-bottom: var(--spacing-lg);
      color: var(--color-text-accent);
      text-align: center;
      border-bottom: 2px solid var(--color-accent);
      padding-bottom: var(--spacing-sm);
    }
    
    .resumo-titulo {
      font-size: 1.2rem;
      margin-bottom: var(--spacing-md);
      color: var(--color-text-accent);
      text-align: center;
      font-weight: 600;
    }
    
    /* Botões */
    .btn,
    .botao-lancar,
    .botao-filtrar,
    .botao-voltar,
    .botao-gerenciar,
    .botao-adicionar-item,
    .delete-btn,
    .botao-fixo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      outline: none;
      font-size: 0.9rem;
      min-height: 38px;
      gap: var(--spacing-sm);
    }
    
    .botao-lancar {
      background-color: var(--color-accent);
      color: var(--color-bg-dark);
    }
    
    .botao-lancar:hover {
      background-color: var(--color-accent-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .botao-filtrar {
      background-color: var(--color-accent);
      color: var(--color-bg-dark);
      align-self: flex-end;
      margin-top: auto;
    }
    
    .botao-filtrar:hover {
      background-color: var(--color-accent-dark);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .botao-voltar {
      background-color: var(--color-warning);
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
    }
    
    .botao-voltar:hover {
      background-color: #e68a00;
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .botao-gerenciar {
      background-color: var(--color-success);
      color: var(--color-text);
      font-size: 0.8rem;
      padding: var(--spacing-xs) var(--spacing-sm);
    }
    
    .botao-gerenciar:hover {
      background-color: #45a049;
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
    }
    
    .botao-adicionar-item {
      background-color: var(--color-success);
      color: var(--color-text);
    }
    
    .botao-adicionar-item:hover {
      background-color: #45a049;
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .delete-btn {
      background-color: var(--color-danger);
      color: var(--color-text);
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.8rem;
    }
    
    .delete-btn:hover {
      background-color: #b71c1c;
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
    }
    
    .botao-abrir-modal {
      background-color: var(--color-accent);
      color: var(--color-bg-dark);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      font-weight: bold;
      line-height: 24px;
      text-align: center;
      cursor: pointer;
      margin-left: var(--spacing-sm);
      padding: 0;
      transition: all var(--transition-fast);
    }
    
    .botao-abrir-modal:hover {
      background-color: var(--color-accent-dark);
      transform: scale(1.1);
    }
    
    /* Botões fixos */
    .botao-fixo {
      position: fixed;
      z-index: 50;
      box-shadow: var(--shadow-md);
      transition: all var(--transition-normal);
    }
    
    .botao-resumo-fixo {
      top: var(--spacing-lg);
      right: var(--spacing-lg);
      background-color: var(--color-info);
      color: var(--color-text);
    }
    
    .botao-mensagens-fixo {
      top: calc(var(--spacing-lg) + 50px);
      right: var(--spacing-lg);
      background-color: #673ab7;
      color: var(--color-text);
    }
    
    .botao-gastos-reais-fixo {
      top: calc(var(--spacing-lg) + 100px);
      right: var(--spacing-lg);
      background-color: #009688;
      color: var(--color-text);
    }
    
    /* Esconde os botões fixos quando a seção correspondente está ativa */
    .container-principal.mostrar-resumo ~ .botao-resumo-fixo,
    .container-principal.mostrar-mensagens ~ .botao-mensagens-fixo,
    .container-principal.mostrar-gastos-reais ~ .botao-gastos-reais-fixo {
      opacity: 0;
      visibility: hidden;
      transform: translateX(20px);
    }
    
    .botao-resumo-fixo:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
    }
    
    .botao-mensagens-fixo:hover {
      background-color: #5e35b1;
      transform: translateY(-2px);
    }
    
    .botao-gastos-reais-fixo:hover {
      background-color: #00796b;
      transform: translateY(-2px);
    }
    
    /* Formulários */
    .form-section {
      background-color: var(--color-bg-medium);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--spacing-lg);
    }
    
    .form-section-modal {
      padding: 0;
      border-radius: var(--border-radius-lg);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-lg);
    }
    
    .form-group {
      margin-bottom: var(--spacing-md);
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      color: var(--color-text-muted);
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: var(--spacing-sm);
      font-size: 0.9rem;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--color-bg-light);
      background-color: var(--color-bg-light);
      color: var(--color-text);
      transition: all var(--transition-fast);
      margin-bottom: var(--spacing-sm);
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
    }
    
    .botoes-formulario {
      grid-column: 1 / -1;
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
      margin-top: var(--spacing-sm);
    }
    
    /* Tabelas */
    .table-container {
      background-color: var(--color-bg-medium);
      border-radius: var(--border-radius-lg);
      overflow-x: auto;
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      color: var(--color-text);
    }
    
    th, td {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--color-bg-light);
      text-align: center;
    }
    
    th {
      background-color: var(--color-bg-light);
      color: var(--color-text-accent);
      position: sticky;
      top: 0;
      z-index: 5;
      font-weight: 600;
    }
    
    th.descricao-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-right: var(--spacing-xs);
    }
    
    /* Cores para tipos de lançamentos */
    .receita { color: var(--color-success); }
    .fixa { color: var(--color-danger); }
    .variavel { color: var(--color-warning); }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }
    .gasto-real { background-color: rgba(0, 150, 136, 0.2); }
    .gasto-real-cartao { background-color: rgba(255, 152, 0, 0.2); }
    
    /* Células editáveis */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: var(--color-bg-medium);
      color: var(--color-text);
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    
    .edit-input:focus {
      outline: 2px solid var(--color-accent);
    }
    
    /* Congelar colunas */
    /* Tabela Resumo */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: var(--color-bg-medium);
    }
    
    #tabelaResumo thead tr th:first-child {
      background-color: var(--color-bg-light);
      z-index: 20;
    }
    
    #tabelaResumo tbody tr td:first-child {
      font-weight: 600;
    }
    
    /* Tabela Lançamentos */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: var(--color-bg-medium);
    }
    
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: var(--color-bg-light);
      z-index: 20;
    }
    
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px;
      text-align: left;
    }
    
    /* Tabela Gastos Reais */
    #tabelaGastosReais thead tr th:nth-child(2),
    #tabelaGastosReais tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: var(--color-bg-medium);
    }
    
    #tabelaGastosReais thead tr th:nth-child(2) {
      background-color: var(--color-bg-light);
      z-index: 20;
    }
    
    #tabelaGastosReais tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px;
      text-align: left;
    }
    
    /* Linha de espaçamento na tabela de resumo */
    .spacer-row td {
      height: 10px;
      padding: 0;
      border: none;
      background-color: var(--color-bg-dark);
    }
    
    /* Cards e Gráficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      justify-content: center;
      margin-top: var(--spacing-xl);
    }
    
    .grafico-card {
      background-color: var(--color-bg-medium);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      width: calc(50% - var(--spacing-lg));
      min-width: 400px;
      box-sizing: border-box;
      box-shadow: var(--shadow-md);
      transition: transform var(--transition-fast);
    }
    
    .grafico-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .grafico-titulo {
      text-align: center;
      margin-bottom: var(--spacing-md);
      color: var(--color-text-accent);
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    
    .grafico-comparacao {
      height: 400px;
    }
    
    .seletor-mes {
      text-align: center;
      margin-bottom: var(--spacing-lg);
    }
    
    .seletor-mes select {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      border: none;
      background-color: var(--color-bg-light);
      color: var(--color-text);
      font-weight: 600;
      cursor: pointer;
    }
    
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      width: 100%;
    }
    
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      width: 100%;
    }
    
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      flex-shrink: 0;
    }
    
    .valor-legenda {
      margin-left: var(--spacing-xs);
      font-weight: 600;
    }
    
    .descricao-legenda {
      min-width: 120px;
    }
    
    /* Cards de Faturas */
    .resumo-faturas {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }
    
    .card-fatura {
      background-color: var(--color-bg-medium);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-md);
      width: calc(33.33% - var(--spacing-lg));
      min-width: 300px;
      box-sizing: border-box;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-sm);
    }
    
    .card-fatura:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .card-fatura-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--color-bg-light);
      padding-bottom: var(--spacing-sm);
    }
    
    .card-fatura-titulo {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .card-fatura-valor {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--color-text-accent);
    }
    
    .card-fatura-detalhes {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .card-fatura-itens {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .card-fatura-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    
    .card-fatura-item-descricao {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }
    
    .card-fatura-item-valor {
      font-weight: 600;
    }
    
    .indicador-fatura {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: var(--spacing-xs);
    }
    
    .fatura-atual {
      background-color: var(--color-info);
      color: var(--color-text);
    }
    
    .fatura-fechada {
      background-color: #9e9e9e;
      color: var(--color-text);
    }
    
    .fatura-futura {
      background-color: var(--color-success);
      color: var(--color-text);
    }
    
    /* Comparação de valores */
    .comparacao-valor {
      display: flex;
      flex-direction: column;
    }
    
    .valor-real {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .valor-planejado {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    
    .variacao-positiva {
      color: var(--color-success);
    }
    
    .variacao-negativa {
      color: var(--color-danger);
    }
    
    .info-fatura {
      margin-top: var(--spacing-xs);
      font-size: 0.8rem;
      color: var(--color-text-accent);
    }
    
    /* Filtros */
    .filtros-container,
    .filtros-gastos-reais {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
      background-color: var(--color-bg-medium);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
    }
    
    .filtro-grupo {
      display: flex;
      flex-direction: column;
      min-width: 150px;
      flex: 1;
    }
    
    .filtro-grupo label {
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .filtro-grupo select {
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-md);
      border: none;
      background-color: var(--color-bg-light);
      color: var(--color-text);
    }
    
    /* Categoria e Subcategoria */
    .categoria-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }
    
    .categoria-select {
      flex: 1;
    }
    
    /* Cartão container */
    .cartao-container {
      display: none;
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    
    .cartao-container.show {
      display: block;
      opacity: 1;
    }
    
    .cartao-container.obrigatorio {
      border: 2px solid var(--color-accent);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-md);
      background-color: rgba(255, 215, 0, 0.1);
    }
    
    /* Modal */
    .modal,
    .modal-gerenciamento,
    .modal-detalhamento {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      padding-top: 60px;
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    
    .modal.show {
      opacity: 1;
    }
    
    .modal-content,
    .modal-gerenciamento-content,
    .modal-detalhamento-content {
      background-color: var(--color-bg-medium);
      margin: 5% auto;
      padding: var(--spacing-xl);
      border: 1px solid var(--color-bg-light);
      width: 60%;
      max-width: 600px;
      border-radius: var(--border-radius-lg);
      position: relative;
      box-shadow: var(--shadow-lg);
      transform: translateY(-20px);
      opacity: 0;
      transition: all var(--transition-normal);
    }
    
    .modal.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }
    
    .modal-title,
    h2 {
      margin-bottom: var(--spacing-lg);
      color: var(--color-text-accent);
      font-size: 1.2rem;
      border-bottom: 1px solid var(--color-bg-light);
      padding-bottom: var(--spacing-sm);
    }
    
    .close-button,
    .modal-close {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      color: var(--color-text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color var(--transition-fast);
    }
    
    .close-button:hover,
    .modal-close:hover {
      color: var(--color-danger);
    }
    
    /* Modal de gerenciamento */
    .lista-gerenciamento {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: var(--spacing-lg);
    }
    
    .item-gerenciamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
      background-color: var(--color-bg-light);
      border-radius: var(--border-radius-md);
      transition: background-color var(--transition-fast);
    }
    
    .item-gerenciamento:hover {
      background-color: var(--color-primary-dark);
    }
    
    .item-gerenciamento-info {
      display: flex;
      flex-direction: column;
    }
    
    .item-gerenciamento-nome {
      font-weight: 600;
    }
    
    .item-gerenciamento-detalhe {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    
    .botoes-item-gerenciamento button {
      background-color: var(--color-warning);
      color: var(--color-text);
      border: none;
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: var(--spacing-xs);
      transition: all var(--transition-fast);
    }
    
    .botoes-item-gerenciamento button.excluir {
      background-color: var(--color-danger);
      color: var(--color-text);
    }
    
    .botoes-item-gerenciamento button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .novo-item-container {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .novo-item-input {
      flex: 1;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-md);
      border: none;
      background-color: var(--color-bg-light);
      color: var(--color-text);
      min-width: 150px;
    }
    
    .novo-item-input.dia {
      flex: 0 0 80px;
    }
    
    /* Modal de detalhamento */
    .modal-detalhamento-content {
      width: 70%;
      max-width: 900px;
    }
    
    .lista-detalhamento {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: var(--spacing-lg);
    }
    
    .item-detalhamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
      background-color: var(--color-bg-light);
      border-radius: var(--border-radius-md);
      transition: background-color var(--transition-fast);
    }
    
    .item-detalhamento:hover {
      background-color: var(--color-primary-dark);
    }
    
    .item-detalhamento-info {
      flex: 1;
      text-align: left;
    }
    
    .item-detalhamento-valores {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: var(--spacing-xs);
    }
    
    .item-detalhamento-valor {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .item-detalhamento-media {
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .item-detalhamento-percentual {
      color: var(--color-text-accent);
      font-size: 0.85rem;
    }
    
    /* Cores para subcategorias */
    .subcategoria-cor-1 { color: #e91e63; }
    .subcategoria-cor-2 { color: #9c27b0; }
    .subcategoria-cor-3 { color: #673ab7; }
    .subcategoria-cor-4 { color: #3f51b5; }
    .subcategoria-cor-5 { color: #2196f3; }
    .subcategoria-cor-6 { color: #00bcd4; }
    .subcategoria-cor-7 { color: #009688; }
    .subcategoria-cor-8 { color: #8bc34a; }
    .subcategoria-cor-9 { color: #cddc39; }
    .subcategoria-cor-10 { color: #ffeb3b; }
    .subcategoria-cor-11 { color: #ff5722; }
    .subcategoria-cor-12 { color: #795548; }
    
    /* Linha clicável na tabela */
    #tabelaLancamentos tbody tr,
    #tabelaResumo tbody tr {
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }
    
    #tabelaLancamentos tbody tr:hover,
    #tabelaResumo tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Estilo para dia de fechamento editável */
    .dia-fechamento-editavel {
      cursor: pointer;
      text-decoration: underline;
      color: var(--color-text-accent);
      font-weight: 600;
      transition: color var(--transition-fast);
    }
    
    .dia-fechamento-editavel:hover {
      color: var(--color-accent-light);
    }
    
    /* Elementos escondidos */
    .hidden-id {
      display: none;
    }
    
    /* Mensagens e Insights */
    #insightsContainer,
    .mensagem-card {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      background-color: var(--color-bg-medium);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition-fast);
    }
    
    #insightsContainer:hover,
    .mensagem-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    #insightsContent,
    #mensagensDia,
    #mensagensSemana,
    #mensagensMes {
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    .seletor-data-mensagens {
      text-align: center;
      margin-bottom: var(--spacing-lg);
    }
    
    .seletor-data-mensagens input[type="date"] {
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-md);
      border: none;
      background-color: var(--color-bg-light);
      color: var(--color-text);
      margin-right: var(--spacing-sm);
    }
    
    /* ===== MELHORIAS DE ACESSIBILIDADE ===== */
    
    /* Foco visível para navegação por teclado */
    *:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    
    /* Indicadores de estado para leitores de tela */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Animações reduzidas para usuários que preferem menos movimento */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* ===== RESPONSIVIDADE ===== */
    
    /* Tablets em modo paisagem */
    @media (max-width: 1200px) {
      .graficos-container {
        gap: var(--spacing-md);
      }
      
      .grafico-card {
        min-width: 350px;
      }
      
      .card-fatura {
        width: calc(50% - var(--spacing-lg));
      }
    }
    
    /* Tablets em modo retrato */
    @media (max-width: 1024px) {
      .form-section-modal {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
      
      .card-fatura {
        width: calc(50% - var(--spacing-md));
        min-width: 280px;
      }
      
      .table-container {
        font-size: 0.85rem;
      }
      
      th, td {
        padding: var(--spacing-xs) var(--spacing-sm);
      }
      
      .grafico-card {
        width: 100%;
      }
    }
    
    /* Smartphones grandes */
    @media (max-width: 768px) {
      .card-fatura {
        width: 100%;
        min-width: auto;
      }
      
      .modal-content,
      .modal-gerenciamento-content,
      .modal-detalhamento-content {
        width: 95%;
        margin: 2% auto;
        padding: var(--spacing-lg);
      }
      
      .botao-fixo {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
        padding: 0;
        border-radius: 50%;
      }
      
      .botao-fixo span {
        display: none;
      }
      
      .filtros-container,
      .filtros-gastos-reais {
        flex-direction: column;
        gap: var(--spacing-md);
      }
      
      .filtro-grupo {
        width: 100%;
        min-width: auto;
      }
      
      .novo-item-container {
        flex-direction: column;
      }
      
      .novo-item-input {
        width: 100%;
        min-width: auto;
      }
      
      .botoes-formulario {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .botao-lancar,
      .botao-filtrar,
      .botao-voltar,
      .botao-gerenciar,
      .botao-adicionar-item {
        width: 100%;
        justify-content: center;
      }
      
      /* Ajustes para tabelas em mobile */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        min-width: 600px;
      }
      
      /* Melhor visualização de cards em mobile */
      .grafico-card {
        width: 100%;
        min-width: auto;
        padding: var(--spacing-md);
      }
      
      .grafico {
        height: 250px;
      }
    }
    
    /* Smartphones pequenos */
    @media (max-width: 576px) {
      :root {
        --spacing-xs: 2px;
        --spacing-sm: 6px;
        --spacing-md: 12px;
        --spacing-lg: 18px;
        --spacing-xl: 24px;
      }
      
      body {
        font-size: 0.9rem;
      }
      
      .secao-lancamentos,
      .secao-resumo,
      .secao-mensagens,
      .secao-gastos-reais {
        padding: var(--spacing-xs);
      }
      
      .table-container {
        margin-left: -var(--spacing-xs);
        margin-right: -var(--spacing-xs);
        width: calc(100% + var(--spacing-xs) * 2);
        border-radius: 0;
      }
      
      .form-section {
        padding: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }
      
      .botao-lancar,
      .botao-filtrar,
      .botao-voltar,
      .botao-gerenciar,
      .botao-adicionar-item {
        padding: var(--spacing-sm);
        font-size: 0.85rem;
        min-height: 36px;
      }
      
      .botao-fixo {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      
      .modal-content,
      .modal-gerenciamento-content,
      .modal-detalhamento-content {
        width: 98%;
        margin: 1% auto;
        padding: var(--spacing-md);
      }
      
      /* Ajustes específicos para formulários em mobile */
      .form-group input,
      .form-group select {
        padding: var(--spacing-sm);
        font-size: 16px; /* Evita zoom no iOS */
      }
      
      /* Cards de fatura mais compactos */
      .card-fatura {
        padding: var(--spacing-sm);
      }
      
      .card-fatura-titulo {
        font-size: 0.9rem;
      }
      
      .card-fatura-valor {
        font-size: 1rem;
      }
      
      /* Gráficos mais compactos */
      .grafico {
        height: 200px;
      }
      
      .legenda-grafico {
        font-size: 0.8rem;
      }
    }
    
    /* Smartphones muito pequenos */
    @media (max-width: 375px) {
      h1 {
        font-size: 1.4rem;
      }
      
      .botao-lancar,
      .botao-filtrar,
      .botao-voltar,
      .botao-gerenciar,
      .botao-adicionar-item {
        font-size: 0.8rem;
        padding: var(--spacing-xs) var(--spacing-sm);
      }
      
      .card-fatura-item {
        font-size: 0.8rem;
      }
      
      .table-container {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: var(--spacing-xs);
      }
    }
    
    /* ===== PRINT STYLES ===== */
    @media print {
      .botao-fixo,
      .modal,
      .botao-lancar,
      .botao-filtrar,
      .botao-voltar,
      .botao-gerenciar,
      .botao-adicionar-item,
      .delete-btn {
        display: none !important;
      }
      
      .table-container {
        box-shadow: none;
        border: 1px solid #000;
      }
      
      body {
        background: white;
        color: black;
      }
      
      .card-fatura {
        break-inside: avoid;
        border: 1px solid #000;
        margin-bottom: var(--spacing-md);
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Controle Financeiro</h1>
  
  <!-- Container Principal (Lançamentos e Resumo) -->
  <div class="container-principal mostrar-lancamentos" id="containerPrincipal">
    <!-- Seção da Tabela de Lançamentos -->
    <div class="secao-lancamentos">
      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModal" class="botao-abrir-modal" onclick="abrirModal()">+</button>
              </th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lançamentos serão inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seção do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th> <!-- Nova coluna Média -->
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo será inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Seção dos Gráficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o mês: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="-2">Médias Mensais</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas e Poupança</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Relação às Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>
        <!-- New Graph 3: Credit Cards -->
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas por Cartão de Crédito</div>
          <div class="grafico">
            <canvas id="graficoCartoesCredito"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaCartoesCredito"></div>
        </div>
        <!-- New Graph 4: Subcategories -->
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas por Subcategoria</div>
          <div class="grafico">
            <canvas id="graficoSubcategorias"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaSubcategorias"></div>
        </div>
      </div>
      <!-- Nova Seção de Insights -->
      <div id="insightsContainer">
        <div class="resumo-titulo">Insights Financeiros</div>
        <div id="insightsContent">
          <p>Insights serão gerados aqui...</p>
        </div>
      </div>
    </div> <!-- Fim secao-resumo -->

    <!-- Nova Seção de Mensagens -->
    <div class="secao-mensagens">
      <button class="botao-voltar" onclick="mostrarResumo()">← Voltar para Resumo</button>
      <div class="resumo-titulo">Mensagens e Alertas</div>

      <div class="seletor-data-mensagens">
        <label for="dataSimulacao">Simular para data:</label>
        <input type="date" id="dataSimulacao">
        <button class="botao-lancar" onclick="gerarMensagens()">Gerar Mensagens</button>
        <button class="botao-lancar" style="background-color: var(--color-info); margin-left: 5px;" onclick="gerarMensagensHoje()">Usar Hoje</button>
      </div>

      <div id="mensagensContainer">
        <div class="mensagem-card">
          <h3 style="color: var(--color-text-accent); margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos do Dia</h3>
          <div id="mensagensDia"><p>Selecione uma data e clique em 'Gerar Mensagens'.</p></div>
        </div>
        <div class="mensagem-card">
          <h3 style="color: var(--color-text-accent); margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos da Semana</h3>
          <div id="mensagensSemana"></div>
        </div>
        <div class="mensagem-card">
          <h3 style="color: var(--color-text-accent); margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos do Mês</h3>
          <div id="mensagensMes"></div>
        </div>
      </div>
    </div>
    <!-- Fim da Nova Seção de Mensagens -->

    <!-- Nova Seção de Gastos Reais -->
    <div class="secao-gastos-reais">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Registro de Gastos Reais</div>
      
      <!-- Filtros para Gastos Reais -->
      <div class="filtros-gastos-reais">
        <div class="filtro-grupo">
          <label for="filtroMes">Mês:</label>
          <select id="filtroMes">
            <option value="todos">Todos</option>
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroFormaPagamento">Forma de Pagamento:</label>
          <select id="filtroFormaPagamento">
            <option value="todos">Todos</option>
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroCartao">Cartão:</label>
          <select id="filtroCartao">
            <option value="todos">Todos</option>
            <!-- Opções de cartões serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroSubcategoria">Subcategoria:</label>
          <select id="filtroSubcategoria">
            <option value="todos">Todos</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroFatura">Fatura:</label>
          <select id="filtroFatura" onchange="aplicarFiltroFatura()">
            <option value="todas">Todas as Faturas</option>
            <!-- Opções de faturas serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <button class="botao-filtrar" onclick="filtrarGastosReais()">Filtrar</button>
      </div>
      
      <!-- Tabela de Gastos Reais -->
      <div class="table-container">
        <table id="tabelaGastosReais">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModalGastoReal" class="botao-abrir-modal" onclick="abrirModalGastoReal()">+</button>
              </th>
              <th>Data</th>
              <th>Valor</th>
              <th>Forma de Pagamento</th>
              <th>Cartão</th>
              <th>Fatura</th>
              <th>Subcategoria</th>
              <th>Observação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="gastosReaisBody">
            <!-- Gastos reais serão inseridos aqui -->
          </tbody>
        </table>
      </div>
      
      <!-- Resumo de Faturas -->
      <div class="resumo-titulo" style="margin-top: 30px;">Resumo de Faturas</div>
      <div class="resumo-faturas" id="resumoFaturas">
        <!-- Cards de faturas serão inseridos aqui -->
      </div>
      
      <!-- Gráfico de Comparação Planejado vs Real -->
      <div class="resumo-titulo" style="margin-top: 30px;">Comparação: Planejado vs Real</div>
      <div class="seletor-mes">
        <label for="mesComparacao">Selecione o mês: </label>
        <select id="mesComparacao" onchange="atualizarGraficoComparacao()">
          <option value="-1">Total Anual</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>
      <div class="grafico-card" style="width: 100%; min-width: 100%;">
        <div class="grafico-titulo">Planejado vs Real</div>
        <div class="grafico grafico-comparacao">
          <canvas id="graficoComparacao"></canvas>
        </div>
      </div>
    </div>
    <!-- Fim da Seção de Gastos Reais -->
  </div>
  
  <!-- Botões fixos -->
  <button class="botao-fixo botao-resumo-fixo" onclick="mostrarResumo()">
    <span>Ver Resumo e Análises</span>
  </button>
  
  <button class="botao-fixo botao-mensagens-fixo" onclick="mostrarMensagens()">
    <span>Ver Mensagens</span>
  </button>
  
  <button class="botao-fixo botao-gastos-reais-fixo" onclick="mostrarGastosReais()">
    <span>Ver Gastos Reais</span>
  </button>

  <!-- Modal do Formulário de Adição de Gasto Real -->
  <div id="modalGastoReal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalGastoReal()">&times;</span>
      <h2>Registrar Gasto Real</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="gastoRealDescricao">Descrição:</label>
          <input type="text" id="gastoRealDescricao" placeholder="Ex: Supermercado, Restaurante" />

          <label for="gastoRealValor">Valor (R$):</label>
          <input type="text" id="gastoRealValor" placeholder="Ex: 150,00" />
          
          <label for="gastoRealData">Data:</label>
          <input type="date" id="gastoRealData" />
          
          <label for="gastoRealFormaPagamento">Forma de Pagamento:</label>
          <select id="gastoRealFormaPagamento" onchange="toggleGastoRealCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
          
          <div id="gastoRealCartaoContainer" class="cartao-container">
            <label for="gastoRealCartaoCredito">Cartão de Crédito:</label>
            <select id="gastoRealCartaoCredito" onchange="atualizarFaturaGastoReal()">
              <option value="">Selecione o cartão</option>
              <!-- Opções de cartões serão preenchidas dinamicamente -->
            </select>
            <div id="gastoRealInfoFatura" class="info-fatura"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="gastoRealSubcategoria">Subcategoria (opcional):</label>
          <select id="gastoRealSubcategoria">
            <option value="">Nenhuma</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealLancamento">Lançamento Relacionado (opcional):</label>
          <select id="gastoRealLancamento">
            <option value="">Nenhum</option>
            <!-- Opções de lançamentos serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealObservacao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="registrarGastoReal()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Edição de Gasto Real -->
  <div id="modalEdicaoGastoReal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicaoGastoReal()">&times;</span>
      <h2>Editar Gasto Real</h2>
      <input type="hidden" id="editGastoRealId" />
      <div class="form-section-modal">
        <div class="form-group">
          <label for="gastoRealDescricaoEdicao">Descrição:</label>
          <input type="text" id="gastoRealDescricaoEdicao" placeholder="Ex: Supermercado, Restaurante" />

          <label for="gastoRealValorEdicao">Valor (R$):</label>
          <input type="text" id="gastoRealValorEdicao" placeholder="Ex: 150,00" />
          
          <label for="gastoRealDataEdicao">Data:</label>
          <input type="date" id="gastoRealDataEdicao" />
          
          <label for="gastoRealFormaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="gastoRealFormaPagamentoEdicao" onchange="toggleGastoRealCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
          
          <div id="gastoRealCartaoContainerEdicao" class="cartao-container">
            <label for="gastoRealCartaoCreditoEdicao">Cartão de Crédito:</label>
            <select id="gastoRealCartaoCreditoEdicao" onchange="atualizarFaturaGastoRealEdicao()">
              <option value="">Selecione o cartão</option>
              <!-- Opções de cartões serão preenchidas dinamicamente -->
            </select>
            <div id="gastoRealInfoFaturaEdicao" class="info-fatura"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="gastoRealSubcategoriaEdicao">Subcategoria (opcional):</label>
          <select id="gastoRealSubcategoriaEdicao">
            <option value="">Nenhuma</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealLancamentoEdicao">Lançamento Relacionado (opcional):</label>
          <select id="gastoRealLancamentoEdicao">
            <option value="">Nenhum</option>
            <!-- Opções de lançamentos serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealObservacaoEdicao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacaoEdicao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="salvarEdicaoGastoReal()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Formulário de Adição -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2>Novo Lançamento</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento" onchange="toggleCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoria">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoria" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainer">
            <label for="cartaoCredito">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCredito" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lançar Item</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Formulário de Edição -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
      <h2>Editar Lançamento</h2>
      <input type="hidden" id="editLancamentoId">
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricaoEdicao">Descrição:</label>
          <input type="text" id="descricaoEdicao" placeholder="Ex: Salário, Luz" />

          <label for="valorEdicao">Valor (R$):</label>
          <input type="text" id="valorEdicao" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamentoEdicao">Tipo de Lançamento:</label>
          <select id="tipoLancamentoEdicao">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="formaPagamentoEdicao" onchange="toggleCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoriaEdicao">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoriaEdicao" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão Edição (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainerEdicao">
            <label for="cartaoCreditoEdicao">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCreditoEdicao" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValorEdicao">A cada:</label>
          <input type="number" id="frequenciaValorEdicao" min="1" value="1" />

          <label for="frequenciaTipoEdicao">Unidade de Frequência:</label>
          <select id="frequenciaTipoEdicao">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicialEdicao">Data Inicial:</label>
          <input type="date" id="dataInicialEdicao" />

          <label for="dataFinalEdicao">Data Final:</label>
          <input type="date" id="dataFinalEdicao" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="salvarEdicao()">Salvar Edição</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento Genérico (Subcategorias e Cartões) -->
  <div id="modalGerenciamento" class="modal-gerenciamento">
    <div class="modal-gerenciamento-content">
      <span class="close-button" onclick="fecharModalGerenciamento()">&times;</span>
      <h2 id="tituloModalGerenciamento">Gerenciar</h2>
      
      <div id="formNovoItem">
        <!-- Formulário para adicionar novo item (subcategoria ou cartão) -->
      </div>
      
      <div id="listaItens" class="lista-gerenciamento">
        <!-- Lista de itens existentes -->
      </div>
      
      <div style="text-align: center;">
        <button class="botao-lancar" onclick="fecharModalGerenciamento()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhamento -->
  <div id="modalDetalhamento" class="modal-detalhamento">
    <div class="modal-detalhamento-content">
      <span class="close-button" onclick="fecharModalDetalhamento()">&times;</span>
      <h2 id="tituloDetalhamento">Detalhamento</h2>
      
      <div id="listaDetalhamento" class="lista-detalhamento">
        <!-- Lista de detalhes será inserida aqui -->
      </div>
      
      <div style="text-align: center;">
        <button class="botao-lancar" onclick="fecharModalDetalhamento()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Funções de navegação lateral
    function mostrarResumo() {
      document.getElementById('containerPrincipal').className = 'container-principal mostrar-resumo';
    }
    
    function mostrarMensagens() {
      document.getElementById('containerPrincipal').className = 'container-principal mostrar-mensagens';
    }
    
    function mostrarGastosReais() {
      document.getElementById('containerPrincipal').className = 'container-principal mostrar-gastos-reais';
    }
    
    function voltarParaLancamentos() {
      document.getElementById('containerPrincipal').className = 'container-principal mostrar-lancamentos';
    }
  </script>


          <label for="gastoRealObservacao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="registrarGastoReal()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Edição de Gasto Real -->
  <div id="modalEdicaoGastoReal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicaoGastoReal()">&times;</span>
      <h2>Editar Gasto Real</h2>
      <input type="hidden" id="editGastoRealId" />
      <div class="form-section-modal">
        <div class="form-group">
          <label for="gastoRealDescricaoEdicao">Descrição:</label>
          <input type="text" id="gastoRealDescricaoEdicao" placeholder="Ex: Supermercado, Restaurante" />

          <label for="gastoRealValorEdicao">Valor (R$):</label>
          <input type="text" id="gastoRealValorEdicao" placeholder="Ex: 150,00" />
          
          <label for="gastoRealDataEdicao">Data:</label>
          <input type="date" id="gastoRealDataEdicao" />
          
          <label for="gastoRealFormaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="gastoRealFormaPagamentoEdicao" onchange="toggleGastoRealCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
          
          <div id="gastoRealCartaoContainerEdicao" class="cartao-container">
            <label for="gastoRealCartaoCreditoEdicao">Cartão de Crédito:</label>
            <select id="gastoRealCartaoCreditoEdicao" onchange="atualizarFaturaGastoRealEdicao()">
              <option value="">Selecione o cartão</option>
              <!-- Opções de cartões serão preenchidas dinamicamente -->
            </select>
            <div id="gastoRealInfoFaturaEdicao" class="info-fatura"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="gastoRealSubcategoriaEdicao">Subcategoria (opcional):</label>
          <select id="gastoRealSubcategoriaEdicao">
            <option value="">Nenhuma</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealLancamentoEdicao">Lançamento Relacionado (opcional):</label>
          <select id="gastoRealLancamentoEdicao">
            <option value="">Nenhum</option>
            <!-- Opções de lançamentos serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealObservacaoEdicao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacaoEdicao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="salvarEdicaoGastoReal()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

      <div class="resumo-titulo">Registro de Gastos Reais</div>
      
      <!-- Filtros para Gastos Reais -->
      <div class="filtros-gastos-reais">
        <div class="filtro-grupo">
          <label for="filtroMes">Mês:</label>
          <select id="filtroMes">
            <option value="todos">Todos</option>
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroFormaPagamento">Forma de Pagamento:</label>
          <select id="filtroFormaPagamento">
            <option value="todos">Todos</option>
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroCartao">Cartão:</label>
          <select id="filtroCartao">
            <option value="todos">Todos</option>
            <!-- Opções de cartões serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroSubcategoria">Subcategoria:</label>
          <select id="filtroSubcategoria">
            <option value="todos">Todos</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroFatura">Fatura:</label>
          <select id="filtroFatura" onchange="aplicarFiltroFatura()">
            <option value="todas">Todas as Faturas</option>
            <!-- Opções de faturas serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <button class="botao-filtrar" onclick="filtrarGastosReais()">Filtrar</button>
      </div>
      
      <!-- Tabela de Gastos Reais -->
      <div class="table-container">
        <table id="tabelaGastosReais">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModalGastoReal" class="botao-abrir-modal" onclick="abrirModalGastoReal()">+</button>
              </th>
              <th>Data</th>
              <th>Valor</th>
              <th>Forma de Pagamento</th>
              <th>Cartão</th>
              <th>Fatura</th>
              <th>Subcategoria</th>
              <th>Observação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="gastosReaisBody">
            <!-- Gastos reais serão inseridos aqui -->
          </tbody>
        </table>
      </div>
      
      <!-- Resumo de Faturas -->
      <div class="resumo-titulo" style="margin-top: 30px;">Resumo de Faturas</div>
      <div class="resumo-faturas" id="resumoFaturas">
        <!-- Cards de faturas serão inseridos aqui -->
      </div>
      
      <!-- Gráfico de Comparação Planejado vs Real -->
      <div class="resumo-titulo" style="margin-top: 30px;">Comparação: Planejado vs Real</div>
      <div class="seletor-mes">
        <label for="mesComparacao">Selecione o mês: </label>
        <select id="mesComparacao" onchange="atualizarGraficoComparacao()">
          <option value="-1">Total Anual</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>
      <div class="grafico-card" style="width: 100%; min-width: 100%;">
        <div class="grafico-titulo">Planejado vs Real</div>
        <div class="grafico grafico-comparacao">
          <canvas id="graficoComparacao"></canvas>
        </div>
      </div>
    </div>
    <!-- Fim da Seção de Gastos Reais -->

    <button class="botao-resumo-fixo" onclick="mostrarResumo()">Ver Resumo e Análises</button>
    <button class="botao-mensagens-fixo" style="position: fixed; top: 60px; right: 20px; z-index: 50; background-color: #673ab7; color: white; font-weight: bold; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.3s ease, visibility 0.3s ease; opacity: 1; visibility: visible;" onclick="mostrarMensagens()">Ver Mensagens</button>  <!-- Modal do Formulário de Adição -->
    <button class="botao-gastos-reais-fixo" style="position: fixed; top: 100px; right: 20px; z-index: 50; background-color: #4caf50; color: white; font-weight: bold; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.3s ease, visibility 0.3s ease; opacity: 1; visibility: visible;" onclick="mostrarGastosReais()">Ver Gastos Reais</button>
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2>Novo Lançamento</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento" onchange="toggleCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoria">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoria" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainer">
            <label for="cartaoCredito">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCredito" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lançar Item</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Formulário de Edição -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
      <h2>Editar Lançamento</h2>
      <input type="hidden" id="editLancamentoId">
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricaoEdicao">Descrição:</label>
          <input type="text" id="descricaoEdicao" placeholder="Ex: Salário, Luz" />

          <label for="valorEdicao">Valor (R$):</label>
          <input type="text" id="valorEdicao" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamentoEdicao">Tipo de Lançamento:</label>
          <select id="tipoLancamentoEdicao">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="formaPagamentoEdicao" onchange="toggleCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoriaEdicao">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoriaEdicao" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão Edição (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainerEdicao">
            <label for="cartaoCreditoEdicao">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCreditoEdicao" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValorEdicao">A cada:</label>
          <input type="number" id="frequenciaValorEdicao" min="1" value="1" />

          <label for="frequenciaTipoEdicao">Unidade de Frequência:</label>
          <select id="frequenciaTipoEdicao">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicialEdicao">Data Inicial:</label>
          <input type="date" id="dataInicialEdicao" />

          <label for="dataFinalEdicao">Data Final:</label>
          <input type="date" id="dataFinalEdicao" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="salvarEdicao()">Salvar Edição</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento Genérico (Subcategorias e Cartões) -->
  <div id="modalGerenciamento" class="modal-gerenciamento">
    <div class="modal-gerenciamento-content">
      <span class="close-button" onclick="fecharModalGerenciamento()">&times;</span>
      <h2 id="tituloModalGerenciamento">Gerenciar</h2>
      
      <div id="formNovoItem">
        <!-- Formulário para adicionar novo item (subcategoria ou cartão) -->
      </div>
      
      <div class="lista-gerenciamento" id="listaGerenciamento">
        <!-- Lista de itens será inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalGerenciamento()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhamento -->
  <div id="modalDetalhamento" class="modal-detalhamento">
    <div class="modal-detalhamento-content">
      <span class="close-button" onclick="fecharModalDetalhamento()">&times;</span>
      <h2 id="tituloDetalhamento">Detalhamento da Categoria</h2>
      
      <div class="lista-detalhamento" id="listaDetalhamento">
        <!-- Lista de itens será inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalDetalhamento()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let graficoCartoesCreditoInstance = null; // Nova variável para o gráfico de cartões
    let graficoSubcategoriasInstance = null; // Nova variável para o gráfico de subcategorias
    let dadosResumo = null;
    let lancamentos = [];
    let subcategorias = [];
    let cartoes = []; // Variável para cartões
    let tipoGerenciamentoAtual = null; // Para saber qual modal de gerenciamento está aberto
    const modal = document.getElementById("modalFormulario");
    const modalEdicao = document.getElementById("modalEdicao");
    const modalGerenciamento = document.getElementById("modalGerenciamento");
    const modalDetalhamento = document.getElementById("modalDetalhamento");
    const containerPrincipal = document.getElementById("containerPrincipal");
    const botaoResumoFixo = document.querySelector(".botao-resumo-fixo");

    // Função para mostrar/esconder campo de cartão
    function toggleCartaoContainer() {
      const formaPagamento = document.getElementById("formaPagamento").value;
      const cartaoContainer = document.getElementById("cartaoContainer");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        // Limpa a seleção do cartão quando não é necessário
        document.getElementById("cartaoCredito").value = "";
      }
    }

    // Função para mostrar/esconder campo de cartão na edição
    function toggleCartaoContainerEdicao() {
      const formaPagamento = document.getElementById("formaPagamentoEdicao").value;
      const cartaoContainer = document.getElementById("cartaoContainerEdicao");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        // Limpa a seleção do cartão quando não é necessário
        document.getElementById("cartaoCreditoEdicao").value = "";
      }
    }

    // Funções de Gerenciamento (Subcategorias e Cartões)
    function carregarDadosGerenciamento() {
      subcategorias = JSON.parse(localStorage.getItem("subcategorias") || "[]");
      cartoes = JSON.parse(localStorage.getItem("cartoes") || "[]");
      atualizarSelects();
    }

    function atualizarSelects() {
      atualizarSelect("subcategoria", subcategorias, "Nenhuma");
      atualizarSelect("subcategoriaEdicao", subcategorias, "Nenhuma");
      atualizarSelect("cartaoCredito", cartoes, "Selecione o cartão");
      atualizarSelect("cartaoCreditoEdicao", cartoes, "Selecione o cartão");
    }

    function atualizarSelect(selectId, dados, placeholder) {
      const select = document.getElementById(selectId);
      const valorAtual = select.value;
      select.innerHTML = `<option value="">${placeholder}</option>`;
      
      dados.forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.nome;
        select.appendChild(option);
      });
      
      // Tenta manter o valor selecionado se ele ainda existir nos dados
      if (valorAtual && dados.find(d => d.id == valorAtual)) {
        select.value = valorAtual;
      }
    }

    function abrirModalGerenciamento(tipo) {
      tipoGerenciamentoAtual = tipo;
      const tituloModal = document.getElementById("tituloModalGerenciamento");
      const formNovoItem = document.getElementById("formNovoItem");
      const listaGerenciamento = document.getElementById("listaGerenciamento");

      listaGerenciamento.innerHTML = ""; // Limpa a lista

      if (tipo === "subcategorias") {
        tituloModal.textContent = "Gerenciar Subcategorias";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome da nova subcategoria" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        subcategorias.forEach(sub => adicionarItemNaLista(sub));
      } else if (tipo === "cartoes") {
        tituloModal.textContent = "Gerenciar Cartões de Crédito";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome do Cartão (Ex: Nubank)" />
            <input type="number" id="novoDiaVencimento" class="novo-item-input dia" placeholder="Venc." min="1" max="31" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        cartoes.forEach(cartao => adicionarItemNaLista(cartao));
      }

      modalGerenciamento.style.display = "block";
    }

    function fecharModalGerenciamento() {
      modalGerenciamento.style.display = "none";
      tipoGerenciamentoAtual = null;
    }

    function adicionarItemNaLista(item) {
      const lista = document.getElementById("listaGerenciamento");
      const divItem = document.createElement("div");
      divItem.className = "item-gerenciamento";
      divItem.dataset.id = item.id;

      let detalhes = "";
      if (tipoGerenciamentoAtual === "cartoes") {
        detalhes = `<div class="item-gerenciamento-detalhe">Vencimento: dia ${item.diaVencimento} / Fechamento: dia ${item.diaFechamento}</div>`;
      }

      divItem.innerHTML = `
        <div class="item-gerenciamento-info">
          <span class="item-gerenciamento-nome">${item.nome}</span>
          ${detalhes}
        </div>
        <div class="botoes-item-gerenciamento">
          <button onclick="editarItemGerenciamento(${item.id})">Editar</button>
          <button class="excluir" onclick="excluirItemGerenciamento(${item.id})">Excluir</button>
        </div>
      `;
      lista.appendChild(divItem);
    }

    function adicionarItemGerenciamento() {
      const nomeInput = document.getElementById("novoNomeItem");
      const nome = nomeInput.value.trim();
      if (!nome) {
        alert("Digite o nome.");
        return;
      }

      let novoItem;
      let listaDados;
      let storageKey;

      if (tipoGerenciamentoAtual === "subcategorias") {
        if (subcategorias.find(s => s.nome.toLowerCase() === nome.toLowerCase())) {
          alert("Já existe uma subcategoria com este nome.");
          return;
        }
        const novoId = subcategorias.length > 0 ? Math.max(...subcategorias.map(s => s.id)) + 1 : 1;
        novoItem = { id: novoId, nome: nome };
        subcategorias.push(novoItem);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      } else if (tipoGerenciamentoAtual === "cartoes") {
        const diaVencimentoInput = document.getElementById("novoDiaVencimento");
        const diaVencimento = parseInt(diaVencimentoInput.value);
        if (!diaVencimento || diaVencimento < 1 || diaVencimento > 31) {
          alert("Digite um dia de vencimento válido (1-31).");
          return;
        }
        if (cartoes.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
          alert("Já existe um cartão com este nome.");
          return;
        }
        const novoId = cartoes.length > 0 ? Math.max(...cartoes.map(c => c.id)) + 1 : 1;
        const diaFechamento = calcularDiaFechamento(diaVencimento);
        novoItem = { id: novoId, nome: nome, diaVencimento: diaVencimento, diaFechamentoManual: null, diaFechamento: diaFechamento }; // MOD: Added diaFechamentoManual: null
        cartoes.push(novoItem);
        listaDados = cartoes;
        storageKey = "cartoes";
        diaVencimentoInput.value = ""; // Limpa campo dia
      }

      if (novoItem) {
        localStorage.setItem(storageKey, JSON.stringify(listaDados));
        adicionarItemNaLista(novoItem);
        atualizarSelects();
        nomeInput.value = ""; // Limpa campo nome
      }
    }

    function editarItemGerenciamento(id) {
      let item, listaDados, storageKey;
      if (tipoGerenciamentoAtual === "subcategorias") {
        item = subcategorias.find(s => s.id === id);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      } else if (tipoGerenciamentoAtual === "cartoes") {
        item = cartoes.find(c => c.id === id);
        listaDados = cartoes;
        storageKey = "cartoes";
      }
      if (!item) return;

      const novoNome = prompt(`Editar ${tipoGerenciamentoAtual === 'subcategorias' ? 'subcategoria' : 'cartão'}:`, item.nome);
      if (novoNome === null) return;
      const nomeFormatado = novoNome.trim();
      if (!nomeFormatado) {
        alert("Nome não pode estar vazio.");
        return;
      }
      if (listaDados.find(i => i.id !== id && i.nome.toLowerCase() === nomeFormatado.toLowerCase())) {
        alert(`Já existe ${tipoGerenciamentoAtual === 'subcategorias' ? 'uma subcategoria' : 'um cartão'} com este nome.`);
        return;
      }
      item.nome = nomeFormatado;

      if (tipoGerenciamentoAtual === "cartoes") {
        const novoDiaVencimentoStr = prompt("Novo dia de vencimento (1-31):", item.diaVencimento);
        if (novoDiaVencimentoStr === null) return; // Cancelou no segundo prompt
        const novoDiaVencimento = parseInt(novoDiaVencimentoStr);
        if (!novoDiaVencimento || novoDiaVencimento < 1 || novoDiaVencimento > 31) {
          alert("Dia de vencimento inválido.");
          return;
        }
        item.diaVencimento = novoDiaVencimento;
        item.diaFechamentoManual = null; // MOD: Reset manual day when due date changes
        item.diaFechamento = calcularDiaFechamento(novoDiaVencimento); // MOD: Calculate effective day
      }

      localStorage.setItem(storageKey, JSON.stringify(listaDados));
      // Atualiza a lista visualmente
      const itemElement = document.querySelector(`.item-gerenciamento[data-id="${id}"]`);
        const detalheElement = itemElement ? itemElement.querySelector(".item-gerenciamento-detalhe") : null;
      if (itemElement) {
        itemElement.querySelector(".item-gerenciamento-nome").textContent = item.nome;
        if (tipoGerenciamentoAtual === "cartoes") {
          itemElement.querySelector(".item-gerenciamento-detalhe").textContent = `Vencimento: dia ${item.diaVencimento} / Fechamento: dia ${item.diaFechamento}`;
        }
      }
      atualizarSelects();
    }

    function excluirItemGerenciamento(id) {
      let item, listaDados, storageKey;
      if (tipoGerenciamentoAtual === "subcategorias") {
        item = subcategorias.find(s => s.id === id);
        listaDados = subcategorias;
        storageKey = "subcategorias";
      }
      else if (tipoGerenciamentoAtual === "cartoes") {
        item = cartoes.find(c => c.id === id);
        listaDados = cartoes;
        storageKey = "cartoes";
      }
      if (!item) return;
if (!confirm(`Tem certeza que deseja excluir "${item.nome}"?`)) return;

      // Remove o item da lista
      if (tipoGerenciamentoAtual === "subcategorias") {
        subcategorias = subcategorias.filter(s => s.id !== id);
      } else if (tipoGerenciamentoAtual === "cartoes") {
        cartoes = cartoes.filter(c => c.id !== id);
      }

      localStorage.setItem(storageKey, JSON.stringify(tipoGerenciamentoAtual === "subcategorias" ? subcategorias : cartoes));
      
      // Remove da lista visual
      const itemElement = document.querySelector(`.item-gerenciamento[data-id="${id}"]`);if (itemElement) {
        itemElement.remove();
      }
           atualizarSelects();
    }

// *** INÍCIO MODIFICAÇÃO: Função para editar dia de fechamento manualmente ***
    function editarDiaFechamentoManual(id) {
      const item = cartoes.find(c => c.id === id);
      if (!item) return;

      const diaAtual = item.diaFechamentoManual !== null ? item.diaFechamentoManual : ''; // Mostra vazio se for automático
      const novoDiaManualStr = prompt(`Editar dia de fechamento manual para "${item.nome}" (1-31). Deixe vazio ou digite 0 para cálculo automático (baseado no vencimento):`, diaAtual);

      if (novoDiaManualStr === null) return; // Cancelou

      const diaTrimmed = novoDiaManualStr.trim();

      if (diaTrimmed === '' || diaTrimmed === '0') {
        // Definir como automático
        item.diaFechamentoManual = null;
        alert(`Dia de fechamento para "${item.nome}" definido para cálculo automático.`);
      } else {
        const novoDiaManual = parseInt(diaTrimmed);
        if (isNaN(novoDiaManual) || novoDiaManual < 1 || novoDiaManual > 31) {
          alert("Dia de fechamento inválido. Use um número entre 1 e 31, ou 0/vazio para automático.");
          return;
        }
        item.diaFechamentoManual = novoDiaManual;
        alert(`Dia de fechamento manual para "${item.nome}" definido para ${novoDiaManual}.`);
      }

      // Atualiza o dia de fechamento efetivo que será usado nos cálculos
      item.diaFechamento = getDiaFechamentoEfetivo(item);

      // Salva no localStorage
      	localStorage.setItem("cartoes", JSON.stringify(cartoes));

		// Atualiza a lista visualmente
		const itemElementParaAtualizar = document.querySelector(`.item-gerenciamento[data-id="${id}"]`);
		const detalheElement = itemElementParaAtualizar ? itemElement.querySelector(".item-gerenciamento-detalhe") : null; // MOD: Define detalheElement
		if (detalheElement) {
		  // Reconstroi o HTML do detalhe com o span clicável atualizado
		  detalheElement.innerHTML = `Vencimento: dia ${item.diaVencimento} / Fechamento: dia <span class="dia-fechamento-editavel" onclick="editarDiaFechamentoManual(${item.id})">${getDiaFechamentoEfetivo(item)}</span>`;
		}
		carregarLancamentos(); // Recarrega os lançamentos para atualizar o resumo financeiro
	  } // Closes editarDiaFechamentoManual function
	  // *** FIM MODIFICAÇÃO ***


    // Função para calcular dia de fechamento (7 dias antes do vencimento)
    function calcularDiaFechamento(diaVencimento) {
      let diaFechamento = diaVencimento - 7;
      if (diaFechamento <= 0) {
        diaFechamento += 30; // Aproximação para mês anterior
      }

    // *** INÍCIO MODIFICAÇÃO: Função para obter dia de fechamento efetivo ***
    function getDiaFechamentoEfetivo(cartao) {
      // Se diaFechamentoManual for null ou 0, calcula automaticamente
      if (cartao.diaFechamentoManual === null || cartao.diaFechamentoManual === 0) {
        return calcularDiaFechamento(cartao.diaVencimento);
      }
      // Senão, retorna o dia manual
      return cartao.diaFechamentoManual;
    }
    // *** FIM MODIFICAÇÃO ***

      return diaFechamento;
    }

    // Funções do Modal de Adição
    function abrirModal() {
      const today = new Date();
      const currentYear = today.getFullYear();
      if (!document.getElementById("dataInicial").value) {
        document.getElementById("dataInicial").value = `${currentYear}-01-01`;
      }
      if (!document.getElementById("dataFinal").value) {
        document.getElementById("dataFinal").value = `${currentYear}-12-31`;
      }
      // Garante que o campo cartão esteja no estado correto ao abrir
      toggleCartaoContainer();
      modal.style.display = "block";
    }

    function fecharModal() {
      modal.style.display = "none";
    }

    // Funções do Modal de Edição
    function abrirModalEdicao(id) {
      const lancamento = lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      document.getElementById("editLancamentoId").value = id;
      document.getElementById("descricaoEdicao").value = lancamento.descricao;
      document.getElementById("valorEdicao").value = formatarMoedaParaInput(lancamento.valor);
      document.getElementById("tipoLancamentoEdicao").value = lancamento.tipo;
      document.getElementById("formaPagamentoEdicao").value = lancamento.formaPagamento;
      document.getElementById("subcategoriaEdicao").value = lancamento.subcategoria || "";
      document.getElementById("cartaoCreditoEdicao").value = lancamento.cartaoId || ""; // Carrega cartão
      document.getElementById("frequenciaValorEdicao").value = lancamento.frequenciaValor;
      document.getElementById("frequenciaTipoEdicao").value = lancamento.frequenciaTipo;
      document.getElementById("dataInicialEdicao").value = lancamento.dataInicial;
      document.getElementById("dataFinalEdicao").value = lancamento.dataFinal;

      // Trigger change para atualizar forma de pagamento e visibilidade do cartão
      toggleCartaoContainerEdicao();
      
      modalEdicao.style.display = "block";
    }

    function fecharModalEdicao() {
      modalEdicao.style.display = "none";
    }

    function salvarEdicao() {
      const id = parseInt(document.getElementById("editLancamentoId").value);
      const descricao = document.getElementById("descricaoEdicao").value.trim();
      const valorStr = document.getElementById("valorEdicao").value.trim();
      const formaPagamento = document.getElementById("formaPagamentoEdicao").value;
      const tipo = document.getElementById("tipoLancamentoEdicao").value;
      const subcategoria = document.getElementById("subcategoriaEdicao").value || null;
      const cartaoId = document.getElementById("cartaoCreditoEdicao").value || null; // Pega ID do cartão
      const frequenciaValor = parseInt(document.getElementById("frequenciaValorEdicao").value) || 1;
      const frequenciaTipo = document.getElementById("frequenciaTipoEdicao").value;
      const dataInicial = document.getElementById("dataInicialEdicao").value;
      const dataFinal = document.getElementById("dataFinalEdicao").value;

      if (!descricao || !valorStr) {
        alert("Preencha a descrição e o valor.");
        return;
      }

      if (tipo === "receita" && formaPagamento !== "conta") {
        alert("Receitas devem ser lançadas apenas como \"Conta\"");
        return;
      }
      
      // Validação do Cartão Obrigatório
      if (formaPagamento === "credito" && !cartaoId) {
          alert("Selecione um cartão de crédito para este lançamento.");
          return;
      }

      const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
      if (isNaN(valorNumerico)) {
        alert("Valor inválido.");
        return;
      }

      let lancamentosArray = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const lancamentoIndex = lancamentosArray.findIndex(l => l.id === id);
      
      if (lancamentoIndex !== -1) {
        lancamentosArray[lancamentoIndex] = {
          ...lancamentosArray[lancamentoIndex],
          descricao,
          valor: valorNumerico,
          formaPagamento,
          tipo,
          subcategoria,
          cartaoId: formaPagamento === "credito" ? cartaoId : null, // Salva ID do cartão
          frequenciaValor,
          frequenciaTipo,
          dataInicial,
          dataFinal
        };
        
        localStorage.setItem("lancamentos", JSON.stringify(lancamentosArray));
        fecharModalEdicao();
        carregarLancamentos();
      }
    }

    // Função para adicionar lançamento
    function adicionarLancamento() {
      const descricao = document.getElementById("descricao").value.trim();
      const valorStr = document.getElementById("valor").value.trim();
      const formaPagamento = document.getElementById("formaPagamento").value;
      const tipo = document.getElementById("tipoLancamento").value;
      const subcategoria = document.getElementById("subcategoria").value || null;
      const cartaoId = document.getElementById("cartaoCredito").value || null;
      const frequenciaValor = parseInt(document.getElementById("frequenciaValor").value) || 1;
      const frequenciaTipo = document.getElementById("frequenciaTipo").value;
      const dataInicial = document.getElementById("dataInicial").value;
      const dataFinal = document.getElementById("dataFinal").value;

      if (!descricao || !valorStr) {
        alert("Preencha a descrição e o valor.");
        return;
      }

      if (tipo === "receita" && formaPagamento !== "conta") {
        alert("Receitas devem ser lançadas apenas como \"Conta\"");
        return;
      }

      // Validação do Cartão Obrigatório
      if (formaPagamento === "credito" && !cartaoId) {
        alert("Selecione um cartão de crédito para este lançamento.");
        return;
      }

      const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
      if (isNaN(valorNumerico)) {
        alert("Valor inválido.");
        return;
      }

      const lancamentosArray = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const novoId = lancamentosArray.length > 0 ? Math.max(...lancamentosArray.map(l => l.id)) + 1 : 1;

      const novoLancamento = {
        id: novoId,
        descricao,
        valor: valorNumerico,
        formaPagamento,
        tipo,
        subcategoria,
        cartaoId: formaPagamento === "credito" ? cartaoId : null,
        frequenciaValor,
        frequenciaTipo,
        dataInicial,
        dataFinal,
        valoresManuais: null
      };

      lancamentosArray.push(novoLancamento);
      localStorage.setItem("lancamentos", JSON.stringify(lancamentosArray));

      // Limpar formulário
      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("subcategoria").value = "";
      document.getElementById("cartaoCredito").value = "";
      document.getElementById("frequenciaValor").value = "1";
      document.getElementById("frequenciaTipo").value = "meses";

      fecharModal();
      carregarLancamentos();
    }

    // Resto das funções continuam igual...
    // (Devido ao limite de caracteres, vou continuar na próxima parte)


    // Funções de Detalhamento Modal
    function abrirModalDetalhamento(categoria, cartaoId = null) {
      const currentYear = new Date().getFullYear();
      const titulo = document.getElementById("tituloDetalhamento");
      const lista = document.getElementById("listaDetalhamento");
      
      titulo.textContent = `Detalhamento: ${categoria}`;
      lista.innerHTML = "";

      let itensCategoria = [];
      let totalCategoria = 0;

      // Determinar quais lançamentos pertencem à categoria
      if (cartaoId) {
        // Detalhamento de um cartão específico
        itensCategoria = lancamentos.filter(l => l.cartaoId == cartaoId);
      } else {
        switch(categoria) {
          case "Receitas":
            itensCategoria = lancamentos.filter(l => l.tipo === "receita");
            break;
          case "Despesas Fixas":
            itensCategoria = lancamentos.filter(l => l.tipo === "fixa");
            break;
          case "Despesas Variáveis":
            itensCategoria = lancamentos.filter(l => l.tipo === "variavel");
            break;
          case "Cartão de Crédito (Total)":
            itensCategoria = lancamentos.filter(l => l.formaPagamento === "credito" && l.tipo !== "receita");
            break;
          case "Conta":
            itensCategoria = lancamentos.filter(l => l.formaPagamento === "conta" && l.tipo !== "receita");
            break;
          default:
            // Subcategoria
            const subcategoriaObj = subcategorias.find(s => s.nome === categoria);
            if (subcategoriaObj) {
              itensCategoria = lancamentos.filter(l => l.subcategoria == subcategoriaObj.id);
            }
        }
      }

      // Calcular valores e percentuais
      itensCategoria.forEach(lancamento => {
        const ocorrencias = calcularOcorrencias(lancamento, currentYear);
        let valorTotal = 0;
        
        for (let index = 0; index < 12; index++) {
          if (lancamento.valoresManuais && lancamento.valoresManuais[index] !== null) {
            valorTotal += lancamento.valoresManuais[index];
          } else {
            const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
            valorTotal += lancamento.valor * ocorrenciasNoMes.length;
          }
        }
        
        totalCategoria += valorTotal;
        const mediaAnual = valorTotal / 12;
        
        const item = document.createElement("div");
        item.className = "item-detalhamento";
        item.innerHTML = `
          <div class="item-detalhamento-info">${lancamento.descricao}</div>
          <div class="item-detalhamento-valores">
            <div class="item-detalhamento-valor">${formatarMoeda(valorTotal)}</div>
            <div class="item-detalhamento-media">Média: ${formatarMoeda(mediaAnual)}</div>
            <div class="item-detalhamento-percentual">0%</div>
          </div>
        `;
        lista.appendChild(item);
      });

      // Atualizar percentuais
      const itensDetalhamento = lista.querySelectorAll(".item-detalhamento");
      itensDetalhamento.forEach((item, index) => {
        const valorElement = item.querySelector(".item-detalhamento-valor");
        const percentualElement = item.querySelector(".item-detalhamento-percentual");
        const valor = parseFloat(valorElement.textContent.replace(/[^\d,-]/g, "").replace(",", "."));
        const percentual = totalCategoria > 0 ? ((valor / totalCategoria) * 100).toFixed(1) : 0;
        percentualElement.textContent = `${percentual}%`;
      });

      modalDetalhamento.style.display = "block";
    }

    function fecharModalDetalhamento() {
      modalDetalhamento.style.display = "none";
    }

    // Event handlers para cliques nos modais
    window.onclick = function (event) {
      if (event.target == modal) {
        fecharModal();
      }
      if (event.target == modalEdicao) {
        fecharModalEdicao();
      }
      if (event.target == modalGerenciamento) {
        fecharModalGerenciamento();
      }
      if (event.target == modalDetalhamento) {
        fecharModalDetalhamento();
      }
    };

    // Funções de Navegação e Exibição
    function mostrarResumo() {
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.add("container-resumo-ativo");
    }

    function mostrarMensagens() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.add("container-mensagens-ativo");
    }

    function voltarParaLancamentos() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-mensagens-ativo");
    }

    // Funções para a Seção de Mensagens
    function gerarMensagensHoje() {
      const hoje = new Date();
      const formatoISO = hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD
      document.getElementById('dataSimulacao').value = formatoISO;
      gerarMensagens();
    }

    function gerarMensagens() {
      const dataInput = document.getElementById('dataSimulacao');
      const dataSelecionadaStr = dataInput.value;
      if (!dataSelecionadaStr) {
        alert("Por favor, selecione uma data para simular as mensagens.");
        return;
      }

      const dataSelecionada = new Date(dataSelecionadaStr + "T00:00:00"); // Considera o início do dia no fuso local
      if (isNaN(dataSelecionada.getTime())) {
          alert("Data inválida.");
          return;
      }

      const diaContainer = document.getElementById('mensagensDia');
      const semanaContainer = document.getElementById('mensagensSemana');
      const mesContainer = document.getElementById('mensagensMes');

      diaContainer.innerHTML = "<p>Calculando...</p>";
      semanaContainer.innerHTML = "<p>Calculando...</p>";
      mesContainer.innerHTML = "<p>Calculando...</p>";

      // Lógica para buscar lançamentos e cartões (já carregados em 'lancamentos' e 'cartoes')
      const anoSelecionado = dataSelecionada.getFullYear();
      const mesSelecionado = dataSelecionada.getMonth(); // 0-11
      const diaSelecionado = dataSelecionada.getDate(); // 1-31

      // Calcular início/fim da semana e mês
      const diaDaSemana = dataSelecionada.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
      const inicioSemana = new Date(dataSelecionada);
      // Ajusta para segunda-feira: Se for domingo (0), subtrai 6 dias, senão subtrai (diaDaSemana - 1) dias.
      inicioSemana.setDate(diaSelecionado - (diaDaSemana === 0 ? 6 : diaDaSemana - 1)); 
      const fimSemana = new Date(inicioSemana);
      fimSemana.setDate(inicioSemana.getDate() + 6); // Adiciona 6 dias para chegar ao domingo

      const inicioMes = new Date(anoSelecionado, mesSelecionado, 1);
      const fimMes = new Date(anoSelecionado, mesSelecionado + 1, 0); // Último dia do mês

      let mensagensDia = [];
      let mensagensSemana = [];
      let mensagensMes = [];

      // 1. Verificar Lançamentos Recorrentes
      lancamentos.forEach(l => {
        const ocorrenciasAno = calcularOcorrencias(l, anoSelecionado);
        
        ocorrenciasAno.forEach(ocorrencia => {
            const dataOcorrencia = new Date(ocorrencia); // Cria nova instância para não modificar a original
            dataOcorrencia.setHours(0, 0, 0, 0); // Normaliza a hora
            const dataSelecionadaNorm = new Date(dataSelecionada); 
            dataSelecionadaNorm.setHours(0, 0, 0, 0); // Normaliza a hora
            const inicioSemanaNorm = new Date(inicioSemana);
            inicioSemanaNorm.setHours(0, 0, 0, 0);
            const fimSemanaNorm = new Date(fimSemana);
            fimSemanaNorm.setHours(0, 0, 0, 0);
            const inicioMesNorm = new Date(inicioMes);
            inicioMesNorm.setHours(0, 0, 0, 0);
            const fimMesNorm = new Date(fimMes);
            fimMesNorm.setHours(0, 0, 0, 0);

            const textoLancamento = `${l.descricao} (${formatarMoeda(l.valor)} - ${l.tipo})`;
            const estiloReceita = l.tipo === 'receita' ? ' style="color: #4caf50;"' : '';

            // Dia
            if (dataOcorrencia.getTime() === dataSelecionadaNorm.getTime()) {
                mensagensDia.push(`<li${estiloReceita}>${textoLancamento}</li>`);
            }
            // Semana
            if (dataOcorrencia >= inicioSemanaNorm && dataOcorrencia <= fimSemanaNorm) {
                mensagensSemana.push(`<li${estiloReceita}>${dataOcorrencia.toLocaleDateString('pt-BR')}: ${textoLancamento}</li>`);
            }
            // Mês
            if (dataOcorrencia >= inicioMesNorm && dataOcorrencia <= fimMesNorm) {
              				mensagensMes.push(`<li${estiloReceita}>${dataOcorrencia.toLocaleDateString('pt-BR')}: ${textoLancamento}</li>`);
			}
		}); // Closes ocorrenciasAno.forEach
	  }); // Closes lancamentos.forEach

	  // Calcula totais por cartão ANTES do loop para ter os valores disponíveis
	  const totaisCartoesAno = calcularTotaisPorCartao(lancamentos, anoSelecionado);
	  // 2. Verificar Fechamento/Vencimento de Cartões
	  cartoes.forEach(cartao => {
        const diaFechamento = cartao.diaFechamento;
        const diaVencimento = cartao.diaVencimento;

        const dataFechamentoMesAtual = new Date(anoSelecionado, mesSelecionado, diaFechamento);
        const dataVencimentoMesAtual = new Date(anoSelecionado, mesSelecionado, diaVencimento);
        // Ajuste para vencimento no mês seguinte se fechamento for no final do mês anterior
        const dataVencimentoAjustada = new Date(dataFechamentoMesAtual);
        dataVencimentoAjustada.setDate(dataVencimentoAjustada.getDate() + (diaVencimento > diaFechamento ? diaVencimento - diaFechamento : (new Date(anoSelecionado, mesSelecionado+1, 0).getDate() - diaFechamento + diaVencimento) ));

        const dataSelecionadaNorm = new Date(dataSelecionada);
        dataSelecionadaNorm.setHours(0, 0, 0, 0); // Normaliza a hora
        const inicioSemanaNorm = new Date(inicioSemana);
        inicioSemanaNorm.setHours(0, 0, 0, 0);
        const fimSemanaNorm = new Date(fimSemana);
        fimSemanaNorm.setHours(0, 0, 0, 0);
        const inicioMesNorm = new Date(inicioMes);
        inicioMesNorm.setHours(0, 0, 0, 0);
        const fimMesNorm = new Date(fimMes);
        fimMesNorm.setHours(0, 0, 0, 0);

        const textoFechamento = `Fechamento da fatura do cartão ${cartao.nome}`;
        let textoVencimento = `Vencimento da fatura do cartão ${cartao.nome}`;

        // Calcula o índice do mês da fatura que vence no mês selecionado
        // A fatura que vence no mesSelecionado (0-11) é a que fechou no mesSelecionado - 1
        const mesDaFaturaVencendo = (mesSelecionado === 0) ? 11 : mesSelecionado - 1;
        const valorEstimadoFatura = totaisCartoesAno[cartao.id]?.meses[mesDaFaturaVencendo] || 0;

        // Adiciona valor estimado ao texto de vencimento
        if (valorEstimadoFatura > 0) {
            textoVencimento += ` (Valor Estimado: ${formatarMoeda(valorEstimadoFatura)})`;
        }

        // Dia
        if (dataFechamentoMesAtual.getTime() === dataSelecionadaNorm.getTime()) {
            mensagensDia.push(`<li style="color: #f57c00;">${textoFechamento}</li>`);
        }
        if (dataVencimentoAjustada.getTime() === dataSelecionadaNorm.getTime()) {
            mensagensDia.push(`<li style="color: #c62828;">${textoVencimento}</li>`);
        }
        // Semana
        if (dataFechamentoMesAtual >= inicioSemanaNorm && dataFechamentoMesAtual <= fimSemanaNorm) {
            mensagensSemana.push(`<li style="color: #f57c00;">${dataFechamentoMesAtual.toLocaleDateString('pt-BR')}: ${textoFechamento}</li>`);
        }
         if (dataVencimentoAjustada >= inicioSemanaNorm && dataVencimentoAjustada <= fimSemanaNorm) {
            mensagensSemana.push(`<li style="color: #c62828;">${dataVencimentoAjustada.toLocaleDateString('pt-BR')}: ${textoVencimento}</li>`);
        }
        // Mês
        // Verifica data de fechamento no mês atual
        const dataFechamentoNoMes = new Date(anoSelecionado, mesSelecionado, diaFechamento);
        dataFechamentoNoMes.setHours(0, 0, 0, 0);
        if (dataFechamentoNoMes >= inicioMesNorm && dataFechamentoNoMes <= fimMesNorm) {
            mensagensMes.push(`<li style="color: #f57c00;">${dataFechamentoNoMes.toLocaleDateString('pt-BR')}: ${textoFechamento}</li>`);
        }

        // Verifica data de vencimento no mês atual
        const dataVencimentoNoMes = new Date(anoSelecionado, mesSelecionado, diaVencimento);
        dataVencimentoNoMes.setHours(0, 0, 0, 0);
        if (dataVencimentoNoMes >= inicioMesNorm && dataVencimentoNoMes <= fimMesNorm) {
            mensagensMes.push(`<li style="color: #c62828;">${dataVencimentoNoMes.toLocaleDateString("pt-BR")}: ${textoVencimento}</li>`);
        }
    }
);

	      // Ordenar mensagens da semana e mês por data (extraindo data do texto)
	  const sortByDate = (a, b) => {
        const dateA = new Date(a.match(/(\d{2}\/\d{2}\/\d{4})/)[0].split('/').reverse().join('-') + 'T00:00:00');
        const dateB = new Date(b.match(/(\d{2}\/\d{2}\/\d{4})/)[0].split('/').reverse().join('-') + 'T00:00:00');
        return dateA - dateB;
      };
      mensagensSemana.sort(sortByDate);
      mensagensMes.sort(sortByDate);
      // Atualizar HTML
      diaContainer.innerHTML = mensagensDia.length > 0 ? `<ul>${mensagensDia.join('')}</ul>` : '<p>Nenhum evento esperado para hoje.</p>';
      semanaContainer.innerHTML = mensagensSemana.length > 0 ? `<ul>${[...new Set(mensagensSemana)].join('')}</ul>` : '<p>Nenhum evento esperado para esta semana.</p>'; // Usa Set para remover duplicatas se necessário
      mesContainer.innerHTML = mensagensMes.length > 0 ? `<ul>${[...new Set(mensagensMes)].join('')}</ul>` : '<p>Nenhum evento esperado para este mês.</p>';
    }

    // Funções de Formatação e Cálculo
    function formatarMoeda(valor) {
      const numero = typeof valor === "number" ? valor : parseFloat(String(valor).replace(/[^\d,-]/g, "").replace(",", "."));
      if (isNaN(numero)) return "R$ 0,00";
      return numero.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function formatarMoedaParaInput(valor) {
      if (!valor) return "";
      return valor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function calcularOcorrencias(lancamento, ano) {
      const startDate = new Date(lancamento.dataInicial + "T00:00:00");
      const endDate = new Date(lancamento.dataFinal + "T00:00:00");
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        console.error("Datas inválidas para o lançamento:", lancamento);
        return [];
      }
      const ocorrencias = [];
      if (lancamento.frequenciaTipo === "unico") {
        if (startDate.getFullYear() === ano) {
          ocorrencias.push(new Date(startDate));
        }
        return ocorrencias;
      }
      const inicioAno = new Date(`${ano}-01-01T00:00:00`);
      const fimAno = new Date(`${ano}-12-31T00:00:00`);
      const dataInicioCalculo = startDate > inicioAno ? startDate : inicioAno;
      const dataFimCalculo = endDate < fimAno ? endDate : fimAno;
      if (dataInicioCalculo > dataFimCalculo) return ocorrencias;
      let currentDate = new Date(dataInicioCalculo);
      let safetyBreak = 0;
      while (currentDate <= dataFimCalculo && safetyBreak < 500) {
        if (currentDate >= startDate && currentDate <= endDate && currentDate.getFullYear() === ano) {
          ocorrencias.push(new Date(currentDate));
        }
        const currentDayOfMonth = currentDate.getDate();
        let dataAnterior = new Date(currentDate);
        switch (lancamento.frequenciaTipo) {
          case "dias": currentDate.setDate(currentDate.getDate() + lancamento.frequenciaValor); break;
          case "dias_uteis":
            let diasAdicionados = 0;
            while (diasAdicionados < lancamento.frequenciaValor) {
              currentDate.setDate(currentDate.getDate() + 1);
              if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) diasAdicionados++;
            }
            break;
          case "meses":
            currentDate.setMonth(currentDate.getMonth() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "anos":
            currentDate.setFullYear(currentDate.getFullYear() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "semanas": currentDate.setDate(currentDate.getDate() + 7 * lancamento.frequenciaValor); break;
          case "quinzenas": currentDate.setDate(currentDate.getDate() + 15 * lancamento.frequenciaValor); break;
          case "segunda": case "terca": case "quarta": case "quinta": case "sexta":
            const diaSemana = { segunda: 1, terca: 2, quarta: 3, quinta: 4, sexta: 5 };
            const diaAlvo = diaSemana[lancamento.frequenciaTipo];
            do { currentDate.setDate(currentDate.getDate() + 1); } while (currentDate.getDay() !== diaAlvo);
            if (lancamento.frequenciaValor > 1) currentDate.setDate(currentDate.getDate() + 7 * (lancamento.frequenciaValor - 1));
            break;
          default:
            console.warn("Tipo de frequência desconhecido:", lancamento.frequenciaTipo);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        if (currentDate.getTime() === dataAnterior.getTime()) {
          console.error("Loop infinito detectado em calcularOcorrencias", lancamento);
          break;
        }
        safetyBreak++;
        if (safetyBreak >= 500) console.error("Safety break atingido em calcularOcorrencias", lancamento);
      }
      return ocorrencias;
    }
    
    function calcularTotaisPorCategoria(lancamentosCategoria, ano) {
      const meses = Array(12).fill(0);
      
      lancamentosCategoria.forEach(l => {
        const ocorrencias = calcularOcorrencias(l, ano);
        for (let index = 0; index < 12; index++) {
          if (l.valoresManuais && l.valoresManuais[index] !== null) {
            meses[index] += l.valoresManuais[index];
          } else {
            const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
            if (ocorrenciasNoMes.length > 0) {
              meses[index] += l.valor * ocorrenciasNoMes.length; 
            }
          }
        }
      });
      
      const total = meses.reduce((sum, val) => sum + val, 0);
      return { meses, total };
    }

    function calcularTotaisPorSubcategoria(lancamentos, ano) {
      const subcategoriasResumo = {};
      
      lancamentos.forEach(l => {
        if (l.subcategoria && l.tipo !== "receita") {
          const subcategoriaNome = subcategorias.find(s => s.id == l.subcategoria)?.nome || "Subcategoria Removida";
          
          if (!subcategoriasResumo[subcategoriaNome]) {
            subcategoriasResumo[subcategoriaNome] = { meses: Array(12).fill(0), total: 0 };
          }
          
          const ocorrencias = calcularOcorrencias(l, ano);
          for (let index = 0; index < 12; index++) {
            if (l.valoresManuais && l.valoresManuais[index] !== null) {
              subcategoriasResumo[subcategoriaNome].meses[index] += l.valoresManuais[index];
            } else {
              const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
              if (ocorrenciasNoMes.length > 0) {
                subcategoriasResumo[subcategoriaNome].meses[index] += l.valor * ocorrenciasNoMes.length;
              }
            }
          }
          subcategoriasResumo[subcategoriaNome].total = subcategoriasResumo[subcategoriaNome].meses.reduce((sum, val) => sum + val, 0);
        }
      });
      
      return subcategoriasResumo;
    }

    // Função para calcular totais por cartão, considerando fechamento
    function calcularTotaisPorCartao(lancamentos, ano) {
      const cartoesResumo = {};

      cartoes.forEach(cartao => {
        cartoesResumo[cartao.id] = { nome: cartao.nome, meses: Array(12).fill(0), total: 0 };
      });

      lancamentos.forEach(l => {
        if (l.formaPagamento === "credito" && l.cartaoId && cartoesResumo[l.cartaoId]) {
          const cartao = cartoes.find(c => c.id == l.cartaoId);
          if (!cartao) return; // Cartão não encontrado

          const ocorrencias = calcularOcorrencias(l, ano);
          
          ocorrencias.forEach(dataOcorrencia => {
            const diaOcorrencia = dataOcorrencia.getDate();
            let mesFatura = dataOcorrencia.getMonth();

            // Se a compra foi feita APÓS o dia do fechamento, vai para a fatura do mês seguinte
            if (diaOcorrencia > cartao.diaFechamento) { // AJUSTE: Alterado de >= para >
              mesFatura = (mesFatura + 1) % 12;
            }

            if (l.valoresManuais && l.valoresManuais[dataOcorrencia.getMonth()] !== null) {
              cartoesResumo[l.cartaoId].meses[mesFatura] += l.valoresManuais[dataOcorrencia.getMonth()];
            } else {
              cartoesResumo[l.cartaoId].meses[mesFatura] += l.valor;
            }
          });
        }
      });

      // Calcular totais
      Object.values(cartoesResumo).forEach(cartao => {
        cartao.total = cartao.meses.reduce((sum, val) => sum + val, 0);
      });

      return cartoesResumo;
    }

    // Função para obter cor de subcategoria
    function obterCorSubcategoria(index) {
      const cores = [
        "subcategoria-cor-1", "subcategoria-cor-2", "subcategoria-cor-3", "subcategoria-cor-4",
        "subcategoria-cor-5", "subcategoria-cor-6", "subcategoria-cor-7", "subcategoria-cor-8",
        "subcategoria-cor-9", "subcategoria-cor-10", "subcategoria-cor-11", "subcategoria-cor-12"
      ];
      return cores[index % cores.length];
    }

    // Funções de Atualização da Interface
    function atualizarResumoFinanceiro(lancamentos, ano) {
      const resumoBody = document.getElementById("resumoBody");
      resumoBody.innerHTML = "";

      const receitas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "receita"), ano);
      const fixas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "fixa"), ano);
      const variaveis = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "variavel"), ano);
      const cartaoTotal = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "credito" && l.tipo !== "receita"), ano);
      const conta = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "conta" && l.tipo !== "receita"), ano);
      const subcategoriasResumo = calcularTotaisPorSubcategoria(lancamentos, ano);
            const cartoesResumo = calcularTotaisPorCartao(lancamentos, ano);

      // *** INÍCIO MODIFICAÇÃO: Calcular total agregado dos cartões ***
      const cartaoTotalAgregado = { meses: Array(12).fill(0), total: 0 };
      Object.values(cartoesResumo).forEach(dadosCartao => {
          if (dadosCartao && dadosCartao.meses) { // Check if dadosCartao and meses exist
            for (let i = 0; i < 12; i++) {
                cartaoTotalAgregado.meses[i] += dadosCartao.meses[i] || 0; // Add || 0 for safety
            }
            cartaoTotalAgregado.total += dadosCartao.total || 0; // Add || 0 for safety
          }
      });
      const mediaCartaoTotalAgregado = cartaoTotalAgregado.total / 12;
      // *** FIM MODIFICAÇÃO ***


      const totalReceitas = receitas.total;
      const totalFixas = fixas.total;
      const totalVariaveis = variaveis.total;
      const totalDespesas = totalFixas + totalVariaveis;
      const saldo = totalReceitas - totalDespesas;
      
      const mediaReceitas = totalReceitas / 12;
      const mediaFixas = totalFixas / 12;
      const mediaVariaveis = totalVariaveis / 12;
      const mediaTotalDespesas = totalDespesas / 12;
      const mediaSaldo = saldo / 12;
      // const mediaCartaoTotal = cartaoTotal.total / 12; // Removido - Média agora é agregada
      const mediaConta = conta.total / 12;
      
      const spacerRowHTML = `<tr class="spacer-row"><td colspan="15"></td></tr>`;

      let subcategoriasHTML = "";
      if (Object.keys(subcategoriasResumo).length > 0) {
        subcategoriasHTML = spacerRowHTML;
        Object.entries(subcategoriasResumo).forEach(([nome, dados], index) => {
          const corClass = obterCorSubcategoria(index);
          const media = dados.total / 12;
          subcategoriasHTML += `
            <tr class="${corClass}" onclick="abrirModalDetalhamento('${nome}')">
              <td>${nome}</td>
              ${dados.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
              <td>${formatarMoeda(dados.total)}</td>
              <td>${formatarMoeda(media)}</td>
            </tr>
          `;
        });
      }

      let cartoesHTML = "";
      if (Object.keys(cartoesResumo).length > 0) {
        cartoesHTML = spacerRowHTML;
        Object.entries(cartoesResumo).forEach(([id, dados]) => {
          const media = dados.total / 12;
          // Usando a classe 'cartao-laranja' para todos os cartões individuais
          cartoesHTML += `
            <tr class="cartao-laranja" onclick="abrirModalDetalhamento('${dados.nome}', ${id})">
              <td>${dados.nome}</td>
              ${dados.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
              <td>${formatarMoeda(dados.total)}</td>
              <td>${formatarMoeda(media)}</td>
            </tr>
          `;
        });
      }

      resumoBody.innerHTML = `
        <tr class="receita" onclick="abrirModalDetalhamento('Receitas')">
          <td>Receitas</td>
          ${receitas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalReceitas)}</td>
          <td>${formatarMoeda(mediaReceitas)}</td>
        </tr>
        ${spacerRowHTML} 
        <tr class="fixa" onclick="abrirModalDetalhamento('Despesas Fixas')">
          <td>Despesas Fixas</td>
          ${fixas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalFixas)}</td>
          <td>${formatarMoeda(mediaFixas)}</td>
        </tr>
        <tr class="variavel" onclick="abrirModalDetalhamento('Despesas Variáveis')">
          <td>Despesas Variáveis</td>
          ${variaveis.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalVariaveis)}</td>
          <td>${formatarMoeda(mediaVariaveis)}</td>
        </tr>
        <tr onclick="event.stopPropagation()">
          <td>Total Despesas</td>
          ${Array(12).fill(0).map((_, i) => {
            const mesTotal = (fixas.meses[i] || 0) + (variaveis.meses[i] || 0);
            return `<td>${formatarMoeda(mesTotal)}</td>`;
          }).join("")}
          <td>${formatarMoeda(totalDespesas)}</td>
          <td>${formatarMoeda(mediaTotalDespesas)}</td>
        </tr>
        ${spacerRowHTML}
        <tr onclick="event.stopPropagation()"> 
          <td class="saldo-positivo">Potencial de Investimento</td>
          ${Array(12).fill(0).map((_, i) => {
            const mesSaldo = (receitas.meses[i] || 0) - (fixas.meses[i] || 0) - (variaveis.meses[i] || 0);
            const classeCor = mesSaldo >= 0 ? "saldo-positivo" : "saldo-negativo";
            return `<td class="${classeCor}">${formatarMoeda(mesSaldo)}</td>`;
          }).join("")}
          <td class="${saldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(saldo)}</td>
          <td class="${mediaSaldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(mediaSaldo)}</td>
        </tr>
        ${cartoesHTML}
        ${spacerRowHTML}
                <tr class="cartao-laranja" onclick="abrirModalDetalhamento('Cartão de Crédito (Total)')">
          <td>Cartão de Crédito (Total)</td>
          ${cartaoTotalAgregado.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(cartaoTotalAgregado.total)}</td>
          <td>${formatarMoeda(mediaCartaoTotalAgregado)}</td>
        </tr>
        <tr class="conta-amarela" onclick="abrirModalDetalhamento('Conta')">
          <td>Conta</td>
          ${conta.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(conta.total)}</td>
          <td>${formatarMoeda(mediaConta)}</td>
        </tr>
        ${subcategoriasHTML}
      `;

      dadosResumo = {
        receitas: receitas,
        fixas: fixas,
        variaveis: variaveis,
        totalReceitas: totalReceitas,
        totalFixas: totalFixas,
        totalVariaveis: totalVariaveis,
        totalDespesas: totalDespesas,
        saldo: saldo,
        mediaReceitas: mediaReceitas,
        mediaFixas: mediaFixas,
        mediaVariaveis: mediaVariaveis,
        mediaSaldo: mediaSaldo,
        lancamentos: lancamentos,
      };

      atualizarGraficos();
      gerarInsightsFinanceiros(dadosResumo); // Chama a função de insights
    }

    function atualizarGraficos() {
      if (!dadosResumo) return;
      const mesSelecionado = parseInt(document.getElementById("mesSelecionado").value);
      let receitaPeriodo, fixasPeriodo, variaveisPeriodo, saldoPeriodo;

      if (mesSelecionado === -1) {
        receitaPeriodo = dadosResumo.totalReceitas;
        fixasPeriodo = dadosResumo.totalFixas;
        variaveisPeriodo = dadosResumo.totalVariaveis;
        saldoPeriodo = dadosResumo.saldo;
      } else if (mesSelecionado === -2) {
        receitaPeriodo = dadosResumo.mediaReceitas;
        fixasPeriodo = dadosResumo.mediaFixas;
        variaveisPeriodo = dadosResumo.mediaVariaveis;
        saldoPeriodo = dadosResumo.mediaSaldo;
      } else {
        receitaPeriodo = dadosResumo.receitas.meses[mesSelecionado] || 0;
        fixasPeriodo = dadosResumo.fixas.meses[mesSelecionado] || 0;
        variaveisPeriodo = dadosResumo.variaveis.meses[mesSelecionado] || 0;
        saldoPeriodo = receitaPeriodo - fixasPeriodo - variaveisPeriodo;
      }

      atualizarGraficoDespesasPoupanca(fixasPeriodo, variaveisPeriodo, saldoPeriodo);
      atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado);
      atualizarGraficoCartoesCredito(mesSelecionado); // Adiciona chamada para o novo gráfico
      atualizarGraficoSubcategorias(mesSelecionado); // Adiciona chamada para o gráfico de subcategorias
    }

    function atualizarGraficoDespesasPoupanca(fixas, variaveis, saldo) {
      const ctx = document.getElementById("graficoDespesasPoupanca").getContext("2d");
      if (graficoDespesasPoupanca) graficoDespesasPoupanca.destroy();
      const total = fixas + variaveis + Math.max(0, saldo);
      const labels = [];
      const data = [];
      const backgroundColors = [];
      if (fixas > 0) { labels.push("Despesas Fixas"); data.push(fixas); backgroundColors.push("#f44336"); }
      if (variaveis > 0) { labels.push("Despesas Variáveis"); data.push(variaveis); backgroundColors.push("#ff9800"); }
      if (saldo > 0) { labels.push("Potencial de Investimento"); data.push(saldo); backgroundColors.push("#1976d2"); }
      if (data.length === 0) {
        document.getElementById("legendaDespesasPoupanca").innerHTML = "<p style=\"text-align:center;\">Sem dados para exibir.</p>";
        return;
      }
      const percentuais = total > 0 ? data.map((val) => ((val / total) * 100).toFixed(1) + "%") : data.map(() => "0%");
      const legendaHTML = labels.map((label, i) => `
        <div class="item-legenda">
          <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
          <span class="descricao-legenda">${label}</span>
          <span class="valor-legenda">${formatarMoeda(data[i])}</span>
          <span>(${percentuais[i]})</span>
        </div>
      `).join("");
      document.getElementById("legendaDespesasPoupanca").innerHTML = legendaHTML;
      graficoDespesasPoupanca = new Chart(ctx, {
        type: "pie",
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const currentTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = currentTotal > 0 ? Math.round((value / currentTotal) * 100) : 0;
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    function atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado) {
      const ctx = document.getElementById("graficoDespesasReceitas").getContext("2d");
      if (graficoDespesasReceitas) graficoDespesasReceitas.destroy();

      const despesasAgrupadas = {};
      const anoAtual = new Date().getFullYear();
      const todasDespesas = dadosResumo.lancamentos.filter((l) => l.tipo !== "receita");

      todasDespesas.forEach((despesa) => {
        let valorDespesa = 0;

        if (mesSelecionado === -2) {
          let totalAnualDespesa = 0;
          if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
            totalAnualDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            for (let i = 0; i < 12; i++) {
              if (despesa.valoresManuais[i] === null) {
                const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
                totalAnualDespesa += despesa.valor * ocorrenciasMesSemManual.length;
              }
            }
          } else {
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            totalAnualDespesa = despesa.valor * ocorrencias.length;
          }
          valorDespesa = totalAnualDespesa / 12;

        } else if (mesSelecionado === -1) {
          if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
             valorDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
             const ocorrencias = calcularOcorrencias(despesa, anoAtual);
             for(let i=0; i<12; i++){
                 if(despesa.valoresManuais[i] === null){ 
                     const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
                     valorDespesa += despesa.valor * ocorrenciasMesSemManual.length;
                 }
             }
          } else {
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            valorDespesa = despesa.valor * ocorrencias.length;
          }
        } else {
           const ocorrencias = calcularOcorrencias(despesa, anoAtual);
           const temOcorrenciaNoMes = ocorrencias.some((d) => d.getMonth() === mesSelecionado);
           const temValorManualNoMes = despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null;
           
           if(temOcorrenciaNoMes || temValorManualNoMes){
                if (despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null) {
                    valorDespesa = despesa.valoresManuais[mesSelecionado];
                } else {
                    const ocorrenciasNoMes = ocorrencias.filter((d) => d.getMonth() === mesSelecionado);
                    valorDespesa = despesa.valor * ocorrenciasNoMes.length;
                }
           }
        }

        if (valorDespesa > 0) {
          const key = despesa.descricao;
          if (!despesasAgrupadas[key]) {
            despesasAgrupadas[key] = { valor: 0, tipo: despesa.tipo, formaPagamento: despesa.formaPagamento };
          }
          despesasAgrupadas[key].valor += valorDespesa;
        }
      });

      const labels = [];
      const data = [];
      const backgroundColors = [];
      const tipos = [];
      const despesasOrdenadas = Object.entries(despesasAgrupadas).map(([descricao, info]) => ({ descricao, ...info })).sort((a, b) => b.valor - a.valor);
      const limiteGrafico = 10;
      const despesasParaGrafico = despesasOrdenadas.slice(0, limiteGrafico);
      let outrasDespesas = despesasOrdenadas.slice(limiteGrafico).reduce((sum, d) => sum + d.valor, 0);

      despesasParaGrafico.forEach((d) => {
        labels.push(d.descricao);
        data.push(d.valor);
        if (d.tipo === "fixa") backgroundColors.push(d.formaPagamento === "credito" ? "#c62828" : "#f44336");
        else backgroundColors.push(d.formaPagamento === "credito" ? "#f57c00" : "#ff9800");
        tipos.push(d.tipo);
      });

      if (outrasDespesas > 0) {
        labels.push("Outras Despesas");
        data.push(outrasDespesas);
        backgroundColors.push("#757575");
        tipos.push("variavel");
      }

      const totalDespesasPeriodo = data.reduce((sum, val) => sum + val, 0);
      const restante = Math.max(0, receitaPeriodo - totalDespesasPeriodo);

      if (data.length === 0 && restante <= 0) {
        document.getElementById("legendaDespesasReceitas").innerHTML = "<p style=\"text-align:center;\">Sem despesas para exibir neste período.</p>";
        if (graficoDespesasReceitas) {
          graficoDespesasReceitas.destroy();
          graficoDespesasReceitas = null;
        }
        return;
      }

      if (restante > 0 || data.length > 0) {
         labels.push("Potencial de Investimento");
         data.push(restante);
         backgroundColors.push("#1976d2");
         tipos.push("receita");
      }

      const percentuais = receitaPeriodo > 0 ? data.map((val) => ((val / receitaPeriodo) * 100).toFixed(1) + "%") : data.map(() => "0%");

      const legendaHTML = labels.map((label, i) => {
        const tipo = tipos[i];
        const classeCor = tipo === "fixa" ? "fixa" : tipo === "variavel" ? "variavel" : "receita"; 
        const percentualExibido = receitaPeriodo > 0 ? `(${percentuais[i]})` : "";
        return `
          <div class="item-legenda">
            <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
            <span class="descricao-legenda ${classeCor}">${label}</span>
            <span class="valor-legenda">${formatarMoeda(data[i])}</span>
            <span>${percentualExibido}</span>
          </div>
        `;
      }).join("");
      document.getElementById("legendaDespesasReceitas").innerHTML = legendaHTML;

      graficoDespesasReceitas = new Chart(ctx, {
        type: "pie",
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const percentage = receitaPeriodo > 0 ? Math.round((value / receitaPeriodo) * 100) : 0;
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    // Nova função para atualizar o gráfico de Cartões de Crédito
    function atualizarGraficoCartoesCredito(mesSelecionado) {
      const ctx = document.getElementById("graficoCartoesCredito").getContext("2d");
      if (graficoCartoesCreditoInstance) graficoCartoesCreditoInstance.destroy();

      const anoAtual = new Date().getFullYear();
      const cartoesResumo = calcularTotaisPorCartao(dadosResumo.lancamentos, anoAtual);
      const legendaContainer = document.getElementById("legendaCartoesCredito");
      legendaContainer.innerHTML = ""; // Limpa legenda anterior

      const labels = [];
      const data = [];
      const backgroundColors = []; // Usaremos cores fixas ou geradas
      const coresCartoes = ["#f57c00", "#ffb74d", "#e65100", "#ffa726", "#fb8c00"]; // Paleta laranja/amarelo
      let corIndex = 0;

      let totalCartoesPeriodo = 0;

      Object.values(cartoesResumo).forEach(cartao => {
        let valorPeriodo = 0;
        if (mesSelecionado === -1) { // Total Anual
          valorPeriodo = cartao.total;
        } else if (mesSelecionado === -2) { // Média Mensal
          valorPeriodo = cartao.total / 12;
        } else { // Mês específico
          valorPeriodo = cartao.meses[mesSelecionado] || 0;
        }

        if (valorPeriodo > 0) {
          labels.push(cartao.nome);
          data.push(valorPeriodo);
          backgroundColors.push(coresCartoes[corIndex % coresCartoes.length]);
          corIndex++;
          totalCartoesPeriodo += valorPeriodo;
        }
      });

      if (data.length === 0) {
        legendaContainer.innerHTML = "<p style=\"text-align:center;\">Sem despesas de cartão para exibir neste período.</p>";
        if (graficoCartoesCreditoInstance) {
            graficoCartoesCreditoInstance.destroy();
            graficoCartoesCreditoInstance = null;
        }
        // Limpa o canvas explicitamente se não houver dados
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }

      const percentuais = totalCartoesPeriodo > 0 ? data.map((val) => ((val / totalCartoesPeriodo) * 100).toFixed(1) + "%") : data.map(() => "0%");

      const legendaHTML = labels.map((label, i) => `
        <div class="item-legenda">
          <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
          <span class="descricao-legenda cartao-laranja">${label}</span>
          <span class="valor-legenda">${formatarMoeda(data[i])}</span>
          <span>(${percentuais[i]})</span>
        </div>
      `).join("");
      legendaContainer.innerHTML = legendaHTML;

      graficoCartoesCreditoInstance = new Chart(ctx, {
        type: "pie",
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const currentTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = currentTotal > 0 ? Math.round((value / currentTotal) * 100) : 0;
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    // Nova função para atualizar o gráfico de Subcategorias
    function atualizarGraficoSubcategorias(mesSelecionado) {
      const ctx = document.getElementById("graficoSubcategorias").getContext("2d");
      if (graficoSubcategoriasInstance) graficoSubcategoriasInstance.destroy();

      const anoAtual = new Date().getFullYear();
      const subcategoriasResumo = calcularTotaisPorSubcategoria(dadosResumo.lancamentos, anoAtual);
      const legendaContainer = document.getElementById("legendaSubcategorias");
      legendaContainer.innerHTML = ""; // Limpa legenda anterior

      const labels = [];
      const data = [];
      const backgroundColors = [];
      // Usar as cores definidas no CSS
      const coresCSS = [
        "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#00bcd4", 
        "#009688", "#8bc34a", "#cddc39", "#ffeb3b", "#ff5722", "#795548"
      ];
      let corIndex = 0;
      let totalSubcategoriasPeriodo = 0;

      Object.entries(subcategoriasResumo).forEach(([nome, dados]) => {
        let valorPeriodo = 0;
        if (mesSelecionado === -1) { // Total Anual
          valorPeriodo = dados.total;
        } else if (mesSelecionado === -2) { // Média Mensal
          valorPeriodo = dados.total / 12;
        } else { // Mês específico
          valorPeriodo = dados.meses[mesSelecionado] || 0;
        }

        if (valorPeriodo > 0) {
          labels.push(nome);
          data.push(valorPeriodo);
          backgroundColors.push(coresCSS[corIndex % coresCSS.length]);
          corIndex++;
          totalSubcategoriasPeriodo += valorPeriodo;
        }
      });

      if (data.length === 0) {
        legendaContainer.innerHTML = "<p style=\"text-align:center;\">Sem despesas por subcategoria para exibir neste período.</p>";
        if (graficoSubcategoriasInstance) {
            graficoSubcategoriasInstance.destroy();
            graficoSubcategoriasInstance = null;
        }
        // Limpa o canvas explicitamente se não houver dados
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }

      const percentuais = totalSubcategoriasPeriodo > 0 ? data.map((val) => ((val / totalSubcategoriasPeriodo) * 100).toFixed(1) + "%") : data.map(() => "0%");

      const legendaHTML = labels.map((label, i) => `
        <div class="item-legenda">
          <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
          <span class="descricao-legenda">${label}</span>
          <span class="valor-legenda">${formatarMoeda(data[i])}</span>
          <span>(${percentuais[i]})</span>
        </div>
      `).join("");
      legendaContainer.innerHTML = legendaHTML;

      graficoSubcategoriasInstance = new Chart(ctx, {
        type: "pie",
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const currentTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = currentTotal > 0 ? Math.round((value / currentTotal) * 100) : 0;
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    // Nova função para gerar insights financeiros
    function gerarInsightsFinanceiros(dados) {
      const insightsContent = document.getElementById("insightsContent");
      insightsContent.innerHTML = ""; // Limpa insights anteriores
      let insightsHTML = "<ul>";

      if (!dados) {
        insightsHTML += "<li>Não há dados suficientes para gerar insights.</li>";
        insightsContent.innerHTML = insightsHTML + "</ul>";
        return;
      }

      const anoAtual = new Date().getFullYear();
      const subcategoriasResumo = calcularTotaisPorSubcategoria(dados.lancamentos, anoAtual);
      const cartoesResumo = calcularTotaisPorCartao(dados.lancamentos, anoAtual);

      // Insight 1: Balanço Geral (Anual)
      if (dados.saldo > 0) {
        insightsHTML += `<li>Parabéns! Seu balanço anual é positivo em <strong>${formatarMoeda(dados.saldo)}</strong>. Você está no caminho certo para atingir seus objetivos financeiros.</li>`;
      } else if (dados.saldo < 0) {
        insightsHTML += `<li style="color: #ff9800;">Atenção! Seu balanço anual está negativo em <strong>${formatarMoeda(Math.abs(dados.saldo))}</strong>. É importante revisar suas despesas.</li>`;
      } else {
        insightsHTML += `<li>Seu balanço anual está zerado. Considere buscar formas de aumentar sua receita ou reduzir despesas.</li>`;
      }

      // Insight 2: Proporção Despesas x Receitas (Anual)
      if (dados.totalReceitas > 0) {
        const proporcaoDespesas = (dados.totalDespesas / dados.totalReceitas) * 100;
        insightsHTML += `<li>Suas despesas totais anuais (<strong>${formatarMoeda(dados.totalDespesas)}</strong>) representam <strong>${proporcaoDespesas.toFixed(1)}%</strong> de suas receitas totais (<strong>${formatarMoeda(dados.totalReceitas)}</strong>).</li>`;
        if (proporcaoDespesas > 80 && dados.saldo > 0) {
            insightsHTML += `<li style="color: #ffeb3b;">Embora seu saldo seja positivo, suas despesas consomem uma parte significativa da sua receita. Avalie onde é possível cortar gastos.</li>`;
        }
      } else if (dados.totalDespesas > 0) {
        insightsHTML += `<li>Você registrou despesas (<strong>${formatarMoeda(dados.totalDespesas)}</strong>) mas nenhuma receita anual. Verifique seus lançamentos.</li>`;
      }

      // Insight 3			// Insight 3: Maiores Despesas por Descrição (Anual) - MODIFICADO
			const despesasAgrupadasPorDescricao = {};
			const anoAtualInsight = new Date().getFullYear(); // Renomeado para evitar conflito
			const todasDespesasInsight = dados.lancamentos.filter((l) => l.tipo !== "receita");

			todasDespesasInsight.forEach((despesa) => {
				let totalAnualDespesa = 0;
				// Calcula o total anual da despesa (considerando ocorrências e valores manuais)
				if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
					// Soma valores manuais não nulos
					let somaValoresManuais = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
					// Calcula ocorrências para meses sem valor manual
					const ocorrencias = calcularOcorrencias(despesa, anoAtualInsight);
					let somaOcorrenciasNormais = 0;
					for(let i=0; i<12; i++){
						if(despesa.valoresManuais[i] === null){ // Apenas meses sem valor manual
							const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
							somaOcorrenciasNormais += despesa.valor * ocorrenciasMesSemManual.length;
						}
					}
					totalAnualDespesa = somaValoresManuais + somaOcorrenciasNormais;
				} else {
					// Se não há valores manuais, calcula baseado nas ocorrências
					const ocorrencias = calcularOcorrencias(despesa, anoAtualInsight);
					totalAnualDespesa = despesa.valor * ocorrencias.length;
				}

				if (totalAnualDespesa > 0) {
					const key = despesa.descricao;
					if (!despesasAgrupadasPorDescricao[key]) {
						despesasAgrupadasPorDescricao[key] = 0;
					}
					despesasAgrupadasPorDescricao[key] += totalAnualDespesa;
				}
			});

			const despesasOrdenadasPorDescricao = Object.entries(despesasAgrupadasPorDescricao)
												.map(([descricao, valor]) => ({ descricao, valor }))
												.sort((a, b) => b.valor - a.valor);

			if (despesasOrdenadasPorDescricao.length > 0) {
				const top1 = despesasOrdenadasPorDescricao[0];
				let insightTexto = `<li>Anualmente, suas maiores despesas individuais são: <strong>${top1.descricao}</strong> (${formatarMoeda(top1.valor)})`;
				if (despesasOrdenadasPorDescricao.length > 1) {
					const top2 = despesasOrdenadasPorDescricao[1];
					insightTexto += ` e <strong>${top2.descricao}</strong> (${formatarMoeda(top2.valor)})`;
				}
				// Opcional: Adicionar top 3 se desejar
				// if (despesasOrdenadasPorDescricao.length > 2) {
				//   const top3 = despesasOrdenadasPorDescricao[2];
				//   insightTexto += `, e <strong>${top3.descricao}</strong> (${formatarMoeda(top3.valor)})`;
				// }
				insightTexto += `.</li>`;
					insightsHTML += insightTexto;
				}     
      // Insight 4: Maiores Subcategorias (Anual)
      const subcategoriasOrdenadas = Object.entries(subcategoriasResumo)
                                        .map(([nome, dadosSub]) => ({ nome, valor: dadosSub.total }))
                                        .sort((a, b) => b.valor - a.valor);
                                        
      if (subcategoriasOrdenadas.length > 0) {
          const topSubcategoria = subcategoriasOrdenadas[0];
          insightsHTML += `<li>Sua principal subcategoria de despesa anual é <strong>${topSubcategoria.nome}</strong>, totalizando <strong>${formatarMoeda(topSubcategoria.valor)}</strong>.</li>`;
      }
      
      // Insight 5: Uso de Cartão de Crédito (Anual)
      const totalGastoCartoes = Object.values(cartoesResumo).reduce((sum, cartao) => sum + cartao.total, 0);
      if (totalGastoCartoes > 0 && dados.totalDespesas > 0) {
          const percentualCartao = (totalGastoCartoes / dados.totalDespesas) * 100;
          insightsHTML += `<li>O uso de cartão de crédito corresponde a <strong>${percentualCartao.toFixed(1)}%</strong> (<strong>${formatarMoeda(totalGastoCartoes)}</strong>) do total de suas despesas anuais.</li>`;
          const cartoesOrdenados = Object.values(cartoesResumo).sort((a, b) => b.total - a.total);
          if (cartoesOrdenados.length > 0 && cartoesOrdenados[0].total > 0) {
              insightsHTML += `<li>O cartão mais utilizado anualmente é o <strong>${cartoesOrdenados[0].nome}</strong>, com um gasto total de <strong>${formatarMoeda(cartoesOrdenados[0].total)}</strong>.</li>`;
          }
      }

      insightsHTML += "</ul>";
      insightsContent.innerHTML = insightsHTML;
    }

    function carregarLancamentos() {
      const tabelaBody = document.getElementById("tabelaBody");
      tabelaBody.innerHTML = "";
      lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const currentYear = new Date().getFullYear();
      const lancamentosOrdenados = ordenarLancamentos(lancamentos);
      lancamentosOrdenados.forEach((l) => {
        const tr = document.createElement("tr");
        if (l.formaPagamento === "credito" && l.tipo !== "receita") tr.classList.add("cartao-credito");
        if (!l.valoresManuais) l.valoresManuais = Array(12).fill(null);
        const meses = Array(12).fill(0);
        const ocorrencias = calcularOcorrencias(l, currentYear);
        for (let index = 0; index < 12; index++) {
            if (l.valoresManuais[index] !== null) {
                meses[index] = l.valoresManuais[index];
            } else {
                const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
                meses[index] = l.valor * ocorrenciasNoMes.length;
            }
        }
        const total = meses.reduce((sum, val) => sum + val, 0);
        const media = total / 12;
        const classeCSS = l.tipo === "receita" ? "receita" : l.tipo === "fixa" ? "fixa" : "variavel";
        
        // Adicionar onclick para abrir modal de edição, exceto nas células editáveis e botão excluir
        tr.onclick = function(event) {
          // Verificar se o clique foi em uma célula editável ou no botão excluir
          if (event.target.classList.contains('editable') || event.target.classList.contains('delete-btn')) {
            return; // Não abrir modal de edição
          }
          abrirModalEdicao(l.id);
        };
        
        tr.innerHTML = `
          <td class="hidden-id">${l.id}</td>
          <td class="${classeCSS}">${l.descricao}</td>
          ${meses.map((m, i) => `<td class="editable" onclick="event.stopPropagation(); editarCelula(this, ${l.id}, ${i})">${formatarMoeda(m)}</td>`).join("")}
          <td class="${classeCSS}">${formatarMoeda(total)}</td>
          <td class="${classeCSS}">${formatarMoeda(media)}</td>
          <td><button class="delete-btn" onclick="event.stopPropagation(); excluirLancamento(${l.id})">Excluir</button></td>
        `;
        tabelaBody.appendChild(tr);
      });
      atualizarResumoFinanceiro(lancamentos, currentYear);
    }

    function excluirLancamento(id) {
      if (!confirm("Tem certeza que deseja excluir este lançamento?")) return;
      let lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      lancamentos = lancamentos.filter((l) => l.id !== id);
      localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
      carregarLancamentos();
    }

    function editarCelula(cell, id, month) {
      if (cell.querySelector("input")) return;
      const currentValueText = cell.innerHTML;
      const currentValue = parseFloat(currentValueText.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
      const input = document.createElement("input");
      input.type = "text";
      input.className = "edit-input";
      input.value = currentValue > 0 ? formatarMoeda(currentValue).replace("R$ ", "").replace(".", "").replace(",", ".") : "";
      cell.innerHTML = "";
      input.addEventListener("input", function () {
        let v = this.value.replace(/[^\d]/g, "");
        if (!v) { this.value = ""; return; }
        if (v.length < 3) v = v.padStart(3, "0");
        let inteiro = v.slice(0, -2).replace(/^0+/, "") || "0";
        const decimal = v.slice(-2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + decimal;
      });
      cell.appendChild(input);
      input.focus();
      input.select();
      const blurHandler = () => {
        finalizarEdicao(input, id, month, cell);
        input.removeEventListener("blur", blurHandler);
      };
      input.addEventListener("blur", blurHandler);
      input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          input.removeEventListener("blur", blurHandler);
          finalizarEdicao(input, id, month, cell);
        }
      });
      input.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          input.removeEventListener("blur", blurHandler);
          cell.innerHTML = currentValueText;
        }
      });
    }

    function finalizarEdicao(input, id, month, cell) {
      const novoValorStr = input.value.trim();
      let lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const lancamento = lancamentos.find((l) => l.id === id);
      if (lancamento) {
        let valorNumerico = 0;
        if (novoValorStr && novoValorStr !== "-") {
          valorNumerico = parseFloat(novoValorStr.replace(/\./g, "").replace(",", "."));
          if (isNaN(valorNumerico)) valorNumerico = 0;
        }
        if (!lancamento.valoresManuais) lancamento.valoresManuais = Array(12).fill(null);
        lancamento.valoresManuais[month] = valorNumerico;
        localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
        carregarLancamentos();
      } else {
        cell.innerHTML = formatarMoeda(0);
      }
    }

    function ordenarLancamentos(lancamentos) {
      const entradas = lancamentos.filter((l) => l.tipo === "receita").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const fixasNaoCredito = lancamentos.filter((l) => l.tipo === "fixa" && l.formaPagamento !== "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const fixasCredito = lancamentos.filter((l) => l.tipo === "fixa" && l.formaPagamento === "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const variaveisNaoCredito = lancamentos.filter((l) => l.tipo === "variavel" && l.formaPagamento !== "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const variaveisCredito = lancamentos.filter((l) => l.tipo === "variavel" && l.formaPagamento === "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      return [...entradas, ...fixasNaoCredito, ...fixasCredito, ...variaveisNaoCredito, ...variaveisCredito];
    }

    // Inicialização
    document.addEventListener("DOMContentLoaded", function () {
      carregarDadosGerenciamento(); // Carrega subcategorias e cartões
      carregarLancamentos();
      // Inicializar elementos relacionados aos gastos reais
      gastosReais = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      
      // Inicializar selects de filtro
      atualizarSelectsFiltro();
      
      // Carregar gastos reais
      carregarGastosReais();
      
      // Atualizar resumo de faturas
      atualizarResumoFaturas();

      
      // Listeners para formatação de valor
      document.getElementById("valor").addEventListener("input", function () {
        let v = this.value.replace(/[^\d]/g, "");
        if (!v) { this.value = ""; return; }
        if (v.length < 3) v = v.padStart(3, "0");
        let inteiro = v.slice(0, -2).replace(/^0+/, "") || "0";
        const decimal = v.slice(-2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + decimal;
      });
      
      document.getElementById("valorEdicao").addEventListener("input", function () {
        let v = this.value.replace(/[^\d]/g, "");
        if (!v) { this.value = ""; return; }
        if (v.length < 3) v = v.padStart(3, "0");
        let inteiro = v.slice(0, -2).replace(/^0+/, "") || "0";
        const decimal = v.slice(-2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + decimal;
      });
      
      // Listeners para tipo de lançamento (afeta forma de pagamento)
      document.getElementById("tipoLancamento").addEventListener("change", function () {
        const formaPagamentoSelect = document.getElementById("formaPagamento");
        if (this.value === "receita") {
          formaPagamentoSelect.innerHTML = `<option value="conta">Conta</option>`;
          formaPagamentoSelect.value = "conta";
        } else {
          const valorAtual = formaPagamentoSelect.value;
          formaPagamentoSelect.innerHTML = `
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          `;
          if (valorAtual === "conta" || valorAtual === "credito") {
            formaPagamentoSelect.value = valorAtual;
          } else {
            formaPagamentoSelect.value = "conta";
          }
        }
        // Dispara o change da forma de pagamento para atualizar visibilidade do cartão
        toggleCartaoContainer();
      });
      
      document.getElementById("tipoLancamentoEdicao").addEventListener("change", function () {
        const formaPagamentoSelect = document.getElementById("formaPagamentoEdicao");
        if (this.value === "receita") {
          formaPagamentoSelect.innerHTML = `<option value="conta">Conta</option>`;
          formaPagamentoSelect.value = "conta";
        } else {
          const valorAtual = formaPagamentoSelect.value;
          formaPagamentoSelect.innerHTML = `
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          `;
          if (valorAtual === "conta" || valorAtual === "credito") {
            formaPagamentoSelect.value = valorAtual;
          } else {
            formaPagamentoSelect.value = "conta";
          }
        }
        // Dispara o change da forma de pagamento para atualizar visibilidade do cartão
        toggleCartaoContainerEdicao();
      });
    });

    // Variáveis globais adicionais para gastos reais
    let gastosReais = []; // Array para armazenar os gastos reais
    const modalGastoReal = document.getElementById("modalGastoReal");
    const modalEdicaoGastoReal = document.getElementById("modalEdicaoGastoReal");
    const botaoGastosReaisFixo = document.querySelector(".botao-gastos-reais-fixo");

    // Funções de Navegação para Gastos Reais
    function mostrarGastosReais() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.add("container-gastos-reais-ativo");
      carregarGastosReais();
      atualizarResumoFaturas();
      atualizarGraficoComparacao();
    }

    // Funções para Modal de Gasto Real
    function abrirModalGastoReal() {
      // Preencher o campo de data com a data atual
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById("gastoRealData").value = hoje;
      
      // Atualizar os selects de cartões e subcategorias
      atualizarSelectGastoReal();
      
      // Exibir o modal
      modalGastoReal.style.display = "block";
    }

    function fecharModalGastoReal() {
      modalGastoReal.style.display = "none";
      // Limpar campos
      document.getElementById("gastoRealDescricao").value = "";
      document.getElementById("gastoRealValor").value = "";
      document.getElementById("gastoRealFormaPagamento").value = "conta";
      document.getElementById("gastoRealCartaoCredito").value = "";
      document.getElementById("gastoRealSubcategoria").value = "";
      document.getElementById("gastoRealLancamento").value = "";
      document.getElementById("gastoRealObservacao").value = "";
      document.getElementById("gastoRealCartaoContainer").style.display = "none";
      document.getElementById("gastoRealInfoFatura").innerHTML = "";
    }

    function toggleGastoRealCartaoContainer() {
      const formaPagamento = document.getElementById("gastoRealFormaPagamento").value;
      const cartaoContainer = document.getElementById("gastoRealCartaoContainer");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        atualizarFaturaGastoReal();
      } else {
        cartaoContainer.style.display = "none";
        document.getElementById("gastoRealCartaoCredito").value = "";
        document.getElementById("gastoRealInfoFatura").innerHTML = "";
      }
    }

    function toggleGastoRealCartaoContainerEdicao() {
      const formaPagamento = document.getElementById("gastoRealFormaPagamentoEdicao").value;
      const cartaoContainer = document.getElementById("gastoRealCartaoContainerEdicao");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        atualizarFaturaGastoRealEdicao();
      } else {
        cartaoContainer.style.display = "none";
        document.getElementById("gastoRealCartaoCreditoEdicao").value = "";
        document.getElementById("gastoRealInfoFaturaEdicao").innerHTML = "";
      }
    }

    function atualizarSelectGastoReal() {
      // Atualizar select de cartões
      const selectCartao = document.getElementById("gastoRealCartaoCredito");
      selectCartao.innerHTML = '<option value="">Selecione o cartão</option>';
      cartoes.forEach(cartao => {
        const option = document.createElement("option");
        option.value = cartao.id;
        option.textContent = cartao.nome;
        selectCartao.appendChild(option);
      });
      
      // Atualizar select de subcategorias
      const selectSubcategoria = document.getElementById("gastoRealSubcategoria");
      selectSubcategoria.innerHTML = '<option value="">Nenhuma</option>';
      subcategorias.forEach(subcategoria => {
        const option = document.createElement("option");
        option.value = subcategoria.id;
        option.textContent = subcategoria.nome;
        selectSubcategoria.appendChild(option);
      });
      
      // Atualizar select de lançamentos
      const selectLancamento = document.getElementById("gastoRealLancamento");
      selectLancamento.innerHTML = '<option value="">Nenhum</option>';
      lancamentos.forEach(lancamento => {
        const option = document.createElement("option");
        option.value = lancamento.id;
        option.textContent = lancamento.descricao;
        selectLancamento.appendChild(option);
      });
    }

    function atualizarSelectGastoRealEdicao() {
      // Atualizar select de cartões
      const selectCartao = document.getElementById("gastoRealCartaoCreditoEdicao");
      selectCartao.innerHTML = '<option value="">Selecione o cartão</option>';
      cartoes.forEach(cartao => {
        const option = document.createElement("option");
        option.value = cartao.id;
        option.textContent = cartao.nome;
        selectCartao.appendChild(option);
      });
      
      // Atualizar select de subcategorias
      const selectSubcategoria = document.getElementById("gastoRealSubcategoriaEdicao");
      selectSubcategoria.innerHTML = '<option value="">Nenhuma</option>';
      subcategorias.forEach(subcategoria => {
        const option = document.createElement("option");
        option.value = subcategoria.id;
        option.textContent = subcategoria.nome;
        selectSubcategoria.appendChild(option);
      });
      
      // Atualizar select de lançamentos
      const selectLancamento = document.getElementById("gastoRealLancamentoEdicao");
      selectLancamento.innerHTML = '<option value="">Nenhum</option>';
      lancamentos.forEach(lancamento => {
        const option = document.createElement("option");
        option.value = lancamento.id;
        option.textContent = lancamento.descricao;
        selectLancamento.appendChild(option);
      });
    }

    function atualizarFaturaGastoReal() {
      const cartaoId = document.getElementById("gastoRealCartaoCredito").value;
      const dataGasto = document.getElementById("gastoRealData").value;
      
      if (!cartaoId || !dataGasto) {
        document.getElementById("gastoRealInfoFatura").innerHTML = "";
        return;
      }
      
      const cartao = cartoes.find(c => c.id == cartaoId);
      if (!cartao) {
        document.getElementById("gastoRealInfoFatura").innerHTML = "";
        return;
      }
      
      const dataObj = new Date(dataGasto);
      const fatura = determinarFatura(dataObj, cartao);
      
      document.getElementById("gastoRealInfoFatura").innerHTML = `
        Fatura: ${fatura.mes}/${fatura.ano} | 
        Fechamento: ${fatura.dataFechamento.toLocaleDateString()} | 
        Vencimento: ${fatura.dataVencimento.toLocaleDateString()}
      `;
    }

    function atualizarFaturaGastoRealEdicao() {
      const cartaoId = document.getElementById("gastoRealCartaoCreditoEdicao").value;
      const dataGasto = document.getElementById("gastoRealDataEdicao").value;
      
      if (!cartaoId || !dataGasto) {
        document.getElementById("gastoRealInfoFaturaEdicao").innerHTML = "";
        return;
      }
      
      const cartao = cartoes.find(c => c.id == cartaoId);
      if (!cartao) {
        document.getElementById("gastoRealInfoFaturaEdicao").innerHTML = "";
        return;
      }
      
      const dataObj = new Date(dataGasto);
      const fatura = determinarFatura(dataObj, cartao);
      
      document.getElementById("gastoRealInfoFaturaEdicao").innerHTML = `
        Fatura: ${fatura.mes}/${fatura.ano} | 
        Fechamento: ${fatura.dataFechamento.toLocaleDateString()} | 
        Vencimento: ${fatura.dataVencimento.toLocaleDateString()}
      `;
    }

    function registrarGastoReal() {
      const descricao = document.getElementById("gastoRealDescricao").value.trim();
      const valorStr = document.getElementById("gastoRealValor").value.trim();
      const data = document.getElementById("gastoRealData").value;
      const formaPagamento = document.getElementById("gastoRealFormaPagamento").value;
      const cartaoId = document.getElementById("gastoRealCartaoCredito").value || null;
      const subcategoriaId = document.getElementById("gastoRealSubcategoria").value || null;
      const lancamentoId = document.getElementById("gastoRealLancamento").value || null;
      const observacao = document.getElementById("gastoRealObservacao").value.trim() || null;
      
      if (!descricao || !valorStr || !data) {
        alert("Preencha a descrição, o valor e a data.");
        return;
      }
      
      if (formaPagamento === "credito" && !cartaoId) {
        alert("Selecione um cartão de crédito para este gasto.");
        return;
      }
      
      const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
      if (isNaN(valorNumerico)) {
        alert("Valor inválido.");
        return;
      }
      
      const gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      const novoId = gastosReaisArray.length > 0 ? Math.max(...gastosReaisArray.map(g => g.id)) + 1 : 1;
      
      let fatura = null;
      if (formaPagamento === "credito" && cartaoId) {
        const cartao = cartoes.find(c => c.id == cartaoId);
        if (cartao) {
          const dataObj = new Date(data);
          fatura = determinarFatura(dataObj, cartao);
        }
      }
      
      const novoGasto = {
        id: novoId,
        descricao,
        valor: valorNumerico,
        data,
        formaPagamento,
        cartaoId,
        fatura: fatura ? {
          mes: fatura.mes,
          ano: fatura.ano,
          dataFechamento: fatura.dataFechamento.toISOString(),
          dataVencimento: fatura.dataVencimento.toISOString()
        } : null,
        subcategoriaId,
        lancamentoId,
        observacao
      };
      
      gastosReaisArray.push(novoGasto);
      localStorage.setItem("gastosReais", JSON.stringify(gastosReaisArray));
      
      fecharModalGastoReal();
      carregarGastosReais();
      atualizarResumoFaturas();
      atualizarGraficoComparacao();
    }

    function carregarGastosReais() {
      const tabelaBody = document.getElementById("gastosReaisBody");
      tabelaBody.innerHTML = "";
      
      gastosReais = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      
      // Aplicar filtros
      const filtroMes = document.getElementById("filtroMes").value;
      const filtroFormaPagamento = document.getElementById("filtroFormaPagamento").value;
      const filtroCartao = document.getElementById("filtroCartao").value;
      const filtroSubcategoria = document.getElementById("filtroSubcategoria").value;
      const filtroFatura = document.getElementById("filtroFatura").value;
      
      const gastosFiltrados = gastosReais.filter(gasto => {
        // Filtro por mês
        if (filtroMes !== "todos") {
          const dataGasto = new Date(gasto.data);
          const mesGasto = dataGasto.getMonth();
          if (parseInt(filtroMes) !== mesGasto) return false;
        }
        
        // Filtro por forma de pagamento
        if (filtroFormaPagamento !== "todos" && gasto.formaPagamento !== filtroFormaPagamento) return false;
        
        // Filtro por cartão
        if (filtroCartao !== "todos" && gasto.cartaoId != filtroCartao) return false;
        
        // Filtro por subcategoria
        if (filtroSubcategoria !== "todos" && gasto.subcategoriaId != filtroSubcategoria) return false;
        
        // Filtro por fatura
        if (filtroFatura !== "todas" && (!gasto.fatura || `${gasto.fatura.mes}/${gasto.fatura.ano}` !== filtroFatura)) return false;
        
        return true;
      });
      
      // Ordenar por data (mais recente primeiro)
      gastosFiltrados.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      gastosFiltrados.forEach(gasto => {
        const tr = document.createElement("tr");
        tr.classList.add(gasto.formaPagamento === "credito" ? "gasto-real-cartao" : "gasto-real");
        
        // Encontrar informações relacionadas
        const cartao = gasto.cartaoId ? cartoes.find(c => c.id == gasto.cartaoId) : null;
        const subcategoria = gasto.subcategoriaId ? subcategorias.find(s => s.id == gasto.subcategoriaId) : null;
        const lancamento = gasto.lancamentoId ? lancamentos.find(l => l.id == gasto.lancamentoId) : null;
        
        // Formatar data
        const dataObj = new Date(gasto.data);
        const dataFormatada = dataObj.toLocaleDateString();
        
        tr.innerHTML = `
          <td class="hidden-id">${gasto.id}</td>
          <td>${gasto.descricao}${lancamento ? ` <span style="font-size: 12px; color: #b0bec5;">(${lancamento.descricao})</span>` : ''}</td>
          <td>${dataFormatada}</td>
          <td>${formatarMoeda(gasto.valor)}</td>
          <td class="${gasto.formaPagamento === 'credito' ? 'cartao-laranja' : 'conta-amarela'}">${gasto.formaPagamento === 'credito' ? 'Cartão' : 'Conta'}</td>
          <td>${cartao ? cartao.nome : '-'}</td>
          <td>${gasto.fatura ? `${gasto.fatura.mes}/${gasto.fatura.ano}` : '-'}</td>
          <td>${subcategoria ? subcategoria.nome : '-'}</td>
          <td>${gasto.observacao || '-'}</td>
          <td>
            <button class="edit-btn" onclick="abrirModalEdicaoGastoReal(${gasto.id})">Editar</button>
            <button class="delete-btn" onclick="excluirGastoReal(${gasto.id})">Excluir</button>
          </td>
        `;
        
        tabelaBody.appendChild(tr);
      });
      
      // Atualizar os selects de filtro
      atualizarSelectsFiltro();
    }

    function atualizarSelectsFiltro() {
      // Atualizar select de cartões
      const selectCartao = document.getElementById("filtroCartao");
      const cartaoSelecionado = selectCartao.value;
      selectCartao.innerHTML = '<option value="todos">Todos</option>';
      
      // Obter cartões únicos dos gastos
      const cartoesUnicos = [...new Set(gastosReais
        .filter(g => g.cartaoId)
        .map(g => g.cartaoId))];
      
      cartoesUnicos.forEach(cartaoId => {
        const cartao = cartoes.find(c => c.id == cartaoId);
        if (cartao) {
          const option = document.createElement("option");
          option.value = cartaoId;
          option.textContent = cartao.nome;
          selectCartao.appendChild(option);
        }
      });
      
      // Restaurar seleção anterior
      if (cartoesUnicos.includes(parseInt(cartaoSelecionado))) {
        selectCartao.value = cartaoSelecionado;
      }
      
      // Atualizar select de subcategorias
      const selectSubcategoria = document.getElementById("filtroSubcategoria");
      const subcategoriaSelecionada = selectSubcategoria.value;
      selectSubcategoria.innerHTML = '<option value="todos">Todos</option>';
      
      // Obter subcategorias únicas dos gastos
      const subcategoriasUnicas = [...new Set(gastosReais
        .filter(g => g.subcategoriaId)
        .map(g => g.subcategoriaId))];
      
      subcategoriasUnicas.forEach(subcategoriaId => {
        const subcategoria = subcategorias.find(s => s.id == subcategoriaId);
        if (subcategoria) {
          const option = document.createElement("option");
          option.value = subcategoriaId;
          option.textContent = subcategoria.nome;
          selectSubcategoria.appendChild(option);
        }
      });
      
      // Restaurar seleção anterior
      if (subcategoriasUnicas.includes(parseInt(subcategoriaSelecionada))) {
        selectSubcategoria.value = subcategoriaSelecionada;
      }
      
      // Atualizar select de faturas
      const selectFatura = document.getElementById("filtroFatura");
      const faturaSelecionada = selectFatura.value;
      selectFatura.innerHTML = '<option value="todas">Todas as Faturas</option>';
      
      // Obter faturas únicas dos gastos
      const faturasUnicas = gastosReais
        .filter(g => g.fatura)
        .map(g => `${g.fatura.mes}/${g.fatura.ano}`);
      
      // Remover duplicatas e ordenar
      const faturasUnicasOrdenadas = [...new Set(faturasUnicas)]
        .sort((a, b) => {
          const [mesA, anoA] = a.split('/').map(Number);
          const [mesB, anoB] = b.split('/').map(Number);
          if (anoA !== anoB) return anoB - anoA;
          return mesB - mesA;
        });
      
      faturasUnicasOrdenadas.forEach(fatura => {
        const option = document.createElement("option");
        option.value = fatura;
        option.textContent = `Fatura ${fatura}`;
        selectFatura.appendChild(option);
      });
      
      // Restaurar seleção anterior
      if (faturasUnicasOrdenadas.includes(faturaSelecionada)) {
        selectFatura.value = faturaSelecionada;
      }
    }

    function filtrarGastosReais() {
      carregarGastosReais();
    }

    function aplicarFiltroFatura() {
      const filtroFatura = document.getElementById("filtroFatura").value;
      if (filtroFatura !== "todas") {
        document.getElementById("filtroFormaPagamento").value = "credito";
      }
      filtrarGastosReais();
    }

    function abrirModalEdicaoGastoReal(id) {
      const gasto = gastosReais.find(g => g.id === id);
      if (!gasto) return;
      
      document.getElementById("editGastoRealId").value = gasto.id;
      document.getElementById("gastoRealDescricaoEdicao").value = gasto.descricao;
      document.getElementById("gastoRealValorEdicao").value = gasto.valor.toString().replace(".", ",");
      document.getElementById("gastoRealDataEdicao").value = gasto.data;
      document.getElementById("gastoRealFormaPagamentoEdicao").value = gasto.formaPagamento;
      document.getElementById("gastoRealObservacaoEdicao").value = gasto.observacao || "";
      
      // Atualizar selects
      atualizarSelectGastoRealEdicao();
      
      // Definir valores dos selects
      if (gasto.subcategoriaId) {
        document.getElementById("gastoRealSubcategoriaEdicao").value = gasto.subcategoriaId;
      }
      
      if (gasto.lancamentoId) {
        document.getElementById("gastoRealLancamentoEdicao").value = gasto.lancamentoId;
      }
      
      // Mostrar/esconder container de cartão
      const cartaoContainer = document.getElementById("gastoRealCartaoContainerEdicao");
      if (gasto.formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        if (gasto.cartaoId) {
          document.getElementById("gastoRealCartaoCreditoEdicao").value = gasto.cartaoId;
          atualizarFaturaGastoRealEdicao();
        }
      } else {
        cartaoContainer.style.display = "none";
      }
      
      modalEdicaoGastoReal.style.display = "block";
    }

    function fecharModalEdicaoGastoReal() {
      modalEdicaoGastoReal.style.display = "none";
    }

    function salvarEdicaoGastoReal() {
      const id = parseInt(document.getElementById("editGastoRealId").value);
      const descricao = document.getElementById("gastoRealDescricaoEdicao").value.trim();
      const valorStr = document.getElementById("gastoRealValorEdicao").value.trim();
      const data = document.getElementById("gastoRealDataEdicao").value;
      const formaPagamento = document.getElementById("gastoRealFormaPagamentoEdicao").value;
      const cartaoId = document.getElementById("gastoRealCartaoCreditoEdicao").value || null;
      const subcategoriaId = document.getElementById("gastoRealSubcategoriaEdicao").value || null;
      const lancamentoId = document.getElementById("gastoRealLancamentoEdicao").value || null;
      const observacao = document.getElementById("gastoRealObservacaoEdicao").value.trim() || null;
      
      if (!descricao || !valorStr || !data) {
        alert("Preencha a descrição, o valor e a data.");
        return;
      }
      
      if (formaPagamento === "credito" && !cartaoId) {
        alert("Selecione um cartão de crédito para este gasto.");
        return;
      }
      
      const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
      if (isNaN(valorNumerico)) {
        alert("Valor inválido.");
        return;
      }
      
      let fatura = null;
      if (formaPagamento === "credito" && cartaoId) {
        const cartao = cartoes.find(c => c.id == cartaoId);
        if (cartao) {
          const dataObj = new Date(data);
          fatura = determinarFatura(dataObj, cartao);
        }
      }
      
      const gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      const index = gastosReaisArray.findIndex(g => g.id === id);
      
      if (index !== -1) {
        gastosReaisArray[index] = {
          id,
          descricao,
          valor: valorNumerico,
          data,
          formaPagamento,
          cartaoId,
          fatura: fatura ? {
            mes: fatura.mes,
            ano: fatura.ano,
            dataFechamento: fatura.dataFechamento.toISOString(),
            dataVencimento: fatura.dataVencimento.toISOString()
          } : null,
          subcategoriaId,
          lancamentoId,
          observacao
        };
        
        localStorage.setItem("gastosReais", JSON.stringify(gastosReaisArray));
        
        fecharModalEdicaoGastoReal();
        carregarGastosReais();
        atualizarResumoFaturas();
        atualizarGraficoComparacao();
      }
    }

    function excluirGastoReal(id) {
      if (!confirm("Tem certeza que deseja excluir este gasto?")) return;
      
      const gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      const novoArray = gastosReaisArray.filter(g => g.id !== id);
      
      localStorage.setItem("gastosReais", JSON.stringify(novoArray));
      
      carregarGastosReais();
      atualizarResumoFaturas();
      atualizarGraficoComparacao();
    }

    // Função para determinar a fatura de um gasto de cartão
    function determinarFatura(dataGasto, cartao) {
      const diaFechamento = parseInt(cartao.diaFechamento);
      const diaVencimento = parseInt(cartao.diaVencimento);
      
      // Clonar a data para não modificar a original
      const dataGastoObj = new Date(dataGasto);
      
      // Obter o dia do mês da data do gasto
      const diaGasto = dataGastoObj.getDate();
      
      // Determinar o mês e ano da fatura
      let mesFatura, anoFatura;
      
      if (diaGasto > diaFechamento) {
        // Se o dia do gasto for após o fechamento, entra na fatura do mês seguinte
        mesFatura = dataGastoObj.getMonth() + 1;
        anoFatura = dataGastoObj.getFullYear();
        
        // Ajustar se passar para o próximo ano
        if (mesFatura > 11) {
          mesFatura = 0;
          anoFatura++;
        }
      } else {
        // Se o dia do gasto for antes ou igual ao fechamento, entra na fatura do mês atual
        mesFatura = dataGastoObj.getMonth();
        anoFatura = dataGastoObj.getFullYear();
      }
      
      // Calcular a data de fechamento da fatura
      const dataFechamento = new Date(anoFatura, mesFatura, diaFechamento);
      
      // Calcular a data de vencimento da fatura
      let dataVencimento = new Date(anoFatura, mesFatura, diaVencimento);
      
      // Se o vencimento for antes do fechamento, ajustar para o mês seguinte
      if (diaVencimento < diaFechamento) {
        dataVencimento.setMonth(dataVencimento.getMonth() + 1);
      }
      
      return {
        mes: mesFatura + 1, // Ajustar para formato humano (1-12)
        ano: anoFatura,
        dataFechamento,
        dataVencimento
      };
    }

    // Função para atualizar o resumo de faturas
    function atualizarResumoFaturas() {
      const resumoFaturas = document.getElementById("resumoFaturas");
      resumoFaturas.innerHTML = "";
      
      // Obter todos os gastos de cartão de crédito
      const gastosCartao = gastosReais.filter(g => g.formaPagamento === "credito" && g.fatura);
      
      if (gastosCartao.length === 0) {
        resumoFaturas.innerHTML = "<p>Nenhuma fatura encontrada.</p>";
        return;
      }
      
      // Agrupar gastos por fatura
      const faturas = {};
      
      gastosCartao.forEach(gasto => {
        const chave = `${gasto.cartaoId}-${gasto.fatura.mes}-${gasto.fatura.ano}`;
        
        if (!faturas[chave]) {
          const cartao = cartoes.find(c => c.id == gasto.cartaoId);
          
          faturas[chave] = {
            cartaoId: gasto.cartaoId,
            cartaoNome: cartao ? cartao.nome : "Cartão Desconhecido",
            mes: gasto.fatura.mes,
            ano: gasto.fatura.ano,
            dataFechamento: new Date(gasto.fatura.dataFechamento),
            dataVencimento: new Date(gasto.fatura.dataVencimento),
            gastos: [],
            total: 0
          };
        }
        
        faturas[chave].gastos.push(gasto);
        faturas[chave].total += gasto.valor;
      });
      
      // Converter para array e ordenar por data de vencimento (mais próximas primeiro)
      const faturasArray = Object.values(faturas).sort((a, b) => {
        // Primeiro por ano
        if (a.ano !== b.ano) return a.ano - b.ano;
        // Depois por mês
        if (a.mes !== b.mes) return a.mes - b.mes;
        // Por fim por cartão
        return a.cartaoNome.localeCompare(b.cartaoNome);
      });
      
      // Determinar status da fatura
      const hoje = new Date();
      
      faturasArray.forEach(fatura => {
        // Determinar status da fatura
        let status = "";
        let classeStatus = "";
        
        if (hoje > fatura.dataVencimento) {
          status = "Fechada";
          classeStatus = "fatura-fechada";
        } else if (hoje > fatura.dataFechamento) {
          status = "Atual";
          classeStatus = "fatura-atual";
        } else {
          status = "Futura";
          classeStatus = "fatura-futura";
        }
        
        // Ordenar gastos por valor (maiores primeiro)
        const gastosOrdenados = [...fatura.gastos].sort((a, b) => b.valor - a.valor);
        
        // Pegar os 5 maiores gastos
        const maioresGastos = gastosOrdenados.slice(0, 5);
        
        // Criar card de fatura
        const cardFatura = document.createElement("div");
        cardFatura.className = "card-fatura";
        cardFatura.dataset.fatura = `${fatura.mes}/${fatura.ano}`;
        cardFatura.onclick = () => {
          document.getElementById("filtroFormaPagamento").value = "credito";
          document.getElementById("filtroCartao").value = fatura.cartaoId;
          document.getElementById("filtroFatura").value = `${fatura.mes}/${fatura.ano}`;
          filtrarGastosReais();
        };
        
        cardFatura.innerHTML = `
          <div class="card-fatura-header">
            <div class="card-fatura-titulo">
              ${fatura.cartaoNome} - ${fatura.mes}/${fatura.ano}
              <span class="indicador-fatura ${classeStatus}">${status}</span>
            </div>
            <div class="card-fatura-valor">${formatarMoeda(fatura.total)}</div>
          </div>
          <div class="card-fatura-detalhes">
            <div>Fechamento: ${fatura.dataFechamento.toLocaleDateString()}</div>
            <div>Vencimento: ${fatura.dataVencimento.toLocaleDateString()}</div>
          </div>
          <div class="card-fatura-itens">
            ${maioresGastos.map(g => `
              <div class="card-fatura-item">
                <div class="card-fatura-item-descricao">${g.descricao}</div>
                <div class="card-fatura-item-valor">${formatarMoeda(g.valor)}</div>
              </div>
            `).join('')}
            ${fatura.gastos.length > 5 ? `<div style="text-align: center; margin-top: 5px; font-size: 12px; color: #b0bec5;">+ ${fatura.gastos.length - 5} outros gastos</div>` : ''}
          </div>
        `;
        
        resumoFaturas.appendChild(cardFatura);
      });
    }

    // Função para atualizar o gráfico de comparação entre planejado e real
    function atualizarGraficoComparacao() {
      const mesComparacao = parseInt(document.getElementById("mesComparacao").value);
      const canvas = document.getElementById("graficoComparacao");
      
      // Obter dados do resumo financeiro
      if (!dadosResumo) return;
      
      // Preparar dados para o gráfico
      let labels = [];
      let dadosPlanejado = [];
      let dadosReal = [];
      
      // Calcular totais reais por categoria
      const totaisReaisPorCategoria = calcularTotaisReaisPorCategoria(mesComparacao);
      
      if (mesComparacao === -1) {
        // Total anual
        labels = ["Receitas", "Despesas Fixas", "Despesas Variáveis", "Saldo"];
        
        const totalReceitasPlanejado = dadosResumo.totalReceitas;
        const totalFixasPlanejado = dadosResumo.totalFixas;
        const totalVariaveisPlanejado = dadosResumo.totalVariaveis;
        const saldoPlanejado = totalReceitasPlanejado - totalFixasPlanejado - totalVariaveisPlanejado;
        
        const totalReceitasReal = totaisReaisPorCategoria.receitas || 0;
        const totalFixasReal = totaisReaisPorCategoria.fixas || 0;
        const totalVariaveisReal = totaisReaisPorCategoria.variaveis || 0;
        const saldoReal = totalReceitasReal - totalFixasReal - totalVariaveisReal;
        
        dadosPlanejado = [totalReceitasPlanejado, totalFixasPlanejado, totalVariaveisPlanejado, saldoPlanejado];
        dadosReal = [totalReceitasReal, totalFixasReal, totalVariaveisReal, saldoReal];
      } else {
        // Mês específico
        labels = ["Receitas", "Despesas Fixas", "Despesas Variáveis", "Saldo"];
        
        const totalReceitasPlanejado = dadosResumo.receitasPorMes[mesComparacao];
        const totalFixasPlanejado = dadosResumo.fixasPorMes[mesComparacao];
        const totalVariaveisPlanejado = dadosResumo.variaveisPorMes[mesComparacao];
        const saldoPlanejado = totalReceitasPlanejado - totalFixasPlanejado - totalVariaveisPlanejado;
        
        const totalReceitasReal = totaisReaisPorCategoria.receitas || 0;
        const totalFixasReal = totaisReaisPorCategoria.fixas || 0;
        const totalVariaveisReal = totaisReaisPorCategoria.variaveis || 0;
        const saldoReal = totalReceitasReal - totalFixasReal - totalVariaveisReal;
        
        dadosPlanejado = [totalReceitasPlanejado, totalFixasPlanejado, totalVariaveisPlanejado, saldoPlanejado];
        dadosReal = [totalReceitasReal, totalFixasReal, totalVariaveisReal, saldoReal];
      }
      
      // Criar ou atualizar o gráfico
      if (graficoComparacaoInstance) {
        graficoComparacaoInstance.data.labels = labels;
        graficoComparacaoInstance.data.datasets[0].data = dadosPlanejado;
        graficoComparacaoInstance.data.datasets[1].data = dadosReal;
        graficoComparacaoInstance.update();
      } else {
        graficoComparacaoInstance = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Planejado',
                data: dadosPlanejado,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              },
              {
                label: 'Real',
                data: dadosReal,
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R$ ' + value.toLocaleString('pt-BR');
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                }
              }
            }
          }
        });
      }
      
      // Atualizar a tabela de resumo com os valores reais
      atualizarTabelaResumoComReais();
    }

    // Função para calcular totais reais por categoria
    function calcularTotaisReaisPorCategoria(mes) {
      const gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      const lancamentosArray = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      
      // Inicializar objeto de totais
      const totais = {
        receitas: 0,
        fixas: 0,
        variaveis: 0
      };
      
      // Filtrar gastos pelo mês, se necessário
      let gastosFiltrados = gastosReaisArray;
      
      if (mes >= 0) {
        gastosFiltrados = gastosReaisArray.filter(gasto => {
          const dataGasto = new Date(gasto.data);
          return dataGasto.getMonth() === mes;
        });
      }
      
      // Processar cada gasto
      gastosFiltrados.forEach(gasto => {
        // Se o gasto está associado a um lançamento, usar o tipo do lançamento
        if (gasto.lancamentoId) {
          const lancamento = lancamentosArray.find(l => l.id == gasto.lancamentoId);
          if (lancamento) {
            if (lancamento.tipo === "receita") {
              totais.receitas += gasto.valor;
            } else if (lancamento.tipo === "fixa") {
              totais.fixas += gasto.valor;
            } else if (lancamento.tipo === "variavel") {
              totais.variaveis += gasto.valor;
            }
            return;
          }
        }
        
        // Se não está associado a um lançamento ou o lançamento não foi encontrado
        // Assumir que é uma despesa variável, a menos que seja explicitamente uma receita
        if (gasto.valor < 0) {
          totais.receitas += gasto.valor; // Valor negativo = receita
        } else {
          totais.variaveis += gasto.valor;
        }
      });
      
      return totais;
    }

    // Função para atualizar a tabela de resumo com os valores reais
    function atualizarTabelaResumoComReais() {
      // Verificar se a tabela de resumo existe
      const tabelaResumo = document.getElementById("resumoBody");
      if (!tabelaResumo) return;
      
      // Obter todas as linhas da tabela
      const linhas = tabelaResumo.querySelectorAll("tr");
      
      // Calcular totais reais por categoria para cada mês
      const totaisReaisPorMes = [];
      for (let mes = 0; mes < 12; mes++) {
        totaisReaisPorMes.push(calcularTotaisReaisPorCategoria(mes));
      }
      
      // Calcular total anual
      const totalAnual = calcularTotaisReaisPorCategoria(-1);
      
      // Atualizar cada linha da tabela
      linhas.forEach(linha => {
        const celulas = linha.querySelectorAll("td");
        if (celulas.length < 2) return;
        
        const categoria = celulas[0].textContent.trim();
        let tipoCategoria = "";
        
        if (categoria === "Receitas") {
          tipoCategoria = "receitas";
        } else if (categoria === "Despesas Fixas") {
          tipoCategoria = "fixas";
        } else if (categoria === "Despesas Variáveis") {
          tipoCategoria = "variaveis";
        } else if (categoria === "Saldo") {
          tipoCategoria = "saldo";
        } else {
          return; // Pular outras categorias
        }
        
        // Atualizar cada célula de mês
        for (let mes = 0; mes < 12; mes++) {
          const celula = celulas[mes + 1]; // +1 porque a primeira célula é o nome da categoria
          if (!celula) continue;
          
          const valorPlanejado = parseFloat(celula.textContent.replace(/[^\d,-]/g, "").replace(".", "").replace(",", ".")) || 0;
          let valorReal = 0;
          
          if (tipoCategoria === "saldo") {
            valorReal = totaisReaisPorMes[mes].receitas - totaisReaisPorMes[mes].fixas - totaisReaisPorMes[mes].variaveis;
          } else {
            valorReal = totaisReaisPorMes[mes][tipoCategoria] || 0;
          }
          
          // Calcular variação percentual
          const variacao = valorPlanejado !== 0 ? ((valorReal - valorPlanejado) / Math.abs(valorPlanejado) * 100) : 0;
          const classeVariacao = variacao > 0 ? "variacao-positiva" : variacao < 0 ? "variacao-negativa" : "";
          
          // Atualizar conteúdo da célula
          celula.innerHTML = `
            <div class="comparacao-valor">
              <div class="valor-real">${formatarMoeda(valorReal)}</div>
              <div class="valor-planejado">${formatarMoeda(valorPlanejado)}</div>
              ${Math.abs(variacao) > 0.1 ? `<div class="${classeVariacao}">${variacao > 0 ? "+" : ""}${variacao.toFixed(1)}%</div>` : ""}
            </div>
          `;
        }
        
        // Atualizar célula de total
        const celulaTotal = celulas[13]; // Índice 13 para a coluna de total
        if (celulaTotal) {
          const valorPlanejadoTotal = parseFloat(celulaTotal.textContent.replace(/[^\d,-]/g, "").replace(".", "").replace(",", ".")) || 0;
          let valorRealTotal = 0;
          
          if (tipoCategoria === "saldo") {
            valorRealTotal = totalAnual.receitas - totalAnual.fixas - totalAnual.variaveis;
          } else {
            valorRealTotal = totalAnual[tipoCategoria] || 0;
          }
          
          // Calcular variação percentual
          const variacaoTotal = valorPlanejadoTotal !== 0 ? ((valorRealTotal - valorPlanejadoTotal) / Math.abs(valorPlanejadoTotal) * 100) : 0;
          const classeVariacaoTotal = variacaoTotal > 0 ? "variacao-positiva" : variacaoTotal < 0 ? "variacao-negativa" : "";
          
          // Atualizar conteúdo da célula
          celulaTotal.innerHTML = `
            <div class="comparacao-valor">
              <div class="valor-real">${formatarMoeda(valorRealTotal)}</div>
              <div class="valor-planejado">${formatarMoeda(valorPlanejadoTotal)}</div>
              ${Math.abs(variacaoTotal) > 0.1 ? `<div class="${classeVariacaoTotal}">${variacaoTotal > 0 ? "+" : ""}${variacaoTotal.toFixed(1)}%</div>` : ""}
            </div>
          `;
        }
        
        // Atualizar célula de média
        const celulaMedia = celulas[14]; // Índice 14 para a coluna de média
        if (celulaMedia) {
          const valorPlanejadoMedia = parseFloat(celulaMedia.textContent.replace(/[^\d,-]/g, "").replace(".", "").replace(",", ".")) || 0;
          let valorRealMedia = valorRealTotal / 12;
          
          // Calcular variação percentual
          const variacaoMedia = valorPlanejadoMedia !== 0 ? ((valorRealMedia - valorPlanejadoMedia) / Math.abs(valorPlanejadoMedia) * 100) : 0;
          const classeVariacaoMedia = variacaoMedia > 0 ? "variacao-positiva" : variacaoMedia < 0 ? "variacao-negativa" : "";
          
          // Atualizar conteúdo da célula
          celulaMedia.innerHTML = `
            <div class="comparacao-valor">
              <div class="valor-real">${formatarMoeda(valorRealMedia)}</div>
              <div class="valor-planejado">${formatarMoeda(valorPlanejadoMedia)}</div>
              ${Math.abs(variacaoMedia) > 0.1 ? `<div class="${classeVariacaoMedia}">${variacaoMedia > 0 ? "+" : ""}${variacaoMedia.toFixed(1)}%</div>` : ""}
            </div>
          `;
        }
      });
    }

  </script>
</body>
</html>
