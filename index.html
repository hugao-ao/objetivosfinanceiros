<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Financeiro V6 - Edição</title> <!-- Versão atualizada -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002d26;
      color: white;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    .saldo-positivo {
         color: #1976d2; /* Azul não brilhante */
    }
    .saldo-negativo {
        color: #c62828; /* Vermelho não brilhante */
    }
    h1 {
      margin: 0 0 20px;
    }
    .cartao-laranja {
        color: #f57c00; /* Laranja não brilhante */
    }
    .conta-amarela {
        color: #fbc02d; /* Amarelo não brilhante */
    }
    .container-principal {
      display: flex;
      width: 200%; /* Mantido para o slide do resumo */
      transition: transform 0.5s ease;
    }

    .container-ativo {
      transform: translateX(-50%); /* Mantido para mostrar o resumo */
    }

    /* Nova seção para conter apenas a tabela de lançamentos */
    .secao-lancamentos {
      width: 50%; /* Ocupa metade do container principal */
      padding-right: 20px;
      box-sizing: border-box;
    }

    .secao-resumo {
      width: 50%; /* Ocupa a outra metade */
      padding-left: 20px;
      box-sizing: border-box;
    }

    /* Estilos para o Modal */
    .modal {
      display: none; /* Escondido por padrão */
      position: fixed; 
      z-index: 100; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      padding-top: 60px;
    }

    .modal-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 10px;
      position: relative;
    }

    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #ffd700;
      text-decoration: none;
      cursor: pointer;
    }

    /* Formulário dentro do Modal */
    .form-section-modal {
      padding: 0; 
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .botoes-formulario {
      grid-column: 1 / -1; 
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .table-container {
      background-color: #014034;
      border-radius: 10px;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #006a56;
      text-align: center;
    }

    th {
      background-color: #006a56;
      color: #ffd700;
      position: sticky;
      top: 0;
      z-index: 5; 
    }
    
    th.descricao-header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        padding-right: 5px; 
    }

    .botao-abrir-modal {
        background-color: #ffd700;
        color: #002d26;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 18px;
        font-weight: bold;
        line-height: 24px; 
        text-align: center;
        cursor: pointer;
        margin-left: 10px;
        padding: 0;
    }

    .botao-abrir-modal:hover {
        background-color: #ffc400;
    }

    .receita { color: #4caf50; }
    .fixa { color: #f44336; }
    .variavel { color: #ff9800; }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }

    .botao-acao-modal {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-acao-modal:hover {
      background-color: #ffc400;
    }

    /* Botão Resumo Fixo */
    .botao-resumo-fixo {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 50;
      background-color: #2196F3;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: opacity 0.3s ease, visibility 0.3s ease; /* Adiciona transição */
      opacity: 1;
      visibility: visible;
    }
    
    /* Esconde o botão quando o resumo está ativo */
    .container-ativo ~ .botao-resumo-fixo {
        opacity: 0;
        visibility: hidden;
    }

    .botao-resumo-fixo:hover {
      background-color: #0b7dda;
    }

    .botao-voltar {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .botao-voltar:hover {
      background-color: #e68a00;
    }

    .delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }
    
    .hidden-id {
      display: none;
    }

    .resumo-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }
    
    /* Congelar a primeira coluna (Categoria) - Tabela Resumo */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaResumo thead tr th:first-child {
      background-color: #006a56; 
      z-index: 20; 
    }
    #tabelaResumo tbody tr td:first-child {
      font-weight: bold; 
    }

    /* Congelar a coluna Descrição - Tabela Lançamentos */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: #006a56; 
      z-index: 20;
    }
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; 
      cursor: pointer; /* Adicionado para indicar clicável */
      text-decoration: underline;
      text-decoration-color: rgba(255, 255, 255, 0.3);
    }
    #tabelaLancamentos tbody tr td:nth-child(2):hover {
        background-color: rgba(255, 255, 255, 0.1);
        text-decoration-color: white;
    }

    /* Estilo para células editáveis (valores mensais) */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: #014034;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 14px;
      box-sizing: border-box;
    }
    .edit-input:focus {
      outline: 2px solid #ffd700;
    }
    
    /* Estilos para os gráficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .grafico-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      width: calc(50% - 40px);
      min-width: 400px;
      box-sizing: border-box;
    }
    .grafico-titulo {
      text-align: center;
      margin-bottom: 15px;
      color: #ffd700;
      font-size: 16px;
    }
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    .seletor-mes {
      text-align: center;
      margin-bottom: 20px;
    }
    .seletor-mes select {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
      font-weight: bold;
    }
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      width: 100%;
    }
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 14px;
      width: 100%;
    }
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .valor-legenda {
      margin-left: 5px;
      font-weight: bold;
    }
    .descricao-legenda {
      min-width: 120px;
    }
    
    /* Linha de espaçamento na tabela de resumo */
    .spacer-row td {
        height: 10px; /* Altura do espaço */
        padding: 0;
        border: none; /* Remove bordas */
        background-color: #002d26; /* Cor de fundo do corpo */
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Controle Financeiro</h1>
  
  <!-- Container Principal (Lançamentos e Resumo) -->
  <div class="container-principal" id="containerPrincipal">
    <!-- Seção da Tabela de Lançamentos -->
    <div class="secao-lancamentos">
      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModalNovo" class="botao-abrir-modal" onclick="abrirModalParaNovo()">+</button>
              </th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lançamentos serão inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seção do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th> <!-- Nova coluna Média -->
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo será inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Seção dos Gráficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o mês: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="-2">Médias Mensais</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas e Poupança</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Relação às Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botão Resumo Fixo (movido para fora do container principal para CSS funcionar) -->
  <button class="botao-resumo-fixo" onclick="mostrarResumo()">Ver Resumo e Análises</button>

  <!-- Modal do Formulário -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2 id="modalTitulo">Novo Lançamento</h2> <!-- ID adicionado -->
      <input type="hidden" id="lancamentoId" /> <!-- Campo oculto para ID -->
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button id="botaoAcaoModal" class="botao-acao-modal" onclick="adicionarLancamento()">Lançar Item</button> <!-- ID e classe alterados -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let dadosResumo = null;
    let lancamentos = [];
    const modal = document.getElementById("modalFormulario");
    const modalTitulo = document.getElementById("modalTitulo");
    const botaoAcaoModal = document.getElementById("botaoAcaoModal");
    const lancamentoIdInput = document.getElementById("lancamentoId");
    const containerPrincipal = document.getElementById("containerPrincipal");
    const botaoResumoFixo = document.querySelector(".botao-resumo-fixo"); 

    // Funções do Modal
    function limparFormularioModal() {
        document.getElementById("descricao").value = "";
        document.getElementById("valor").value = "";
        document.getElementById("tipoLancamento").value = "receita";
        document.getElementById("formaPagamento").value = "conta";
        document.getElementById("frequenciaValor").value = "1";
        document.getElementById("frequenciaTipo").value = "meses";
        document.getElementById("dataInicial").value = "";
        document.getElementById("dataFinal").value = "";
        lancamentoIdInput.value = ""; // Limpa o ID oculto
    }

    function abrirModalParaNovo() {
      limparFormularioModal();
      const today = new Date();
      const currentYear = today.getFullYear();
      document.getElementById("dataInicial").value = `${currentYear}-01-01`;
      document.getElementById("dataFinal").value = `${currentYear}-12-31`;
      modalTitulo.textContent = "Novo Lançamento";
      botaoAcaoModal.textContent = "Lançar Item";
      botaoAcaoModal.onclick = adicionarLancamento; // Define a função de adicionar
      modal.style.display = "block";
    }

    function abrirModalParaEditar(id) {
      const lancamento = lancamentos.find(l => l.id === id);
      if (!lancamento) {
          console.error("Lançamento não encontrado para edição: ID", id);
          return;
      }
      
      limparFormularioModal(); // Limpa antes de preencher

      document.getElementById("descricao").value = lancamento.descricao;
      // Formata o valor para exibição no input (sem R$, com vírgula)
      document.getElementById("valor").value = lancamento.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace('.', ',');
      document.getElementById("tipoLancamento").value = lancamento.tipo;
      document.getElementById("formaPagamento").value = lancamento.formaPagamento;
      document.getElementById("frequenciaValor").value = lancamento.frequenciaValor;
      document.getElementById("frequenciaTipo").value = lancamento.frequenciaTipo;
      document.getElementById("dataInicial").value = lancamento.dataInicial;
      document.getElementById("dataFinal").value = lancamento.dataFinal;
      lancamentoIdInput.value = lancamento.id; // Define o ID oculto

      modalTitulo.textContent = "Editar Lançamento";
      botaoAcaoModal.textContent = "Salvar Alterações";
      botaoAcaoModal.onclick = salvarEdicao; // Define a função de salvar edição
      modal.style.display = "block";
    }

    function fecharModal() {
      limparFormularioModal(); // Limpa o formulário ao fechar
      modal.style.display = "none";
    }

    window.onclick = function (event) {
      if (event.target == modal) {
        fecharModal();
      }
    };

    // Funções de Navegação e Exibição
    function mostrarResumo() {
      containerPrincipal.classList.add("container-ativo");
    }

    function voltarParaLancamentos() {
      containerPrincipal.classList.remove("container-ativo");
    }

    // Funções de Formatação e Cálculo
    function formatarMoeda(valor) {
      const numero = typeof valor === "number" ? valor : parseFloat(String(valor).replace(/[^\d,-]/g, "").replace(",", "."));
      if (isNaN(numero)) return "R$ 0,00";
      return numero.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }
    
    function parseValor(valorString) {
        // Remove pontos e substitui vírgula por ponto
        return parseFloat(String(valorString).replace(/\./g, '').replace(',', '.'));
    }

    function calcularOcorrencias(lancamento, ano) {
      // --- Função calcularOcorrencias (sem alterações) --- 
      const startDate = new Date(lancamento.dataInicial + "T00:00:00");
      const endDate = new Date(lancamento.dataFinal + "T00:00:00");
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        console.error("Datas inválidas para o lançamento:", lancamento);
        return [];
      }
      const ocorrencias = [];
      if (lancamento.frequenciaTipo === "unico") {
        if (startDate.getFullYear() === ano) {
          ocorrencias.push(new Date(startDate));
        }
        return ocorrencias;
      }
      const inicioAno = new Date(`${ano}-01-01T00:00:00`);
      const fimAno = new Date(`${ano}-12-31T00:00:00`);
      const dataInicioCalculo = startDate > inicioAno ? startDate : inicioAno;
      const dataFimCalculo = endDate < fimAno ? endDate : fimAno;
      if (dataInicioCalculo > dataFimCalculo) return ocorrencias;
      let currentDate = new Date(dataInicioCalculo);
      let safetyBreak = 0; // Safety break
      while (currentDate <= dataFimCalculo && safetyBreak < 500) {
        if (currentDate >= startDate && currentDate <= endDate && currentDate.getFullYear() === ano) {
          ocorrencias.push(new Date(currentDate));
        }
        const currentDayOfMonth = currentDate.getDate();
        let dataAnterior = new Date(currentDate);
        switch (lancamento.frequenciaTipo) {
          case "dias": currentDate.setDate(currentDate.getDate() + lancamento.frequenciaValor); break;
          case "dias_uteis":
            let diasAdicionados = 0;
            while (diasAdicionados < lancamento.frequenciaValor) {
              currentDate.setDate(currentDate.getDate() + 1);
              if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) diasAdicionados++;
            }
            break;
          case "meses":
            currentDate.setMonth(currentDate.getMonth() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "anos":
            currentDate.setFullYear(currentDate.getFullYear() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "semanas": currentDate.setDate(currentDate.getDate() + 7 * lancamento.frequenciaValor); break;
          case "quinzenas": currentDate.setDate(currentDate.getDate() + 15 * lancamento.frequenciaValor); break;
          case "segunda": case "terca": case "quarta": case "quinta": case "sexta":
            const diaSemana = { segunda: 1, terca: 2, quarta: 3, quinta: 4, sexta: 5 };
            const diaAlvo = diaSemana[lancamento.frequenciaTipo];
            do { currentDate.setDate(currentDate.getDate() + 1); } while (currentDate.getDay() !== diaAlvo);
            if (lancamento.frequenciaValor > 1) currentDate.setDate(currentDate.getDate() + 7 * (lancamento.frequenciaValor - 1));
            break;
          default:
            console.warn("Tipo de frequência desconhecido:", lancamento.frequenciaTipo);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        if (currentDate.getTime() === dataAnterior.getTime()) {
          console.error("Loop infinito detectado em calcularOcorrencias", lancamento);
          break;
        }
        safetyBreak++;
        if (safetyBreak >= 500) console.error("Safety break atingido em calcularOcorrencias", lancamento);
      }
      return ocorrencias;
    }
    
    function calcularTotaisPorCategoria(lancamentosCategoria, ano) {
      // --- Função calcularTotaisPorCategoria (sem alterações) --- 
      const meses = Array(12).fill(0);
      
      lancamentosCategoria.forEach(l => {
        const ocorrencias = calcularOcorrencias(l, ano);
        // Para cada mês do ano
        for (let index = 0; index < 12; index++) {
          // Verifica se há valor manual para este mês específico
          if (l.valoresManuais && l.valoresManuais[index] !== null && l.valoresManuais[index] !== undefined) {
            meses[index] += l.valoresManuais[index];
          } else {
            // Senão, verifica quantas ocorrências calculadas existem neste mês
            const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
            if (ocorrenciasNoMes.length > 0) {
              // Adiciona o valor base multiplicado pelo número de ocorrências no mês
              meses[index] += l.valor * ocorrenciasNoMes.length; 
            }
          }
        }
      });
      
      const total = meses.reduce((sum, val) => sum + val, 0);
      return { meses, total };
    }

    // Funções CRUD (Create, Read, Update, Delete) e Persistência
    function adicionarLancamento() {
      const descricao = document.getElementById("descricao").value.trim();
      const valorString = document.getElementById("valor").value;
      const tipo = document.getElementById("tipoLancamento").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const frequenciaValor = parseInt(document.getElementById("frequenciaValor").value) || 1;
      const frequenciaTipo = document.getElementById("frequenciaTipo").value;
      const dataInicial = document.getElementById("dataInicial").value;
      const dataFinal = document.getElementById("dataFinal").value;

      if (!descricao || !valorString || !dataInicial || !dataFinal) {
        alert("Por favor, preencha todos os campos obrigatórios (Descrição, Valor, Data Inicial, Data Final).");
        return;
      }
      
      const valor = parseValor(valorString);
      if (isNaN(valor)) {
        alert("Valor inválido. Use o formato 1.234,56.");
        return;
      }

      const novoLancamento = {
        id: Date.now(), // ID único baseado no timestamp
        descricao,
        valor,
        tipo,
        formaPagamento,
        frequenciaValor,
        frequenciaTipo,
        dataInicial,
        dataFinal,
        valoresManuais: Array(12).fill(null), // Inicializa valores manuais
      };

      lancamentos.push(novoLancamento);
      salvarLancamentos();
      atualizarInterface();
      fecharModal();
    }

    function salvarEdicao() {
      const id = parseInt(lancamentoIdInput.value);
      if (!id) {
          console.error("ID do lançamento não encontrado para salvar edição.");
          alert("Erro ao salvar alterações. ID não encontrado.");
          return;
      }

      const index = lancamentos.findIndex(l => l.id === id);
      if (index === -1) {
          console.error("Lançamento não encontrado no array para edição: ID", id);
          alert("Erro ao salvar alterações. Lançamento original não encontrado.");
          return;
      }

      const descricao = document.getElementById("descricao").value.trim();
      const valorString = document.getElementById("valor").value;
      const tipo = document.getElementById("tipoLancamento").value;
      const formaPagamento = document.getElementById("formaPagamento").value;
      const frequenciaValor = parseInt(document.getElementById("frequenciaValor").value) || 1;
      const frequenciaTipo = document.getElementById("frequenciaTipo").value;
      const dataInicial = document.getElementById("dataInicial").value;
      const dataFinal = document.getElementById("dataFinal").value;

      if (!descricao || !valorString || !dataInicial || !dataFinal) {
        alert("Por favor, preencha todos os campos obrigatórios (Descrição, Valor, Data Inicial, Data Final).");
        return;
      }
      
      const valor = parseValor(valorString);
      if (isNaN(valor)) {
        alert("Valor inválido. Use o formato 1.234,56.");
        return;
      }
      
      // Mantém os valoresManuais existentes
      const valoresManuaisExistentes = lancamentos[index].valoresManuais || Array(12).fill(null);

      // Atualiza o lançamento existente no array
      lancamentos[index] = {
        ...lancamentos[index], // Mantém propriedades não editáveis (como ID e valoresManuais)
        id: id, // Garante que o ID seja mantido
        descricao,
        valor,
        tipo,
        formaPagamento,
        frequenciaValor,
        frequenciaTipo,
        dataInicial,
        dataFinal,
        valoresManuais: valoresManuaisExistentes // Preserva edições manuais anteriores
      };

      salvarLancamentos();
      atualizarInterface();
      fecharModal();
    }

    function excluirLancamento(id) {
      if (confirm("Tem certeza que deseja excluir este lançamento?")) {
        lancamentos = lancamentos.filter(l => l.id !== id);
        salvarLancamentos();
        atualizarInterface();
      }
    }
    
    function editarValorManual(id, mesIndex, novoValorString) {
        const index = lancamentos.findIndex(l => l.id === id);
        if (index === -1) return;

        let novoValor = null;
        if (novoValorString.trim() !== "") {
            novoValor = parseValor(novoValorString);
            if (isNaN(novoValor)) {
                alert("Valor inválido. Use o formato 1.234,56 ou deixe em branco para usar o cálculo automático.");
                return; // Não atualiza se o valor for inválido
            }
        }
        
        // Inicializa valoresManuais se não existir
        if (!lancamentos[index].valoresManuais) {
            lancamentos[index].valoresManuais = Array(12).fill(null);
        }

        lancamentos[index].valoresManuais[mesIndex] = novoValor;
        salvarLancamentos();
        atualizarInterface(); // Atualiza tudo para refletir a mudança
    }

    function salvarLancamentos() {
      localStorage.setItem("controleFinanceiroLancamentos_v6", JSON.stringify(lancamentos));
    }

    function carregarLancamentos() {
      const dadosSalvos = localStorage.getItem("controleFinanceiroLancamentos_v6");
      if (dadosSalvos) {
        lancamentos = JSON.parse(dadosSalvos);
        // Garante que IDs e valoresManuais existam (migração de versões antigas)
        lancamentos.forEach(l => {
            if (!l.id) l.id = Date.now() + Math.random(); // Adiciona ID se não existir
            if (!l.valoresManuais) l.valoresManuais = Array(12).fill(null);
        });
      } else {
        lancamentos = [];
      }
    }

    // Funções de Atualização da Interface
    function atualizarTabelaLancamentos(lancamentos, ano) {
      const tabelaBody = document.getElementById("tabelaBody");
      tabelaBody.innerHTML = "";

      lancamentos.sort((a, b) => a.descricao.localeCompare(b.descricao)); // Ordena por descrição

      lancamentos.forEach((l) => {
        const row = tabelaBody.insertRow();
        row.className = l.tipo === "receita" ? "receita" : (l.tipo === "fixa" ? "fixa" : "variavel");
        if (l.formaPagamento === "credito" && l.tipo !== "receita") {
          row.classList.add("cartao-credito");
        }

        const cellId = row.insertCell();
        cellId.className = "hidden-id";
        cellId.textContent = l.id;

        const cellDescricao = row.insertCell();
        cellDescricao.textContent = l.descricao;
        cellDescricao.onclick = () => abrirModalParaEditar(l.id); // Adiciona evento de clique para editar
        cellDescricao.style.textAlign = "left";

        const totais = calcularTotaisPorCategoria([l], ano); // Calcula totais para este lançamento
        let totalLancamento = 0;
        let mesesComValor = 0;

        for (let i = 0; i < 12; i++) {
          const cellMes = row.insertCell();
          cellMes.classList.add("editable");
          const valorMes = (l.valoresManuais && l.valoresManuais[i] !== null && l.valoresManuais[i] !== undefined) 
                             ? l.valoresManuais[i] 
                             : totais.meses[i]; // Usa valor manual ou calculado
          cellMes.textContent = formatarMoeda(valorMes);
          totalLancamento += valorMes;
          if (valorMes !== 0) {
              mesesComValor++;
          }
          
          // Lógica de Edição Inline (mantida)
          cellMes.addEventListener('click', (e) => {
              if (e.target.tagName === 'INPUT') return; // Não faz nada se já estiver editando

              const currentValue = (l.valoresManuais && l.valoresManuais[i] !== null && l.valoresManuais[i] !== undefined) 
                                    ? l.valoresManuais[i].toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace('.', ',')
                                    : ''; // Mostra vazio se for valor calculado
              cellMes.innerHTML = `<input type="text" class="edit-input" value="${currentValue}" data-month-index="${i}" data-lancamento-id="${l.id}">`;
              const input = cellMes.querySelector('input');
              input.focus();

              input.addEventListener('blur', () => {
                  editarValorManual(l.id, i, input.value);
                  // A atualização da interface já é chamada dentro de editarValorManual
              });

              input.addEventListener('keydown', (event) => {
                  if (event.key === 'Enter') {
                      input.blur();
                  } else if (event.key === 'Escape') {
                      // Reverte para o valor original (formatado)
                      cellMes.textContent = formatarMoeda(valorMes);
                  }
              });
          });
        }

        const cellTotal = row.insertCell();
        cellTotal.textContent = formatarMoeda(totalLancamento);

        const cellMedia = row.insertCell();
        const media = mesesComValor > 0 ? totalLancamento / mesesComValor : 0;
        cellMedia.textContent = formatarMoeda(media);

        const cellAcoes = row.insertCell();
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Excluir";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => excluirLancamento(l.id);
        cellAcoes.appendChild(deleteBtn);
      });
    }

    function atualizarResumoFinanceiro(lancamentos, ano) {
      // --- Função atualizarResumoFinanceiro (sem alterações na lógica principal, mas usa calcularTotaisPorCategoria atualizado) ---
      const resumoBody = document.getElementById("resumoBody");
      resumoBody.innerHTML = "";

      const receitas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "receita"), ano);
      const fixas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "fixa"), ano);
      const variaveis = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "variavel"), ano);
      const cartao = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "credito" && l.tipo !== "receita"), ano);
      const conta = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "conta" && l.tipo !== "receita"), ano);

      const totalReceitas = receitas.total;
      const totalFixas = fixas.total;
      const totalVariaveis = variaveis.total;
      const totalDespesas = totalFixas + totalVariaveis;
      const saldo = totalReceitas - totalDespesas;
      
      // Calcula médias
      const mediaReceitas = totalReceitas / 12;
      const mediaFixas = totalFixas / 12;
      const mediaVariaveis = totalVariaveis / 12;
      const mediaTotalDespesas = totalDespesas / 12;
      const mediaSaldo = saldo / 12;
      const mediaCartao = cartao.total / 12;
      const mediaConta = conta.total / 12;
      
      // Linha de espaçamento (HTML string)
      const spacerRowHTML = `<tr class="spacer-row"><td colspan="15"></td></tr>`; // Colspan = 1 (Cat) + 12 (Meses) + 1 (Total) + 1 (Média)

      resumoBody.innerHTML = `
        <tr class="receita">
          <td>Receitas</td>
          ${receitas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalReceitas)}</td>
          <td>${formatarMoeda(mediaReceitas)}</td>
        </tr>
        ${spacerRowHTML} 
        <tr class="fixa">
          <td>Despesas Fixas</td>
          ${fixas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalFixas)}</td>
          <td>${formatarMoeda(mediaFixas)}</td>
        </tr>
        <tr class="variavel">
          <td>Despesas Variáveis</td>
          ${variaveis.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalVariaveis)}</td>
          <td>${formatarMoeda(mediaVariaveis)}</td>
        </tr>
        <tr>
          <td>Total Despesas</td>
          ${Array(12).fill(0).map((_, i) => {
            const mesTotal = (fixas.meses[i] || 0) + (variaveis.meses[i] || 0);
            return `<td>${formatarMoeda(mesTotal)}</td>`;
          }).join("")}
          <td>${formatarMoeda(totalDespesas)}</td>
          <td>${formatarMoeda(mediaTotalDespesas)}</td>
        </tr>
        ${spacerRowHTML}
        <tr> 
          <td class="saldo-positivo">Potencial de Investimento</td> <!-- Sempre azul -->
          ${Array(12).fill(0).map((_, i) => {
            const mesSaldo = (receitas.meses[i] || 0) - (fixas.meses[i] || 0) - (variaveis.meses[i] || 0);
            const classeCor = mesSaldo >= 0 ? "saldo-positivo" : "saldo-negativo";
            return `<td class="${classeCor}">${formatarMoeda(mesSaldo)}</td>`;
          }).join("")}
          <td class="${saldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(saldo)}</td>
          <td class="${mediaSaldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(mediaSaldo)}</td>
        </tr>
        ${spacerRowHTML}
        <tr class="cartao-laranja">
          <td>Cartão de Crédito</td>
          ${cartao.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(cartao.total)}</td>
          <td>${formatarMoeda(mediaCartao)}</td>
        </tr>
        <tr class="conta-amarela">
          <td>Conta</td>
          ${conta.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(conta.total)}</td>
          <td>${formatarMoeda(mediaConta)}</td>
        </tr>
      `;

      dadosResumo = {
        receitas: receitas,
        fixas: fixas,
        variaveis: variaveis,
        totalReceitas: totalReceitas,
        totalFixas: totalFixas,
        totalVariaveis: totalVariaveis,
        totalDespesas: totalDespesas,
        saldo: saldo,
        mediaReceitas: mediaReceitas, 
        mediaFixas: mediaFixas,       
        mediaVariaveis: mediaVariaveis, 
        mediaSaldo: mediaSaldo,       
        lancamentos: lancamentos, // Passa os lançamentos originais para o gráfico
      };

      atualizarGraficos();
    }

    function atualizarGraficos() {
      // --- Função atualizarGraficos (sem alterações) --- 
      if (!dadosResumo) return;
      const mesSelecionado = parseInt(document.getElementById("mesSelecionado").value);
      let receitaPeriodo, fixasPeriodo, variaveisPeriodo, saldoPeriodo;
      let tituloExtra = ""; // Para adicionar ao título do gráfico

      if (mesSelecionado === -1) { // Total Anual
        receitaPeriodo = dadosResumo.totalReceitas;
        fixasPeriodo = dadosResumo.totalFixas;
        variaveisPeriodo = dadosResumo.totalVariaveis;
        saldoPeriodo = dadosResumo.saldo;
        tituloExtra = " (Total Anual)";
      } else if (mesSelecionado === -2) { // Médias Mensais
        receitaPeriodo = dadosResumo.mediaReceitas;
        fixasPeriodo = dadosResumo.mediaFixas;
        variaveisPeriodo = dadosResumo.mediaVariaveis;
        saldoPeriodo = dadosResumo.mediaSaldo;
        tituloExtra = " (Médias Mensais)";
      } else { // Mês específico
        receitaPeriodo = dadosResumo.receitas.meses[mesSelecionado] || 0;
        fixasPeriodo = dadosResumo.fixas.meses[mesSelecionado] || 0;
        variaveisPeriodo = dadosResumo.variaveis.meses[mesSelecionado] || 0;
        saldoPeriodo = receitaPeriodo - fixasPeriodo - variaveisPeriodo;
        const nomeMes = document.getElementById("mesSelecionado").options[document.getElementById("mesSelecionado").selectedIndex].text;
        tituloExtra = ` (${nomeMes})`;
      }

      atualizarGraficoDespesasPoupanca(fixasPeriodo, variaveisPeriodo, saldoPeriodo, tituloExtra);
      atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado, tituloExtra);
    }

    function atualizarGraficoDespesasPoupanca(fixas, variaveis, saldo, tituloExtra) {
      // --- Função atualizarGraficoDespesasPoupanca (sem alterações na lógica, apenas título) --- 
      const ctx = document.getElementById("graficoDespesasPoupanca").getContext("2d");
      const legendaDiv = document.getElementById("legendaDespesasPoupanca");
      legendaDiv.innerHTML = ''; // Limpa legenda anterior
      if (graficoDespesasPoupanca) graficoDespesasPoupanca.destroy();
      
      const poupanca = Math.max(0, saldo);
      const totalGrafico = fixas + variaveis + poupanca;
      const labels = [];
      const data = [];
      const backgroundColors = [];
      const cores = {
          fixas: '#f44336', // Vermelho
          variaveis: '#ff9800', // Laranja
          poupanca: '#4caf50' // Verde
      };

      if (fixas > 0) { labels.push("Despesas Fixas"); data.push(fixas); backgroundColors.push(cores.fixas); }
      if (variaveis > 0) { labels.push("Despesas Variáveis"); data.push(variaveis); backgroundColors.push(cores.variaveis); }
      if (poupanca > 0) { labels.push("Potencial Poupança"); data.push(poupanca); backgroundColors.push(cores.poupanca); }
      
      // Adiciona legenda HTML
      labels.forEach((label, index) => {
          const percentual = totalGrafico > 0 ? ((data[index] / totalGrafico) * 100).toFixed(1) : 0;
          legendaDiv.innerHTML += `
            <div class="item-legenda">
              <span class="cor-legenda" style="background-color: ${backgroundColors[index]};"></span>
              <span class="descricao-legenda">${label}:</span>
              <span class="valor-legenda">${formatarMoeda(data[index])} (${percentual}%)</span>
            </div>
          `;
      });

      if (data.length === 0) {
        legendaDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Sem dados para exibir neste período.</div>';
        return; // Não cria gráfico se não houver dados
      }

      graficoDespesasPoupanca = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: '#014034', // Cor de fundo do card para borda
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
                display: true,
                text: `Distribuição de Despesas e Poupança${tituloExtra}`,
                color: '#ffd700',
                font: { size: 16 }
            },
            legend: { display: false }, // Oculta legenda padrão do Chart.js
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) label += ': ';
                  let value = context.parsed || 0;
                  const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0.0%';
                  return `${label}${formatarMoeda(value)} (${percentage})`;
                }
              }
            }
          }
        }
      });
    }

    function atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado, tituloExtra) {
        // --- Função atualizarGraficoDespesasReceitas (sem alterações na lógica, apenas título) --- 
        const ctx = document.getElementById("graficoDespesasReceitas").getContext("2d");
        const legendaDiv = document.getElementById("legendaDespesasReceitas");
        legendaDiv.innerHTML = ''; // Limpa legenda anterior
        if (graficoDespesasReceitas) graficoDespesasReceitas.destroy();

        let despesasDetalhadas = {};
        const anoAtual = new Date().getFullYear(); // Assume ano atual para cálculo

        // Filtra e calcula despesas para o período selecionado
        dadosResumo.lancamentos
            .filter(l => l.tipo === 'fixa' || l.tipo === 'variavel')
            .forEach(l => {
                let valorPeriodo = 0;
                const ocorrencias = calcularOcorrencias(l, anoAtual);
                
                if (mesSelecionado === -1) { // Total Anual
                    valorPeriodo = calcularTotaisPorCategoria([l], anoAtual).total;
                } else if (mesSelecionado === -2) { // Médias Mensais
                     valorPeriodo = calcularTotaisPorCategoria([l], anoAtual).total / 12;
                } else { // Mês específico
                    if (l.valoresManuais && l.valoresManuais[mesSelecionado] !== null && l.valoresManuais[mesSelecionado] !== undefined) {
                        valorPeriodo = l.valoresManuais[mesSelecionado];
                    } else {
                        const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === mesSelecionado);
                        if (ocorrenciasNoMes.length > 0) {
                            valorPeriodo = l.valor * ocorrenciasNoMes.length;
                        }
                    }
                }
                
                if (valorPeriodo > 0) {
                    if (!despesasDetalhadas[l.descricao]) {
                        despesasDetalhadas[l.descricao] = 0;
                    }
                    despesasDetalhadas[l.descricao] += valorPeriodo;
                }
            });

        const labels = Object.keys(despesasDetalhadas);
        const data = Object.values(despesasDetalhadas);
        const totalDespesasPeriodo = data.reduce((sum, val) => sum + val, 0);
        const percentualReceita = receitaPeriodo > 0 ? ((totalDespesasPeriodo / receitaPeriodo) * 100) : 0;

        // Adiciona legenda HTML
        legendaDiv.innerHTML += `
            <div class="item-legenda">
              <span class="cor-legenda" style="background-color: #1976d2;"></span>
              <span class="descricao-legenda">Receita Total:</span>
              <span class="valor-legenda">${formatarMoeda(receitaPeriodo)}</span>
            </div>
            <div class="item-legenda">
              <span class="cor-legenda" style="background-color: #c62828;"></span>
              <span class="descricao-legenda">Despesa Total:</span>
              <span class="valor-legenda">${formatarMoeda(totalDespesasPeriodo)} (${percentualReceita.toFixed(1)}% da Receita)</span>
            </div>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 10px 0;">
        `;
        labels.forEach((label, index) => {
             const percentualDespesa = totalDespesasPeriodo > 0 ? ((data[index] / totalDespesasPeriodo) * 100).toFixed(1) : 0;
             legendaDiv.innerHTML += `
                <div class="item-legenda">
                  <span class="cor-legenda" style="background-color: #aaa;"></span> <!-- Cor genérica para itens -->
                  <span class="descricao-legenda">${label}:</span>
                  <span class="valor-legenda">${formatarMoeda(data[index])} (${percentualDespesa}%)</span>
                </div>
             `;
        });

        if (receitaPeriodo <= 0 && totalDespesasPeriodo <= 0) {
             legendaDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Sem dados de receita ou despesa para exibir neste período.</div>';
             return; // Não cria gráfico se não houver dados
        }

        graficoDespesasReceitas = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Comparativo'], // Apenas uma barra agrupada
                datasets: [
                    {
                        label: 'Receitas',
                        data: [receitaPeriodo],
                        backgroundColor: '#1976d2', // Azul
                        borderColor: '#1976d2',
                        borderWidth: 1
                    },
                    {
                        label: 'Despesas',
                        data: [totalDespesasPeriodo],
                        backgroundColor: '#c62828', // Vermelho
                        borderColor: '#c62828',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Barras horizontais para melhor visualização
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: 'white', // Cor dos ticks do eixo X
                            callback: function(value) {
                                return formatarMoeda(value);
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)' // Cor das linhas de grade
                        }
                    },
                    y: {
                        ticks: {
                            color: 'white' // Cor dos ticks do eixo Y
                        },
                         grid: {
                            color: 'rgba(255, 255, 255, 0.1)' // Cor das linhas de grade
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Despesas em Relação às Receitas${tituloExtra}`,
                        color: '#ffd700',
                        font: { size: 16 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                           color: 'white' // Cor da legenda
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                let value = context.parsed.x || 0;
                                return `${label}${formatarMoeda(value)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    function atualizarInterface() {
      const anoAtual = new Date().getFullYear(); // Ou permitir seleção de ano no futuro
      atualizarTabelaLancamentos(lancamentos, anoAtual);
      atualizarResumoFinanceiro(lancamentos, anoAtual);
      // Gráficos são atualizados dentro de atualizarResumoFinanceiro
    }

    // Inicialização
    document.addEventListener("DOMContentLoaded", () => {
      carregarLancamentos();
      atualizarInterface();
      // Define o ano atual como padrão nas datas do modal para novos lançamentos
      const today = new Date();
      const currentYear = today.getFullYear();
      if (!document.getElementById("dataInicial").value) {
        document.getElementById("dataInicial").value = `${currentYear}-01-01`;
      }
      if (!document.getElementById("dataFinal").value) {
        document.getElementById("dataFinal").value = `${currentYear}-12-31`;
      }
    });

  </script>
</body>
</html>

