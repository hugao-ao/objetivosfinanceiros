<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Novos Objetivos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
      --cinza-claro: #e9ecef;
      --cinza-medio: #ced4da;
      --cinza-escuro: #6c757d;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      margin: 20px auto;
      padding: 20px;
      max-width: 1200px;
    }
    h1 {
      color: var(--dourado);
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid var(--dourado);
      background-color: white;
      border-radius: 8px;
    }
    .recommendation {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .recommendation h3 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
    }
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background-color: #25D366; /* WhatsApp green */
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 20.8px; /* 30% maior que 16px */
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
      text-transform: uppercase;
    }
    .whatsapp-button:hover {
      background-color: #128C7E; /* Darker WhatsApp green */
    }
    .save-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background-color: var(--dourado);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
      text-transform: uppercase;
    }
    .save-scenario-button:hover {
      background-color: var(--dourado-escuro);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .row > div {
      flex: 1;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid var(--verde-esmeralda);
      border-radius: 5px;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 12px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 16px;
    }
    button:hover {
      background-color: #03563f;
    }
    .chart-container {
      margin-top: 30px;
      position: relative;
      border: 1px solid var(--dourado-claro);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--verde-esmeralda);
    }
    .chart-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .chart-nav button {
      padding: 8px 15px;
      margin-top: 0;
      width: auto;
      font-size: 14px;
    }
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 400px;
    }
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    .table-slide {
      flex: 0 0 100%;
      overflow-x: auto; /* Habilitar rolagem horizontal */
      overflow-y: auto;
      padding: 10px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 800px; /* Garantir largura mínima para forçar rolagem se necessário */
    }
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
      white-space: nowrap; /* Evitar quebra de linha nas células */
    }
    .data-table th {
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .data-table tr:hover {
      background-color: #f1f1f1;
    }
    
    /* Estilos para múltiplos cenários */
    .scenarios-container {
      margin-top: 20px;
      border: 2px solid var(--dourado);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    
    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .scenarios-header h3 {
      color: var(--verde-esmeralda);
      margin: 0;
    }
    
    .scenario-card {
      border: 1px solid var(--cinza-medio);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--cinza-claro);
      position: relative;
    }
    
    .scenario-card.active {
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
    }
    
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .scenario-title {
      font-weight: bold;
      color: var(--verde-esmeralda);
      margin: 0;
    }
    
    .scenario-actions {
      display: flex;
      gap: 10px;
    }
    
    .scenario-actions button {
      padding: 5px 10px;
      margin: 0;
      width: auto;
      font-size: 12px;
    }
    
    .scenario-delete {
      background-color: #dc3545;
    }
    
    .scenario-delete:hover {
      background-color: #c82333;
    }
    
    .scenario-select {
      background-color: var(--dourado);
    }
    
    .scenario-select:hover {
      background-color: var(--dourado-escuro);
    }
    
    .scenario-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .scenario-info {
      flex: 1;
      min-width: 200px;
    }
    
    .scenario-info p {
      margin: 5px 0;
    }
    
    .scenario-info strong {
      color: var(--verde-esmeralda);
    }
    
    .scenario-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--fundo-claro);
      border-radius: 5px;
      font-size: 14px;
    }
    
    /* Estilos para comparação de cenários */
    .comparison-container {
      margin-top: 30px;
      border: 2px solid var(--roxo);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    
    .comparison-header {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
    
    .comparison-chart-container {
      height: 400px;
      margin: 20px 0;
    }
    
    #comparisonTableContainer {
      overflow-x: auto; /* Habilitar rolagem horizontal */
    }
    
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 900px; /* Garantir largura mínima para forçar rolagem se necessário */
    }
    
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      white-space: nowrap; /* Evitar quebra de linha nas células */
    }
    
    .comparison-table th {
      background-color: var(--roxo-translucido);
      color: var(--roxo-escuro);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .comparison-table tr:nth-child(even) {
      background-color: var(--fundo-claro);
    }
    
    .comparison-table .best-value {
      font-weight: bold;
      color: var(--verde-esmeralda);
      background-color: rgba(40, 167, 69, 0.1);
    }
    
    .general-analysis {
      margin-top: 30px;
      padding: 20px;
      border: 2px solid var(--roxo);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .general-analysis h3 {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Objetivos</h1>
  <form id="savingsForm">
    <label for="goalDescription">Qual é o seu objetivo financeiro e por que ele é importante para você?</label>
    <textarea id="goalDescription" placeholder="Ex: Comprar um imóvel para ter segurança e estabilidade para minha família, ou fazer uma viagem internacional para conhecer novas culturas..."></textarea>
    
    <label for="goal">Valor do Objetivo (R$):</label>
    <input type="text" id="goal" required oninput="formatCurrency(this)">

    <label for="period">Prazo (em meses):</label>
    <input type="number" id="period" required>

    <label for="currentSavings">Valor já Guardado (R$):</label>
    <input type="text" id="currentSavings" required oninput="formatCurrency(this)">

    <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
    <input type="text" id="currentContribution" required oninput="formatCurrency(this)">

    <div class="row">
      <div>
        <label for="rate">Taxa de Juros (%):</label>
        <input type="text" id="rate" required oninput="formatPercentage(this)">
      </div>
      <div>
        <label for="rateType">Tipo de Taxa:</label>
        <select id="rateType">
          <option value="annual">Anual</option>
          <option value="monthly">Mensal</option>
        </select>
      </div>
    </div>

    <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
    <div class="row">
      <div>
        <select id="knowsTax" onchange="toggleTaxInput("tax", "15,00 %")">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="tax" placeholder="15,00 %" oninput="formatPercentage(this)">
      </div>
    </div>

    <label>Você sabe a taxa de inflação dos últimos 12 meses?</label>
    <div class="row">
      <div>
        <select id="knowsInflation" onchange="toggleTaxInput("inflation", "5,00 %")">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="inflation" placeholder="5,00 %" oninput="formatPercentage(this)">
      </div>
    </div>

    <button type="button" onclick="calculateSavings()">Calcular</button>
  </form>

  <div id="result" class="result" style="display: none;"></div>
  
  <!-- Container para cenários -->
  <div id="scenariosContainer" class="scenarios-container" style="display: none;">
    <div class="scenarios-header">
      <h3>Cenários Salvos</h3>
    </div>
    <div id="scenariosList"></div>
  </div>
  
  <!-- Container para comparação de cenários -->
  <div id="comparisonContainer" class="comparison-container" style="display: none;">
    <h3 class="comparison-header">Comparação de Cenários</h3>
    <!-- Gráfico removido pois a comparação agora é baseada apenas nos parâmetros -->
    <div id="comparisonTableContainer">
      <table id="comparisonTable" class="comparison-table">
        <thead>
          <tr>
            <th>Cenário</th>
            <th>Valor do Objetivo</th>
            <th>Prazo (meses)</th>
            <th>Valor Guardado</th>
            <th>Aporte Mensal</th>
            <th>Taxa de Juros</th>
            <th>Inflação</th>
            <th>Imposto</th>
          </tr>
        </thead>
        <tbody id="comparisonTableBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- Análise Geral Automática -->
  <div id="generalAnalysis" class="general-analysis" style="display: none;">
    <h3>Análise Geral Automática</h3>
    <div id="generalAnalysisText"></div>
  </div>
  
  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>
  
  <!-- Botão para salvar e simular outro cenário -->
  <button id="saveScenarioButton" class="save-scenario-button" onclick="saveAndSimulateAnother()" style="display: none;">
    SALVAR E SIMULAR OUTRO CENÁRIO
  </button>
  
  <!-- Botão WhatsApp fora da caixa de análise automatizada -->
  <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
    AVANÇAR PARA ANÁLISE PERSONALIZADA
  </a>
  
  <div id="chartUnicoContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Investimento Único</div>
    <div class="chart-nav">
      <button onclick="showChartSlide("Unico", "chart")">Gráfico</button>
      <button onclick="showChartSlide("Unico", "table")">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartUnicoSlide" class="chart-slide">
        <canvas id="chartUnico"></canvas>
      </div>
      <div id="tableUnicoSlide" class="table-slide" style="display: none;">
        <table id="tableUnico" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartIdealContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Plano Ideal</div>
    <div class="chart-nav">
      <button onclick="showChartSlide("Ideal", "chart")">Gráfico</button>
      <button onclick="showChartSlide("Ideal", "table")">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartIdealSlide" class="chart-slide">
        <canvas id="chartIdeal"></canvas>
      </div>
      <div id="tableIdealSlide" class="table-slide" style="display: none;">
        <table id="tableIdeal" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartAtualContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Poupança Atual</div>
    <div class="chart-nav">
      <button onclick="showChartSlide("Atual", "chart")">Gráfico</button>
      <button onclick="showChartSlide("Atual", "table")">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartAtualSlide" class="chart-slide">
        <canvas id="chartAtual"></canvas>
      </div>
      <div id="tableAtualSlide" class="table-slide" style="display: none;">
        <table id="tableAtual" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartRentabilidadeContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Rentabilidade Necessária</div>
    <div class="chart-nav">
      <button onclick="showChartSlide("Rentabilidade", "chart")">Gráfico</button>
      <button onclick="showChartSlide("Rentabilidade", "table")">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartRentabilidadeSlide" class="chart-slide">
        <canvas id="chartRentabilidade"></canvas>
      </div>
      <div id="tableRentabilidadeSlide" class="table-slide" style="display: none;">
        <table id="tableRentabilidade" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais para armazenar os resultados e textos
    let goalDescriptionText = ";
    let resultText = ";
    
    // Array para armazenar os cenários (agora com dados simplificados)
    let scenarios = [];
    let scenarioCounter = 1; // Contador para nomeação automática de cenários
    let isSavingScenario = false; // Flag para evitar duplicidade ao salvar cenários
    let calculationComplete = false; // Flag para indicar se o cálculo foi concluído
    let currentCalculationData = null; // Armazena os dados do cálculo atual para salvar
    
    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, ");
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = "R$ " + value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.").replace(/\.(\d{2})$/, ",$1");
    }

    function formatPercentage(input) {
      let value = input.value.replace(/\D/g, ");
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = value.replace(".", ",") + " %";
    }

    function toggleTaxInput(id, defaultValue) {
      const select = document.getElementById(id === "tax" ? "knowsTax" : "knowsInflation");
      const input = document.getElementById(id);
      input.disabled = select.value !== "yes";
      input.value = select.value === "yes" ? "" : defaultValue;
    }

    function parseCurrency(value) {
      return parseFloat(value.replace(/[R$\s.]/g, ").replace(",", ".")) || 0;
    }

    function parsePercentage(value) {
      return parseFloat(value.replace("%", ").replace(",", ".")) / 100 || 0;
    }

    // Função para formatar valores monetários com sempre duas casas decimais
    function formatMoney(value) {
      return value.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Função para alternar entre visualização de gráfico e tabela
    function showChartSlide(chartId, slideType) {
      const chartSlide = document.getElementById(`chart${chartId}Slide`);
      const tableSlide = document.getElementById(`table${chartId}Slide`);
      
      if (slideType === "chart") {
        chartSlide.style.display = "block";
        tableSlide.style.display = "none";
      } else {
        chartSlide.style.display = "none";
        tableSlide.style.display = "block";
      }
    }

    // Função para capturar a página como imagem e enviar pelo WhatsApp
    async function capturePageAndSend() {
      try {
        // Esconder o botão do WhatsApp durante a captura
        const whatsappButton = document.getElementById("whatsappButton");
        whatsappButton.style.display = "none";
        
        // Capturar a página
        const canvas = await html2canvas(document.body, {
          scale: 1,
          useCORS: true,
          logging: false,
          allowTaint: true
        });
        
        // Mostrar o botão novamente
        whatsappButton.style.display = "block";
        
        // Converter para imagem
        const imageData = canvas.toDataURL("image/jpeg", 0.7);
        
        // Criar um link temporário para download
        const link = document.createElement("a");
        link.href = imageData;
        link.download = "analise_financeira.jpg";
        
        // Simular clique para download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        return imageData;
      } catch (error) {
        console.error("Erro ao capturar a página:", error);
        return null;
      }
    }

    // Função para abrir o WhatsApp com a mensagem personalizada
    async function openWhatsAppChat() {
      // Obter o texto do objetivo
      const goalText = goalDescriptionText || "(Objetivo não descrito)";
      
      // Capturar a página como imagem
      await capturePageAndSend();
      
      // Criar a string com os cenários simulados
      let scenariosText = "";
      if (scenarios.length > 0) {
        scenariosText = "Cenários simulados:\n";
        scenarios.forEach(scenario => {
          scenariosText += `\n${scenario.name}:\n`;
          scenariosText += `  - Objetivo: R$ ${formatMoney(scenario.goal)}\n`;
          scenariosText += `  - Prazo: ${scenario.period} meses\n`;
          scenariosText += `  - Valor Guardado: R$ ${formatMoney(scenario.currentSavings)}\n`;
          scenariosText += `  - Aporte Mensal: R$ ${formatMoney(scenario.currentContribution)}\n`;
          scenariosText += `  - Taxa Juros: ${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === "annual" ? "a.a." : "a.m."}\n`;
          scenariosText += `  - Inflação: ${(scenario.inflation * 100).toFixed(2).replace(".", ",")}%\n`;
          scenariosText += `  - Imposto: ${(scenario.tax * 100).toFixed(2).replace(".", ",")}%\n`;
        });
      } else {
        scenariosText = "(Nenhum cenário simulado)";
      }
      
      // Criar a mensagem para o WhatsApp
      const message = `Oi Hugo, queria tua ajuda com meu objetivo:\n${goalText}\n\n${scenariosText}\n\nEstou enviando também uma imagem com todos os detalhes.`;
      
      // Codificar a mensagem para URL
      const encodedMessage = encodeURIComponent(message);
      
      // Criar o link do WhatsApp usando a API correta
      const whatsappUrl = `https://api.whatsapp.com/send?phone=5581994297920&text=${encodedMessage}`;
      
      // Abrir o link em uma nova janela
      window.open(whatsappUrl, "_blank");
    }

    // Função para preencher a tabela de dados
    function fillDataTable(tableId, data) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = ";
      
      // Começar do mês 1 (não do mês 0)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const tr = document.createElement("tr");
        
        // Mês
        const tdMes = document.createElement("td");
        tdMes.textContent = row.month;
        tr.appendChild(tdMes);
        
        // Total Investido
        const tdInvestido = document.createElement("td");
        tdInvestido.textContent = `R$ ${formatMoney(row.totalInvestido)}`;
        tr.appendChild(tdInvestido);
        
        // Juros
        const tdJuros = document.createElement("td");
        tdJuros.textContent = `R$ ${formatMoney(row.juros)}`;
        tr.appendChild(tdJuros);
        
        // Total Juros
        const tdTotalJuros = document.createElement("td");
        tdTotalJuros.textContent = `R$ ${formatMoney(row.totalJuros)}`;
        tr.appendChild(tdTotalJuros);
        
        // Total Acumulado
        const tdAcumulado = document.createElement("td");
        tdAcumulado.textContent = `R$ ${formatMoney(row.totalAcumulado)}`;
        tr.appendChild(tdAcumulado);
        
        // Imposto
        const tdImposto = document.createElement("td");
        tdImposto.textContent = `R$ ${formatMoney(row.imposto)}`;
        tr.appendChild(tdImposto);
        
        // Valor Líquido
        const tdLiquido = document.createElement("td");
        tdLiquido.textContent = `R$ ${formatMoney(row.valorLiquido)}`;
        tr.appendChild(tdLiquido);
        
        // Objetivo Corrigido
        const tdObjetivo = document.createElement("td");
        tdObjetivo.textContent = `R$ ${formatMoney(row.objetivoCorrigido)}`;
        tr.appendChild(tdObjetivo);
        
        tbody.appendChild(tr);
      }
    }

    function drawChart(ctx, bruto, liquido, investido, corBruto, corLiquido, corInvestido) {
      new Chart(ctx, {
        type: "line",
        data: {
          labels: Array.from({length: bruto.length}, (_, i) => i + 1),
          datasets: [
            {
              label: "Valor Bruto",
              data: bruto,
              borderColor: corBruto,
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            },
            {
              label: "Valor Líquido",
              data: liquido,
              borderColor: corLiquido,
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            },
            {
              label: "Total Investido",
              data: investido,
              borderColor: corInvestido,
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return "R$ " + value.toLocaleString("pt-BR");
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || ";
                  if (label) {
                    label += ": ";
                  }
                  if (context.parsed.y !== null) {
                    label += "R$ " + context.parsed.y.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Função para calcular juros compostos
    function calculateCompoundInterest(initialValue, monthlyContribution, monthlyRate, months, tax, goal, inflation) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;
      
      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });
      
      for (let i = 1; i <= months; i++) {
        // Calcular juros do mês
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        
        // Adicionar aporte mensal
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;
        
        // Calcular imposto sobre o rendimento
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;
        
        // Calcular objetivo corrigido pela inflação (a cada 12 meses)
        if (i % 12 === 0) {
          objetivoCorrigido = objetivoCorrigido * (1 + inflation);
        }
        
        // Registrar valores mensais para gráfico e análise
        valoresMensais.push({
          month: i,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });
      }
      
      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais
      };
    }

    // Função para calcular juros compostos até atingir o objetivo
    function calculateCompoundInterestUntilGoal(initialValue, monthlyContribution, monthlyRate, tax, goal, inflation, maxMonths = 600) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;
      let month = 0;
      let goalReached = false;
      
      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });
      
      while (!goalReached && month < maxMonths) {
        month++;
        
        // Calcular juros do mês
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        
        // Adicionar aporte mensal
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;
        
        // Calcular imposto sobre o rendimento
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;
        
        // Calcular objetivo corrigido pela inflação (a cada 12 meses)
        if (month % 12 === 0) {
          objetivoCorrigido = objetivoCorrigido * (1 + inflation);
        }
        
        // Registrar valores mensais para gráfico e análise
        valoresMensais.push({
          month: month,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });
        
        // Verificar se o objetivo foi atingido
        if (valorLiquido >= objetivoCorrigido) {
          goalReached = true;
        }
      }
      
      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais,
        monthsToGoal: month,
        goalReached: goalReached
      };
    }

    // Função para calcular a taxa anual necessária para atingir o objetivo no prazo desejado
    function calculateRequiredRate(goal, currentSavings, monthlyContribution, period, tax, inflation) {
      // Ajustar o objetivo pela inflação (anualmente)
      let inflatedGoal = goal;
      const yearsCount = Math.floor(period / 12);
      
      // Aplicar inflação para anos completos
      for (let i = 0; i < yearsCount; i++) {
        inflatedGoal *= (1 + inflation);
      }
      
      // Busca binária para encontrar a taxa mensal necessária
      let lowRate = 0;
      let highRate = 1; // 100% ao mês como limite superior inicial
      let requiredMonthlyRate = 0;
      let iterations = 0;
      let result;
      
      while (iterations < 100) { // Limite de iterações para evitar loop infinito
        requiredMonthlyRate = (lowRate + highRate) / 2;
        result = calculateCompoundInterest(currentSavings, monthlyContribution, requiredMonthlyRate, period, tax, goal, inflation);
        
        // Verificar se o valor líquido final está próximo o suficiente do objetivo
        const valorLiquidoFinal = result.valoresMensais[period].valorLiquido;
        const objetivoFinal = result.valoresMensais[period].objetivoCorrigido;
        
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) {
          break;
        }
        
        // Ajusta os limites da busca
        if (valorLiquidoFinal > objetivoFinal) {
          highRate = requiredMonthlyRate;
        } else {
          lowRate = requiredMonthlyRate;
        }
        
        iterations++;
      }
      
      // Converter taxa mensal para anual: (1 + taxa_mensal)^12 - 1
      const requiredAnnualRate = Math.pow(1 + requiredMonthlyRate, 12) - 1;
      
      return {
        monthlyRate: requiredMonthlyRate,
        annualRate: requiredAnnualRate,
        finalValue: result.finalValue,
        finalGoal: inflatedGoal,
        valoresMensais: result.valoresMensais
      };
    }

    // Função para gerar análise automatizada
    function generateRecommendation(goalDescription, goal, currentSavings, currentContribution, idealContribution, months, requiredRate, rate) {
      const recommendationDiv = document.getElementById("recommendation");
      const recommendationText = document.getElementById("recommendationText");
      
      // Extrair informações relevantes
      const goalGap = goal - currentSavings;
      const contributionGap = idealContribution - currentContribution;
      const contributionPercentage = (currentContribution / idealContribution) * 100;
      const rateGap = requiredRate - rate;
      
      let analysis = ";
      
      // Análise da situação atual
      if (currentSavings > 0) {
        const savingsPercentage = (currentSavings / goal) * 100;
        analysis += `<p>Valor já guardado: R$ ${formatMoney(currentSavings)}, o que representa ${savingsPercentage.toFixed(1).replace(".", ",")}% do objetivo. `;
        
        if (savingsPercentage < 10) {
          analysis += `Este é um bom começo, mas ainda há um longo caminho pela frente.</p>`;
        } else if (savingsPercentage < 30) {
          analysis += `Já foram dados passos importantes em direção ao objetivo.</p>`;
        } else if (savingsPercentage < 60) {
          analysis += `Uma parte significativa do caminho já foi percorrida.</p>`;
        } else {
          analysis += `O objetivo está muito próximo de ser alcançado.</p>`;
        }
      } else {
        analysis += `<p>Ainda não foi iniciada a poupança para este objetivo específico.</p>`;
      }
      
      // Análise do aporte mensal
      if (currentContribution > 0) {
        if (contributionPercentage >= 100) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} é suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 80) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está próximo do ideal. Um pequeno ajuste de R$ ${formatMoney(contributionGap)} a mais por mês seria o suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 50) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} representa um bom esforço, mas para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês (um acréscimo de R$ ${formatMoney(contributionGap)}).</p>`;
        } else {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está significativamente abaixo do ideal. Para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês.</p>`;
        }
      } else {
        analysis += `<p>Não estão sendo feitos aportes mensais. Para atingir o objetivo no prazo desejado, seria necessário poupar R$ ${formatMoney(idealContribution)} por mês.</p>`;
      }
      
      // Análise da rentabilidade
      if (rateGap > 0) {
        const rateGapPercentage = rateGap * 100;
        if (rateGapPercentage > 10) {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace(".", ",")}% ao ano, o que está ${rateGapPercentage.toFixed(2).replace(".", ",")} pontos percentuais acima da taxa informada. Esta diferença é significativa e pode representar um risco maior.</p>`;
        } else {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace(".", ",")}% ao ano, o que está ${rateGapPercentage.toFixed(2).replace(".", ",")} pontos percentuais acima da taxa informada. Esta diferença é relativamente pequena e pode ser alcançável com ajustes na estratégia de investimento.</p>`;
        }
      } else {
        analysis += `<p>A rentabilidade informada de ${(rate * 100).toFixed(2).replace(".", ",")}% ao ano é suficiente para atingir o objetivo no prazo desejado, desde que sejam mantidos os aportes mensais adequados.</p>`;
      }
      
      recommendationText.innerHTML = analysis;
      recommendationDiv.style.display = "block";
      
      // Marcar que o cálculo foi concluído
      calculationComplete = true;
    }
    
    // Função para salvar o cenário atual e preparar para um novo
    function saveAndSimulateAnother() {
      // Verificar se há dados do cálculo atual para salvar
      if (!currentCalculationData) {
        alert("Por favor, calcule um cenário antes de salvá-lo.");
        return;
      }
      
      // Evitar duplicidade ao salvar cenários
      if (isSavingScenario) {
        return;
      }
      
      isSavingScenario = true;
      
      // Adicionar o cenário atual (com dados simplificados)
      addCurrentScenario();
      
      // Limpar os campos do formulário, exceto o objetivo
      document.getElementById("goal").value = ";
      document.getElementById("period").value = ";
      document.getElementById("currentSavings").value = ";
      document.getElementById("currentContribution").value = ";
      document.getElementById("rate").value = ";
      document.getElementById("knowsTax").value = "no";
      document.getElementById("knowsInflation").value = "no";
      toggleTaxInput("tax", "15,00 %");
      toggleTaxInput("inflation", "5,00 %");
      
      // Limpar os resultados e esconder elementos
      document.getElementById("result").innerHTML = ";
      document.getElementById("result").style.display = "none";
      document.getElementById("recommendation").style.display = "none";
      document.getElementById("chartUnicoContainer").style.display = "none";
      document.getElementById("chartIdealContainer").style.display = "none";
      document.getElementById("chartAtualContainer").style.display = "none";
      document.getElementById("chartRentabilidadeContainer").style.display = "none";
      document.getElementById("saveScenarioButton").style.display = "none";
      document.getElementById("whatsappButton").style.display = "none";
      
      // Resetar a flag de cálculo concluído e dados do cálculo atual
      calculationComplete = false;
      currentCalculationData = null;
      
      // Rolar para o topo do formulário
      window.scrollTo(0, 0);
      
      // Resetar a flag após um breve intervalo
      setTimeout(() => {
        isSavingScenario = false;
      }, 500);
    }
    
    // Função para adicionar o cenário atual à lista de cenários (com dados simplificados)
    function addCurrentScenario() {
      // Verificar se há dados do cálculo atual para adicionar
      if (!currentCalculationData) {
        alert("Erro interno: Dados do cálculo não encontrados para salvar.");
        return;
      }
      
      const scenarioName = `Cenário ${scenarioCounter.toString().padStart(2, "0")}`;
      scenarioCounter++; // Incrementar o contador para o próximo cenário
      
      // Criar objeto do cenário com dados simplificados
      const scenario = {
        id: Date.now(), // ID único baseado no timestamp
        name: scenarioName,
        goalDescription: currentCalculationData.goalDescription, // Manter a descrição original
        goal: currentCalculationData.goal,
        rate: currentCalculationData.rate,
        rateType: currentCalculationData.rateType,
        tax: currentCalculationData.tax,
        inflation: currentCalculationData.inflation,
        period: currentCalculationData.period,
        currentSavings: currentCalculationData.currentSavings,
        currentContribution: currentCalculationData.currentContribution
      };
      
      // Adicionar o cenário ao array
      scenarios.push(scenario);
      
      // Atualizar a interface de cenários salvos
      updateScenariosUI();
      
      // Mostrar a seção de cenários salvos
      document.getElementById("scenariosContainer").style.display = "block";
      
      // Atualizar a comparação se houver mais de um cenário
      if (scenarios.length > 1) {
        updateComparisonUI();
        generateGeneralAnalysis(); // Gerar análise geral com base nos parâmetros salvos
        document.getElementById("comparisonContainer").style.display = "block";
        document.getElementById("generalAnalysis").style.display = "block";
      }
    }
    
    // Função para remover um cenário
    function removeScenario(id) {
      // Encontrar o índice do cenário no array
      const index = scenarios.findIndex(s => s.id === id);
      
      // Remover o cenário do array
      if (index !== -1) {
        scenarios.splice(index, 1);
      }
      
      // Atualizar a interface
      updateScenariosUI();
      
      // Atualizar ou esconder a comparação dependendo do número de cenários
      if (scenarios.length > 1) {
        updateComparisonUI();
        generateGeneralAnalysis();
      } else {
        document.getElementById("comparisonContainer").style.display = "none";
        document.getElementById("generalAnalysis").style.display = "none";
      }
      
      // Esconder a seção de cenários se não houver nenhum
      if (scenarios.length === 0) {
        document.getElementById("scenariosContainer").style.display = "none";
      }
    }
    
    // Função para atualizar a interface de cenários salvos (com dados simplificados)
    function updateScenariosUI() {
      const scenariosList = document.getElementById("scenariosList");
      scenariosList.innerHTML = ";
      
      scenarios.forEach((scenario) => {
        const scenarioCard = document.createElement("div");
        scenarioCard.className = "scenario-card";
        scenarioCard.id = `scenario-${scenario.id}`;
        
        // Cabeçalho do cenário
        const scenarioHeader = document.createElement("div");
        scenarioHeader.className = "scenario-header";
        
        const scenarioTitle = document.createElement("h4");
        scenarioTitle.className = "scenario-title";
        scenarioTitle.textContent = scenario.name;
        
        const scenarioActions = document.createElement("div");
        scenarioActions.className = "scenario-actions";
        
        const deleteButton = document.createElement("button");
        deleteButton.className = "scenario-delete";
        deleteButton.textContent = "Excluir";
        deleteButton.onclick = function() { removeScenario(scenario.id); };
        
        scenarioActions.appendChild(deleteButton);
        scenarioHeader.appendChild(scenarioTitle);
        scenarioHeader.appendChild(scenarioActions);
        
        // Conteúdo do cenário (dados simplificados)
        const scenarioContent = document.createElement("div");
        scenarioContent.className = "scenario-content";
        
        // Informações básicas
        const basicInfo = document.createElement("div");
        basicInfo.className = "scenario-info";
        basicInfo.innerHTML = `
          <p><strong>Objetivo:</strong> R$ ${formatMoney(scenario.goal)}</p>
          <p><strong>Prazo:</strong> ${scenario.period} meses</p>
          <p><strong>Valor Guardado:</strong> R$ ${formatMoney(scenario.currentSavings)}</p>
        `;
        
        // Informações financeiras
        const financialInfo = document.createElement("div");
        financialInfo.className = "scenario-info";
        financialInfo.innerHTML = `
          <p><strong>Aporte Mensal:</strong> R$ ${formatMoney(scenario.currentContribution)}</p>
          <p><strong>Taxa Juros:</strong> ${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === "annual" ? "a.a." : "a.m."}</p>
          <p><strong>Inflação:</strong> ${(scenario.inflation * 100).toFixed(2).replace(".", ",")}%</p>
          <p><strong>Imposto:</strong> ${(scenario.tax * 100).toFixed(2).replace(".", ",")}%</p>
        `;
        
        scenarioContent.appendChild(basicInfo);
        scenarioContent.appendChild(financialInfo);
        
        scenarioCard.appendChild(scenarioHeader);
        scenarioCard.appendChild(scenarioContent);
        
        scenariosList.appendChild(scenarioCard);
      });
    }
    
    // Função para atualizar a interface de comparação (com dados simplificados)
    function updateComparisonUI() {
      // Atualizar a tabela de comparação
      const comparisonTableBody = document.getElementById("comparisonTableBody");
      comparisonTableBody.innerHTML = ";
      
      scenarios.forEach(scenario => {
        const row = document.createElement("tr");
        
        // Nome do cenário
        const tdName = document.createElement("td");
        tdName.textContent = scenario.name;
        row.appendChild(tdName);
        
        // Valor do objetivo
        const tdGoal = document.createElement("td");
        tdGoal.textContent = `R$ ${formatMoney(scenario.goal)}`;
        row.appendChild(tdGoal);
        
        // Prazo
        const tdPeriod = document.createElement("td");
        tdPeriod.textContent = scenario.period;
        row.appendChild(tdPeriod);
        
        // Valor guardado
        const tdSavings = document.createElement("td");
        tdSavings.textContent = `R$ ${formatMoney(scenario.currentSavings)}`;
        row.appendChild(tdSavings);
        
        // Aporte mensal
        const tdContribution = document.createElement("td");
        tdContribution.textContent = `R$ ${formatMoney(scenario.currentContribution)}`;
        row.appendChild(tdContribution);
        
        // Taxa de juros
        const tdRate = document.createElement("td");
        tdRate.textContent = `${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === "annual" ? "a.a." : "a.m."}`;
        row.appendChild(tdRate);
        
        // Inflação
        const tdInflation = document.createElement("td");
        tdInflation.textContent = `${(scenario.inflation * 100).toFixed(2).replace(".", ",")}%`;
        row.appendChild(tdInflation);
        
        // Imposto
        const tdTax = document.createElement("td");
        tdTax.textContent = `${(scenario.tax * 100).toFixed(2).replace(".", ",")}%`;
        row.appendChild(tdTax);
        
        comparisonTableBody.appendChild(row);
      });
    }
    
    // Função para gerar análise geral automática (baseada nos parâmetros salvos)
    function generateGeneralAnalysis() {
      if (scenarios.length < 2) return;
      
      const generalAnalysisText = document.getElementById("generalAnalysisText");
      let analysis = ";
      
      // Introdução
      analysis += `<p>Comparando os ${scenarios.length} cenários simulados com base nos parâmetros informados:</p>`;
      
      // Análise de prazos
      const differentPeriods = [...new Set(scenarios.map(s => s.period))].length > 1;
      if (differentPeriods) {
        const sortedByPeriod = [...scenarios].sort((a, b) => a.period - b.period);
        const shortestPeriodScenario = sortedByPeriod[0];
        const longestPeriodScenario = sortedByPeriod[sortedByPeriod.length - 1];
        analysis += `<p><strong>Tempo:</strong> O "${shortestPeriodScenario.name}" propõe o menor prazo (${shortestPeriodScenario.period} meses), enquanto "${longestPeriodScenario.name}" considera o maior prazo (${longestPeriodScenario.period} meses).</p>`;
      }
      
      // Análise de esforço financeiro (aporte mensal)
      const differentContributions = [...new Set(scenarios.map(s => s.currentContribution))].length > 1;
      if (differentContributions) {
        const sortedByContribution = [...scenarios].sort((a, b) => a.currentContribution - b.currentContribution);
        const lowestContributionScenario = sortedByContribution[0];
        const highestContributionScenario = sortedByContribution[sortedByContribution.length - 1];
        analysis += `<p><strong>Esforço Mensal:</strong> O "${lowestContributionScenario.name}" exige o menor aporte mensal (R$ ${formatMoney(lowestContributionScenario.currentContribution)}), enquanto "${highestContributionScenario.name}" exige o maior (R$ ${formatMoney(highestContributionScenario.currentContribution)}).</p>`;
      }
      
      // Análise de valor inicial
      const differentInitialValues = [...new Set(scenarios.map(s => s.currentSavings))].length > 1;
      if (differentInitialValues) {
        const sortedByInitialValue = [...scenarios].sort((a, b) => a.currentSavings - b.currentSavings);
        const lowestInitialValueScenario = sortedByInitialValue[0];
        const highestInitialValueScenario = sortedByInitialValue[sortedByInitialValue.length - 1];
        analysis += `<p><strong>Ponto de Partida:</strong> O "${lowestInitialValueScenario.name}" parte do menor valor inicial (R$ ${formatMoney(lowestInitialValueScenario.currentSavings)}), enquanto "${highestInitialValueScenario.name}" parte do maior (R$ ${formatMoney(highestInitialValueScenario.currentSavings)}).</p>`;
      }
      
      // Análise de Taxa de Juros
      const differentRates = [...new Set(scenarios.map(s => s.rate))].length > 1;
      if (differentRates) {
        const sortedByRate = [...scenarios].sort((a, b) => a.rate - b.rate);
        const lowestRateScenario = sortedByRate[0];
        const highestRateScenario = sortedByRate[sortedByRate.length - 1];
        analysis += `<p><strong>Rentabilidade Esperada:</strong> O "${lowestRateScenario.name}" considera a menor taxa de juros (${(lowestRateScenario.rate * 100).toFixed(2).replace(".", ",")}% ${lowestRateScenario.rateType === "annual" ? "a.a." : "a.m."}), enquanto "${highestRateScenario.name}" considera a maior (${(highestRateScenario.rate * 100).toFixed(2).replace(".", ",")}% ${highestRateScenario.rateType === "annual" ? "a.a." : "a.m."}).</p>`;
      }
      
      // Considerações Finais (Simplificadas)
      analysis += `<p>Cada cenário apresenta uma combinação diferente de prazo, esforço mensal, valor inicial e rentabilidade. A escolha ideal dependerá das suas prioridades e tolerância a riscos.</p>`;
      
      generalAnalysisText.innerHTML = analysis;
    }

    function calculateSavings() {
      // Armazenar o texto do objetivo para uso posterior
      goalDescriptionText = document.getElementById("goalDescription").value;
      
      // Resetar os gráficos antes de desenhar novos
      const chartUnico = Chart.getChart("chartUnico");
      if (chartUnico) chartUnico.destroy();
      const chartIdeal = Chart.getChart("chartIdeal");
      if (chartIdeal) chartIdeal.destroy();
      const chartAtual = Chart.getChart("chartAtual");
      if (chartAtual) chartAtual.destroy();
      const chartRentabilidade = Chart.getChart("chartRentabilidade");
      if (chartRentabilidade) chartRentabilidade.destroy();
      
      // Obter dados do formulário
      const goalDescription = document.getElementById("goalDescription").value;
      const goal = parseCurrency(document.getElementById("goal").value);
      const rate = parsePercentage(document.getElementById("rate").value);
      const rateType = document.getElementById("rateType").value;
      const knowsTax = document.getElementById("knowsTax").value;
      const tax = knowsTax === "yes" ? parsePercentage(document.getElementById("tax").value) : 0.15;
      const knowsInflation = document.getElementById("knowsInflation").value;
      const inflation = knowsInflation === "yes" ? parsePercentage(document.getElementById("inflation").value) : 0.05;
      const period = parseInt(document.getElementById("period").value);
      const currentSavings = parseCurrency(document.getElementById("currentSavings").value);
      const currentContribution = parseCurrency(document.getElementById("currentContribution").value);

      // Armazenar dados do cálculo atual para possível salvamento
      currentCalculationData = {
        goalDescription: goalDescription,
        goal: goal,
        rate: rate,
        rateType: rateType,
        tax: tax,
        inflation: inflation,
        period: period,
        currentSavings: currentSavings,
        currentContribution: currentContribution
      };

      const monthlyRate = rateType === "annual" ? Math.pow(1 + rate, 1 / 12) - 1 : rate;
      
      // Calcular o objetivo corrigido pela inflação (anualmente)
      let inflatedGoal = goal;
      const yearsCount = Math.floor(period / 12);
      
      // Aplicar inflação para anos completos
      for (let i = 0; i < yearsCount; i++) {
        inflatedGoal *= (1 + inflation);
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `<p><strong>Reajuste pela Inflação:</strong><br>Valor atual do objetivo: R$ ${formatMoney(goal)}<br>Valor corrigido pela inflação (${(inflation * 100).toFixed(2).replace(".", ",")}%) em ${period} meses: R$ ${formatMoney(inflatedGoal)}</p>`;
      resultDiv.style.display = "block";

      // Cálculo do investimento único necessário
      const taxFactor = (1 + monthlyRate) ** period - tax * ((1 + monthlyRate) ** period - 1);
      const investmentNeeded = inflatedGoal / taxFactor;
      const difference = investmentNeeded - currentSavings;
      const comparisonText = difference > 0 
        ? `Este valor é <strong>R$ ${formatMoney(difference)} maior</strong> do que o valor que você já tem guardado.`
        : `Este valor é <strong>R$ ${formatMoney(Math.abs(difference))} menor</strong> do que o valor que você já tem guardado.`;
      const resultUnico = calculateCompoundInterest(investmentNeeded, 0, monthlyRate, period, tax, goal, inflation);
      const brutoUnico = resultUnico.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoUnico = resultUnico.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoUnico = resultUnico.valoresMensais.slice(1).map(m => m.totalInvestido);
      resultDiv.innerHTML += `<p><strong>Investimento Único Necessário:</strong><br>Para atingir seu objetivo no prazo desejado, sem poupar mensalmente, você precisaria investir <strong>R$ ${formatMoney(investmentNeeded)}</strong> hoje.<br>${comparisonText}</p>`;
      document.getElementById("chartUnicoContainer").style.display = "block";
      fillDataTable("tableUnico", resultUnico.valoresMensais);
      drawChart(document.getElementById("chartUnico").getContext("2d"), brutoUnico, liquidoUnico, investidoUnico, "#6f42c1", "#9f75e5", "#4b2882");

      // Cálculo do plano ideal (quanto poupar mensalmente)
      let low = 0, high = inflatedGoal, Y = 0;
      let resultIdeal;
      for (let i = 0; i < 100; i++) {
        Y = (low + high) / 2;
        resultIdeal = calculateCompoundInterest(currentSavings, Y, monthlyRate, period, tax, goal, inflation);
        const valorLiquidoFinal = resultIdeal.valoresMensais[period].valorLiquido;
        const objetivoFinal = resultIdeal.valoresMensais[period].objetivoCorrigido;
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) break;
        if (valorLiquidoFinal > objetivoFinal) high = Y;
        else low = Y;
      }
      const brutoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.totalInvestido);
      resultDiv.innerHTML += `<p><strong>Plano Ideal:</strong><br>Você precisará poupar R$ ${formatMoney(Y)} por mês para atingir seu objetivo corrigido.</p>`;
      document.getElementById("chartIdealContainer").style.display = "block";
      fillDataTable("tableIdeal", resultIdeal.valoresMensais);
      drawChart(document.getElementById("chartIdeal").getContext("2d"), brutoIdeal, liquidoIdeal, investidoIdeal, "#28a745", "#218838", "#046c4e");

      // Cálculo com a poupança atual até atingir o objetivo
      const resultAtual = calculateCompoundInterestUntilGoal(currentSavings, currentContribution, monthlyRate, tax, goal, inflation);
      const brutoAtual = resultAtual.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoAtual = resultAtual.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoAtual = resultAtual.valoresMensais.slice(1).map(m => m.totalInvestido);
      const lastMonth = resultAtual.valoresMensais.length - 1;
      const valorFinalAtual = resultAtual.valoresMensais[lastMonth].valorLiquido;
      const objetivoFinalAtual = resultAtual.valoresMensais[lastMonth].objetivoCorrigido;
      const diferencaAtual = valorFinalAtual - objetivoFinalAtual;
      if (resultAtual.goalReached) {
        resultDiv.innerHTML += `<p><strong>Plano Atual:</strong><br>Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você <strong>conseguirá</strong> atingir seu objetivo em ${resultAtual.monthsToGoal} meses, com um superávit de R$ ${formatMoney(diferencaAtual)}.</p>`;
      } else {
        resultDiv.innerHTML += `<p><strong>Plano Atual:</strong><br>Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você <strong>não conseguirá</strong> atingir seu objetivo no prazo máximo de simulação (600 meses), ficando com um déficit de R$ ${formatMoney(Math.abs(diferencaAtual))}.</p>`;
      }
      document.getElementById("chartAtualContainer").style.display = "block";
      fillDataTable("tableAtual", resultAtual.valoresMensais);
      drawChart(document.getElementById("chartAtual").getContext("2d"), brutoAtual, liquidoAtual, investidoAtual, "#d4af37", "#f5e2a9", "#b38e2e");

      // Cálculo da rentabilidade necessária
      const requiredRateResult = calculateRequiredRate(goal, currentSavings, currentContribution, period, tax, inflation);
      const requiredAnnualRate = requiredRateResult.annualRate;
      const brutoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.totalInvestido);
      resultDiv.innerHTML += `<p><strong>Rentabilidade Necessária:</strong><br>Para atingir seu objetivo no prazo desejado com o aporte mensal atual, você precisaria de uma rentabilidade de <strong>${(requiredAnnualRate * 100).toFixed(2).replace(".", ",")}% ao ano</strong>.</p>`;
      document.getElementById("chartRentabilidadeContainer").style.display = "block";
      fillDataTable("tableRentabilidade", requiredRateResult.valoresMensais);
      drawChart(document.getElementById("chartRentabilidade").getContext("2d"), brutoRentabilidade, liquidoRentabilidade, investidoRentabilidade, "#dc3545", "#e35d6a", "#b02a37");

      // Armazenar o texto do resultado para uso posterior (apenas para análise individual)
      resultText = resultDiv.innerText;
      
      // Gerar análise automatizada individual
      generateRecommendation(goalDescription, goal, currentSavings, currentContribution, Y, period, requiredAnnualRate, rate);
      
      // Mostrar botões
      document.getElementById("saveScenarioButton").style.display = "block";
      document.getElementById("whatsappButton").style.display = "block";
      
      // Se houver cenários salvos, gerar e mostrar a análise geral
      if (scenarios.length > 0) {
        // Adicionar temporariamente os dados do cálculo atual para análise
        const tempScenario = {
          id: "current",
          name: `Cenário Atual (Não Salvo)`,
          ...currentCalculationData
        };
        const allScenariosForAnalysis = [...scenarios, tempScenario];
        
        updateComparisonUI(allScenariosForAnalysis); // Atualiza a tabela de comparação
        generateGeneralAnalysis(allScenariosForAnalysis); // Gera a análise geral
        
        document.getElementById("comparisonContainer").style.display = "block";
        document.getElementById("generalAnalysis").style.display = "block";
      }
    }

    // Inicializar os campos de imposto e inflação
    document.addEventListener("DOMContentLoaded", function() {
      toggleTaxInput("tax", "15,00 %");
      toggleTaxInput("inflation", "5,00 %");
    });
  </script>
</body>
</html>
