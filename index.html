<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Novos Objetivos</title>
  <!-- Adicionando um favicon simples para evitar erro 404 -->
  <link rel="icon" href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-esmeralda-escuro: #034e38;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --fundo-container: #ffffff;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
      --cinza-claro: #e9ecef;
      --cinza-medio: #ced4da;
      --cinza-escuro: #6c757d;
      --verde-destaque: rgba(4, 108, 78, 0.1);
      --vermelho-destaque: rgba(220, 53, 69, 0.1);
      --sombra-padrao: 0 4px 12px rgba(0,0,0,0.1);
      --borda-arredondada: 8px;
      --espacamento-padrao: 20px;
      --transicao-padrao: all 0.3s ease;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      padding: var(--espacamento-padrao);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }

    /* Estilos para o container retrátil de gráficos */
    .charts-toggle-container {
      margin: 25px 0;
      position: relative;
    }
    .toggle-charts-button {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 15px 20px;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      transition: var(--transicao-padrao);
      box-shadow: var(--sombra-padrao);
      position: relative;
      overflow: hidden;
    }
    .toggle-charts-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .toggle-charts-button:before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      pointer-events: none;
    }
    .toggle-charts-button span#toggleChartsIcon {
      font-size: 1.5rem;
      margin-left: 15px;
      transition: transform 0.3s ease;
    }
    .toggle-charts-button-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(4, 108, 78, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(4, 108, 78, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(4, 108, 78, 0);
      }
    }
    .toggle-instruction {
      text-align: center;
      color: var(--cinza-escuro);
      font-style: italic;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    /* Estilos para os botões no final da página */
    .fixed-buttons-container {
      margin-top: 30px;
      /* Removido padding duplicado e borda superior */
      width: 100%;
      background-color: var(--fundo-claro);
      padding: 15px 0; /* Ajustado padding */
    }
    .buttons-row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
    }
    h1, h2, h3, h4, h5, h6 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      margin-bottom: var(--espacamento-padrao);
      font-weight: 600;
      line-height: 1.3;
    }
    h1 {
      color: var(--verde-esmeralda-escuro);
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 1.5rem;
      border-bottom: 3px solid var(--dourado);
      padding-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    form {
      background-color: var(--fundo-container);
      padding: var(--espacamento-padrao);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
      margin-bottom: var(--espacamento-padrao);
      border: 1px solid var(--cinza-claro);
    }
    .result {
      margin-top: var(--espacamento-padrao);
      padding: var(--espacamento-padrao);
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation {
      margin: var(--espacamento-padrao) 0;
      padding: var(--espacamento-padrao);
      border: 2px solid var(--verde-esmeralda);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation h3 {
      color: var(--verde-esmeralda-escuro);
      margin-top: 0;
      border-bottom: 2px solid var(--dourado);
      padding-bottom: 10px;
      font-size: 1.4rem;
    }
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .whatsapp-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .save-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--dourado);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      /* Removido transition duplicado */
    }
    .save-scenario-button:hover {
      background-color: var(--dourado-escuro);
      transform: translateY(-2px);
    }
    .analyze-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .analyze-scenario-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--verde-esmeralda-escuro);
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
    }
    .row > div {
      flex: 1;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid var(--cinza-medio);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
      font-size: 1rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--dourado);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      margin-top: 20px;
      padding: 14px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 1rem;
      transition: var(--transicao-padrao);
      letter-spacing: 0.5px;
    }
    button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .chart-container {
      margin-top: 30px;
      position: relative;
      border: 2px solid var(--dourado-claro);
      border-radius: var(--borda-arredondada);
      padding: 20px;
      background-color: var(--fundo-container);
      box-shadow: var(--sombra-padrao);
      /* display: none; /* Controlado por JS */
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      color: var(--verde-esmeralda-escuro);
      font-size: 1.2rem;
      border-bottom: 1px solid var(--dourado);
      padding-bottom: 10px;
    }
    .chart-nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .chart-nav button {
      padding: 10px 20px;
      margin-top: 0;
      width: auto;
      font-size: 0.9rem;
      background-color: var(--dourado);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
    }
    .chart-nav button:hover {
      background-color: var(--dourado-escuro);
    }
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 400px;
      border: 1px solid var(--cinza-claro);
      border-radius: var(--borda-arredondada);
      background-color: var(--fundo-container);
    }
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    .table-slide {
      flex: 0 0 100%;
      overflow-x: auto;
      overflow-y: auto;
      padding: 15px;
      background-color: var(--fundo-container);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      min-width: 800px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .data-table th, .data-table td {
      border: 1px solid var(--cinza-claro);
      padding: 10px;
      text-align: right;
      white-space: nowrap;
    }
    .data-table th {
      background-color: var(--verde-esmeralda);
      color: white;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table tr:nth-child(even) {
      background-color: var(--verde-destaque);
    }
    .data-table tr:hover {
      background-color: var(--dourado-claro);
    }
    .scenarios-container {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    /* Corrigido: Removido header duplicado e ajustado */
    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--verde-esmeralda);
      padding-bottom: 10px;
    }
    .scenarios-header h3 {
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      font-size: 1.4rem;
    }
    .scenario-card {
      border: 1px solid var(--cinza-medio);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--cinza-claro);
      position: relative;
    }
    .scenario-card.active {
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
    }
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .scenario-title {
      font-weight: bold;
      color: var(--verde-esmeralda);
      margin: 0;
    }
    .scenario-actions {
      display: flex;
      gap: 10px;
    }
    .scenario-actions button {
      padding: 5px 10px;
      margin: 0;
      width: auto;
      font-size: 12px;
    }
    .scenario-delete {
      background-color: #dc3545;
    }
    .scenario-delete:hover {
      background-color: #c82333;
    }
    .scenario-select {
      background-color: var(--dourado);
    }
    .scenario-select:hover {
      background-color: var(--dourado-escuro);
    }
    .scenario-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .scenario-info {
      flex: 1;
      min-width: 200px;
    }
    .scenario-info p {
      margin: 5px 0;
    }
    .scenario-info strong {
      color: var(--verde-esmeralda);
    }
    .scenario-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--fundo-claro);
      border-radius: 5px;
      font-size: 14px;
    }
    /* Estilos para comparação de cenários */
    .comparison-container {
      margin-top: 30px;
      border: 2px solid var(--roxo);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .comparison-header {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
    .comparison-chart-container {
      height: 400px;
      margin: 20px 0;
    }
    #comparisonTableContainer {
      overflow-x: auto; /* Habilitar rolagem horizontal */
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 900px; /* Garantir largura mínima para forçar rolagem se necessário */
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      white-space: nowrap; /* Evitar quebra de linha nas células */
    }
    .comparison-table th {
      background-color: var(--roxo-translucido);
      color: var(--roxo-escuro);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .comparison-table tr:nth-child(even) {
      background-color: var(--fundo-claro);
    }
    .comparison-table .best-value {
      font-weight: bold;
      color: var(--verde-esmeralda);
      background-color: var(--verde-destaque);
    }
    .comparison-table .worst-value {
      font-weight: bold;
      color: #dc3545;
      background-color: var(--vermelho-destaque);
    }
    .general-analysis {
      margin-top: 30px;
      padding: 20px;
      border: 2px solid var(--roxo);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .general-analysis h3 {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Objetivos</h1>
  <form id="savingsForm" onsubmit="event.preventDefault(); calculateSavings();">
    <label for="goalDescription">Qual é o seu objetivo financeiro e por que ele é importante para você?</label>
    <textarea id="goalDescription" placeholder="Ex: Comprar um imóvel para ter segurança e estabilidade para minha família, ou fazer uma viagem internacional para conhecer novas culturas..."></textarea>

    <label for="goal">Valor do Objetivo (R$):</label>
    <input type="text" id="goal" required oninput="formatCurrency(this)">

    <label for="period">Prazo (em meses):</label>
    <input type="number" id="period" required>

    <label for="currentSavings">Valor já Guardado (R$):</label>
    <input type="text" id="currentSavings" required oninput="formatCurrency(this)">

    <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
    <input type="text" id="currentContribution" required oninput="formatCurrency(this)">

    <div class="row">
      <div>
        <label for="rate">Taxa de Juros (%):</label>
        <input type="text" id="rate" required oninput="formatPercentage(this)">
      </div>
      <div>
        <label for="rateType">Tipo de Taxa:</label>
        <select id="rateType">
          <option value="annual">Anual</option>
          <option value="monthly">Mensal</option>
        </select>
      </div>
    </div>

    <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
    <div class="row">
      <div>
        <select id="knowsTax" onchange="toggleTaxInput('tax', '15,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="tax" placeholder="15,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <label>Você sabe a taxa de inflação dos últimos 12 meses?</label>
    <div class="row">
      <div>
        <select id="knowsInflation" onchange="toggleTaxInput('inflation', '5,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="inflation" placeholder="5,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <button type="submit">Calcular</button>
  </form>

  <div id="result" class="result" style="display: none;"></div>

  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>

  <!-- Container de Cenários Salvos (será criado dinamicamente se necessário) -->
  <div id="scenariosContainer" class="scenarios-container" style="display: none;"></div>

  <!-- Container de Comparação (será criado dinamicamente se necessário) -->
  <div id="comparisonContainer" class="comparison-container" style="display: none;"></div>

  <!-- Container de Análise Geral (será criado dinamicamente se necessário) -->
  <div id="generalAnalysis" class="general-analysis" style="display: none;"></div>

  <!-- Botões no final da página (antes dos gráficos) -->
  <div id="buttonsContainer" class="fixed-buttons-container" style="display: none;">
    <!-- Botões para salvar cenário, analisar cenários e simular outro cenário -->
    <div class="row buttons-row">
      <div style="flex: 1; margin-right: 10px;">
        <button id="saveScenarioButton" class="save-scenario-button" type="button" onclick="addCurrentScenario()" style="display: none;">
          SALVAR CENÁRIO
        </button>
      </div>
      <div style="flex: 1; margin-left: 10px; margin-right: 10px;">
        <button id="analyzeScenarioButton" class="analyze-scenario-button" type="button" onclick="analyzeScenarios()" style="display: none;">
          ANALISAR CENÁRIOS
        </button>
      </div>
      <div style="flex: 1; margin-left: 10px;">
        <button id="newScenarioButton" class="save-scenario-button" type="button" onclick="prepareNewScenario()" style="display: none;">
          SIMULAR OUTRO CENÁRIO
        </button>
      </div>
    </div>

    <!-- Botão WhatsApp para análise personalizada - sempre visível após cálculo -->
    <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
      AVANÇAR PARA ANÁLISE PERSONALIZADA
    </a>
  </div>

  <!-- Botão para Expandir/Retrair Gráficos -->
  <div id="toggleChartsSection" class="charts-toggle-container" style="display: none;">
    <button id="toggleAllChartsButton" class="toggle-charts-button" type="button" onclick="toggleAllCharts()">
      Retrair Todos os Gráficos e Memórias
      <span id="toggleChartsIcon">➖</span>
    </button>
    <p class="toggle-instruction">Clique para mostrar ou ocultar todos os detalhes abaixo.</p>
  </div>

  <!-- Container para gráficos e memórias de cálculo (MOVADO PARA DEPOIS DOS BOTÕES) -->
  <div id="chartsContainer" style="display: none;">
    <div id="chartUnicoContainer" class="chart-container" style="display: none;">
      <div class="chart-title">Evolução do Investimento Único</div>
      <div class="chart-nav">
        <button type="button" onclick="showChartSlide('Unico', 'chart')">Gráfico</button>
        <button type="button" onclick="showChartSlide('Unico', 'table')">Memória de Cálculo</button>
      </div>
      <div class="chart-content">
        <div id="chartUnicoSlide" class="chart-slide">
          <canvas id="chartUnico"></canvas>
        </div>
        <div id="tableUnicoSlide" class="table-slide" style="display: none;">
          <table id="tableUnico" class="data-table">
            <thead>
              <tr>
                <th scope="col">Mês</th>
                <th scope="col">Total Investido</th>
                <th scope="col">Juros</th>
                <th scope="col">Total Juros</th>
                <th scope="col">Total Acumulado</th>
                <th scope="col">Imposto</th>
                <th scope="col">Valor Líquido</th>
                <th scope="col">Objetivo Corrigido</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="chartIdealContainer" class="chart-container" style="display: none;">
      <div class="chart-title">Evolução do Plano Ideal</div>
      <div class="chart-nav">
        <button type="button" onclick="showChartSlide('Ideal', 'chart')">Gráfico</button>
        <button type="button" onclick="showChartSlide('Ideal', 'table')">Memória de Cálculo</button>
      </div>
      <div class="chart-content">
        <div id="chartIdealSlide" class="chart-slide">
          <canvas id="chartIdeal"></canvas>
        </div>
        <div id="tableIdealSlide" class="table-slide" style="display: none;">
          <table id="tableIdeal" class="data-table">
            <thead>
              <tr>
                <th scope="col">Mês</th>
                <th scope="col">Total Investido</th>
                <th scope="col">Juros</th>
                <th scope="col">Total Juros</th>
                <th scope="col">Total Acumulado</th>
                <th scope="col">Imposto</th>
                <th scope="col">Valor Líquido</th>
                <th scope="col">Objetivo Corrigido</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="chartAtualContainer" class="chart-container" style="display: none;">
      <div class="chart-title">Evolução da Poupança Atual</div>
      <div class="chart-nav">
        <button type="button" onclick="showChartSlide('Atual', 'chart')">Gráfico</button>
        <button type="button" onclick="showChartSlide('Atual', 'table')">Memória de Cálculo</button>
      </div>
      <div class="chart-content">
        <div id="chartAtualSlide" class="chart-slide">
          <canvas id="chartAtual"></canvas>
        </div>
        <div id="tableAtualSlide" class="table-slide" style="display: none;">
          <table id="tableAtual" class="data-table">
            <thead>
              <tr>
                <th scope="col">Mês</th>
                <th scope="col">Total Investido</th>
                <th scope="col">Juros</th>
                <th scope="col">Total Juros</th>
                <th scope="col">Total Acumulado</th>
                <th scope="col">Imposto</th>
                <th scope="col">Valor Líquido</th>
                <th scope="col">Objetivo Corrigido</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="chartRentabilidadeContainer" class="chart-container" style="display: none;">
      <div class="chart-title">Evolução da Rentabilidade Necessária</div>
      <div class="chart-nav">
        <button type="button" onclick="showChartSlide('Rentabilidade', 'chart')">Gráfico</button>
        <button type="button" onclick="showChartSlide('Rentabilidade', 'table')">Memória de Cálculo</button>
      </div>
      <div class="chart-content">
        <div id="chartRentabilidadeSlide" class="chart-slide">
          <canvas id="chartRentabilidade"></canvas>
        </div>
        <div id="tableRentabilidadeSlide" class="table-slide" style="display: none;">
          <table id="tableRentabilidade" class="data-table">
            <thead>
              <tr>
                <th scope="col">Mês</th>
                <th scope="col">Total Investido</th>
                <th scope="col">Juros</th>
                <th scope="col">Total Juros</th>
                <th scope="col">Total Acumulado</th>
                <th scope="col">Imposto</th>
                <th scope="col">Valor Líquido</th>
                <th scope="col">Objetivo Corrigido</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais
    let goalDescriptionText = "";
    let resultText = "";
    let scenarios = [];
    let scenarioCounter = 1;
    let calculationComplete = false;
    let currentCalculationData = null;
    let allChartsExpanded = true; // Estado inicial do botão expandir/retrair

    // --- Funções de Formatação e Utilidade ---
    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, "");
      value = (parseFloat(value) / 100).toFixed(2);
      if (isNaN(value)) value = "0.00";
      input.value = "R$ " + parseFloat(value).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function formatPercentage(input) {
      let value = input.value.replace(/\D/g, "");
      value = (parseFloat(value) / 100).toFixed(2);
      if (isNaN(value)) value = "0.00";
      input.value = parseFloat(value).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
    }

    function toggleTaxInput(id, defaultValue) {
      const selectElementId = id === "tax" ? "knowsTax" : "knowsInflation";
      const select = document.getElementById(selectElementId);
      const input = document.getElementById(id);
      if (select.value === "yes") {
        input.disabled = false;
        input.value = "";
        input.placeholder = defaultValue;
      } else {
        input.disabled = true;
        input.value = defaultValue;
      }
    }

    function parseCurrency(value) {
      return parseFloat(value.replace(/R\$\s?/g, "").replace(/\./g, "").replace(",", ".")) || 0;
    }

    function parsePercentage(value) {
      return parseFloat(value.replace(/%\s?/g, "").replace(",", ".")) / 100 || 0;
    }

    function formatMoney(value) {
      return value.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // --- Funções de Exibição (Gráficos, Tabelas, Resultados) ---
    function showChartSlide(chartId, slideType) {
      const chartSlide = document.getElementById(`chart${chartId}Slide`);
      const tableSlide = document.getElementById(`table${chartId}Slide`);
      if (!chartSlide || !tableSlide) return;

      if (slideType === "chart") {
        chartSlide.style.display = "block";
        tableSlide.style.display = "none";
      } else {
        chartSlide.style.display = "none";
        tableSlide.style.display = "block";
      }
    }

    function fillDataTable(tableId, data) {
      const tableBody = document.getElementById(tableId)?.querySelector("tbody");
      if (!tableBody) return;
      tableBody.innerHTML = ""; // Limpar tabela anterior

      data.forEach(d => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${d.month}</td>
          <td>R$ ${formatMoney(d.totalInvestido)}</td>
          <td>R$ ${formatMoney(d.juros)}</td>
          <td>R$ ${formatMoney(d.totalJuros)}</td>
          <td>R$ ${formatMoney(d.totalAcumulado)}</td>
          <td>R$ ${formatMoney(d.imposto)}</td>
          <td>R$ ${formatMoney(d.valorLiquido)}</td>
          <td>R$ ${formatMoney(d.objetivoCorrigido)}</td>
        `;
      });
    }

    function drawChart(ctx, bruto, liquido, investido, objetivo, corBruto, corLiquido, corInvestido) {
      // Destruir gráfico existente se houver
      const existingChart = Chart.getChart(ctx);
      if (existingChart) {
        existingChart.destroy();
      }

      new Chart(ctx, {
        type: "line",
        data: {
          labels: Array.from({ length: bruto.length }, (_, i) => i),
          datasets: [
            {
              label: "Valor Bruto",
              data: bruto,
              borderColor: corBruto,
              backgroundColor: "rgba(255, 150, 150, 0.2)", // Vermelho translúcido genérico
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: false, // Não preencher o bruto para clareza
              hoverBackgroundColor: "rgba(255, 150, 150, 0.4)"
            },
            {
              label: "Valor Líquido",
              data: liquido,
              borderColor: corLiquido,
              backgroundColor: "rgba(100, 255, 100, 0.2)", // Verde translúcido
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: '+1', // Preenche até o próximo dataset (Valor Bruto)
              hoverBackgroundColor: "rgba(100, 255, 100, 0.4)"
            },
            {
              label: "Total Investido",
              data: investido,
              borderColor: corInvestido,
              backgroundColor: "rgba(100, 100, 255, 0.2)", // Azul translúcido
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: 'origin', // Preenche até o eixo
              hoverBackgroundColor: "rgba(100, 100, 255, 0.4)"
            },
            {
              label: "Objetivo Corrigido",
              data: objetivo,
              borderColor: "#000000", // Linha preta para o objetivo
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5], // Linha tracejada
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return "R$ " + value.toLocaleString("pt-BR");
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Meses'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  if (context.parsed.y !== null) {
                    label += "R$ " + context.parsed.y.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // --- Funções de Cálculo ---
    function calculateCompoundInterest(initialValue, monthlyContribution, monthlyRate, months, tax, goal, inflation) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;

      valoresMensais.push({
        month: 0, juros: 0, totalInvestido: totalInvested, totalJuros: 0,
        imposto: 0, valorLiquido: totalValue, totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });

      for (let i = 1; i <= months; i++) {
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;
        if (i % 12 === 0) {
          objetivoCorrigido *= (1 + inflation);
        }
        valoresMensais.push({
          month: i, juros: jurosDoMes, totalInvestido: totalInvested, totalJuros: totalJuros,
          imposto: impostoTotal, valorLiquido: valorLiquido, totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });
      }
      return { valoresMensais };
    }

    function calculateCompoundInterestUntilGoal(initialValue, monthlyContribution, monthlyRate, tax, goal, inflation, maxMonths = 600) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;
      let month = 0;
      let goalReached = false;

      valoresMensais.push({ month: 0, juros: 0, totalInvestido: totalInvested, totalJuros: 0, imposto: 0, valorLiquido: totalValue, totalAcumulado: totalValue, objetivoCorrigido: objetivoCorrigido });

      while (!goalReached && month < maxMonths) {
        month++;
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;
        if (month % 12 === 0) {
          objetivoCorrigido *= (1 + inflation);
        }
        valoresMensais.push({ month: month, juros: jurosDoMes, totalInvestido: totalInvested, totalJuros: totalJuros, imposto: impostoTotal, valorLiquido: valorLiquido, totalAcumulado: totalValue, objetivoCorrigido: objetivoCorrigido });
        if (valorLiquido >= objetivoCorrigido) {
          goalReached = true;
        }
      }
      return { valoresMensais, monthsToGoal: month, goalReached };
    }

    function calculateRequiredRate(goal, currentSavings, monthlyContribution, period, tax, inflation) {
      let lowRate = 0;
      let highRate = 1;
      let requiredMonthlyRate = 0;
      let iterations = 0;
      let result;

      while (iterations < 100) {
        requiredMonthlyRate = (lowRate + highRate) / 2;
        result = calculateCompoundInterest(currentSavings, monthlyContribution, requiredMonthlyRate, period, tax, goal, inflation);
        const valorLiquidoFinal = result.valoresMensais[period]?.valorLiquido || 0;
        const objetivoFinal = result.valoresMensais[period]?.objetivoCorrigido || goal;
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) break;
        if (valorLiquidoFinal > objetivoFinal) highRate = requiredMonthlyRate;
        else lowContribution = requiredMonthlyRate;
        iterations++;
      }
      const requiredAnnualRate = Math.pow(1 + requiredMonthlyRate, 12) - 1;
      return { annualRate: requiredAnnualRate, valoresMensais: result.valoresMensais };
    }

    // --- Funções de Análise e Cenários ---
    function generateRecommendation(goalDescription, goal, currentSavings, currentContribution, idealContribution, months, requiredRate, rate) {
      const recommendationDiv = document.getElementById("recommendation");
      const recommendationText = document.getElementById("recommendationText");
      if (!recommendationDiv || !recommendationText) return;

      const goalGap = goal - currentSavings;
      const contributionGap = idealContribution - currentContribution;
      const contributionPercentage = (idealContribution > 0) ? (currentContribution / idealContribution) * 100 : (currentContribution > 0 ? Infinity : 0);
      const rateGap = requiredRate - rate;
      let analysis = "";

      if (currentSavings > 0) {
        const savingsPercentage = (goal > 0) ? (currentSavings / goal) * 100 : 0;
        analysis += `<p>Valor já guardado: R$ ${formatMoney(currentSavings)}, o que representa ${savingsPercentage.toFixed(1).replace(".", ",")} % do objetivo. `;
        if (savingsPercentage < 10) analysis += `Este é um bom começo, mas ainda há um longo caminho pela frente.</p>`;
        else if (savingsPercentage < 30) analysis += `Já foram dados passos importantes em direção ao objetivo.</p>`;
        else if (savingsPercentage < 60) analysis += `Uma parte significativa do caminho já foi percorrida.</p>`;
        else analysis += `O objetivo está muito próximo de ser alcançado.</p>`;
      } else {
        analysis += `<p>Ainda não foi iniciada a poupança para este objetivo específico.</p>`;
      }

      if (currentContribution > 0) {
        if (contributionPercentage >= 100) analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} é suficiente para atingir o objetivo no prazo desejado.</p>`;
        else if (contributionPercentage >= 80) analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está próximo do ideal. Um pequeno ajuste de R$ ${formatMoney(contributionGap)} a mais por mês seria o suficiente.</p>`;
        else if (contributionPercentage >= 50) analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} representa um bom esforço, mas seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês (acréscimo de R$ ${formatMoney(contributionGap)}).</p>`;
        else analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está significativamente abaixo do ideal (R$ ${formatMoney(idealContribution)}).</p>`;
      } else {
        analysis += `<p>Não estão sendo feitos aportes mensais. Seria necessário poupar R$ ${formatMoney(idealContribution)} por mês.</p>`;
      }

      if (rateGap > 0) {
        const rateGapPercentage = rateGap * 100;
        if (rateGapPercentage > 10) analysis += `<p>A rentabilidade necessária (${(requiredRate * 100).toFixed(2).replace(".", ",")} % a.a.) está ${rateGapPercentage.toFixed(2).replace(".", ",")} p.p. acima da taxa informada. Diferença significativa.</p>`;
        else analysis += `<p>A rentabilidade necessária (${(requiredRate * 100).toFixed(2).replace(".", ",")} % a.a.) está ${rateGapPercentage.toFixed(2).replace(".", ",")} p.p. acima da taxa informada. Diferença pequena.</p>`;
      } else {
        analysis += `<p>A rentabilidade informada de ${(rate * 100).toFixed(2).replace(".", ",")} % a.a. é suficiente.</p>`;
      }

      recommendationText.innerHTML = analysis;
      recommendationDiv.style.display = "block";
      calculationComplete = true;
    }

    function addCurrentScenario() {
      if (!currentCalculationData) return;
      const scenarioData = { name: `Cenário ${scenarioCounter++}`, ...currentCalculationData };
      scenarios.push(scenarioData);
      displayScenarios();
      document.getElementById("scenariosContainer").style.display = "block";
      if (scenarios.length >= 2) {
        document.getElementById("analyzeScenarioButton").style.display = "block";
        analyzeScenarios(); // Analisar automaticamente ao adicionar o segundo cenário
      }
    }

    function displayScenarios() {
      const container = document.getElementById("scenariosContainer");
      if (!container) return;
      container.innerHTML = '<div class="scenarios-header"><h3>Cenários Salvos</h3></div>'; // Limpa e adiciona header

      if (scenarios.length === 0) {
        container.style.display = "none";
        return;
      }

      scenarios.forEach((scenario, index) => {
        const card = document.createElement("div");
        card.className = "scenario-card";
        card.innerHTML = `
          <div class="scenario-header">
            <h4 class="scenario-title">${scenario.name}</h4>
            <div class="scenario-actions">
              <button type="button" class="scenario-select" onclick="selectScenario(${index})">Carregar</button>
              <button type="button" class="scenario-delete" onclick="deleteScenario(${index})">Excluir</button>
            </div>
          </div>
          <div class="scenario-content">
            <div class="scenario-info">
              <p><strong>Objetivo:</strong> R$ ${formatMoney(scenario.goal)}</p>
              <p><strong>Prazo:</strong> ${scenario.period} meses</p>
              <p><strong>Guardado:</strong> R$ ${formatMoney(scenario.currentSavings)}</p>
            </div>
            <div class="scenario-info">
              <p><strong>Aporte:</strong> R$ ${formatMoney(scenario.currentContribution)}/mês</p>
              <p><strong>Taxa:</strong> ${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === 'annual' ? 'a.a.' : 'a.m.'}</p>
              <p><strong>Inflação:</strong> ${(scenario.inflation * 100).toFixed(2).replace(".", ",")}%</p>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
      container.style.display = "block";
    }

    function selectScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      const scenario = scenarios[index];

      document.getElementById("goalDescription").value = scenario.goalDescription || "";
      document.getElementById("goal").value = formatMoney(scenario.goal);
      formatCurrency(document.getElementById("goal"));
      document.getElementById("period").value = scenario.period;
      document.getElementById("currentSavings").value = formatMoney(scenario.currentSavings);
      formatCurrency(document.getElementById("currentSavings"));
      document.getElementById("currentContribution").value = formatMoney(scenario.currentContribution);
      formatCurrency(document.getElementById("currentContribution"));
      document.getElementById("rate").value = (scenario.rate * 100).toFixed(2).replace(".", ",") + " %";
      formatPercentage(document.getElementById("rate"));
      document.getElementById("rateType").value = scenario.rateType;

      document.getElementById("knowsTax").value = scenario.tax > 0.15 || scenario.tax === 0 ? "yes" : "no"; // Ajuste na lógica padrão
      toggleTaxInput("tax", "15,00 %");
      if (document.getElementById("knowsTax").value === "yes") {
        document.getElementById("tax").value = (scenario.tax * 100).toFixed(2).replace(".", ",") + " %";
        formatPercentage(document.getElementById("tax"));
      }

      document.getElementById("knowsInflation").value = scenario.inflation > 0.05 || scenario.inflation === 0 ? "yes" : "no"; // Ajuste na lógica padrão
      toggleTaxInput("inflation", "5,00 %");
      if (document.getElementById("knowsInflation").value === "yes") {
        document.getElementById("inflation").value = (scenario.inflation * 100).toFixed(2).replace(".", ",") + " %";
        formatPercentage(document.getElementById("inflation"));
      }

      clearResults();
      calculateSavings();

      const cards = document.querySelectorAll('.scenario-card');
      cards.forEach((card, i) => card.classList.toggle('active', i === index));
    }

    function deleteScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      if (confirm(`Tem certeza que deseja excluir o ${scenarios[index].name}?`)) {
        scenarios.splice(index, 1);
        displayScenarios();
        if (scenarios.length < 2) {
          document.getElementById("comparisonContainer").style.display = "none";
          document.getElementById("generalAnalysis").style.display = "none";
          document.getElementById("analyzeScenarioButton").style.display = "none";
        } else {
          analyzeScenarios(); // Reanalisar após exclusão
        }
      }
    }

    function analyzeScenarios() {
      if (scenarios.length < 2) return;

      let comparisonContainer = document.getElementById("comparisonContainer");
      let generalAnalysisContainer = document.getElementById("generalAnalysis");

      // Criar containers se não existirem
      if (!comparisonContainer) {
        comparisonContainer = document.createElement("div");
        comparisonContainer.id = "comparisonContainer";
        comparisonContainer.className = "comparison-container";
        comparisonContainer.innerHTML = `
          <h3 class="comparison-header">Comparação de Cenários</h3>
          <div class="comparison-chart-container">
            <canvas id="comparisonChart"></canvas>
          </div>
          <div id="comparisonTableContainer">
            <table id="comparisonTable" class="comparison-table">
              <thead>
                <tr>
                  <th scope="col">Cenário</th>
                  <th scope="col">Obj. Corrigido</th>
                  <th scope="col">Invest. Único</th>
                  <th scope="col">Aporte Ideal</th>
                  <th scope="col">Prazo Atual (m)</th>
                  <th scope="col">Rentab. Nec. (%aa)</th>
                </tr>
              </thead>
              <tbody id="comparisonTableBody"></tbody>
            </table>
          </div>
        `;
        // Inserir após scenariosContainer
        document.getElementById("scenariosContainer").after(comparisonContainer);
      }

      if (!generalAnalysisContainer) {
        generalAnalysisContainer = document.createElement("div");
        generalAnalysisContainer.id = "generalAnalysis";
        generalAnalysisContainer.className = "general-analysis";
        generalAnalysisContainer.innerHTML = `
          <h3>Análise Geral Automática</h3>
          <div id="generalAnalysisText"></div>
        `;
        // Inserir após comparisonContainer
        comparisonContainer.after(generalAnalysisContainer);
      }

      const comparisonTableBody = document.getElementById("comparisonTableBody");
      if (!comparisonTableBody) return;

      comparisonTableBody.innerHTML = "";
      comparisonContainer.style.display = "block";
      generalAnalysisContainer.style.display = "block";

      const labels = scenarios.map(s => s.name);
      const objectiveData = scenarios.map(s => s.finalGoal || 0);
      const singleInvestmentData = scenarios.map(s => s.requiredInitialInvestment || 0);
      const idealContributionData = scenarios.map(s => s.idealContribution || 0);
      const currentPlanMonthsData = scenarios.map(s => s.monthsToGoalAtual > 0 ? s.monthsToGoalAtual : NaN);
      const requiredRateData = scenarios.map(s => s.requiredRate > 0 ? s.requiredRate * 100 : NaN);

      scenarios.forEach((scenario, index) => {
        const row = comparisonTableBody.insertRow();
        row.innerHTML = `
          <td>${scenario.name}</td>
          <td>R$ ${formatMoney(objectiveData[index])}</td>
          <td>R$ ${formatMoney(singleInvestmentData[index])}</td>
          <td>R$ ${formatMoney(idealContributionData[index])}</td>
          <td>${isNaN(currentPlanMonthsData[index]) ? 'N/A' : currentPlanMonthsData[index]}</td>
          <td>${isNaN(requiredRateData[index]) ? 'N/A' : requiredRateData[index].toFixed(2).replace('.', ',') + '%'}</td>
        `;
      });

      highlightComparisonTable();
      drawComparisonChart(labels, objectiveData, singleInvestmentData, idealContributionData, currentPlanMonthsData, requiredRateData);
      generateGeneralAnalysis();
    }

    function highlightComparisonTable() {
      const tableBody = document.getElementById("comparisonTableBody");
      if (!tableBody) return;
      const rows = tableBody.getElementsByTagName("tr");
      if (rows.length === 0) return;

      const columnsToCompare = { objective: 1, singleInvestment: 2, idealContribution: 3, currentPlanMonths: 4, requiredRate: 5 };
      const getCellValue = (row, colIndex) => {
        const cell = row.cells[colIndex];
        if (!cell) return NaN;
        const text = cell.textContent.replace(/R\$\s?/g, "").replace(/\./g, "").replace(/,/g, ".").replace(/%/g, "").trim();
        return text === 'N/A' ? NaN : parseFloat(text);
      };

      Object.values(columnsToCompare).forEach(colIndex => {
        let bestValue = (colIndex >= 2 && colIndex <= 5) ? Infinity : -Infinity; // Menor é melhor para cols 2 a 5
        let worstValue = (colIndex >= 2 && colIndex <= 5) ? -Infinity : Infinity;
        let bestRowIndex = -1, worstRowIndex = -1;
        let validValues = [];

        for (let i = 0; i < rows.length; i++) {
          const value = getCellValue(rows[i], colIndex);
          rows[i].cells[colIndex].classList.remove("best-value", "worst-value"); // Limpar classes
          if (isNaN(value)) continue;
          validValues.push(value);

          if ((colIndex >= 2 && colIndex <= 5) ? (value < bestValue) : (value > bestValue)) { bestValue = value; bestRowIndex = i; }
          if ((colIndex >= 2 && colIndex <= 5) ? (value > worstValue) : (value < worstValue)) { worstValue = value; worstRowIndex = i; }
        }

        if (bestRowIndex !== -1) rows[bestRowIndex].cells[colIndex].classList.add("best-value");
        if (worstRowIndex !== -1 && bestValue !== worstValue) rows[worstRowIndex].cells[colIndex].classList.add("worst-value");
      });
    }

    function drawComparisonChart(labels, objectiveData, singleInvestmentData, idealContributionData, currentPlanMonthsData, requiredRateData) {
      const canvas = document.getElementById('comparisonChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const existingChart = Chart.getChart(ctx);
      if (existingChart) existingChart.destroy();

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Obj. Corrigido (R$)', data: objectiveData, backgroundColor: 'rgba(4, 108, 78, 0.6)', yAxisID: 'y-money' },
            { label: 'Aporte Ideal (R$)', data: idealContributionData, backgroundColor: 'rgba(212, 175, 55, 0.6)', yAxisID: 'y-money' },
            { label: 'Prazo Atual (Meses)', data: currentPlanMonthsData, backgroundColor: 'rgba(111, 66, 193, 0.6)', yAxisID: 'y-months' },
            { label: 'Rentab. Nec. (%aa)', data: requiredRateData, backgroundColor: 'rgba(220, 53, 69, 0.6)', yAxisID: 'y-rate' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            'y-money': { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Valor (R$)' }, ticks: { callback: v => "R$ " + v.toLocaleString("pt-BR") } },
            'y-months': { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Meses' } },
            'y-rate': { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Taxa (% a.a.)' }, ticks: { callback: v => v.toFixed(2).replace('.', ',') + '%' } },
            x: { title: { display: true, text: 'Cenários' } }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  if (context.parsed.y !== null) {
                    if (context.dataset.yAxisID === 'y-money') label += "R$ " + context.parsed.y.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    else if (context.dataset.yAxisID === 'y-rate') label += context.parsed.y.toFixed(2).replace('.', ',') + '%';
                    else label += context.parsed.y;
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    function generateGeneralAnalysis() {
      const analysisText = document.getElementById("generalAnalysisText");
      if (!analysisText || scenarios.length < 2) return;

      let bestContribution = scenarios.reduce((prev, curr) => (curr.idealContribution < prev.idealContribution) ? curr : prev);
      let bestMonths = scenarios.filter(s => s.monthsToGoalAtual > 0).reduce((prev, curr) => (curr.monthsToGoalAtual < prev.monthsToGoalAtual) ? curr : prev, { monthsToGoalAtual: Infinity });
      let bestRate = scenarios.filter(s => s.requiredRate > 0).reduce((prev, curr) => (curr.requiredRate < prev.requiredRate) ? curr : prev, { requiredRate: Infinity });
      let highestGoal = scenarios.reduce((prev, curr) => (curr.finalGoal > prev.finalGoal) ? curr : prev);

      let analysis = `<p>Comparando os ${scenarios.length} cenários simulados:</p><ul>`;
      analysis += `<li>O cenário <strong>${bestContribution.name}</strong> requer o menor <strong>Aporte Ideal Mensal</strong> (R$ ${formatMoney(bestContribution.idealContribution)}).</li>`;
      if (bestMonths.monthsToGoalAtual !== Infinity) {
        analysis += `<li>O cenário <strong>${bestMonths.name}</strong> atinge o objetivo no menor <strong>Prazo com o Plano Atual</strong> (${bestMonths.monthsToGoalAtual} meses).</li>`;
      } else {
        analysis += `<li>Nenhum cenário atinge o objetivo com o plano atual dentro do prazo máximo simulado.</li>`;
      }
      if (bestRate.requiredRate !== Infinity) {
        analysis += `<li>O cenário <strong>${bestRate.name}</strong> exige a menor <strong>Rentabilidade Necessária</strong> (${(bestRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a.).</li>`;
      } else {
        analysis += `<li>Não foi possível calcular a rentabilidade necessária para todos os cenários (provavelmente devido a aportes zero ou negativos).</li>`;
      }
      analysis += `<li>O cenário <strong>${highestGoal.name}</strong> resulta no maior <strong>Objetivo Corrigido pela Inflação</strong> (R$ ${formatMoney(highestGoal.finalGoal)}), geralmente associado a prazos mais longos.</li>`;
      analysis += `</ul><p>Considere qual métrica é mais importante para você (menor esforço mensal, menor tempo, menor risco/rentabilidade) ao escolher o melhor caminho.</p>`;

      analysisText.innerHTML = analysis;
    }

    // --- Funções de Controle da Interface ---
    function clearResults() {
      document.getElementById("result").innerHTML = "";
      document.getElementById("result").style.display = "none";
      document.getElementById("recommendation").style.display = "none";
      document.getElementById("buttonsContainer").style.display = "none"; // Esconder botões de ação
      document.getElementById("toggleChartsSection").style.display = "none"; // Esconder botão de toggle
      document.getElementById("chartsContainer").style.display = "none"; // Esconder container principal dos gráficos

      // Esconder containers individuais de gráficos
      const chartContainerIds = ["chartUnicoContainer", "chartIdealContainer", "chartAtualContainer", "chartRentabilidadeContainer"];
      chartContainerIds.forEach(id => {
        const container = document.getElementById(id);
        if (container) container.style.display = "none";
      });

      // Limpar canvases dos gráficos
      const chartIds = ["chartUnico", "chartIdeal", "chartAtual", "chartRentabilidade"];
      chartIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          const chart = Chart.getChart(ctx);
          if (chart) chart.destroy();
        }
      });

      calculationComplete = false;
      currentCalculationData = null;
    }

    function prepareNewScenario() {
      document.getElementById("goal").value = "";
      document.getElementById("period").value = "";
      document.getElementById("currentSavings").value = "";
      document.getElementById("currentContribution").value = "";
      document.getElementById("rate").value = "";
      document.getElementById("rateType").value = "annual";
      document.getElementById("knowsTax").value = "no";
      document.getElementById("knowsInflation").value = "no";
      toggleTaxInput("tax", "15,00 %");
      toggleTaxInput("inflation", "5,00 %");
      clearResults();
      document.getElementById("savingsForm").scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function openWhatsAppChat() {
      goalDescriptionText = document.getElementById("goalDescription").value;
      const goalText = goalDescriptionText || "(Objetivo não descrito)";
      let scenariosText = "";
      if (scenarios.length > 0) {
        scenariosText = "Cenários simulados:\n";
        scenarios.forEach(s => {
          scenariosText += `\n${s.name}: Obj R$${formatMoney(s.goal)}, Prazo ${s.period}m, Guard R$${formatMoney(s.currentSavings)}, Aporte R$${formatMoney(s.currentContribution)}, Taxa ${(s.rate * 100).toFixed(2).replace(".", ",")}%, Infl ${(s.inflation * 100).toFixed(2).replace(".", ",")}%. Result: Aporte Ideal R$${formatMoney(s.idealContribution)}, Prazo Atual ${s.monthsToGoalAtual > 0 ? s.monthsToGoalAtual + 'm' : 'N/A'}, Rent. Nec. ${(s.requiredRate * 100).toFixed(2).replace(".", ",")}%.`;
        });
      }

      const message = `Olá! Gostaria de uma análise personalizada para meu objetivo financeiro:\n\n*Objetivo:* ${goalText}\n\n*Resultados da Simulação Atual:*\n${resultText.replace(/<[^>]*>/g, "\n").replace(/\n\n+/g, "\n").trim()}\n\n${scenariosText}`;

      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/SEUNUMERO?text=${encodedMessage}`; // SUBSTITUA SEUNUMERO

      // Tentar capturar a tela (opcional, pode falhar dependendo do navegador/permissões)
      try {
        const canvas = await html2canvas(document.body);
        const imageDataUrl = canvas.toDataURL('image/png');
        // Aqui você poderia enviar a imagem para um servidor ou tentar anexá-la (difícil via URL)
        console.log("Screenshot capturado (Data URL no console)");
      } catch (error) {
        console.error("Erro ao capturar screenshot:", error);
      }

      window.open(whatsappUrl, '_blank');
    }

    // --- Função de Toggle Geral dos Gráficos ---
    function toggleAllCharts() {
      const chartsContainer = document.getElementById('chartsContainer');
      const chartContainers = chartsContainer.querySelectorAll('.chart-container');
      const button = document.getElementById('toggleAllChartsButton');
      const icon = document.getElementById('toggleChartsIcon');
      if (!chartsContainer || !button || !icon) return;

      allChartsExpanded = !allChartsExpanded; // Inverte o estado

      chartContainers.forEach(container => {
        // Mostra/esconde apenas os containers que foram originalmente exibidos pelo cálculo
        // Isso evita mostrar containers vazios (ex: chartAtual se não atingiu o objetivo)
        if (container.dataset.initiallyVisible === 'true') {
             container.style.display = allChartsExpanded ? 'block' : 'none';
        }
      });

      if (allChartsExpanded) {
        button.textContent = 'Retrair Todos os Gráficos e Memórias ';
        icon.textContent = '➖';
      } else {
        button.textContent = 'Expandir Todos os Gráficos e Memórias ';
        icon.textContent = '➕';
      }
      button.appendChild(icon); // Re-anexa o ícone após mudar o texto
    }

    // --- Função Principal de Cálculo ---
    function calculateSavings() {
      clearResults();

      // Obter valores do formulário
      goalDescriptionText = document.getElementById("goalDescription").value;
      const goal = parseCurrency(document.getElementById("goal").value);
      const period = parseInt(document.getElementById("period").value) || 0;
      const currentSavings = parseCurrency(document.getElementById("currentSavings").value);
      const currentContribution = parseCurrency(document.getElementById("currentContribution").value);
      let rate = parsePercentage(document.getElementById("rate").value);
      const rateType = document.getElementById("rateType").value;
      const knowsTax = document.getElementById("knowsTax").value === "yes";
      const tax = knowsTax ? parsePercentage(document.getElementById("tax").value) : 0.15;
      const knowsInflation = document.getElementById("knowsInflation").value === "yes";
      const inflation = knowsInflation ? parsePercentage(document.getElementById("inflation").value) : 0.05;

      if (goal <= 0 || period <= 0) {
        alert("Por favor, insira um valor de objetivo e prazo válidos.");
        return;
      }

      const monthlyRate = rateType === "annual" ? Math.pow(1 + rate, 1/12) - 1 : rate;
      const annualRate = rateType === "monthly" ? Math.pow(1 + rate, 12) - 1 : rate;

      // Cálculos
      let inflatedGoalSingle = goal * Math.pow(1 + inflation, Math.floor(period / 12));
      const singleInvestmentResult = calculateCompoundInterest(0, 0, monthlyRate, period, tax, goal, inflation); // Simula juros puros
      const requiredInitialInvestmentNet = inflatedGoalSingle / Math.pow(1 + monthlyRate, period) / (1 - tax * (1 - 1/Math.pow(1 + monthlyRate, period))); // Aproximação considerando imposto no final
      const singleInvestmentData = calculateCompoundInterest(requiredInitialInvestmentNet, 0, monthlyRate, period, tax, goal, inflation);

      let lowContribution = 0, highContribution = goal * 2, idealContribution = 0, iterations = 0, idealResult;
      while (iterations < 100) {
        idealContribution = (lowContribution + highContribution) / 2;
        idealResult = calculateCompoundInterest(currentSavings, idealContribution, monthlyRate, period, tax, goal, inflation);
        const finalNetValue = idealResult.valoresMensais[period]?.valorLiquido || 0;
        const finalGoalValue = idealResult.valoresMensais[period]?.objetivoCorrigido || goal;
        if (Math.abs(finalNetValue - finalGoalValue) < 0.01) break;
        if (finalNetValue > finalGoalValue) highContribution = idealContribution; else lowContribution = idealContribution;
        iterations++;
      }

      const currentPlanResult = calculateCompoundInterestUntilGoal(currentSavings, currentContribution, monthlyRate, tax, goal, inflation);
      const monthsToGoalAtual = currentPlanResult.goalReached ? currentPlanResult.monthsToGoal : -1;

      const requiredRateResult = calculateRequiredRate(goal, currentSavings, currentContribution, period, tax, inflation);
      const requiredAnnualRate = requiredRateResult.annualRate;

      // Exibir Resultados
      const resultDiv = document.getElementById("result");
      const finalObjectiveValue = idealResult.valoresMensais[period]?.objetivoCorrigido || goal;
      resultText = `
        <h3>Resultados da Simulação</h3>
        <p><strong>Objetivo Financeiro:</strong> ${goalDescriptionText || '(Não especificado)'}</p>
        <p><strong>Valor do Objetivo (Corrigido p/ Inflação):</strong> R$ ${formatMoney(finalObjectiveValue)}</p>
        <p><strong>Prazo Desejado:</strong> ${period} meses</p>
        <hr>
        <p><strong>1. Investimento Único Hoje:</strong> R$ ${formatMoney(requiredInitialInvestmentNet)}</p>
        <p><strong>2. Aporte Ideal Mensal:</strong> R$ ${formatMoney(idealContribution)}</p>
        <p><strong>3. Prazo com Plano Atual:</strong> ${monthsToGoalAtual > 0 ? `${monthsToGoalAtual} meses` : 'Não atinge no prazo simulado'}</p>
        <p><strong>4. Rentabilidade Necessária:</strong> ${formatMoney(requiredAnnualRate * 100)}% a.a.</p>
      `;
      resultDiv.innerHTML = resultText;
      resultDiv.style.display = "block";

      currentCalculationData = {
        goalDescription: goalDescriptionText, goal: goal, period: period, currentSavings: currentSavings,
        currentContribution: currentContribution, rate: annualRate, rateType: rateType, tax: tax, inflation: inflation,
        monthlyRate: monthlyRate, requiredInitialInvestment: requiredInitialInvestmentNet, idealContribution: idealContribution,
        monthsToGoalAtual: monthsToGoalAtual, requiredRate: requiredAnnualRate, finalGoal: finalObjectiveValue
      };

      // Gerar Gráficos e Tabelas
      const chartsToShow = [];
      const chartUnicoContainer = document.getElementById("chartUnicoContainer");
      const chartIdealContainer = document.getElementById("chartIdealContainer");
      const chartAtualContainer = document.getElementById("chartAtualContainer");
      const chartRentabilidadeContainer = document.getElementById("chartRentabilidadeContainer");

      if (chartUnicoContainer) {
          const ctxUnico = document.getElementById("chartUnico").getContext("2d");
          const dataUnico = singleInvestmentData.valoresMensais;
          drawChart(ctxUnico, dataUnico.map(d => d.totalAcumulado), dataUnico.map(d => d.valorLiquido), dataUnico.map(d => d.totalInvestido), dataUnico.map(d => d.objetivoCorrigido), 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)');
          fillDataTable("tableUnico", dataUnico);
          chartUnicoContainer.style.display = "block";
          chartUnicoContainer.dataset.initiallyVisible = 'true'; // Marcar para toggle
          showChartSlide("Unico", "chart");
          chartsToShow.push(chartUnicoContainer);
      }
      if (chartIdealContainer) {
          const ctxIdeal = document.getElementById("chartIdeal").getContext("2d");
          const dataIdeal = idealResult.valoresMensais;
          drawChart(ctxIdeal, dataIdeal.map(d => d.totalAcumulado), dataIdeal.map(d => d.valorLiquido), dataIdeal.map(d => d.totalInvestido), dataIdeal.map(d => d.objetivoCorrigido), 'rgba(255, 159, 64, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 205, 86, 1)');
          fillDataTable("tableIdeal", dataIdeal);
          chartIdealContainer.style.display = "block";
          chartIdealContainer.dataset.initiallyVisible = 'true'; // Marcar para toggle
          showChartSlide("Ideal", "chart");
          chartsToShow.push(chartIdealContainer);
      }
      if (monthsToGoalAtual > 0 && chartAtualContainer) {
          const ctxAtual = document.getElementById("chartAtual").getContext("2d");
          const dataAtual = currentPlanResult.valoresMensais.slice(0, monthsToGoalAtual + 1);
          drawChart(ctxAtual, dataAtual.map(d => d.totalAcumulado), dataAtual.map(d => d.valorLiquido), dataAtual.map(d => d.totalInvestido), dataAtual.map(d => d.objetivoCorrigido), 'rgba(201, 203, 207, 1)', 'rgba(0, 0, 0, 1)', 'rgba(100, 100, 100, 1)');
          fillDataTable("tableAtual", dataAtual);
          chartAtualContainer.style.display = "block";
          chartAtualContainer.dataset.initiallyVisible = 'true'; // Marcar para toggle
          showChartSlide("Atual", "chart");
          chartsToShow.push(chartAtualContainer);
      } else if (chartAtualContainer) {
          chartAtualContainer.style.display = "none";
          chartAtualContainer.dataset.initiallyVisible = 'false';
      }
      if (chartRentabilidadeContainer) {
          const ctxRentabilidade = document.getElementById("chartRentabilidade").getContext("2d");
          const dataRentabilidade = requiredRateResult.valoresMensais;
          drawChart(ctxRentabilidade, dataRentabilidade.map(d => d.totalAcumulado), dataRentabilidade.map(d => d.valorLiquido), dataRentabilidade.map(d => d.totalInvestido), dataRentabilidade.map(d => d.objetivoCorrigido), 'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(75, 192, 192, 0.6)');
          fillDataTable("tableRentabilidade", dataRentabilidade);
          chartRentabilidadeContainer.style.display = "block";
          chartRentabilidadeContainer.dataset.initiallyVisible = 'true'; // Marcar para toggle
          showChartSlide("Rentabilidade", "chart");
          chartsToShow.push(chartRentabilidadeContainer);
      }

      // Mostrar container principal dos gráficos e botão de toggle se houver gráficos
      const chartsContainer = document.getElementById("chartsContainer");
      const toggleChartsSection = document.getElementById("toggleChartsSection");
      if (chartsToShow.length > 0) {
          chartsContainer.style.display = "block";
          toggleChartsSection.style.display = "block";
          // Resetar botão para estado expandido
          allChartsExpanded = true;
          const button = document.getElementById('toggleAllChartsButton');
          const icon = document.getElementById('toggleChartsIcon');
          button.textContent = 'Retrair Todos os Gráficos e Memórias ';
          icon.textContent = '➖';
          button.appendChild(icon);
      } else {
          chartsContainer.style.display = "none";
          toggleChartsSection.style.display = "none";
      }

      // Gerar Análise Automatizada
      generateRecommendation(goalDescriptionText, goal, currentSavings, currentContribution, idealContribution, period, requiredAnnualRate, annualRate);

      // Mostrar botões de ação
      document.getElementById("buttonsContainer").style.display = "block";
      document.getElementById("saveScenarioButton").style.display = "block";
      document.getElementById("newScenarioButton").style.display = "block";
      document.getElementById("whatsappButton").style.display = "block";
      if (scenarios.length >= 2) {
        document.getElementById("analyzeScenarioButton").style.display = "block";
      }

      // Scroll para os resultados
      document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', (event) => {
      toggleTaxInput('tax', '15,00 %');
      toggleTaxInput('inflation', '5,00 %');
      displayScenarios(); // Exibir cenários salvos (se houver)
      // Esconder elementos que só aparecem após cálculo
      clearResults();
    });

  </script>
</body>
</html>

