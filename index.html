<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Financeiro</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002d26;
      color: white;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    .saldo-positivo {
         color: #1976d2; /* Azul não brilhante */
    }
    .saldo-negativo {
        color: #c62828; /* Vermelho não brilhante */
    }
    h1 {
      margin: 0 0 20px;
    }
    .cartao-laranja {
        color: #f57c00; /* Laranja não brilhante */
    }
    .conta-amarela {
        color: #fbc02d; /* Amarelo não brilhante */
    }
    .container-principal {
      display: flex;
      width: 200%;
      transition: transform 0.5s ease;
    }

    .container-ativo {
      transform: translateX(-50%);
    }

    .secao-formulario {
      width: 50%;
      padding-right: 20px;
    }

    .secao-resumo {
      width: 50%;
      padding-left: 20px;
    }

    .form-section {
      background-color: #014034;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
    }

    .botoes-formulario {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .table-container {
      background-color: #014034;
      border-radius: 10px;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #006a56;
      text-align: center;
    }

    th {
      background-color: #006a56;
      color: #ffd700;
      position: sticky;
      top: 0;
    }

    .receita { color: #4caf50; }
    .fixa { color: #f44336; }
    .variavel { color: #ff9800; }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }

    .botao-lancar {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-lancar:hover {
      background-color: #ffc400;
    }

    .botao-resumo {
      background-color: #2196F3;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-resumo:hover {
      background-color: #0b7dda;
    }

    .botao-voltar {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .botao-voltar:hover {
      background-color: #e68a00;
    }

    .delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }
    
    .hidden-id {
      display: none;
    }

    .resumo-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }
    
    /* Congelar a primeira coluna (Categoria) */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; /* Cor de fundo igual ao cabeçalho */
    }

    /* Ajuste para o cabeçalho */
    #tabelaResumo thead tr th:first-child {
      background-color: #006a56; /* Cor do cabeçalho */
      z-index: 20; /* Garante que fique acima das células */
    }
    #tabelaResumo tbody tr td:first-child {
      font-weight: bold; /* Opcional: destaque */
    }
    /* Congelar a coluna Descrição */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; /* Cor de fundo */
    }
    
    /* Ajuste para o cabeçalho */
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: #006a56; /* Cor do cabeçalho */
      z-index: 20;
    }
    
    /* Garantir que a Descrição não quebre linha */
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; /* Largura mínima para evitar esmagamento */
    }
    .table-container {
      overflow-x: auto;
      max-width: 100%;
      margin-bottom: 20px;
    }
    
    /* Estilo para células editáveis */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: #014034;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 14px;
    }
    
    .edit-input:focus {
      outline: 2px solid #ffd700;
    }
    
    /* Estilos para os gráficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    
    .grafico-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      width: calc(50% - 40px);
      min-width: 400px;
      box-sizing: border-box;
    }
    
    .grafico-titulo {
      text-align: center;
      margin-bottom: 15px;
      color: #ffd700;
      font-size: 16px;
    }
    
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    
    .seletor-mes {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .seletor-mes select {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
      font-weight: bold;
    }
    
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      width: 100%;
    }
    
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 14px;
      width: 100%;
    }
    
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    .valor-legenda {
      margin-left: 5px;
      font-weight: bold;
    }
    
    .descricao-legenda {
      min-width: 120px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Controle Financeiro</h1>

  <div class="container-principal" id="containerPrincipal">
    <!-- Seção do Formulário -->
    <div class="secao-formulario">
      <div class="form-section">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />

          <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lançar Item</button>
            <button class="botao-resumo" onclick="mostrarResumo()">Ver Resumo e Análises</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th>Descrição</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lançamentos serão inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seção do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaFormulario()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo será inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Seção dos Gráficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o mês: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas e Poupança</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Relação às Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais para os gráficos
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let dadosResumo = null;
    let lancamentos = [];

    // Função para formatar valores monetários corretamente
    function formatarMoeda(valor) {
      // Converter para número
      const numero = typeof valor === 'number' ? valor : parseFloat(valor);
      
      // Formatar com separadores de milhar e decimal
      return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function mostrarResumo() {
      document.getElementById('containerPrincipal').classList.add('container-ativo');
    }

    function voltarParaFormulario() {
      document.getElementById('containerPrincipal').classList.remove('container-ativo');
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Definir datas padrão
      const today = new Date();
      const currentYear = today.getFullYear();
      document.getElementById('dataInicial').value = `${currentYear}-01-01`;
      document.getElementById('dataFinal').value = `${currentYear}-12-31`;
      
      carregarLancamentos();

      // Formatar valor monetário durante a digitação
      document.getElementById('valor').addEventListener('input', function() {
        let v = this.value.replace(/[^\d]/g, '');
        if (v.length < 3) v = v.padStart(3, '0');
        const inteiro = v.slice(0, v.length - 2);
        const decimal = v.slice(v.length - 2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ',' + decimal;
      });
      
      // Controlar as opções de forma de pagamento
      document.getElementById('tipoLancamento').addEventListener('change', function() {
        const formaPagamentoSelect = document.getElementById('formaPagamento');
        
        if (this.value === 'receita') {
          formaPagamentoSelect.innerHTML = '<option value="conta">Conta</option>';
        } else {
          formaPagamentoSelect.innerHTML = `
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          `;
        }
      });
      
      // Inicializar o estado do formulário
      document.getElementById('tipoLancamento').dispatchEvent(new Event('change'));
    });

    function adicionarLancamento() {
      const descricao = document.getElementById('descricao').value.trim();
      const valor = document.getElementById('valor').value.trim();
      const formaPagamento = document.getElementById('formaPagamento').value;
      const tipo = document.getElementById('tipoLancamento').value;
      const frequenciaValor = parseInt(document.getElementById('frequenciaValor').value) || 1;
      const frequenciaTipo = document.getElementById('frequenciaTipo').value;
      let dataInicial = document.getElementById('dataInicial').value;
      let dataFinal = document.getElementById('dataFinal').value;

      // Validações
      if (!descricao || !valor) {
        alert('Preencha a descrição e o valor.');
        return;
      }
      
      if (tipo === 'receita' && formaPagamento !== 'conta') {
        alert('Receitas devem ser lançadas apenas como "Conta"');
        return;
      }

      // Valores padrão para datas
      const currentYear = new Date().getFullYear();
      if (!dataInicial) dataInicial = `${currentYear}-01-01`;
      if (!dataFinal) dataFinal = `${currentYear}-12-31`;

      // Converter valor para número (remover pontos e trocar vírgula por ponto)
      const valorNumerico = parseFloat(valor.replace(/\./g, '').replace(',', '.'));

      // Salvar no localStorage
      let lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
      const novoId = lancamentos.length > 0 ? Math.max(...lancamentos.map(l => l.id)) + 1 : 1;

      lancamentos.push({
        id: novoId,
        descricao,
        valor: valorNumerico,
        formaPagamento,
        tipo,
        frequenciaValor,
        frequenciaTipo,
        dataInicial,
        dataFinal,
        // Adicionamos um campo para armazenar edições manuais
        valoresManuais: Array(12).fill(null)
      });

      localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
      carregarLancamentos();

      // Limpar campos
      document.getElementById('descricao').value = '';
      document.getElementById('valor').value = '';
    }

    function carregarLancamentos() {
      const tabelaBody = document.getElementById('tabelaBody');
      tabelaBody.innerHTML = '';

      lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
      const currentYear = new Date().getFullYear();

      // Ordenar os lançamentos conforme especificado
      const lancamentosOrdenados = ordenarLancamentos(lancamentos);

      lancamentosOrdenados.forEach(l => {
        const tr = document.createElement('tr');
        if (l.formaPagamento === 'credito') tr.classList.add('cartao-credito');

        // Inicializar valoresManuais se não existir
        if (!l.valoresManuais) {
          l.valoresManuais = Array(12).fill(null);
        }

        // Calcular distribuição mensal
        const meses = Array(12).fill(0);
        const ocorrencias = calcularOcorrencias(l, currentYear);
        
        // Distribuir o valor completo para cada ocorrência
        ocorrencias.forEach(data => {
          const mes = data.getMonth();
          // Usar valor manual se existir, senão usar o valor padrão
          meses[mes] = l.valoresManuais[mes] !== null ? l.valoresManuais[mes] : (meses[mes] + l.valor);
        });

        // Calcular total e média
        const total = meses.reduce((sum, val) => sum + val, 0);
        const media = total / 12;

        tr.innerHTML = `
          <td class="hidden-id">${l.id}</td>
          <td class="${l.tipo}">${l.descricao}</td>
          ${meses.map((m, index) => `
            <td class="editable" data-id="${l.id}" data-month="${index}">
              ${m ? formatarMoeda(m) : '-'}
            </td>
          `).join('')}
          <td>${formatarMoeda(total)}</td>
          <td>${formatarMoeda(media)}</td>
          <td><button class="delete-btn" onclick="excluirLancamento(${l.id})">Excluir</button></td>
        `;
        tabelaBody.appendChild(tr);
      });

      // Adicionar eventos de clique para edição
      document.querySelectorAll('.editable').forEach(cell => {
        cell.addEventListener('click', function() {
          iniciarEdicao(this);
        });
      });

      // Atualizar o resumo financeiro
      atualizarResumoFinanceiro(lancamentos, currentYear);
    }

    function iniciarEdicao(cell) {
      const id = parseInt(cell.getAttribute('data-id'));
      const month = parseInt(cell.getAttribute('data-month'));
      const currentValue = cell.textContent.trim();
      
      // Criar input para edição
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'edit-input';
      input.value = currentValue === '-' ? '' : currentValue.replace('R$', '').trim();
      
      // Posicionar o input sobre a célula
      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      
      // Finalizar edição quando perder o foco
      input.addEventListener('blur', function() {
        finalizarEdicao(input, id, month, cell);
      });
      
      // Finalizar edição ao pressionar Enter
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          finalizarEdicao(input, id, month, cell);
        }
      });
    }
    
    function finalizarEdicao(input, id, month, cell) {
      const novoValor = input.value.trim();
      
      // Carregar lançamentos
      let lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
      const lancamento = lancamentos.find(l => l.id === id);
      
      if (lancamento) {
        // Converter valor para número
        let valorNumerico = 0;
        if (novoValor && novoValor !== '-') {
          valorNumerico = parseFloat(novoValor.replace(/\./g, '').replace(',', '.'));
        }
        
        // Atualizar valor manual
        if (!lancamento.valoresManuais) {
          lancamento.valoresManuais = Array(12).fill(null);
        }
        
        lancamento.valoresManuais[month] = valorNumerico || null;
        
        // Salvar no localStorage
        localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
        
        // Recarregar a tabela
        carregarLancamentos();
      }
    }

    function ordenarLancamentos(lancamentos) {
      // Separar em categorias conforme especificado
      const entradas = lancamentos.filter(l => l.tipo === 'receita')
                                 .sort((a, b) => a.descricao.localeCompare(b.descricao));
      
      const fixasNaoCredito = lancamentos.filter(l => l.tipo === 'fixa' && l.formaPagamento !== 'credito')
                                       .sort((a, b) => a.descricao.localeCompare(b.descricao));
      
      const fixasCredito = lancamentos.filter(l => l.tipo === 'fixa' && l.formaPagamento === 'credito')
                                    .sort((a, b) => a.descricao.localeCompare(b.descricao));
      
      const variaveisNaoCredito = lancamentos.filter(l => l.tipo === 'variavel' && l.formaPagamento !== 'credito')
                                           .sort((a, b) => a.descricao.localeCompare(b.descricao));
      
      const variaveisCredito = lancamentos.filter(l => l.tipo === 'variavel' && l.formaPagamento === 'credito')
                                        .sort((a, b) => a.descricao.localeCompare(b.descricao));
      
      // Concatenar na ordem especificada
      return [...entradas, ...fixasNaoCredito, ...fixasCredito, ...variaveisNaoCredito, ...variaveisCredito];
    }

    function calcularOcorrencias(lancamento, ano) {
      const startDate = new Date(lancamento.dataInicial);
      const endDate = new Date(lancamento.dataFinal);
      const ocorrencias = [];
      
      // Se for único, verifica se está dentro do ano
      if (lancamento.frequenciaTipo === 'unico') {
        if (startDate.getFullYear() === ano) {
          ocorrencias.push(new Date(startDate));
        }
        return ocorrencias;
      }
      
      // Ajustar para o ano atual
      const dataInicio = startDate < new Date(`${ano}-01-01`) ? 
        new Date(`${ano}-01-01`) : new Date(startDate);
      const dataFim = endDate > new Date(`${ano}-12-31`) ? 
        new Date(`${ano}-12-31`) : new Date(endDate);
      
      if (dataInicio > dataFim) return ocorrencias;
      
      // Calcular ocorrências
      let currentDate = new Date(dataInicio);
      
      while (currentDate <= dataFim) {
        if (currentDate.getFullYear() === ano) {
          ocorrencias.push(new Date(currentDate));
        }
        
        // Avançar conforme a frequência
        switch(lancamento.frequenciaTipo) {
          case 'dias':
            currentDate.setDate(currentDate.getDate() + lancamento.frequenciaValor);
            break;
          case 'dias_uteis':
            currentDate.setDate(currentDate.getDate() + lancamento.frequenciaValor);
            while ([0, 6].includes(currentDate.getDay())) {
              currentDate.setDate(currentDate.getDate() + 1);
            }
            break;
          case 'meses':
            const nextMonth = currentDate.getMonth() + lancamento.frequenciaValor;
            currentDate.setMonth(nextMonth);
            
            // Ajuste para não pular fevereiro quando dia > 28
            if (currentDate.getMonth() !== (nextMonth % 12)) {
              currentDate.setDate(0); // Vai para o último dia do mês anterior
            }
            break;
          case 'anos':
            currentDate.setFullYear(currentDate.getFullYear() + lancamento.frequenciaValor);
            break;
          case 'semanas':
            currentDate.setDate(currentDate.getDate() + (7 * lancamento.frequenciaValor));
            break;
          case 'quinzenas':
            currentDate.setDate(currentDate.getDate() + (15 * lancamento.frequenciaValor));
            break;
          default: // Dias específicos da semana
            currentDate.setDate(currentDate.getDate() + 7);
        }
      }
      
      return ocorrencias;
    }

    function atualizarResumoFinanceiro(lancamentos, ano) {
      const resumoBody = document.getElementById('resumoBody');
      resumoBody.innerHTML = '';

      // Calcular totais por categoria
      const receitas = calcularTotaisPorCategoria(lancamentos.filter(l => l.tipo === 'receita'), ano);
      const fixas = calcularTotaisPorCategoria(lancamentos.filter(l => l.tipo === 'fixa'), ano);
      const variaveis = calcularTotaisPorCategoria(lancamentos.filter(l => l.tipo === 'variavel'), ano);
      const cartao = calcularTotaisPorCategoria(lancamentos.filter(l => l.formaPagamento === 'credito' && l.tipo !== 'receita'), ano);
      const conta = calcularTotaisPorCategoria(lancamentos.filter(l => l.formaPagamento === 'conta' && l.tipo !== 'receita'), ano);
      
      // Calcular totais gerais
      const totalReceitas = receitas.total;
      const totalFixas = fixas.total;
      const totalVariaveis = variaveis.total;
      const totalDespesas = totalFixas + totalVariaveis;
      const saldo = totalReceitas - totalDespesas;

      // Adicionar linhas ao resumo
      resumoBody.innerHTML = `
        <tr class="receita">
          <td>Receitas</td>
          ${receitas.meses.map(m => `<td>${m ? formatarMoeda(m) : '-'}</td>`).join('')}
          <td>${formatarMoeda(totalReceitas)}</td>
        </tr>
        <tr class="fixa">
          <td>Despesas Fixas</td>
          ${fixas.meses.map(m => `<td>${m ? formatarMoeda(m) : '-'}</td>`).join('')}
          <td>${formatarMoeda(totalFixas)}</td>
        </tr>
        <tr class="variavel">
          <td>Despesas Variáveis</td>
          ${variaveis.meses.map(m => `<td>${m ? formatarMoeda(m) : '-'}</td>`).join('')}
          <td>${formatarMoeda(totalVariaveis)}</td>
        </tr>
        <tr>
          <td>Total Despesas</td>
          ${Array(12).fill(0).map((_, i) => {
            const mes = (fixas.meses[i] || 0) + (variaveis.meses[i] || 0);
            return `<td>${mes ? formatarMoeda(mes) : '-'}</td>`;
          }).join('')}
          <td>${formatarMoeda(totalDespesas)}</td>
        </tr>
        <tr> 
          <td class="saldo-positivo">Potencial de Investimento</td>
          ${Array(12).fill(0).map((_, i) => {
            const mes = (receitas.meses[i] || 0) - (fixas.meses[i] || 0) - (variaveis.meses[i] || 0);
            const classeCor = mes >= 0 ? 'saldo-positivo' : 'saldo-negativo';
            return `<td class="${classeCor}">${mes ? formatarMoeda(mes) : '-'}</td>`;
          }).join('')}
          <td class="${saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${formatarMoeda(saldo)}</td>
        </tr>
        <tr class="cartao-laranja">
          <td>Cartão de Crédito</td>
          ${cartao.meses.map(m => `<td>${m ? formatarMoeda(m) : '-'}</td>`).join('')}
          <td>${formatarMoeda(cartao.total)}</td>
        </tr>
        <tr class="conta-amarela">
          <td>Conta</td>
          ${conta.meses.map(m => `<td>${m ? formatarMoeda(m) : '-'}</td>`).join('')}
          <td>${formatarMoeda(conta.total)}</td>
        </tr>
      `;

      // Armazenar dados para os gráficos
      dadosResumo = {
        receitas: receitas,
        fixas: fixas,
        variaveis: variaveis,
        totalReceitas: totalReceitas,
        totalFixas: totalFixas,
        totalVariaveis: totalVariaveis,
        totalDespesas: totalDespesas,
        saldo: saldo,
        lancamentos: lancamentos
      };

      // Atualizar gráficos
      atualizarGraficos();
    }

    function calcularTotaisPorCategoria(lancamentos, ano) {
      const meses = Array(12).fill(0);
      
      lancamentos.forEach(l => {
        // Se houver valores manuais, usá-los
        if (l.valoresManuais && l.valoresManuais.some(v => v !== null)) {
          l.valoresManuais.forEach((valor, index) => {
            if (valor !== null) {
              meses[index] += valor;
            } else {
              // Se não houver valor manual, calcular normalmente
              const ocorrencias = calcularOcorrencias(l, ano);
              const ocorrenciasMes = ocorrencias.filter(d => d.getMonth() === index);
              if (ocorrenciasMes.length > 0) {
                meses[index] += l.valor;
              }
            }
          });
        } else {
          // Se não houver valores manuais, calcular normalmente
          const ocorrencias = calcularOcorrencias(l, ano);
          
          // Distribuir o valor completo para cada ocorrência
          ocorrencias.forEach(data => {
            const mes = data.getMonth();
            meses[mes] += l.valor;
          });
        }
      });

      const total = meses.reduce((sum, val) => sum + val, 0);
      
      return {
        meses,
        total
      };
    }

    function excluirLancamento(id) {
      if (!confirm('Deseja excluir este lançamento?')) return;

      let lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
      lancamentos = lancamentos.filter(l => l.id !== id);
      localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
      carregarLancamentos();
    }
    
    function atualizarGraficos() {
      if (!dadosResumo) return;
      
      const mesSelecionado = parseInt(document.getElementById('mesSelecionado').value);
      
      // Calcular valores para o mês selecionado ou total anual
      let receita, fixa, variavel, poupanca;
      
      if (mesSelecionado === -1) { // Total anual
        receita = dadosResumo.totalReceitas;
        fixa = dadosResumo.totalFixas;
        variavel = dadosResumo.totalVariaveis;
        poupanca = dadosResumo.saldo > 0 ? dadosResumo.saldo : 0;
      } else { // Mês específico
        receita = dadosResumo.receitas.meses[mesSelecionado] || 0;
        fixa = dadosResumo.fixas.meses[mesSelecionado] || 0;
        variavel = dadosResumo.variaveis.meses[mesSelecionado] || 0;
        const saldoMes = receita - fixa - variavel;
        poupanca = saldoMes > 0 ? saldoMes : 0;
      }
      
      // Atualizar gráfico de Despesas e Poupança
      atualizarGraficoDespesasPoupanca(fixa, variavel, poupanca);
      
      // Atualizar gráfico de Despesas em Relação às Receitas
      atualizarGraficoDespesasReceitas(receita, mesSelecionado);
    }
    
    function atualizarGraficoDespesasPoupanca(fixa, variavel, poupanca) {
      const ctx = document.getElementById('graficoDespesasPoupanca').getContext('2d');
      
      // Destruir gráfico anterior se existir
      if (graficoDespesasPoupanca) {
        graficoDespesasPoupanca.destroy();
      }
      
      const labels = ['Despesas Fixas', 'Despesas Variáveis'];
      const data = [fixa, variavel];
      const backgroundColors = ['#f44336', '#ff9800'];
      
      // Adicionar poupança apenas se for positiva
      if (poupanca > 0) {
        labels.push('Potencial de Poupança');
        data.push(poupanca);
        backgroundColors.push('#1976d2');
      }
      
      // Calcular totais e percentuais para a legenda
      const total = data.reduce((sum, val) => sum + val, 0);
      const percentuais = data.map(val => total > 0 ? (val / total * 100).toFixed(1) + '%' : '0%');
      
      // Atualizar legenda
      const legendaHTML = labels.map((label, i) => `
        <div class="item-legenda">
          <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
          <span class="descricao-legenda">${label}</span>
          <span class="valor-legenda">${formatarMoeda(data[i])}</span>
          <span>(${percentuais[i]})</span>
        </div>
      `).join('');
      
      document.getElementById('legendaDespesasPoupanca').innerHTML = legendaHTML;
      
      // Criar novo gráfico
      graficoDespesasPoupanca = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function atualizarGraficoDespesasReceitas(receita, mesSelecionado) {
      const ctx = document.getElementById('graficoDespesasReceitas').getContext('2d');
      
      // Destruir gráfico anterior se existir
      if (graficoDespesasReceitas) {
        graficoDespesasReceitas.destroy();
      }
      
      // Obter todas as despesas (fixas e variáveis)
      const despesas = dadosResumo.lancamentos.filter(l => l.tipo !== 'receita');
      
      // Agrupar despesas por descrição e calcular valores
      const despesasAgrupadas = {};
      
      despesas.forEach(despesa => {
        // Calcular valor para o mês selecionado ou total anual
        let valor = 0;
        
        if (mesSelecionado === -1) { // Total anual
          const ocorrencias = calcularOcorrencias(despesa, new Date().getFullYear());
          valor = despesa.valor * ocorrencias.length;
          
          // Considerar valores manuais se existirem
          if (despesa.valoresManuais && despesa.valoresManuais.some(v => v !== null)) {
            valor = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
          }
        } else { // Mês específico
          if (despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null) {
            valor = despesa.valoresManuais[mesSelecionado];
          } else {
            const ocorrencias = calcularOcorrencias(despesa, new Date().getFullYear());
            const ocorrenciasNoMes = ocorrencias.filter(d => d.getMonth() === mesSelecionado);
            valor = despesa.valor * ocorrenciasNoMes.length;
          }
        }
        
        if (valor > 0) {
          if (!despesasAgrupadas[despesa.descricao]) {
            despesasAgrupadas[despesa.descricao] = {
              valor: 0,
              tipo: despesa.tipo,
              formaPagamento: despesa.formaPagamento
            };
          }
          despesasAgrupadas[despesa.descricao].valor += valor;
        }
      });
      
      // Converter para arrays para o gráfico
      const labels = [];
      const data = [];
      const backgroundColors = [];
      const tipos = [];
      
      // Ordenar despesas por valor (maiores primeiro)
      const despesasOrdenadas = Object.entries(despesasAgrupadas)
        .map(([descricao, info]) => ({ descricao, ...info }))
        .sort((a, b) => b.valor - a.valor);
      
      // Limitar a 10 despesas principais para evitar gráfico muito poluído
      const despesasParaGrafico = despesasOrdenadas.slice(0, 10);
      
      // Adicionar "Outras despesas" se houver mais de 10
      let outrasDespesas = 0;
      if (despesasOrdenadas.length > 10) {
        outrasDespesas = despesasOrdenadas.slice(10).reduce((sum, d) => sum + d.valor, 0);
      }
      
      // Preparar dados para o gráfico
      despesasParaGrafico.forEach(despesa => {
        labels.push(despesa.descricao);
        data.push(despesa.valor);
        
        // Definir cores baseadas no tipo de despesa
        if (despesa.tipo === 'fixa') {
          backgroundColors.push(despesa.formaPagamento === 'credito' ? '#e53935' : '#f44336');
        } else {
          backgroundColors.push(despesa.formaPagamento === 'credito' ? '#fb8c00' : '#ff9800');
        }
        tipos.push(despesa.tipo);
      });
      
      // Adicionar "Outras despesas" se necessário
      if (outrasDespesas > 0) {
        labels.push('Outras despesas');
        data.push(outrasDespesas);
        backgroundColors.push('#757575');
        tipos.push('variavel');
      }
      
      // Calcular o restante (receitas - total despesas)
      const totalDespesas = data.reduce((sum, val) => sum + val, 0);
      const restante = Math.max(0, receita - totalDespesas);
      
      if (restante > 0) {
        labels.push('Restante');
        data.push(restante);
        backgroundColors.push('#4caf50');
        tipos.push('receita');
      }
      
      // Calcular percentuais em relação à receita
      const percentuais = receita > 0 ? 
        data.map(val => (val / receita * 100).toFixed(1) + '%') : 
        data.map(() => '0%');
      
      // Atualizar legenda
      const legendaHTML = labels.map((label, i) => {
        const tipo = tipos[i];
        const classeCor = tipo === 'fixa' ? 'fixa' : tipo === 'variavel' ? 'variavel' : 'receita';
        return `
          <div class="item-legenda">
            <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
            <span class="descricao-legenda ${classeCor}">${label}</span>
            <span class="valor-legenda">${formatarMoeda(data[i])}</span>
            <span>(${percentuais[i]})</span>
          </div>
        `;
      }).join('');
      
      document.getElementById('legendaDespesasReceitas').innerHTML = legendaHTML;
      
      // Criar novo gráfico
      graficoDespesasReceitas = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  return `${label}: ${formatarMoeda(value)} (${percentuais[context.dataIndex]})`;
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Função para validar campos obrigatórios
    function validarCampos() {
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim();
      const btnEnviar = document.getElementById('btnEnviar');
      
      // Validação básica
      const camposValidos = nome !== '' && telefone !== '' && email !== '';
      
      // Habilitar/desabilitar botão
      btnEnviar.disabled = !camposValidos;
      
      // Mostrar/ocultar mensagens de erro
      document.getElementById('nome-error').style.display = nome === '' ? 'block' : 'none';
      document.getElementById('telefone-error').style.display = telefone === '' ? 'block' : 'none';
      document.getElementById('email-error').style.display = email === '' ? 'block' : 'none';
    }

    // Adicionar máscara de telefone
    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length > 11) {
        value = value.substring(0, 11);
      }
      
      if (value.length > 0) {
        value = value.replace(/^(\d{0,2})(\d{0,5})(\d{0,4})/, function(match, g1, g2, g3) {
          let result = '';
          if (g1) result += `(${g1}`;
          if (g2) result += `) ${g2}`;
          if (g3) result += `-${g3}`;
          return result;
        });
      }
      
      e.target.value = value;
      validarCampos();
    });

    // Validar campos em tempo real
    document.getElementById('nome').addEventListener('input', validarCampos);
    document.getElementById('telefone').addEventListener('input', validarCampos);
    document.getElementById('email').addEventListener('input', validarCampos);

    // Função para adicionar patrimônio (mantida igual)
    function adicionarPatrimonio() {
      const container = document.createElement('div');
      container.className = 'patrimonio-item';
      container.innerHTML = `
        <div class="patrimonio-row">
          <label>Tipo do patrimônio</label>
          <input type="text" name="tipoBem" placeholder="Ex: Imóvel, Carro">
        </div>
        
        <div class="patrimonio-row">
          <div class="radio-group">
            <label>Possui seguro?</label>
            <div class="radio-options">
              <div class="radio-option">
                <input type="radio" name="temSeguro" value="Sim">
                <label>Sim</label>
              </div>
              <div class="radio-option">
                <input type="radio" name="temSeguro" value="Não">
                <label>Não</label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="patrimonio-row">
          <label>Qual o patrimônio</label>
          <input type="text" name="descricaoBem" placeholder="Ex: Corolla 2020, Casa em SP">
        </div>
        
        <button type="button" class="delete-btn" onclick="this.parentElement.remove()">Excluir</button>
      `;
      document.getElementById('listaPatrimonios').appendChild(container);
    }

    // Função para formatar moeda (mantida igual)
    document.querySelectorAll('input.moeda').forEach(input => {
      input.addEventListener('input', function () {
        let valor = this.value.replace(/\D/g, '');
        valor = (valor / 100).toFixed(2) + '';
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        this.value = "R$ " + valor;
      });
    });

    // Função para gerar PDF (atualizada para incluir telefone e email)
    async function gerarPDF() {
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (nome === '' || telefone === '' || email === '') {
        alert("Por favor, preencha todos os campos obrigatórios antes de enviar.");
        validarCampos();
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = new Date().toLocaleDateString();
      let y = 20;
      
      doc.setFontSize(16);
      doc.text('Formulário de Atendimento', 20, y);
      doc.setFontSize(12);
      y += 10;
      
      // Informações básicas
      doc.text(`Nome: ${nome}`, 20, y);
      y += 10;
      doc.text(`Telefone: ${telefone}`, 20, y);
      y += 10;
      doc.text(`E-mail: ${email}`, 20, y);
      y += 15;
      
      // Restante do conteúdo do PDF (mantido igual)
      // ... (código existente para gerar o PDF) ...
      
      doc.save(`Formulario-${nome}-${data}.pdf`);
      alert("PDF gerado com sucesso! Em breve implementaremos o envio automático por email.");
    }

    // Associar função gerarPDF ao botão de enviar
    document.getElementById('btnEnviar').addEventListener('click', gerarPDF);

    // Validar campos ao carregar a página
    document.addEventListener('DOMContentLoaded', validarCampos);
  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Função para validar campos obrigatórios
    function validarCampos() {
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim();
      const btnEnviar = document.getElementById('btnEnviar');
      
      // Validação básica
      const camposValidos = nome !== '' && telefone !== '' && email !== '';
      
      // Habilitar/desabilitar botão
      btnEnviar.disabled = !camposValidos;
      
      // Mostrar/ocultar mensagens de erro
      document.getElementById('nome-error').style.display = nome === '' ? 'block' : 'none';
      document.getElementById('telefone-error').style.display = telefone === '' ? 'block' : 'none';
      document.getElementById('email-error').style.display = email === '' ? 'block' : 'none';
    }

    // Adicionar máscara de telefone
    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length > 11) {
        value = value.substring(0, 11);
      }
      
      if (value.length > 0) {
        value = value.replace(/^(\d{0,2})(\d{0,5})(\d{0,4})/, function(match, g1, g2, g3) {
          let result = '';
          if (g1) result += `(${g1}`;
          if (g2) result += `) ${g2}`;
          if (g3) result += `-${g3}`;
          return result;
        });
      }
      
      e.target.value = value;
      validarCampos();
    });

    // Validar campos em tempo real
    document.getElementById('nome').addEventListener('input', validarCampos);
    document.getElementById('telefone').addEventListener('input', validarCampos);
    document.getElementById('email').addEventListener('input', validarCampos);

    // Função para adicionar patrimônio (mantida igual)
    function adicionarPatrimonio() {
      const container = document.createElement('div');
      container.className = 'patrimonio-item';
      container.innerHTML = `
        <div class="patrimonio-row">
          <label>Tipo do patrimônio</label>
          <input type="text" name="tipoBem" placeholder="Ex: Imóvel, Carro">
        </div>
        
        <div class="patrimonio-row">
          <div class="radio-group">
            <label>Possui seguro?</label>
            <div class="radio-options">
              <div class="radio-option">
                <input type="radio" name="temSeguro" value="Sim">
                <label>Sim</label>
              </div>
              <div class="radio-option">
                <input type="radio" name="temSeguro" value="Não">
                <label>Não</label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="patrimonio-row">
          <label>Qual o patrimônio</label>
          <input type="text" name="descricaoBem" placeholder="Ex: Corolla 2020, Casa em SP">
        </div>
        
        <button type="button" class="delete-btn" onclick="this.parentElement.remove()">Excluir</button>
      `;
      document.getElementById('listaPatrimonios').appendChild(container);
    }

    // Função para formatar moeda (mantida igual)
    document.querySelectorAll('input.moeda').forEach(input => {
      input.addEventListener('input', function () {
        let valor = this.value.replace(/\D/g, '');
        valor = (valor / 100).toFixed(2) + '';
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        this.value = "R$ " + valor;
      });
    });

    // Função para gerar PDF (atualizada para incluir telefone e email)
    async function gerarPDF() {
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (nome === '' || telefone === '' || email === '') {
        alert("Por favor, preencha todos os campos obrigatórios antes de enviar.");
        validarCampos();
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = new Date().toLocaleDateString();
      let y = 20;
      
      doc.setFontSize(16);
      doc.text('Formulário de Atendimento', 20, y);
      doc.setFontSize(12);
      y += 10;
      
      // Informações básicas
      doc.text(`Nome: ${nome}`, 20, y);
      y += 10;
      doc.text(`Telefone: ${telefone}`, 20, y);
      y += 10;
      doc.text(`E-mail: ${email}`, 20, y);
      y += 15;
      
      // Restante do conteúdo do PDF (mantido igual)
      // ... (código existente para gerar o PDF) ...
      
      doc.save(`Formulario-${nome}-${data}.pdf`);
      alert("PDF gerado com sucesso! Em breve implementaremos o envio automático por email.");
    }

    // Associar função gerarPDF ao botão de enviar
    document.getElementById('btnEnviar').addEventListener('click', gerarPDF);

    // Validar campos ao carregar a página
    document.addEventListener('DOMContentLoaded', validarCampos);
  </script>
