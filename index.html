<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Novos Objetivos</title>
  <!-- Adicionando um favicon simples para evitar erro 404 -->
  <link rel="icon" href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-esmeralda-escuro: #034e38;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --fundo-container: #ffffff;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
      --cinza-claro: #e9ecef;
      --cinza-medio: #ced4da;
      --cinza-escuro: #6c757d;
      --verde-destaque: rgba(4, 108, 78, 0.1);
      --vermelho-destaque: rgba(220, 53, 69, 0.1);
      --sombra-padrao: 0 4px 12px rgba(0,0,0,0.1);
      --borda-arredondada: 8px;
      --espacamento-padrao: 20px;
      --transicao-padrao: all 0.3s ease;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      padding: var(--espacamento-padrao);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    
    /* Estilos para o container retrátil de gráficos */
    .charts-toggle-container {
      margin: 25px 0;
      position: relative;
    }
    .toggle-charts-button {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 15px 20px;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      transition: var(--transicao-padrao);
      box-shadow: var(--sombra-padrao);
      position: relative;
      overflow: hidden;
    }
    .toggle-charts-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .toggle-charts-button:before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      pointer-events: none;
    }
    .toggle-charts-button span#toggleChartsIcon {
      font-size: 1.5rem;
      margin-left: 15px;
      transition: transform 0.3s ease;
    }
    .toggle-charts-button-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(4, 108, 78, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(4, 108, 78, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(4, 108, 78, 0);
      }
    }
    .toggle-instruction {
      text-align: center;
      color: var(--cinza-escuro);
      font-style: italic;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    
    /* Estilos para os botões no final da página */
    .fixed-buttons-container {
      margin-top: 30px;
      padding: 20px 0;
      width: 100%;
      background-color: var(--fundo-claro);
      border-top: 1px solid var(--cinza-claro);
      padding: 15px 0;
    }
    .buttons-row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
    }
    h1, h2, h3, h4, h5, h6 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      margin-bottom: var(--espacamento-padrao);
      font-weight: 600;
      line-height: 1.3;
    }
    h1 {
      color: var(--verde-esmeralda-escuro);
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 1.5rem;
      border-bottom: 3px solid var(--dourado);
      padding-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    form {
      background-color: var(--fundo-container);
      padding: var(--espacamento-padrao);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
      margin-bottom: var(--espacamento-padrao);
      border: 1px solid var(--cinza-claro);
    }
    .result {
      margin-top: var(--espacamento-padrao);
      padding: var(--espacamento-padrao);
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation {
      margin: var(--espacamento-padrao) 0;
      padding: var(--espacamento-padrao);
      border: 2px solid var(--verde-esmeralda);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation h3 {
      color: var(--verde-esmeralda-escuro);
      margin-top: 0;
      border-bottom: 2px solid var(--dourado);
      padding-bottom: 10px;
      font-size: 1.4rem;
    }
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .whatsapp-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .save-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--dourado);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
      transition: background-color 0.3s ease;
      text-transform: uppercase;
    }
    .save-scenario-button:hover {
      background-color: var(--dourado-escuro);
      transform: translateY(-2px);
    }
    .analyze-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .analyze-scenario-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--verde-esmeralda-escuro);
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
    }
    .row > div {
      flex: 1;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid var(--cinza-medio);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
      font-size: 1rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--dourado);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      margin-top: 20px;
      padding: 14px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 1rem;
      transition: var(--transicao-padrao);
      letter-spacing: 0.5px;
    }
    button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .chart-container {
      margin-top: 30px;
      position: relative;
      border: 2px solid var(--dourado-claro);
      border-radius: var(--borda-arredondada);
      padding: 20px;
      background-color: var(--fundo-container);
      box-shadow: var(--sombra-padrao);
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      color: var(--verde-esmeralda-escuro);
      font-size: 1.2rem;
      border-bottom: 1px solid var(--dourado);
      padding-bottom: 10px;
    }
    .chart-nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .chart-nav button {
      padding: 10px 20px;
      margin-top: 0;
      width: auto;
      font-size: 0.9rem;
      background-color: var(--dourado);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
    }
    .chart-nav button:hover {
      background-color: var(--dourado-escuro);
    }
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 400px;
      border: 1px solid var(--cinza-claro);
      border-radius: var(--borda-arredondada);
      background-color: var(--fundo-container);
    }
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    .table-slide {
      flex: 0 0 100%;
      overflow-x: auto;
      overflow-y: auto;
      padding: 15px;
      background-color: var(--fundo-container);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      min-width: 800px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .data-table th, .data-table td {
      border: 1px solid var(--cinza-claro);
      padding: 10px;
      text-align: right;
      white-space: nowrap;
    }
    .data-table th {
      background-color: var(--verde-esmeralda);
      color: white;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table tr:nth-child(even) {
      background-color: var(--verde-destaque);
    }
    .data-table tr:hover {
      background-color: var(--dourado-claro);
    }
    .scenarios-container {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .scenarios-header {
      margin-bottom: 20px;
      border-bottom: 2px solid var(--verde-esmeralda);
      padding-bottom: 10px;
    }
    .scenarios-header h3 {
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      font-size: 1.4rem;
    }
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .scenarios-header h3 {
      color: var(--verde-esmeralda);
      margin: 0;
    }
    .scenario-card {
      border: 1px solid var(--cinza-medio);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--cinza-claro);
      position: relative;
    }
    .scenario-card.active {
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
    }
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .scenario-title {
      font-weight: bold;
      color: var(--verde-esmeralda);
      margin: 0;
    }
    .scenario-actions {
      display: flex;
      gap: 10px;
    }
    .scenario-actions button {
      padding: 5px 10px;
      margin: 0;
      width: auto;
      font-size: 12px;
    }
    .scenario-delete {
      background-color: #dc3545;
    }
    .scenario-delete:hover {
      background-color: #c82333;
    }
    .scenario-select {
      background-color: var(--dourado);
    }
    .scenario-select:hover {
      background-color: var(--dourado-escuro);
    }
    .scenario-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .scenario-info {
      flex: 1;
      min-width: 200px;
    }
    .scenario-info p {
      margin: 5px 0;
    }
    .scenario-info strong {
      color: var(--verde-esmeralda);
    }
    .scenario-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--fundo-claro);
      border-radius: 5px;
      font-size: 14px;
    }
    /* Estilos para comparação de cenários */
    .comparison-container {
      margin-top: 30px;
      border: 2px solid var(--roxo);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .comparison-header {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
    .comparison-chart-container {
      height: 400px;
      margin: 20px 0;
    }
    #comparisonTableContainer {
      overflow-x: auto; /* Habilitar rolagem horizontal */
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 900px; /* Garantir largura mínima para forçar rolagem se necessário */
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      white-space: nowrap; /* Evitar quebra de linha nas células */
    }
    .comparison-table th {
      background-color: var(--roxo-translucido);
      color: var(--roxo-escuro);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .comparison-table tr:nth-child(even) {
      background-color: var(--fundo-claro);
    }
    .comparison-table .best-value {
      font-weight: bold;
      color: var(--verde-esmeralda);
      background-color: var(--verde-destaque);
    }
    .comparison-table .worst-value {
      font-weight: bold;
      color: #dc3545;
      background-color: var(--vermelho-destaque);
    }
    .general-analysis {
      margin-top: 30px;
      padding: 20px;
      border: 2px solid var(--roxo);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .general-analysis h3 {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Objetivos</h1>
  <form id="savingsForm" onsubmit="event.preventDefault(); calculateSavings();">
    <label for="goalDescription">Qual é o seu objetivo financeiro e por que ele é importante para você?</label>
    <textarea id="goalDescription" placeholder="Ex: Comprar um imóvel para ter segurança e estabilidade para minha família, ou fazer uma viagem internacional para conhecer novas culturas..."></textarea>

    <label for="goal">Valor do Objetivo (R$):</label>
    <input type="text" id="goal" required oninput="formatCurrency(this)">

    <label for="period">Prazo (em meses):</label>
    <input type="number" id="period" required>

    <label for="currentSavings">Valor já Guardado (R$):</label>
    <input type="text" id="currentSavings" required oninput="formatCurrency(this)">

    <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
    <input type="text" id="currentContribution" required oninput="formatCurrency(this)">

    <div class="row">
      <div>
        <label for="rate">Taxa de Juros (%):</label>
        <input type="text" id="rate" required oninput="formatPercentage(this)">
      </div>
      <div>
        <label for="rateType">Tipo de Taxa:</label>
        <select id="rateType">
          <option value="annual">Anual</option>
          <option value="monthly">Mensal</option>
        </select>
      </div>
    </div>

    <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
    <div class="row">
      <div>
        <select id="knowsTax" onchange="toggleTaxInput('tax', '15,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="tax" placeholder="15,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <label>Você sabe a taxa de inflação dos últimos 12 meses?</label>
    <div class="row">
      <div>
        <select id="knowsInflation" onchange="toggleTaxInput('inflation', '5,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="inflation" placeholder="5,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <button type="submit">Calcular</button>
  </form>

  <div id="result" class="result" style="display: none;"></div>

  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>
  
  <!-- Container para gráficos e memórias de cálculo (retrátil) -->
  <div id="chartsContainer" style="display: none;">
    <div class="charts-toggle-container">
      <button id="toggleChartsButton" class="toggle-charts-button toggle-charts-button-pulse" type="button" onclick="toggleAllCharts()">
        <span id="toggleChartsText">EXPANDIR/RETRAIR GRÁFICOS E MEMÓRIAS DE CÁLCULO</span>
        <span id="toggleChartsIcon">▼</span>
      </button>
      <div class="toggle-instruction">Clique no botão acima para mostrar ou ocultar todos os gráficos e memórias de cálculo</div>
    </div>
    <div id="chartsContent" style="display: block;">
      <div id="chartUnicoContainer" class="chart-container">
        <div class="chart-title">Evolução do Investimento Único</div>
        <div class="chart-nav">
          <button type="button" onclick="showChartSlide('Unico', 'chart')">Gráfico</button>
          <button type="button" onclick="showChartSlide('Unico', 'table')">Memória de Cálculo</button>
        </div>
        <div class="chart-content">
          <div id="chartUnicoSlide" class="chart-slide">
            <canvas id="chartUnico"></canvas>
          </div>
          <div id="tableUnicoSlide" class="table-slide" style="display: none;">
            <table id="tableUnico" class="data-table">
              <thead>
                <tr>
                  <th scope="col">Mês</th>
                  <th scope="col">Total Investido</th>
                  <th scope="col">Juros</th>
                  <th scope="col">Total Juros</th>
                  <th scope="col">Total Acumulado</th>
                  <th scope="col">Imposto</th>
                  <th scope="col">Valor Líquido</th>
                  <th scope="col">Objetivo Corrigido</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="chartIdealContainer" class="chart-container">
        <div class="chart-title">Evolução do Plano Ideal</div>
        <div class="chart-nav">
          <button type="button" onclick="showChartSlide('Ideal', 'chart')">Gráfico</button>
          <button type="button" onclick="showChartSlide('Ideal', 'table')">Memória de Cálculo</button>
        </div>
        <div class="chart-content">
          <div id="chartIdealSlide" class="chart-slide">
            <canvas id="chartIdeal"></canvas>
          </div>
          <div id="tableIdealSlide" class="table-slide" style="display: none;">
            <table id="tableIdeal" class="data-table">
              <thead>
                <tr>
                  <th scope="col">Mês</th>
                  <th scope="col">Total Investido</th>
                  <th scope="col">Juros</th>
                  <th scope="col">Total Juros</th>
                  <th scope="col">Total Acumulado</th>
                  <th scope="col">Imposto</th>
                  <th scope="col">Valor Líquido</th>
                  <th scope="col">Objetivo Corrigido</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="chartAtualContainer" class="chart-container">
        <div class="chart-title">Evolução da Poupança Atual</div>
        <div class="chart-nav">
          <button type="button" onclick="showChartSlide('Atual', 'chart')">Gráfico</button>
          <button type="button" onclick="showChartSlide('Atual', 'table')">Memória de Cálculo</button>
        </div>
        <div class="chart-content">
          <div id="chartAtualSlide" class="chart-slide">
            <canvas id="chartAtual"></canvas>
          </div>
          <div id="tableAtualSlide" class="table-slide" style="display: none;">
            <table id="tableAtual" class="data-table">
              <thead>
                <tr>
                  <th scope="col">Mês</th>
                  <th scope="col">Total Investido</th>
                  <th scope="col">Juros</th>
                  <th scope="col">Total Juros</th>
                  <th scope="col">Total Acumulado</th>
                  <th scope="col">Imposto</th>
                  <th scope="col">Valor Líquido</th>
                  <th scope="col">Objetivo Corrigido</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="chartRentabilidadeContainer" class="chart-container">
        <div class="chart-title">Evolução da Rentabilidade Necessária</div>
        <div class="chart-nav">
          <button type="button" onclick="showChartSlide('Rentabilidade', 'chart')">Gráfico</button>
          <button type="button" onclick="showChartSlide('Rentabilidade', 'table')">Memória de Cálculo</button>
        </div>
        <div class="chart-content">
          <div id="chartRentabilidadeSlide" class="chart-slide">
            <canvas id="chartRentabilidade"></canvas>
          </div>
          <div id="tableRentabilidadeSlide" class="table-slide" style="display: none;">
            <table id="tableRentabilidade" class="data-table">
              <thead>
                <tr>
                  <th scope="col">Mês</th>
                  <th scope="col">Total Investido</th>
                  <th scope="col">Juros</th>
                  <th scope="col">Total Juros</th>
                  <th scope="col">Total Acumulado</th>
                  <th scope="col">Imposto</th>
                  <th scope="col">Valor Líquido</th>
                  <th scope="col">Objetivo Corrigido</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botões no final da página -->
  <div id="buttonsContainer" class="fixed-buttons-container">
    <!-- Botões para salvar cenário, analisar cenários e simular outro cenário -->
    <div class="row buttons-row">
      <div style="flex: 1; margin-right: 10px;">
        <button id="saveScenarioButton" class="save-scenario-button" type="button" onclick="addCurrentScenario()" style="display: none;">
          SALVAR CENÁRIO
        </button>
      </div>
      <div style="flex: 1; margin-left: 10px; margin-right: 10px;">
        <button id="analyzeScenarioButton" class="analyze-scenario-button" type="button" onclick="analyzeScenarios()" style="display: none;">
          ANALISAR CENÁRIOS
        </button>
      </div>
      <div style="flex: 1; margin-left: 10px;">
        <button id="newScenarioButton" class="save-scenario-button" type="button" onclick="prepareNewScenario()" style="display: none;">
          SIMULAR OUTRO CENÁRIO
        </button>
      </div>
    </div>

    <!-- Botão WhatsApp para análise personalizada - sempre visível após cálculo -->
    <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
      AVANÇAR PARA ANÁLISE PERSONALIZADA
    </a>
  </div>

  <script>
    // Variáveis globais para armazenar os resultados e textos
    let goalDescriptionText = "";
    let resultText = "";

    // Array para armazenar os cenários (agora com dados simplificados + calculados)
    let scenarios = [];
    let scenarioCounter = 1; // Contador para nomeação automática de cenários
    let isSavingScenario = false; // Flag para evitar duplicidade ao salvar cenários
    let calculationComplete = false; // Flag para indicar se o cálculo foi concluído
    let currentCalculationData = null; // Armazena os dados do cálculo atual para salvar e análise

    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, "");
      value = (parseFloat(value) / 100).toFixed(2);
      if (isNaN(value)) value = "0.00";
      input.value = "R$ " + parseFloat(value).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function formatPercentage(input) {
      let value = input.value.replace(/\D/g, "");
      value = (parseFloat(value) / 100).toFixed(2);
      if (isNaN(value)) value = "0.00";
      input.value = parseFloat(value).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
    }

    function toggleTaxInput(id, defaultValue) {
      const selectElementId = id === "tax" ? "knowsTax" : "knowsInflation";
      const select = document.getElementById(selectElementId);
      const input = document.getElementById(id);
      if (select.value === "yes") {
        input.disabled = false;
        input.value = ""; // Limpa o valor se o usuário sabe
        input.placeholder = defaultValue; // Mantém o placeholder como guia
      } else {
        input.disabled = true;
        input.value = defaultValue; // Define o valor padrão se o usuário não sabe
      }
    }

    function parseCurrency(value) {
      // Remove "R$", espaços, e troca "." por nada (milhar) e "," por "." (decimal)
      return parseFloat(value.replace(/R\$\s?/g, "").replace(/\./g, "").replace(",", ".")) || 0;
    }

    function parsePercentage(value) {
      // Remove "%", espaços, e troca "," por "."
      return parseFloat(value.replace(/%\s?/g, "").replace(",", ".")) / 100 || 0;
    }

    // Função para formatar valores monetários com sempre duas casas decimais
    function formatMoney(value) {
      return value.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Função para alternar entre visualização de gráfico e tabela
    function showChartSlide(chartId, slideType) {
      const chartSlide = document.getElementById(`chart${chartId}Slide`);
      const tableSlide = document.getElementById(`table${chartId}Slide`);

      if (slideType === "chart") {
        chartSlide.style.display = "block";
        tableSlide.style.display = "none";
      } else {
        chartSlide.style.display = "none";
        tableSlide.style.display = "block";
      }
    }

    // Função para abrir o WhatsApp com a mensagem personalizada
    async function openWhatsAppChat() {
      // Obter o texto do objetivo
      goalDescriptionText = document.getElementById("goalDescription").value;
      const goalText = goalDescriptionText || "(Objetivo não descrito)";

      // Criar a string com os cenários simulados
      let scenariosText = "";
      if (scenarios.length > 0) {
        scenariosText = "Cenários simulados:\n";
        scenarios.forEach(scenario => {
          scenariosText += `\n${scenario.name}:\n`;
          scenariosText += `  - Objetivo: R$ ${formatMoney(scenario.goal)}\n`;
          scenariosText += `  - Prazo: ${scenario.period} meses\n`;
          scenariosText += `  - Valor Guardado: R$ ${formatMoney(scenario.currentSavings)}\n`;
          scenariosText += `  - Aporte Mensal: R$ ${formatMoney(scenario.currentContribution)}\n`;
          scenariosText += `  - Taxa Juros: ${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === "annual" ? "a.a." : "a.m."}\n`;
          scenariosText += `  - Inflação: ${(scenario.inflation * 100).toFixed(2).replace(".", ",")}%\n`;
          scenariosText += `  - Imposto: ${(scenario.tax * 100).toFixed(2).replace(".", ",")}%\n`;
        });
      } else if (currentCalculationData) {
        // Se não houver cenários salvos, usar os dados do cálculo atual
        scenariosText = "Cenário atual:\n";
        scenariosText += `  - Objetivo: R$ ${formatMoney(currentCalculationData.goal)}\n`;
        scenariosText += `  - Prazo: ${currentCalculationData.period} meses\n`;
        scenariosText += `  - Valor Guardado: R$ ${formatMoney(currentCalculationData.currentSavings)}\n`;
        scenariosText += `  - Aporte Mensal: R$ ${formatMoney(currentCalculationData.currentContribution)}\n`;
        scenariosText += `  - Taxa Juros: ${(currentCalculationData.rate * 100).toFixed(2).replace(".", ",")}% ${currentCalculationData.rateType === "annual" ? "a.a." : "a.m."}\n`;
        scenariosText += `  - Inflação: ${(currentCalculationData.inflation * 100).toFixed(2).replace(".", ",")}%\n`;
        scenariosText += `  - Imposto: ${(currentCalculationData.tax * 100).toFixed(2).replace(".", ",")}%\n`;
      } else {
        scenariosText = "(Nenhum cenário simulado ou calculado)";
      }

      // Criar a mensagem para o WhatsApp
      const message = `Oi Hugo, queria tua ajuda com meu objetivo:\n${goalText}\n\n${scenariosText}\n\nEstou usando a calculadora que você criou.`;

      // Codificar a mensagem para URL
      const encodedMessage = encodeURIComponent(message);

      // Criar o link do WhatsApp usando a API correta
      const whatsappUrl = `https://api.whatsapp.com/send?phone=5581994297920&text=${encodedMessage}`;

      // Abrir o link em uma nova janela
      window.open(whatsappUrl, "_blank");
    }

    // Função para preencher a tabela de dados
    function fillDataTable(tableId, data) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = ""; // Corrigido: String vazia

      // Começar do mês 1 (não do mês 0)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const tr = document.createElement("tr");

        // Mês
        const tdMes = document.createElement("td");
        tdMes.textContent = row.month;
        tr.appendChild(tdMes);

        // Total Investido
        const tdInvestido = document.createElement("td");
        tdInvestido.textContent = `R$ ${formatMoney(row.totalInvestido)}`;
        tr.appendChild(tdInvestido);

        // Juros
        const tdJuros = document.createElement("td");
        tdJuros.textContent = `R$ ${formatMoney(row.juros)}`;
        tr.appendChild(tdJuros);

        // Total Juros
        const tdTotalJuros = document.createElement("td");
        tdTotalJuros.textContent = `R$ ${formatMoney(row.totalJuros)}`;
        tr.appendChild(tdTotalJuros);

        // Total Acumulado
        const tdAcumulado = document.createElement("td");
        tdAcumulado.textContent = `R$ ${formatMoney(row.totalAcumulado)}`;
        tr.appendChild(tdAcumulado);

        // Imposto
        const tdImposto = document.createElement("td");
        tdImposto.textContent = `R$ ${formatMoney(row.imposto)}`;
        tr.appendChild(tdImposto);

        // Valor Líquido
        const tdLiquido = document.createElement("td");
        tdLiquido.textContent = `R$ ${formatMoney(row.valorLiquido)}`;
        tr.appendChild(tdLiquido);

        // Objetivo Corrigido
        const tdObjetivo = document.createElement("td");
        tdObjetivo.textContent = `R$ ${formatMoney(row.objetivoCorrigido)}`;
        tr.appendChild(tdObjetivo);

        tbody.appendChild(tr);
      }
    }

    function drawChart(ctx, bruto, liquido, investido, objetivo, corBruto, corLiquido, corInvestido) {
      // Destruir gráfico existente se houver
      const existingChart = Chart.getChart(ctx);
      if (existingChart) {
        existingChart.destroy();
      }

      new Chart(ctx, {
        type: "line",
        data: {
          labels: Array.from({length: bruto.length}, (_, i) => i), // Começar do mês 0
          datasets: [
            {
              label: "Valor Bruto",
              data: bruto,
              borderColor: corBruto,
              backgroundColor: "rgba(255, 100, 100, 0.2)", // Vermelho translúcido
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: 'origin',
              hoverBackgroundColor: "rgba(255, 100, 100, 0.4)"
            },
            {
              label: "Valor Líquido",
              data: liquido,
              borderColor: corLiquido,
              backgroundColor: "rgba(100, 255, 100, 0.2)", // Verde translúcido
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: '+1', // Preenche até o próximo dataset (Valor Bruto)
              hoverBackgroundColor: "rgba(100, 255, 100, 0.4)"
            },
            {
              label: "Total Investido",
              data: investido,
              borderColor: corInvestido,
              backgroundColor: "rgba(100, 100, 255, 0.2)", // Azul translúcido
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: 'origin', // Preenche até o eixo
              hoverBackgroundColor: "rgba(100, 100, 255, 0.4)"
            },
            {
              label: "Objetivo Corrigido",
              data: objetivo,
              borderColor: "#000000", // Linha preta para o objetivo
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5], // Linha tracejada
              pointRadius: 0,
              pointHoverRadius: 5,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return "R$ " + value.toLocaleString("pt-BR");
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Meses'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || ""; // Corrigido: String vazia
                  if (label) {
                    label += ": ";
                  }
                  if (context.parsed.y !== null) {
                    label += "R$ " + context.parsed.y.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Função para calcular juros compostos
    function calculateCompoundInterest(initialValue, monthlyContribution, monthlyRate, months, tax, goal, inflation) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;

      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });

      for (let i = 1; i <= months; i++) {
        // Calcular juros do mês
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;

        // Adicionar aporte mensal
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;

        // Calcular imposto sobre o rendimento
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;

        // Calcular objetivo corrigido pela inflação (a cada 12 meses)
        if (i % 12 === 0) {
          objetivoCorrigido = objetivoCorrigido * (1 + inflation);
        }

        // Registrar valores mensais para gráfico e análise
        valoresMensais.push({
          month: i,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });
      }

      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais
      };
    }

    // Função para calcular juros compostos até atingir o objetivo
    function calculateCompoundInterestUntilGoal(initialValue, monthlyContribution, monthlyRate, tax, goal, inflation, maxMonths = 600) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;
      let month = 0;
      let goalReached = false;

      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });

      while (!goalReached && month < maxMonths) {
        month++;

        // Calcular juros do mês
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;

        // Adicionar aporte mensal
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;

        // Calcular imposto sobre o rendimento
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;

        // Calcular objetivo corrigido pela inflação (a cada 12 meses)
        if (month % 12 === 0) {
          objetivoCorrigido = objetivoCorrigido * (1 + inflation);
        }

        // Registrar valores mensais para gráfico e análise
        valoresMensais.push({
          month: month,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });

        // Verificar se o objetivo foi atingido
        if (valorLiquido >= objetivoCorrigido) {
          goalReached = true;
        }
      }

      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais,
        monthsToGoal: month,
        goalReached: goalReached
      };
    }

    // Função para calcular a taxa anual necessária para atingir o objetivo no prazo desejado
    function calculateRequiredRate(goal, currentSavings, monthlyContribution, period, tax, inflation) {
      // Ajustar o objetivo pela inflação (anualmente)
      let inflatedGoal = goal;
      const yearsCount = Math.floor(period / 12);

      // Aplicar inflação para anos completos
      for (let i = 0; i < yearsCount; i++) {
        inflatedGoal *= (1 + inflation);
      }

      // Busca binária para encontrar a taxa mensal necessária
      let lowRate = 0;
      let highRate = 1; // 100% ao mês como limite superior inicial
      let requiredMonthlyRate = 0;
      let iterations = 0;
      let result;

      while (iterations < 100) { // Limite de iterações para evitar loop infinito
        requiredMonthlyRate = (lowRate + highRate) / 2;
        result = calculateCompoundInterest(currentSavings, monthlyContribution, requiredMonthlyRate, period, tax, goal, inflation);

        // Verificar se o valor líquido final está próximo o suficiente do objetivo
        const valorLiquidoFinal = result.valoresMensais[period].valorLiquido;
        const objetivoFinal = result.valoresMensais[period].objetivoCorrigido;

        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) {
          break;
        }

        // Ajusta os limites da busca
        if (valorLiquidoFinal > objetivoFinal) {
          highRate = requiredMonthlyRate;
        } else {
          lowRate = requiredMonthlyRate;
        }

        iterations++;
      }

      // Converter taxa mensal para anual: (1 + taxa_mensal)^12 - 1
      const requiredAnnualRate = Math.pow(1 + requiredMonthlyRate, 12) - 1;

      return {
        monthlyRate: requiredMonthlyRate,
        annualRate: requiredAnnualRate,
        finalValue: result.finalValue,
        finalGoal: inflatedGoal,
        valoresMensais: result.valoresMensais
      };
    }

    // Função para gerar análise automatizada
    function generateRecommendation(goalDescription, goal, currentSavings, currentContribution, idealContribution, months, requiredRate, rate) {
      const recommendationDiv = document.getElementById("recommendation");
      const recommendationText = document.getElementById("recommendationText");

      // Extrair informações relevantes
      const goalGap = goal - currentSavings;
      const contributionGap = idealContribution - currentContribution;
      const contributionPercentage = (idealContribution > 0) ? (currentContribution / idealContribution) * 100 : (currentContribution > 0 ? Infinity : 0);
      const rateGap = requiredRate - rate;

      let analysis = ""; // Corrigido: String vazia

      // Análise da situação atual
      if (currentSavings > 0) {
        const savingsPercentage = (goal > 0) ? (currentSavings / goal) * 100 : 0;
        analysis += `<p>Valor já guardado: R$ ${formatMoney(currentSavings)}, o que representa ${savingsPercentage.toFixed(1).replace(".", ",")} % do objetivo. `;

        if (savingsPercentage < 10) {
          analysis += `Este é um bom começo, mas ainda há um longo caminho pela frente.</p>`;
        } else if (savingsPercentage < 30) {
          analysis += `Já foram dados passos importantes em direção ao objetivo.</p>`;
        } else if (savingsPercentage < 60) {
          analysis += `Uma parte significativa do caminho já foi percorrida.</p>`;
        } else {
          analysis += `O objetivo está muito próximo de ser alcançado.</p>`;
        }
      } else {
        analysis += `<p>Ainda não foi iniciada a poupança para este objetivo específico.</p>`;
      }

      // Análise do aporte mensal
      if (currentContribution > 0) {
        if (contributionPercentage >= 100) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} é suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 80) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está próximo do ideal. Um pequeno ajuste de R$ ${formatMoney(contributionGap)} a mais por mês seria o suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 50) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} representa um bom esforço, mas para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês (um acréscimo de R$ ${formatMoney(contributionGap)}).</p>`;
        } else {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está significativamente abaixo do ideal. Para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês.</p>`;
        }
      } else {
        analysis += `<p>Não estão sendo feitos aportes mensais. Para atingir o objetivo no prazo desejado, seria necessário poupar R$ ${formatMoney(idealContribution)} por mês.</p>`;
      }

      // Análise da rentabilidade
      if (rateGap > 0) {
        const rateGapPercentage = rateGap * 100;
        if (rateGapPercentage > 10) {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace(".", ",")} % ao ano, o que está ${rateGapPercentage.toFixed(2).replace(".", ",")} pontos percentuais acima da taxa informada. Esta diferença é significativa e pode representar um risco maior.</p>`;
        } else {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace(".", ",")} % ao ano, o que está ${rateGapPercentage.toFixed(2).replace(".", ",")} pontos percentuais acima da taxa informada. Esta diferença é relativamente pequena e pode ser alcançável com ajustes na estratégia de investimento.</p>`;
        }
      } else {
        analysis += `<p>A rentabilidade informada de ${(rate * 100).toFixed(2).replace(".", ",")} % ao ano é suficiente para atingir o objetivo no prazo desejado, desde que sejam mantidos os aportes mensais adequados.</p>`;
      }

      recommendationText.innerHTML = analysis;
      recommendationDiv.style.display = "block";

      // Marcar que o cálculo foi concluído
      calculationComplete = true;
    }

    // Função para adicionar o cenário atual
    function addCurrentScenario() {
      if (!currentCalculationData) {
        console.log("Nenhum dado de cálculo disponível para salvar");
        return;
      }

      const scenarioData = {
        name: `Cenário ${scenarioCounter++}`,
        ...currentCalculationData // Inclui goal, period, currentSavings, etc.
      };

      scenarios.push(scenarioData);
      console.log("Cenário salvo:", scenarioData);
      
      // Criar container de cenários se não existir
      let scenariosContainer = document.getElementById("scenariosContainer");
      if (!scenariosContainer) {
        scenariosContainer = document.createElement("div");
        scenariosContainer.id = "scenariosContainer";
        scenariosContainer.className = "scenarios-container";
        
        // Inserir após o botão de análise personalizada
        const whatsappButton = document.getElementById("whatsappButton");
        if (whatsappButton && whatsappButton.parentNode) {
          whatsappButton.parentNode.insertBefore(scenariosContainer, whatsappButton.nextSibling);
        } else {
          // Fallback: inserir antes dos containers de gráficos
          const chartContainer = document.getElementById("chartUnicoContainer");
          if (chartContainer && chartContainer.parentNode) {
            chartContainer.parentNode.insertBefore(scenariosContainer, chartContainer);
          } else {
            // Último recurso: adicionar ao final do body
            document.body.appendChild(scenariosContainer);
          }
        }
      }
      
      // Atualizar a interface de cenários salvos
      displayScenarios();
      
      // Mostrar o botão de analisar cenários apenas se houver pelo menos dois cenários
      if (scenarios.length >= 2) {
        // Verificar se já existe um botão de análise abaixo dos cenários
        let analyzeButton = document.getElementById("analyzeScenariosBelowContainer");
        
        if (!analyzeButton) {
          // Criar um novo botão de análise abaixo dos cenários
          analyzeButton = document.createElement("button");
          analyzeButton.id = "analyzeScenariosBelowContainer";
          analyzeButton.className = "analyze-scenario-button";
          analyzeButton.type = "button";
          analyzeButton.onclick = analyzeScenarios;
          analyzeButton.textContent = "ANALISAR CENÁRIOS";
          
          // Inserir após o container de cenários
          const scenariosContainer = document.getElementById("scenariosContainer");
          if (scenariosContainer) {
            scenariosContainer.appendChild(analyzeButton);
          }
        }
        
        // Mostrar o botão
        analyzeButton.style.display = "block";
        
        // Esconder o botão original na área de botões
        document.getElementById("analyzeScenarioButton").style.display = "none";
      } else {
        // Esconder ambos os botões se não houver pelo menos dois cenários
        const analyzeButton = document.getElementById("analyzeScenariosBelowContainer");
        if (analyzeButton) {
          analyzeButton.style.display = "none";
        }
        document.getElementById("analyzeScenarioButton").style.display = "none";
      }
      
      // Exibir mensagem de sucesso
      alert("Cenário salvo com sucesso!");
    }
    
    // Função para analisar os cenários salvos
    function analyzeScenarios() {
      if (scenarios.length < 2) {
        alert("É necessário salvar pelo menos 2 cenários para realizar uma análise comparativa.");
        return;
      }
      
      // Atualizar a comparação de cenários
      updateComparison();
      
      // Mostrar a análise geral automatizada
      document.getElementById("generalAnalysis").style.display = "block";
      
      // Gerar a análise geral
      generateGeneralAnalysis();
      
      // Rolar até a análise
      document.getElementById("comparisonContainer").scrollIntoView({ behavior: 'smooth' });
    }

    // Função para exibir os cenários salvos
    function displayScenarios() {
      // Verificar se o container de cenários existe
      const scenariosContainer = document.getElementById("scenariosContainer");
      if (!scenariosContainer) {
        console.log("Container de cenários não encontrado");
        return;
      }
      
      // Verificar se há cenários para exibir
      if (scenarios.length === 0) {
        scenariosContainer.style.display = "none";
        return;
      }
      
      // Criar cabeçalho e lista se não existirem
      let scenariosHeader = scenariosContainer.querySelector(".scenarios-header");
      let scenariosList = document.getElementById("scenariosList");
      
      if (!scenariosHeader) {
        scenariosHeader = document.createElement("div");
        scenariosHeader.className = "scenarios-header";
        scenariosHeader.innerHTML = "<h3>Cenários Salvos</h3>";
        scenariosContainer.appendChild(scenariosHeader);
      }
      
      if (!scenariosList) {
        scenariosList = document.createElement("div");
        scenariosList.id = "scenariosList";
        scenariosContainer.appendChild(scenariosList);
      }
      
      // Limpar a lista existente
      scenariosList.innerHTML = "";
      
      // Exibir o container
      scenariosContainer.style.display = "block";
      
      // Adicionar cada cenário à lista
      scenarios.forEach((scenario, index) => {
        const card = document.createElement("div");
        card.className = "scenario-card";
        
        card.innerHTML = `
          <div class="scenario-header">
            <h4 class="scenario-title">${scenario.name}</h4>
            <div class="scenario-actions">
              <button type="button" class="scenario-select" onclick="selectScenario(${index})">Selecionar</button>
              <button type="button" class="scenario-delete" onclick="deleteScenario(${index})">Excluir</button>
            </div>
          </div>
          <div class="scenario-content">
            <div class="scenario-info">
              <p><strong>Objetivo:</strong> R$ ${formatMoney(scenario.goal)}</p>
              <p><strong>Prazo:</strong> ${scenario.period} meses</p>
              <p><strong>Guardado:</strong> R$ ${formatMoney(scenario.currentSavings)}</p>
              <p><strong>Aporte:</strong> R$ ${formatMoney(scenario.currentContribution)}</p>
              <p><strong>Taxa:</strong> ${(scenario.rate * 100).toFixed(2).replace(".", ",")}% ${scenario.rateType === 'annual' ? 'a.a.' : 'a.m.'}</p>
            </div>
          </div>
        `;
        
        scenariosList.appendChild(card);
      });
    }

    // Função placeholder para selectScenario (precisa ser implementada)
    function selectScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      const scenario = scenarios[index];

      // Preencher o formulário com os dados do cenário
      document.getElementById("goalDescription").value = scenario.goalDescription || "";
      document.getElementById("goal").value = formatMoney(scenario.goal);
      formatCurrency(document.getElementById("goal")); // Reformatar
      document.getElementById("period").value = scenario.period;
      document.getElementById("currentSavings").value = formatMoney(scenario.currentSavings);
      formatCurrency(document.getElementById("currentSavings")); // Reformatar
      document.getElementById("currentContribution").value = formatMoney(scenario.currentContribution);
      formatCurrency(document.getElementById("currentContribution")); // Reformatar
      document.getElementById("rate").value = (scenario.rate * 100).toFixed(2).replace(".", ",") + " %";
      formatPercentage(document.getElementById("rate")); // Reformatar
      document.getElementById("rateType").value = scenario.rateType;

      // Lógica para imposto e inflação (simplificada)
      document.getElementById("knowsTax").value = scenario.tax > 0 ? "yes" : "no";
      toggleTaxInput("tax", "15,00 %");
      if (scenario.tax > 0) {
        document.getElementById("tax").value = (scenario.tax * 100).toFixed(2).replace(".", ",") + " %";
        formatPercentage(document.getElementById("tax"));
      }

      document.getElementById("knowsInflation").value = scenario.inflation > 0 ? "yes" : "no";
      toggleTaxInput("inflation", "5,00 %");
      if (scenario.inflation > 0) {
        document.getElementById("inflation").value = (scenario.inflation * 100).toFixed(2).replace(".", ",") + " %";
        formatPercentage(document.getElementById("inflation"));
      }

      // Limpar resultados anteriores e recalcular
      clearResults();
      calculateSavings();

      // Marcar card como ativo (opcional)
      const cards = document.querySelectorAll('.scenario-card');
      cards.forEach((card, i) => card.classList.toggle('active', i === index));
    }

    // Função placeholder para deleteScenario (precisa ser implementada)
    function deleteScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      if (confirm(`Tem certeza que deseja excluir o ${scenarios[index].name}?`)) {
        scenarios.splice(index, 1);
        displayScenarios();
        if (scenarios.length > 1) {
          updateComparison();
        } else {
          document.getElementById("comparisonContainer").style.display = "none";
          document.getElementById("generalAnalysis").style.display = "none";
        }
      }
    }

    // Função para atualizar a comparação de cenários
    function updateComparison() {
      // Verificar se há elementos suficientes para comparação
      if (scenarios.length < 2) {
        console.log("Não há cenários suficientes para comparação");
        return;
      }
      
      // Verificar se os elementos de comparação existem
      let comparisonContainer = document.getElementById("comparisonContainer");
      if (!comparisonContainer) {
        console.log("Container de comparação não encontrado");
        
        // Criar o container de comparação
        const newComparisonContainer = document.createElement("div");
        newComparisonContainer.id = "comparisonContainer";
        newComparisonContainer.className = "comparison-container";
        
        // Adicionar o cabeçalho
        newComparisonContainer.innerHTML = `
          <h3 class="comparison-header">Comparação de Cenários</h3>
          <div class="comparison-chart-container">
            <canvas id="comparisonChart"></canvas>
          </div>
          <div id="comparisonTableContainer">
            <table id="comparisonTable" class="comparison-table">
              <thead>
                <tr>
                  <th scope="col">Cenário</th>
                  <th scope="col">Objetivo Corrigido</th>
                  <th scope="col">Invest. Único Necessário</th>
                  <th scope="col">Aporte Ideal Mensal</th>
                  <th scope="col">Prazo Plano Atual (meses)</th>
                  <th scope="col">Rentab. Necessária (% a.a.)</th>
                </tr>
              </thead>
              <tbody id="comparisonTableBody"></tbody>
            </table>
          </div>
        `;
        
        // Adicionar o container de análise geral
        const generalAnalysis = document.createElement("div");
        generalAnalysis.id = "generalAnalysis";
        generalAnalysis.className = "general-analysis";
        generalAnalysis.style.display = "none";
        generalAnalysis.innerHTML = `
          <h3>Análise Geral Automática</h3>
          <div id="generalAnalysisText"></div>
        `;
        
        // Inserir os elementos no DOM
        const scenariosContainer = document.getElementById("scenariosContainer");
        if (scenariosContainer && scenariosContainer.parentNode) {
          scenariosContainer.parentNode.insertBefore(newComparisonContainer, scenariosContainer.nextSibling);
          scenariosContainer.parentNode.insertBefore(generalAnalysis, newComparisonContainer.nextSibling);
        } else {
          // Fallback: inserir antes dos containers de gráficos
          const chartContainer = document.getElementById("chartUnicoContainer");
          if (chartContainer && chartContainer.parentNode) {
            chartContainer.parentNode.insertBefore(newComparisonContainer, chartContainer);
            chartContainer.parentNode.insertBefore(generalAnalysis, chartContainer);
          } else {
            // Último recurso: adicionar ao final do body
            document.body.appendChild(newComparisonContainer);
            document.body.appendChild(generalAnalysis);
          }
        }
        
        // Atualizar a referência
        comparisonContainer = newComparisonContainer;
      }
      
      // Verificar se a tabela de comparação existe
      const comparisonTableBody = document.getElementById("comparisonTableBody");
      if (!comparisonTableBody) {
        console.log("Tabela de comparação não encontrada");
        return;
      }
      
      // Limpar a tabela
      comparisonTableBody.innerHTML = "";
      
      // Exibir o container de comparação
      comparisonContainer.style.display = "block";
      
      // Preparar dados para o gráfico e tabela
      const labels = scenarios.map(s => s.name);
      const objectiveData = scenarios.map(s => s.goal || 0);
      const singleInvestmentData = scenarios.map(s => s.requiredInitialInvestment || 0);
      const idealContributionData = scenarios.map(s => s.idealContribution || 0);
      const currentPlanMonthsData = scenarios.map(s => s.monthsToGoalAtual || 0);
      const requiredRateData = scenarios.map(s => (s.requiredRate || 0) * 100);

      // Preencher a tabela de comparação
      scenarios.forEach((scenario, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${scenario.name}</td>
          <td>R$ ${formatMoney(objectiveData[index])}</td>
          <td>R$ ${formatMoney(singleInvestmentData[index])}</td>
          <td>R$ ${formatMoney(idealContributionData[index])}</td>
          <td>${currentPlanMonthsData[index] > 0 ? currentPlanMonthsData[index] : 'N/A'}</td>
          <td>${requiredRateData[index] > 0 ? requiredRateData[index].toFixed(2).replace('.', ',') + '%' : 'N/A'}</td>
        `;
        comparisonTableBody.appendChild(row);
      });

      // Adicionar destaque na tabela
      try {
        highlightComparisonTable();
      } catch (error) {
        console.log("Erro ao destacar tabela:", error);
      }

      // Desenhar/Atualizar o gráfico de comparação
      try {
        const comparisonChart = document.getElementById('comparisonChart');
        if (comparisonChart) {
          drawComparisonChart(labels, objectiveData, singleInvestmentData, idealContributionData, currentPlanMonthsData, requiredRateData);
        } else {
          console.log("Canvas do gráfico de comparação não encontrado");
        }
      } catch (error) {
        console.log("Erro ao desenhar gráfico:", error);
      }
    }// Função placeholder para highlightComparisonTable (precisa ser implementada)
    function highlightComparisonTable() {
      const tableBody = document.getElementById("comparisonTableBody");
      const rows = tableBody.getElementsByTagName("tr");
      if (rows.length === 0) return;

      // Índices das colunas a serem comparadas (0-based)
      const columnsToCompare = {
        objective: 1,
        singleInvestment: 2,
        idealContribution: 3,
        currentPlanMonths: 4,
        requiredRate: 5
      };

      // Função auxiliar para obter valor numérico da célula
      const getCellValue = (row, colIndex) => {
          const cell = row.cells[colIndex];
          if (!cell) return NaN;
          const text = cell.textContent.replace(/R\$\s?/g, "").replace(/\./g, "").replace(/,/g, ".").replace(/%/g, "").trim();
          return text === 'N/A' ? NaN : parseFloat(text);
      };

      // Comparar cada coluna
      Object.values(columnsToCompare).forEach(colIndex => {
          let bestValue = (colIndex === columnsToCompare.currentPlanMonths || colIndex === columnsToCompare.requiredRate || colIndex === columnsToCompare.idealContribution || colIndex === columnsToCompare.singleInvestment) ? Infinity : -Infinity; // Menor é melhor para prazo/taxa/aporte/invest. único
          let worstValue = (colIndex === columnsToCompare.currentPlanMonths || colIndex === columnsToCompare.requiredRate || colIndex === columnsToCompare.idealContribution || colIndex === columnsToCompare.singleInvestment) ? -Infinity : Infinity;
          let bestRowIndex = -1;
          let worstRowIndex = -1;

          for (let i = 0; i < rows.length; i++) {
              const value = getCellValue(rows[i], colIndex);
              if (isNaN(value)) continue;

              // Melhor valor (menor para prazo/taxa/aporte/invest. único, maior para objetivo)
              if ((colIndex === columnsToCompare.currentPlanMonths || colIndex === columnsToCompare.requiredRate || colIndex === columnsToCompare.idealContribution || colIndex === columnsToCompare.singleInvestment) ? (value < bestValue) : (value > bestValue)) {
                  bestValue = value;
                  bestRowIndex = i;
              }
              // Pior valor (maior para prazo/taxa/aporte/invest. único, menor para objetivo)
              if ((colIndex === columnsToCompare.currentPlanMonths || colIndex === columnsToCompare.requiredRate || colIndex === columnsToCompare.idealContribution || colIndex === columnsToCompare.singleInvestment) ? (value > worstValue) : (value < worstValue)) {
                  worstValue = value;
                  worstRowIndex = i;
              }
          }

          // Aplicar classes
          if (bestRowIndex !== -1) {
              rows[bestRowIndex].cells[colIndex].classList.add("best-value");
          }
          if (worstRowIndex !== -1 && worstRowIndex !== bestRowIndex) { // Não marcar como pior se for o único ou igual ao melhor
              rows[worstRowIndex].cells[colIndex].classList.add("worst-value");
          }
      });
    }

    // Função placeholder para drawComparisonChart (precisa ser implementada)
    function drawComparisonChart(labels, objectiveData, singleInvestmentData, idealContributionData, currentPlanMonthsData, requiredRateData) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');

      // Destruir gráfico existente se houver
      const existingChart = Chart.getChart(ctx);
      if (existingChart) {
        existingChart.destroy();
      }

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Objetivo Corrigido (R$)',
              data: objectiveData,
              backgroundColor: 'rgba(4, 108, 78, 0.6)', // Verde Esmeralda
              borderColor: 'rgba(4, 108, 78, 1)',
              borderWidth: 1,
              yAxisID: 'y-axis-money'
            },
            {
              label: 'Aporte Ideal Mensal (R$)',
              data: idealContributionData,
              backgroundColor: 'rgba(212, 175, 55, 0.6)', // Dourado
              borderColor: 'rgba(212, 175, 55, 1)',
              borderWidth: 1,
              yAxisID: 'y-axis-money'
            },
            {
              label: 'Prazo Plano Atual (Meses)',
              data: currentPlanMonthsData.map(m => m > 0 ? m : null), // Não mostrar N/A
              backgroundColor: 'rgba(111, 66, 193, 0.6)', // Roxo
              borderColor: 'rgba(111, 66, 193, 1)',
              borderWidth: 1,
              yAxisID: 'y-axis-months'
            },
            {
              label: 'Rentab. Necessária (% a.a.)',
              data: requiredRateData.map(r => r > 0 ? r : null), // Não mostrar N/A
              backgroundColor: 'rgba(220, 53, 69, 0.6)', // Vermelho
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1,
              yAxisID: 'y-axis-rate'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            'y-axis-money': {
              type: 'linear',
              position: 'left',
              beginAtZero: true,
              title: {
                display: true,
                text: 'Valor (R$)'
              },
              ticks: {
                callback: function(value) {
                  return "R$ " + value.toLocaleString("pt-BR");
                }
              }
            },
            'y-axis-months': {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false // Não desenhar grid para este eixo
              },
              title: {
                display: true,
                text: 'Meses'
              }
            },
            'y-axis-rate': {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false // Não desenhar grid para este eixo
              },
              title: {
                display: true,
                text: 'Taxa (% a.a.)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(2).replace('.', ',') + '%';
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Cenários'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    if (context.dataset.yAxisID === 'y-axis-money') {
                      label += "R$ " + context.parsed.y.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    } else if (context.dataset.yAxisID === 'y-axis-rate') {
                      label += context.parsed.y.toFixed(2).replace('.', ',') + '%';
                    } else {
                      label += context.parsed.y;
                    }
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Função para gerar análise geral automática detalhada
    function generateGeneralAnalysis() {
      const analysisText = document.getElementById("generalAnalysisText");
      if (scenarios.length < 2) {
        analysisText.innerHTML = "<p>Simule pelo menos dois cenários para gerar uma análise comparativa detalhada.</p>";
        return;
      }

      // Encontrar os melhores cenários para diferentes métricas
      let bestScenarioForContribution = scenarios.reduce((prev, curr) => (curr.idealContribution < prev.idealContribution) ? curr : prev);
      let bestScenarioForMonths = scenarios.reduce((prev, curr) => (curr.monthsToGoalAtual > 0 && curr.monthsToGoalAtual < prev.monthsToGoalAtual) ? curr : (prev.monthsToGoalAtual > 0 ? prev : curr));
      let bestScenarioForRate = scenarios.reduce((prev, curr) => (curr.requiredRate > 0 && curr.requiredRate < prev.requiredRate) ? curr : (prev.requiredRate > 0 ? prev : curr));
      let bestScenarioForInitialInvestment = scenarios.reduce((prev, curr) => (curr.requiredInitialInvestment < prev.requiredInitialInvestment) ? curr : prev);
      
      // Encontrar os piores cenários para diferentes métricas
      let worstScenarioForContribution = scenarios.reduce((prev, curr) => (curr.idealContribution > prev.idealContribution) ? curr : prev);
      let worstScenarioForMonths = scenarios.reduce((prev, curr) => (curr.monthsToGoalAtual > 0 && curr.monthsToGoalAtual > prev.monthsToGoalAtual) ? curr : prev);
      let worstScenarioForRate = scenarios.reduce((prev, curr) => (curr.requiredRate > 0 && curr.requiredRate > prev.requiredRate) ? curr : prev);
      
      // Calcular médias e diferenças percentuais
      let avgContribution = scenarios.reduce((sum, scenario) => sum + scenario.idealContribution, 0) / scenarios.length;
      let avgRate = scenarios.filter(s => s.requiredRate > 0).reduce((sum, scenario) => sum + scenario.requiredRate, 0) / 
                    scenarios.filter(s => s.requiredRate > 0).length;
      
      let contributionDiffPercentage = ((worstScenarioForContribution.idealContribution - bestScenarioForContribution.idealContribution) / 
                                      bestScenarioForContribution.idealContribution) * 100;
      
      let rateDiffPercentage = bestScenarioForRate.requiredRate > 0 && worstScenarioForRate.requiredRate > 0 ? 
                              ((worstScenarioForRate.requiredRate - bestScenarioForRate.requiredRate) / 
                              bestScenarioForRate.requiredRate) * 100 : 0;

      // Iniciar a análise detalhada
      let analysis = `
        <h4>Análise Comparativa Detalhada dos ${scenarios.length} Cenários</h4>
        
        <p>Após analisar detalhadamente todos os cenários simulados, podemos identificar importantes diferenças e oportunidades que podem influenciar significativamente sua estratégia para alcançar o objetivo financeiro desejado.</p>
        
        <h5>Comparação de Aportes Mensais</h5>
        <p>O cenário <strong>${bestScenarioForContribution.name}</strong> apresenta a estratégia mais eficiente em termos de aporte mensal, exigindo apenas R$ ${formatMoney(bestScenarioForContribution.idealContribution)} por mês. Em contraste, o cenário <strong>${worstScenarioForContribution.name}</strong> demanda R$ ${formatMoney(worstScenarioForContribution.idealContribution)}, uma diferença de ${contributionDiffPercentage.toFixed(1).replace('.', ',')}%.</p>
        
        <p>A média de aporte mensal ideal entre todos os cenários é de R$ ${formatMoney(avgContribution)}. Se você conseguir manter um aporte mensal próximo ou superior a R$ ${formatMoney(bestScenarioForContribution.idealContribution * 1.1)}, terá uma margem de segurança que pode compensar eventuais flutuações na rentabilidade ou períodos sem aportes.</p>
        
        <h5>Análise de Prazos</h5>`;
        
      if (bestScenarioForMonths && bestScenarioForMonths.monthsToGoalAtual > 0) {
        analysis += `
        <p>Com seu plano de aportes atual, o cenário <strong>${bestScenarioForMonths.name}</strong> permite alcançar o objetivo em ${bestScenarioForMonths.monthsToGoalAtual} meses (aproximadamente ${(bestScenarioForMonths.monthsToGoalAtual / 12).toFixed(1).replace('.', ',')} anos).`;
        
        if (worstScenarioForMonths && worstScenarioForMonths.monthsToGoalAtual > 0) {
          analysis += ` Já o cenário <strong>${worstScenarioForMonths.name}</strong> exigiria ${worstScenarioForMonths.monthsToGoalAtual} meses (aproximadamente ${(worstScenarioForMonths.monthsToGoalAtual / 12).toFixed(1).replace('.', ',')} anos), uma diferença de ${worstScenarioForMonths.monthsToGoalAtual - bestScenarioForMonths.monthsToGoalAtual} meses.</p>`;
        } else {
          analysis += `</p>`;
        }
        
        // Adicionar recomendação sobre prazo
        if (bestScenarioForMonths.monthsToGoalAtual > bestScenarioForMonths.period) {
          analysis += `
          <p>É importante notar que mesmo no melhor cenário, o prazo estimado (${bestScenarioForMonths.monthsToGoalAtual} meses) é superior ao prazo desejado inicialmente (${bestScenarioForMonths.period} meses). Isso sugere que você poderia considerar aumentar seus aportes mensais ou reavaliar o prazo para tornar seu objetivo mais realista.</p>`;
        } else {
          analysis += `
          <p>É positivo observar que no melhor cenário, você consegue atingir seu objetivo antes do prazo desejado inicialmente, o que demonstra que sua estratégia atual está bem alinhada.</p>`;
        }
      } else {
        analysis += `
        <p>Com base nos aportes atuais, nenhum dos cenários simulados permite atingir o objetivo dentro do prazo máximo simulado (50 anos). Isso indica que seria necessário aumentar significativamente o valor dos aportes mensais ou reconsiderar o valor do objetivo.</p>`;
      }
      
      analysis += `
        <h5>Rentabilidade Necessária</h5>`;
        
      if (bestScenarioForRate && bestScenarioForRate.requiredRate > 0) {
        analysis += `
        <p>O cenário <strong>${bestScenarioForRate.name}</strong> requer a menor rentabilidade anual (${(bestScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a.) para viabilizar seu objetivo com os aportes atuais.`;
        
        if (worstScenarioForRate && worstScenarioForRate.requiredRate > 0) {
          analysis += ` Em contraste, o cenário <strong>${worstScenarioForRate.name}</strong> exige ${(worstScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a., uma diferença de ${rateDiffPercentage.toFixed(1).replace('.', ',')}%.</p>`;
        } else {
          analysis += `</p>`;
        }
        
        // Adicionar contexto sobre a rentabilidade
        if (bestScenarioForRate.requiredRate > 0.12) { // Se a taxa necessária for maior que 12% a.a.
          analysis += `
          <p>É importante destacar que a rentabilidade necessária de ${(bestScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a. está acima da média histórica de muitos investimentos conservadores e moderados no Brasil. Para atingir essa rentabilidade, seria necessário considerar uma carteira com maior exposição a ativos de renda variável, o que naturalmente implica em maior risco. Alternativamente, você poderia aumentar seus aportes mensais para reduzir a dependência de uma alta rentabilidade.</p>`;
        } else if (bestScenarioForRate.requiredRate > 0.06) { // Se a taxa necessária for entre 6% e 12% a.a.
          analysis += `
          <p>A rentabilidade necessária de ${(bestScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a. está dentro de um patamar alcançável com uma estratégia de investimentos moderada no Brasil, possivelmente combinando renda fixa e uma parcela de renda variável. Esta taxa está próxima da média histórica de alguns fundos multimercado e carteiras diversificadas.</p>`;
        } else { // Se a taxa necessária for menor que 6% a.a.
          analysis += `
          <p>A rentabilidade necessária de ${(bestScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a. é relativamente conservadora e pode ser alcançada com investimentos de menor risco, como títulos públicos, CDBs e outros produtos de renda fixa, dependendo do cenário econômico atual.</p>`;
        }
      } else {
        analysis += `
        <p>Não foi possível determinar uma taxa de rentabilidade viável para atingir o objetivo com os aportes atuais nos cenários simulados. Isso sugere que seria necessário aumentar significativamente o valor dos aportes mensais.</p>`;
      }
      
      // Análise do investimento único
      analysis += `
        <h5>Investimento Único</h5>
        <p>Se você preferir fazer um único aporte em vez de contribuições mensais, o cenário <strong>${bestScenarioForInitialInvestment.name}</strong> exigiria o menor valor: R$ ${formatMoney(bestScenarioForInitialInvestment.requiredInitialInvestment)}. Esta opção pode ser interessante se você dispõe de um capital inicial significativo, como uma herança, venda de um bem ou reserva acumulada.</p>
      
        <h5>Recomendações Estratégicas</h5>
        <ul>`;
        
      // Recomendações personalizadas baseadas na análise
      if (bestScenarioForContribution.idealContribution > bestScenarioForContribution.currentContribution * 1.5) {
        analysis += `
          <li><strong>Aumente gradualmente seus aportes mensais:</strong> O aporte ideal (R$ ${formatMoney(bestScenarioForContribution.idealContribution)}) é significativamente maior que seu aporte atual. Considere aumentar gradualmente, por exemplo, 10% a cada três meses, até atingir o valor ideal.</li>`;
      }
      
      if (scenarios.some(s => s.inflation > 0.05)) {
        analysis += `
          <li><strong>Considere o impacto da inflação:</strong> Alguns cenários consideram uma inflação elevada, o que pode corroer significativamente o poder de compra do seu objetivo. Reavalie periodicamente o valor do seu objetivo para garantir que ele mantenha o poder de compra desejado.</li>`;
      }
      
      if (bestScenarioForRate.requiredRate > bestScenarioForRate.rate * 1.2) {
        analysis += `
          <li><strong>Revise sua estratégia de investimentos:</strong> A rentabilidade necessária (${(bestScenarioForRate.requiredRate * 100).toFixed(2).replace('.', ',')}% a.a.) é superior à taxa informada (${(bestScenarioForRate.rate * 100).toFixed(2).replace('.', ',')}% a.a.). Considere diversificar sua carteira para buscar uma rentabilidade maior, sempre respeitando seu perfil de risco.</li>`;
      }
      
      analysis += `
          <li><strong>Mantenha uma reserva de emergência:</strong> Antes de aumentar seus aportes para este objetivo específico, certifique-se de que possui uma reserva de emergência equivalente a 3-6 meses de suas despesas mensais.</li>
          <li><strong>Reavalie periodicamente:</strong> Faça uma revisão trimestral do seu plano, ajustando os valores conforme necessário com base no desempenho real dos seus investimentos e mudanças na sua situação financeira.</li>
        </ul>
        
        <h5>Conclusão</h5>
        <p>Comparando todos os cenários simulados, o <strong>${bestScenarioForContribution.name}</strong> apresenta a melhor relação entre aporte mensal, prazo e rentabilidade necessária. Recomendamos que você utilize este cenário como base para seu planejamento financeiro, fazendo os ajustes necessários conforme sua realidade e preferências pessoais.</p>
        
        <p>Lembre-se que o planejamento financeiro é um processo contínuo e que pequenos ajustes ao longo do tempo podem fazer grande diferença no resultado final. Consulte a tabela comparativa e os gráficos para visualizar melhor as diferenças entre os cenários e tomar uma decisão mais informada.</p>
      `;

      analysisText.innerHTML = analysis;
    }

    // Função para mostrar elementos após o cálculo
    function showResultElements() {
      document.getElementById("result").style.display = "block";
      document.getElementById("recommendation").style.display = "block";
      document.getElementById("whatsappButton").style.display = "block";
      document.getElementById("saveScenarioButton").style.display = "block";
      document.getElementById("newScenarioButton").style.display = "block";
      document.getElementById("chartUnicoContainer").style.display = "block";
      document.getElementById("chartIdealContainer").style.display = "block";
      document.getElementById("chartAtualContainer").style.display = "block";
      document.getElementById("chartRentabilidadeContainer").style.display = "block";
    }

    // Função para limpar resultados e gráficos
    function clearResults() {
      document.getElementById("result").innerHTML = "";
      document.getElementById("result").style.display = "none";
      document.getElementById("recommendation").style.display = "none";
      document.getElementById("chartUnicoContainer").style.display = "none";
      document.getElementById("chartIdealContainer").style.display = "none";
      document.getElementById("chartAtualContainer").style.display = "none";
      document.getElementById("chartRentabilidadeContainer").style.display = "none";
      document.getElementById("saveScenarioButton").style.display = "none";
      document.getElementById("newScenarioButton").style.display = "none";
      document.getElementById("whatsappButton").style.display = "none";

      // Limpar canvases dos gráficos
      const chartIds = ["chartUnico", "chartIdeal", "chartAtual", "chartRentabilidade"];
      chartIds.forEach(id => {       const ctx = document.getElementById(id)?.getContext('2d');
        if (ctx) {
          const chart = Chart.getChart(ctx);
          if (chart) {
            chart.destroy();
          }
        }
      });

      calculationComplete = false;
      currentCalculationData = null;
    }

    // Função para preparar um novo cenário
    function prepareNewScenario() {
      // Limpar os campos do formulário, exceto a descrição do objetivo
      document.getElementById("goal").value = "";
      document.getElementById("period").value = "";
      document.getElementById("currentSavings").value = "";
      document.getElementById("currentContribution").value = "";
      document.getElementById("rate").value = "";
      document.getElementById("rateType").value = "annual";
      document.getElementById("knowsTax").value = "no";
      document.getElementById("knowsInflation").value = "no";
      toggleTaxInput("tax", "15,00 %");
      toggleTaxInput("inflation", "5,00 %");

      // Limpar os resultados e esconder elementos
      clearResults();

      // Rolar para o topo do formulário
      window.scrollTo(0, 0);
    }

    // Função principal de cálculo
    function calculateSavings() {
      // Limpar resultados anteriores
      clearResults();

      // Obter valores do formulário
      goalDescriptionText = document.getElementById("goalDescription").value;
      const goal = parseCurrency(document.getElementById("goal").value);
      const period = parseInt(document.getElementById("period").value) || 0;
      const currentSavings = parseCurrency(document.getElementById("currentSavings").value);
      const currentContribution = parseCurrency(document.getElementById("currentContribution").value);
      let rate = parsePercentage(document.getElementById("rate").value);
      const rateType = document.getElementById("rateType").value;
      const knowsTax = document.getElementById("knowsTax").value === "yes";
      const tax = knowsTax ? parsePercentage(document.getElementById("tax").value) : 0.15; // Padrão 15% se não souber
      const knowsInflation = document.getElementById("knowsInflation").value === "yes";
      const inflation = knowsInflation ? parsePercentage(document.getElementById("inflation").value) : 0.05; // Padrão 5% a.a. se não souber

      // Validar entradas
      if (goal <= 0 || period <= 0) {
        alert("Por favor, insira um valor de objetivo e prazo válidos.");
        return;
      }

      // Converter taxa anual para mensal se necessário
      const monthlyRate = rateType === "annual" ? Math.pow(1 + rate, 1/12) - 1 : rate;
      const annualRate = rateType === "monthly" ? Math.pow(1 + rate, 12) - 1 : rate;

      // --- Cálculos ---

      // 1. Investimento Único Necessário
      // FV = PV * (1 + r)^n => PV = FV / (1 + r)^n
      // Ajustar objetivo pela inflação
      let inflatedGoalSingle = goal;
      for (let y = 0; y < Math.floor(period / 12); y++) {
        inflatedGoalSingle *= (1 + inflation);
      }
      const requiredInitialInvestmentGross = inflatedGoalSingle / Math.pow(1 + monthlyRate, period);
      // Calcular juros e imposto para o investimento único
      const totalJurosSingle = requiredInitialInvestmentGross * (Math.pow(1 + monthlyRate, period) - 1);
      const impostoSingle = totalJurosSingle * tax;
      const requiredInitialInvestmentNet = (inflatedGoalSingle + impostoSingle) / Math.pow(1 + monthlyRate, period);

      // Simular evolução do Investimento Único
      const singleInvestmentData = calculateCompoundInterest(requiredInitialInvestmentNet, 0, monthlyRate, period, tax, goal, inflation);

      // 2. Aporte Ideal Mensal
      // FV = P * [((1 + r)^n - 1) / r] + PV * (1 + r)^n
      // Precisamos encontrar P (aporte mensal)
      // FV_final_liquido = Objetivo_corrigido
      // Usar busca binária ou fórmula se possível (fórmula é complexa com imposto e inflação)
      let lowContribution = 0;
      let highContribution = goal; // Limite superior inicial
      let idealContribution = 0;
      let iterations = 0;
      let idealResult;

      while (iterations < 100) {
        idealContribution = (lowContribution + highContribution) / 2;
        idealResult = calculateCompoundInterest(currentSavings, idealContribution, monthlyRate, period, tax, goal, inflation);
        const finalNetValue = idealResult.valoresMensais[period].valorLiquido;
        const finalGoalValue = idealResult.valoresMensais[period].objetivoCorrigido;

        if (Math.abs(finalNetValue - finalGoalValue) < 0.01) {
          break;
        }

        if (finalNetValue > finalGoalValue) {
          highContribution = idealContribution;
        } else {
          lowContribution = idealContribution;
        }
        iterations++;
      }

      // 3. Prazo com o Plano Atual
      const currentPlanResult = calculateCompoundInterestUntilGoal(currentSavings, currentContribution, monthlyRate, tax, goal, inflation);
      const monthsToGoalAtual = currentPlanResult.goalReached ? currentPlanResult.monthsToGoal : -1; // -1 se não atingir

      // 4. Rentabilidade Necessária
      const requiredRateResult = calculateRequiredRate(goal, currentSavings, currentContribution, period, tax, inflation);
      const requiredAnnualRate = requiredRateResult.annualRate;

      // --- Exibir Resultados ---
      const resultDiv = document.getElementById("result");
      resultText = `
        <h3>Resultados da Simulação</h3>
        <p><strong>Objetivo Financeiro:</strong> ${goalDescriptionText || '(Não especificado)'}</p>
        <p><strong>Valor do Objetivo (Corrigido pela Inflação no Prazo):</strong> R$ ${formatMoney(idealResult.valoresMensais[period].objetivoCorrigido)}</p>
        <p><strong>Prazo Desejado:</strong> ${period} meses</p>
        <hr>
        <p><strong>1. Investimento Único Necessário Hoje:</strong> R$ ${formatMoney(requiredInitialInvestmentNet)}<br><small>(Valor que você precisaria investir hoje, de uma só vez, com a taxa de ${formatMoney(annualRate * 100)}% a.a., para atingir o objetivo no prazo, já considerando imposto de ${formatMoney(tax * 100)}% sobre o rendimento).</small></p>
        <p><strong>2. Aporte Ideal Mensal:</strong> R$ ${formatMoney(idealContribution)}<br><small>(Valor que você precisaria poupar todo mês, somado ao que já tem, com a taxa de ${formatMoney(annualRate * 100)}% a.a., para atingir o objetivo no prazo, já considerando imposto de ${formatMoney(tax * 100)}% sobre o rendimento).</small></p>
        <p><strong>3. Prazo com o Plano Atual:</strong> ${monthsToGoalAtual > 0 ? `${monthsToGoalAtual} meses` : 'Não atinge o objetivo no prazo simulado (50 anos)'}<br><small>(Tempo estimado para atingir o objetivo se mantiver o aporte mensal atual de R$ ${formatMoney(currentContribution)} e a taxa de ${formatMoney(annualRate * 100)}% a.a.).</small></p>
        <p><strong>4. Rentabilidade Necessária:</strong> ${formatMoney(requiredAnnualRate * 100)}% ao ano<br><small>(Taxa de juros anual que seu dinheiro precisaria render para atingir o objetivo no prazo, mantendo o aporte mensal atual de R$ ${formatMoney(currentContribution)}).</small></p>
      `;
      resultDiv.innerHTML = resultText;
      resultDiv.style.display = "block";

      // Armazenar dados do cálculo atual para salvar e análise
      currentCalculationData = {
        goalDescription: goalDescriptionText,
        goal: goal,
        period: period,
        currentSavings: currentSavings,
        currentContribution: currentContribution,
        rate: annualRate, // Salvar taxa anual original informada
        rateType: rateType,
        tax: tax,
        inflation: inflation,
        // Resultados calculados para referência
        monthlyRate: monthlyRate,
        requiredInitialInvestment: requiredInitialInvestmentNet,
        idealContribution: idealContribution,
        monthsToGoalAtual: monthsToGoalAtual,
        requiredRate: requiredAnnualRate,
        finalGoal: idealResult.valoresMensais[period].objetivoCorrigido // Objetivo corrigido no final do prazo ideal
      };

      // --- Gerar Gráficos e Tabelas ---

      // Gráfico/Tabela Investimento Único
      const ctxUnico = document.getElementById("chartUnico").getContext("2d");
      const dataUnico = singleInvestmentData.valoresMensais;
      drawChart(ctxUnico,
                dataUnico.map(d => d.totalAcumulado),
                dataUnico.map(d => d.valorLiquido),
                dataUnico.map(d => d.totalInvestido),
                dataUnico.map(d => d.objetivoCorrigido),
                'rgba(255, 99, 132, 1)', // Vermelho para Bruto
                'rgba(54, 162, 235, 1)', // Azul para Líquido
                'rgba(75, 192, 192, 1)'  // Verde para Investido
               );
      fillDataTable("tableUnico", dataUnico);
      document.getElementById("chartUnicoContainer").style.display = "block";
      showChartSlide("Unico", "chart"); // Mostrar gráfico por padrão

      // Gráfico/Tabela Plano Ideal
      const ctxIdeal = document.getElementById("chartIdeal").getContext("2d");
      const dataIdeal = idealResult.valoresMensais;
      drawChart(ctxIdeal,
                dataIdeal.map(d => d.totalAcumulado),
                dataIdeal.map(d => d.valorLiquido),
                dataIdeal.map(d => d.totalInvestido),
                dataIdeal.map(d => d.objetivoCorrigido),
                'rgba(255, 159, 64, 1)', // Laranja para Bruto
                'rgba(153, 102, 255, 1)',// Roxo para Líquido
                'rgba(255, 205, 86, 1)'  // Amarelo para Investido
               );
      fillDataTable("tableIdeal", dataIdeal);
      document.getElementById("chartIdealContainer").style.display = "block";
      showChartSlide("Ideal", "chart"); // Mostrar gráfico por padrão

      // Gráfico/Tabela Plano Atual (se atingir o objetivo)
      if (monthsToGoalAtual > 0) {
        const ctxAtual = document.getElementById("chartAtual").getContext("2d");
        const dataAtual = currentPlanResult.valoresMensais.slice(0, monthsToGoalAtual + 1); // Limitar dados até atingir
        drawChart(ctxAtual,
                  dataAtual.map(d => d.totalAcumulado),
                  dataAtual.map(d => d.valorLiquido),
                  dataAtual.map(d => d.totalInvestido),
                  dataAtual.map(d => d.objetivoCorrigido),
                  'rgba(201, 203, 207, 1)', // Cinza para Bruto
                  'rgba(0, 0, 0, 1)',       // Preto para Líquido
                  'rgba(100, 100, 100, 1)' // Cinza escuro para Investido
                 );
        fillDataTable("tableAtual", dataAtual);
        document.getElementById("chartAtualContainer").style.display = "block";
        showChartSlide("Atual", "chart"); // Mostrar gráfico por padrão
      } else {
        document.getElementById("chartAtualContainer").style.display = "none";
      }

      // Gráfico/Tabela Rentabilidade Necessária
      const ctxRentabilidade = document.getElementById("chartRentabilidade").getContext("2d");
      const dataRentabilidade = requiredRateResult.valoresMensais;
      drawChart(ctxRentabilidade,
                dataRentabilidade.map(d => d.totalAcumulado),
                dataRentabilidade.map(d => d.valorLiquido),
                dataRentabilidade.map(d => d.totalInvestido),
                dataRentabilidade.map(d => d.objetivoCorrigido),
                'rgba(255, 99, 132, 0.6)', // Vermelho translúcido
                'rgba(54, 162, 235, 0.6)', // Azul translúcido
                'rgba(75, 192, 192, 0.6)'  // Verde translúcido
               );
      fillDataTable("tableRentabilidade", dataRentabilidade);
      document.getElementById("chartRentabilidadeContainer").style.display = "block";
      showChartSlide("Rentabilidade", "chart"); // Mostrar gráfico por padrão

      // --- Gerar Análise Automatizada ---
      generateRecommendation(goalDescriptionText, goal, currentSavings, currentContribution, idealContribution, period, requiredAnnualRate, annualRate);

      // Mostrar botões de ação
      document.getElementById("saveScenarioButton").style.display = "block";
      document.getElementById("whatsappButton").style.display = "block";

      // Atualizar comparação se houver cenários salvos
      if (scenarios.length > 0) {
        updateComparison();
      }
    }

    // Inicializar estado dos inputs de taxa/inflação
    document.addEventListener('DOMContentLoaded', (event) => {
      toggleTaxInput('tax', '15,00 %');
      toggleTaxInput('inflation', '5,00 %');
      displayScenarios(); // Exibir cenários salvos (se houver)
    });
  </script>
</body>
</html>
