<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Novos Objetivos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
      --cinza-claro: #e9ecef;
      --cinza-medio: #ced4da;
      --cinza-escuro: #6c757d;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      margin: 20px auto;
      padding: 20px;
      max-width: 1200px;
    }
    h1 {
      color: var(--dourado);
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid var(--dourado);
      background-color: white;
      border-radius: 8px;
    }
    .recommendation {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .recommendation h3 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
    }
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background-color: #25D366; /* WhatsApp green */
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 20.8px; /* 30% maior que 16px */
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
      text-transform: uppercase;
    }
    .whatsapp-button:hover {
      background-color: #128C7E; /* Darker WhatsApp green */
    }
    .save-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background-color: var(--dourado);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
      text-transform: uppercase;
    }
    .save-scenario-button:hover {
      background-color: var(--dourado-escuro);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .row > div {
      flex: 1;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid var(--verde-esmeralda);
      border-radius: 5px;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 12px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 16px;
    }
    button:hover {
      background-color: #03563f;
    }
    .chart-container {
      margin-top: 30px;
      position: relative;
      border: 1px solid var(--dourado-claro);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--verde-esmeralda);
    }
    .chart-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .chart-nav button {
      padding: 8px 15px;
      margin-top: 0;
      width: auto;
      font-size: 14px;
    }
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 400px;
    }
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    .table-slide {
      flex: 0 0 100%;
      overflow-y: auto;
      padding: 10px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }
    .data-table th {
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda);
      text-align: center;
      position: sticky;
      top: 0;
    }
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .data-table tr:hover {
      background-color: #f1f1f1;
    }
    
    /* Estilos para múltiplos cenários */
    .scenarios-container {
      margin-top: 20px;
      border: 2px solid var(--dourado);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    
    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .scenarios-header h3 {
      color: var(--verde-esmeralda);
      margin: 0;
    }
    
    .scenario-card {
      border: 1px solid var(--cinza-medio);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--cinza-claro);
      position: relative;
    }
    
    .scenario-card.active {
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
    }
    
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .scenario-title {
      font-weight: bold;
      color: var(--verde-esmeralda);
      margin: 0;
    }
    
    .scenario-actions {
      display: flex;
      gap: 10px;
    }
    
    .scenario-actions button {
      padding: 5px 10px;
      margin: 0;
      width: auto;
      font-size: 12px;
    }
    
    .scenario-delete {
      background-color: #dc3545;
    }
    
    .scenario-delete:hover {
      background-color: #c82333;
    }
    
    .scenario-select {
      background-color: var(--dourado);
    }
    
    .scenario-select:hover {
      background-color: var(--dourado-escuro);
    }
    
    .scenario-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .scenario-info {
      flex: 1;
      min-width: 200px;
    }
    
    .scenario-info p {
      margin: 5px 0;
    }
    
    .scenario-info strong {
      color: var(--verde-esmeralda);
    }
    
    .scenario-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--fundo-claro);
      border-radius: 5px;
      font-size: 14px;
    }
    
    /* Estilos para comparação de cenários */
    .comparison-container {
      margin-top: 30px;
      border: 2px solid var(--roxo);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    
    .comparison-header {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
    
    .comparison-chart-container {
      height: 400px;
      margin: 20px 0;
    }
    
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    
    .comparison-table th {
      background-color: var(--roxo-translucido);
      color: var(--roxo-escuro);
    }
    
    .comparison-table tr:nth-child(even) {
      background-color: var(--fundo-claro);
    }
    
    .comparison-table .best-value {
      font-weight: bold;
      color: var(--verde-esmeralda);
      background-color: rgba(40, 167, 69, 0.1);
    }
    
    .general-analysis {
      margin-top: 30px;
      padding: 20px;
      border: 2px solid var(--roxo);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .general-analysis h3 {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Objetivos</h1>
  <form id="savingsForm">
    <label for="goalDescription">Qual é o seu objetivo financeiro e por que ele é importante para você?</label>
    <textarea id="goalDescription" placeholder="Ex: Comprar um imóvel para ter segurança e estabilidade para minha família, ou fazer uma viagem internacional para conhecer novas culturas..."></textarea>
    
    <label for="goal">Valor do Objetivo (R$):</label>
    <input type="text" id="goal" required oninput="formatCurrency(this)">

    <label for="period">Prazo (em meses):</label>
    <input type="number" id="period" required>

    <label for="currentSavings">Valor já Guardado (R$):</label>
    <input type="text" id="currentSavings" required oninput="formatCurrency(this)">

    <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
    <input type="text" id="currentContribution" required oninput="formatCurrency(this)">

    <div class="row">
      <div>
        <label for="rate">Taxa de Juros (%):</label>
        <input type="text" id="rate" required oninput="formatPercentage(this)">
      </div>
      <div>
        <label for="rateType">Tipo de Taxa:</label>
        <select id="rateType">
          <option value="annual">Anual</option>
          <option value="monthly">Mensal</option>
        </select>
      </div>
    </div>

    <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
    <div class="row">
      <div>
        <select id="knowsTax" onchange="toggleTaxInput('tax', '15,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="tax" placeholder="15,00 %" oninput="formatPercentage(this)">
      </div>
    </div>

    <label>Você sabe a taxa de inflação dos últimos 12 meses?</label>
    <div class="row">
      <div>
        <select id="knowsInflation" onchange="toggleTaxInput('inflation', '5,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="inflation" placeholder="5,00 %" oninput="formatPercentage(this)">
      </div>
    </div>

    <button type="button" onclick="calculateSavings()">Calcular</button>
  </form>

  <div id="result" class="result"></div>
  
  <!-- Container para cenários -->
  <div id="scenariosContainer" class="scenarios-container" style="display: none;">
    <div class="scenarios-header">
      <h3>Cenários</h3>
    </div>
    <div id="scenariosList"></div>
  </div>
  
  <!-- Container para comparação de cenários -->
  <div id="comparisonContainer" class="comparison-container" style="display: none;">
    <h3 class="comparison-header">Comparação de Cenários</h3>
    <div class="comparison-chart-container">
      <canvas id="comparisonChart"></canvas>
    </div>
    <div id="comparisonTableContainer">
      <table id="comparisonTable" class="comparison-table">
        <thead>
          <tr>
            <th>Cenário</th>
            <th>Valor do Objetivo</th>
            <th>Prazo (meses)</th>
            <th>Valor Guardado</th>
            <th>Aporte Mensal</th>
            <th>Taxa de Juros</th>
            <th>Valor Final</th>
            <th>Total Investido</th>
            <th>Total de Juros</th>
          </tr>
        </thead>
        <tbody id="comparisonTableBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- Análise Geral Automática -->
  <div id="generalAnalysis" class="general-analysis" style="display: none;">
    <h3>Análise Geral Automática</h3>
    <div id="generalAnalysisText"></div>
  </div>
  
  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>
  
  <!-- Botão para salvar e simular outro cenário -->
  <button id="saveScenarioButton" class="save-scenario-button" onclick="saveAndSimulateAnother()" style="display: none;">
    SALVAR E SIMULAR OUTRO CENÁRIO
  </button>
  
  <!-- Botão WhatsApp fora da caixa de análise automatizada -->
  <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
    AVANÇAR PARA ANÁLISE PERSONALIZADA
  </a>
  
  <div id="chartUnicoContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Investimento Único</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Unico', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Unico', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartUnicoSlide" class="chart-slide">
        <canvas id="chartUnico"></canvas>
      </div>
      <div id="tableUnicoSlide" class="table-slide" style="display: none;">
        <table id="tableUnico" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartIdealContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução do Plano Ideal</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Ideal', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Ideal', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartIdealSlide" class="chart-slide">
        <canvas id="chartIdeal"></canvas>
      </div>
      <div id="tableIdealSlide" class="table-slide" style="display: none;">
        <table id="tableIdeal" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartAtualContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Poupança Atual</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Atual', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Atual', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartAtualSlide" class="chart-slide">
        <canvas id="chartAtual"></canvas>
      </div>
      <div id="tableAtualSlide" class="table-slide" style="display: none;">
        <table id="tableAtual" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="chartRentabilidadeContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Rentabilidade Necessária</div>
    <div class="chart-nav">
      <button onclick="showChartSlide('Rentabilidade', 'chart')">Gráfico</button>
      <button onclick="showChartSlide('Rentabilidade', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartRentabilidadeSlide" class="chart-slide">
        <canvas id="chartRentabilidade"></canvas>
      </div>
      <div id="tableRentabilidadeSlide" class="table-slide" style="display: none;">
        <table id="tableRentabilidade" class="data-table">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Total Investido</th>
              <th>Juros</th>
              <th>Total Juros</th>
              <th>Total Acumulado</th>
              <th>Imposto</th>
              <th>Valor Líquido</th>
              <th>Objetivo Corrigido</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais para armazenar os resultados e textos
    let goalDescriptionText = '';
    let resultText = '';
    
    // Array para armazenar os cenários
    let scenarios = [];
    let currentScenarioIndex = -1;
    let scenarioCounter = 1; // Contador para nomeação automática de cenários
    let isFirstScenario = true; // Flag para controlar se é o primeiro cenário
    
    // Cores para os diferentes cenários nos gráficos comparativos
    const scenarioColors = [
      { background: 'rgba(40, 167, 69, 0.2)', border: 'rgb(40, 167, 69)' },
      { background: 'rgba(111, 66, 193, 0.2)', border: 'rgb(111, 66, 193)' },
      { background: 'rgba(212, 175, 55, 0.2)', border: 'rgb(212, 175, 55)' },
      { background: 'rgba(220, 53, 69, 0.2)', border: 'rgb(220, 53, 69)' },
      { background: 'rgba(0, 123, 255, 0.2)', border: 'rgb(0, 123, 255)' },
      { background: 'rgba(255, 193, 7, 0.2)', border: 'rgb(255, 193, 7)' },
      { background: 'rgba(23, 162, 184, 0.2)', border: 'rgb(23, 162, 184)' },
      { background: 'rgba(108, 117, 125, 0.2)', border: 'rgb(108, 117, 125)' }
    ];
    
    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, '');
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = 'R$ ' + value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.').replace(/\.(\d{2})$/, ',$1');
    }

    function formatPercentage(input) {
      let value = input.value.replace(/\D/g, '');
      value = (parseFloat(value) / 100).toFixed(2);
      input.value = value.replace('.', ',') + ' %';
    }

    function toggleTaxInput(id, defaultValue) {
      const select = document.getElementById(id === 'tax' ? 'knowsTax' : 'knowsInflation');
      const input = document.getElementById(id);
      input.disabled = select.value !== 'yes';
      input.value = select.value === 'yes' ? '' : defaultValue;
    }

    function parseCurrency(value) {
      return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    function parsePercentage(value) {
      return parseFloat(value.replace('%', '').replace(',', '.')) / 100 || 0;
    }

    // Função para formatar valores monetários com sempre duas casas decimais
    function formatMoney(value) {
      return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Função para alternar entre visualização de gráfico e tabela
    function showChartSlide(chartId, slideType) {
      const chartSlide = document.getElementById(`chart${chartId}Slide`);
      const tableSlide = document.getElementById(`table${chartId}Slide`);
      
      if (slideType === 'chart') {
        chartSlide.style.display = 'block';
        tableSlide.style.display = 'none';
      } else {
        chartSlide.style.display = 'none';
        tableSlide.style.display = 'block';
      }
    }

    // Função para capturar a página como imagem e enviar pelo WhatsApp
    async function capturePageAndSend() {
      try {
        // Esconder o botão do WhatsApp durante a captura
        const whatsappButton = document.getElementById('whatsappButton');
        whatsappButton.style.display = 'none';
        
        // Capturar a página
        const canvas = await html2canvas(document.body, {
          scale: 1,
          useCORS: true,
          logging: false,
          allowTaint: true
        });
        
        // Mostrar o botão novamente
        whatsappButton.style.display = 'block';
        
        // Converter para imagem
        const imageData = canvas.toDataURL('image/jpeg', 0.7);
        
        // Criar um link temporário para download
        const link = document.createElement('a');
        link.href = imageData;
        link.download = 'analise_financeira.jpg';
        
        // Simular clique para download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        return imageData;
      } catch (error) {
        console.error('Erro ao capturar a página:', error);
        return null;
      }
    }

    // Função para abrir o WhatsApp com a mensagem personalizada
    async function openWhatsAppChat() {
      // Obter o texto do objetivo e da caixa de resposta
      const goalText = goalDescriptionText;
      const resultBoxText = resultText;
      
      // Capturar a página como imagem
      await capturePageAndSend();
      
      // Criar a mensagem para o WhatsApp
      const message = `Oi Hugo, queria tua ajuda com o meu objetivo:
${goalText}

Segue o resumo:
${resultBoxText}

Estou enviando também uma imagem com todos os detalhes.`;
      
      // Codificar a mensagem para URL
      const encodedMessage = encodeURIComponent(message);
      
      // Criar o link do WhatsApp usando a API correta
      const whatsappUrl = `https://api.whatsapp.com/send?phone=5581994297920&text=${encodedMessage}`;
      
      // Abrir o link em uma nova janela
      window.open(whatsappUrl, '_blank');
    }

    // Função para preencher a tabela de dados
    function fillDataTable(tableId, data, goal, inflation) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      
      // Começar do mês 1 (não do mês 0)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const tr = document.createElement('tr');
        
        // Mês
        const tdMes = document.createElement('td');
        tdMes.textContent = row.month;
        tr.appendChild(tdMes);
        
        // Total Investido
        const tdInvestido = document.createElement('td');
        tdInvestido.textContent = `R$ ${formatMoney(row.totalInvestido)}`;
        tr.appendChild(tdInvestido);
        
        // Juros
        const tdJuros = document.createElement('td');
        tdJuros.textContent = `R$ ${formatMoney(row.juros)}`;
        tr.appendChild(tdJuros);
        
        // Total Juros
        const tdTotalJuros = document.createElement('td');
        tdTotalJuros.textContent = `R$ ${formatMoney(row.totalJuros)}`;
        tr.appendChild(tdTotalJuros);
        
        // Total Acumulado
        const tdAcumulado = document.createElement('td');
        tdAcumulado.textContent = `R$ ${formatMoney(row.totalAcumulado)}`;
        tr.appendChild(tdAcumulado);
        
        // Imposto
        const tdImposto = document.createElement('td');
        tdImposto.textContent = `R$ ${formatMoney(row.imposto)}`;
        tr.appendChild(tdImposto);
        
        // Valor Líquido
        const tdLiquido = document.createElement('td');
        tdLiquido.textContent = `R$ ${formatMoney(row.valorLiquido)}`;
        tr.appendChild(tdLiquido);
        
        // Objetivo Corrigido
        const tdObjetivo = document.createElement('td');
        tdObjetivo.textContent = `R$ ${formatMoney(row.objetivoCorrigido)}`;
        tr.appendChild(tdObjetivo);
        
        tbody.appendChild(tr);
      }
    }

    function drawChart(ctx, bruto, liquido, investido, corBruto, corLiquido, corInvestido) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: bruto.length}, (_, i) => i + 1),
          datasets: [
            {
              label: 'Valor Bruto',
              data: bruto,
              borderColor: corBruto,
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            },
            {
              label: 'Valor Líquido',
              data: liquido,
              borderColor: corLiquido,
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            },
            {
              label: 'Total Investido',
              data: investido,
              borderColor: corInvestido,
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Função para calcular juros compostos
    function calculateCompoundInterest(initialValue, monthlyContribution, monthlyRate, months, tax, goal, inflation) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      let objetivoCorrigido = goal;
      
      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue,
        objetivoCorrigido: objetivoCorrigido
      });
      
      for (let i = 1; i <= months; i++) {
        // Calcular juros do mês
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        
        // Adicionar aporte mensal
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;
        
        // Calcular imposto sobre o rendimento
        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;
        
        // Calcular objetivo corrigido pela inflação (a cada 12 meses)
        if (i % 12 === 0) {
          objetivoCorrigido = objetivoCorrigido * (1 + inflation);
        }
        
        // Registrar valores mensais para gráfico e análise
        valoresMensais.push({
          month: i,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue,
          objetivoCorrigido: objetivoCorrigido
        });
      }
      
      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais
      };
    }

    // Função para calcular a taxa anual necessária para atingir o objetivo no prazo desejado
    function calculateRequiredRate(goal, currentSavings, monthlyContribution, period, tax, inflation) {
      // Ajustar o objetivo pela inflação (anualmente)
      let inflatedGoal = goal;
      const yearsCount = Math.floor(period / 12);
      const remainingMonths = period % 12;
      
      // Aplicar inflação para anos completos
      for (let i = 0; i < yearsCount; i++) {
        inflatedGoal *= (1 + inflation);
      }
      
      // Busca binária para encontrar a taxa mensal necessária
      let lowRate = 0;
      let highRate = 1; // 100% ao mês como limite superior inicial
      let requiredMonthlyRate = 0;
      let iterations = 0;
      let result;
      
      while (iterations < 100) { // Limite de iterações para evitar loop infinito
        requiredMonthlyRate = (lowRate + highRate) / 2;
        result = calculateCompoundInterest(currentSavings, monthlyContribution, requiredMonthlyRate, period, tax, goal, inflation);
        
        // Verificar se o valor líquido final está próximo o suficiente do objetivo
        const valorLiquidoFinal = result.valoresMensais[period].valorLiquido;
        const objetivoFinal = result.valoresMensais[period].objetivoCorrigido;
        
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) {
          break;
        }
        
        // Ajusta os limites da busca
        if (valorLiquidoFinal > objetivoFinal) {
          highRate = requiredMonthlyRate;
        } else {
          lowRate = requiredMonthlyRate;
        }
        
        iterations++;
      }
      
      // Converter taxa mensal para anual: (1 + taxa_mensal)^12 - 1
      const requiredAnnualRate = Math.pow(1 + requiredMonthlyRate, 12) - 1;
      
      return {
        monthlyRate: requiredMonthlyRate,
        annualRate: requiredAnnualRate,
        finalValue: result.finalValue,
        finalGoal: inflatedGoal,
        valoresMensais: result.valoresMensais
      };
    }

    // Função para resumir o texto do objetivo
    function summarizeGoalText(text) {
      if (!text || text.trim() === '') {
        return '';
      }
      
      // Palavras-chave para identificar tipos de objetivos
      const keywords = {
        imovel: ['imóvel', 'casa', 'apartamento', 'moradia', 'residência', 'propriedade', 'terreno'],
        viagem: ['viagem', 'viajar', 'turismo', 'férias', 'exterior', 'internacional', 'conhecer'],
        educacao: ['educação', 'faculdade', 'universidade', 'curso', 'estudo', 'formação', 'pós-graduação', 'mestrado', 'doutorado'],
        aposentadoria: ['aposentadoria', 'aposentar', 'independência financeira', 'liberdade financeira', 'renda passiva'],
        veiculo: ['carro', 'veículo', 'automóvel', 'moto', 'motocicleta', 'caminhão'],
        negocio: ['negócio', 'empresa', 'empreendimento', 'startup', 'investimento', 'sociedade'],
        saude: ['saúde', 'tratamento', 'cirurgia', 'médico', 'hospital', 'plano de saúde'],
        familia: ['família', 'filhos', 'casamento', 'herança', 'futuro dos filhos']
      };
      
      // Converter texto para minúsculas para facilitar a comparação
      const lowerText = text.toLowerCase();
      
      // Identificar o tipo de objetivo
      let goalType = '';
      let maxMatches = 0;
      
      for (const [type, words] of Object.entries(keywords)) {
        const matches = words.filter(word => lowerText.includes(word)).length;
        if (matches > maxMatches) {
          maxMatches = matches;
          goalType = type;
        }
      }
      
      // Criar resumo com base no tipo de objetivo identificado
      let summary = '';
      
      switch (goalType) {
        case 'imovel':
          summary = 'aquisição de imóvel';
          break;
        case 'viagem':
          summary = 'realização de viagem';
          break;
        case 'educacao':
          summary = 'investimento em educação';
          break;
        case 'aposentadoria':
          summary = 'planejamento para aposentadoria';
          break;
        case 'veiculo':
          summary = 'compra de veículo';
          break;
        case 'negocio':
          summary = 'investimento em negócio próprio';
          break;
        case 'saude':
          summary = 'cuidados com saúde';
          break;
        case 'familia':
          summary = 'planejamento familiar';
          break;
        default:
          // Se não conseguir identificar um tipo específico, extrair as primeiras palavras
          const words = lowerText.split(' ');
          if (words.length > 3) {
            summary = words.slice(0, 3).join(' ') + '...';
          } else {
            summary = 'objetivo financeiro';
          }
      }
      
      // Verificar se há menção à importância ou motivo
      const importanceKeywords = ['importante', 'importância', 'significa', 'porque', 'pois', 'para', 'motivo'];
      let hasImportance = importanceKeywords.some(word => lowerText.includes(word));
      
      if (hasImportance) {
        summary += ' com significado pessoal';
      }
      
      return summary;
    }

    // Função para gerar análise automatizada
    function generateRecommendation(goalDescription, goal, currentSavings, currentContribution, idealContribution, months, requiredRate, rate) {
      const recommendationDiv = document.getElementById('recommendation');
      const recommendationText = document.getElementById('recommendationText');
      const whatsappButton = document.getElementById('whatsappButton');
      const saveScenarioButton = document.getElementById('saveScenarioButton');
      
      // Extrair informações relevantes
      const goalGap = goal - currentSavings;
      const contributionGap = idealContribution - currentContribution;
      const contributionPercentage = (currentContribution / idealContribution) * 100;
      const rateGap = requiredRate - rate;
      
      let analysis = '';
      
      // Análise da situação atual - começando diretamente aqui, sem introdução sobre o objetivo
      if (currentSavings > 0) {
        const savingsPercentage = (currentSavings / goal) * 100;
        analysis += `<p>Valor já guardado: R$ ${formatMoney(currentSavings)}, o que representa ${savingsPercentage.toFixed(1).replace('.', ',')}% do objetivo. `;
        
        if (savingsPercentage < 10) {
          analysis += `Este é um bom começo, mas ainda há um longo caminho pela frente.</p>`;
        } else if (savingsPercentage < 30) {
          analysis += `Já foram dados passos importantes em direção ao objetivo.</p>`;
        } else if (savingsPercentage < 60) {
          analysis += `Uma parte significativa do caminho já foi percorrida.</p>`;
        } else {
          analysis += `O objetivo está muito próximo de ser alcançado.</p>`;
        }
      } else {
        analysis += `<p>Ainda não foi iniciada a poupança para este objetivo específico.</p>`;
      }
      
      // Análise do aporte mensal
      if (currentContribution > 0) {
        if (contributionPercentage >= 100) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} é suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 80) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está próximo do ideal. Um pequeno ajuste de R$ ${formatMoney(contributionGap)} a mais por mês seria o suficiente para atingir o objetivo no prazo desejado.</p>`;
        } else if (contributionPercentage >= 50) {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} representa um bom esforço, mas para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês (um acréscimo de R$ ${formatMoney(contributionGap)}).</p>`;
        } else {
          analysis += `<p>O aporte mensal atual de R$ ${formatMoney(currentContribution)} está significativamente abaixo do ideal. Para atingir o objetivo no prazo desejado, seria necessário aumentar para R$ ${formatMoney(idealContribution)} por mês.</p>`;
        }
      } else {
        analysis += `<p>Não estão sendo feitos aportes mensais. Para atingir o objetivo no prazo desejado, seria necessário poupar R$ ${formatMoney(idealContribution)} por mês.</p>`;
      }
      
      // Análise da rentabilidade
      if (rateGap > 0) {
        const rateGapPercentage = rateGap * 100;
        if (rateGapPercentage > 10) {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace('.', ',')}% ao ano, o que está ${rateGapPercentage.toFixed(2).replace('.', ',')} pontos percentuais acima da taxa informada. Esta diferença é significativa e pode representar um risco maior.</p>`;
        } else {
          analysis += `<p>A rentabilidade necessária para atingir o objetivo com o aporte atual é de ${(requiredRate * 100).toFixed(2).replace('.', ',')}% ao ano, o que está ${rateGapPercentage.toFixed(2).replace('.', ',')} pontos percentuais acima da taxa informada. Esta diferença é relativamente pequena e pode ser alcançável com ajustes na estratégia de investimento.</p>`;
        }
      } else {
        analysis += `<p>A rentabilidade informada de ${(rate * 100).toFixed(2).replace('.', ',')}% ao ano é suficiente para atingir o objetivo no prazo desejado, desde que sejam mantidos os aportes mensais adequados.</p>`;
      }
      
      recommendationText.innerHTML = analysis;
      
      // Mostrar os elementos relevantes apenas no primeiro cenário
      if (isFirstScenario) {
        recommendationDiv.style.display = 'block';
        saveScenarioButton.style.display = 'block';
        whatsappButton.style.display = 'block';
      } else {
        // Nos cenários subsequentes, não mostrar a análise automatizada individual
        recommendationDiv.style.display = 'none';
        // Mas continuar mostrando o botão de salvar cenário
        saveScenarioButton.style.display = 'block';
        // E o botão do WhatsApp
        whatsappButton.style.display = 'block';
      }
    }
    
    // Função para salvar o cenário atual e preparar para um novo
    function saveAndSimulateAnother() {
      // Verificar se há dados para adicionar
      if (!document.getElementById('result').innerHTML) {
        alert('Por favor, calcule um cenário antes de salvá-lo.');
        return;
      }
      
      // Adicionar o cenário atual
      addCurrentScenario();
      
      // Limpar os campos do formulário, exceto o objetivo
      document.getElementById('goal').value = '';
      document.getElementById('period').value = '';
      document.getElementById('currentSavings').value = '';
      document.getElementById('currentContribution').value = '';
      document.getElementById('rate').value = '';
      document.getElementById('knowsTax').value = 'no';
      document.getElementById('knowsInflation').value = 'no';
      toggleTaxInput('tax', '15,00 %');
      toggleTaxInput('inflation', '5,00 %');
      
      // Limpar os resultados
      document.getElementById('result').innerHTML = '';
      
      // Esconder os gráficos e tabelas
      document.getElementById('chartUnicoContainer').style.display = 'none';
      document.getElementById('chartIdealContainer').style.display = 'none';
      document.getElementById('chartAtualContainer').style.display = 'none';
      document.getElementById('chartRentabilidadeContainer').style.display = 'none';
      
      // Esconder o botão de salvar cenário até que um novo cálculo seja feito
      document.getElementById('saveScenarioButton').style.display = 'none';
      document.getElementById('whatsappButton').style.display = 'none';
      
      // Marcar que não é mais o primeiro cenário
      isFirstScenario = false;
      
      // Rolar para o topo do formulário
      window.scrollTo(0, 0);
    }
    
    // Função para adicionar o cenário atual à lista de cenários
    function addCurrentScenario() {
      // Verificar se há dados para adicionar
      if (!document.getElementById('result').innerHTML) {
        alert('Por favor, calcule um cenário antes de adicioná-lo.');
        return;
      }
      
      // Obter os dados do formulário
      const scenarioName = `Cenário ${scenarioCounter.toString().padStart(2, '0')}`;
      scenarioCounter++; // Incrementar o contador para o próximo cenário
      
      const goalDescription = document.getElementById('goalDescription').value;
      const goal = parseCurrency(document.getElementById('goal').value);
      const rate = parsePercentage(document.getElementById('rate').value);
      const rateType = document.getElementById('rateType').value;
      const knowsTax = document.getElementById('knowsTax').value;
      const tax = knowsTax === 'yes' ? parsePercentage(document.getElementById('tax').value) : 0.15;
      const knowsInflation = document.getElementById('knowsInflation').value;
      const inflation = knowsInflation === 'yes' ? parsePercentage(document.getElementById('inflation').value) : 0.05;
      const period = parseInt(document.getElementById('period').value);
      const currentSavings = parseCurrency(document.getElementById('currentSavings').value);
      const currentContribution = parseCurrency(document.getElementById('currentContribution').value);
      
      // Calcular a taxa mensal
      const monthlyRate = rateType === 'annual' ? Math.pow(1 + rate, 1 / 12) - 1 : rate;
      
      // Calcular resultados para o cenário
      const resultUnico = calculateCompoundInterest(currentSavings, 0, monthlyRate, period, tax, goal, inflation);
      
      // Calcular o plano ideal
      let low = 0, high = goal * 10, idealContribution = 0;
      let resultIdeal;
      
      for (let i = 0; i < 100; i++) {
        idealContribution = (low + high) / 2;
        resultIdeal = calculateCompoundInterest(currentSavings, idealContribution, monthlyRate, period, tax, goal, inflation);
        
        const valorLiquidoFinal = resultIdeal.valoresMensais[period].valorLiquido;
        const objetivoFinal = resultIdeal.valoresMensais[period].objetivoCorrigido;
        
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) break;
        if (valorLiquidoFinal > objetivoFinal) high = idealContribution;
        else low = idealContribution;
      }
      
      // Calcular com a poupança atual
      const resultAtual = calculateCompoundInterest(currentSavings, currentContribution, monthlyRate, period, tax, goal, inflation);
      
      // Calcular a rentabilidade necessária
      const requiredRateResult = calculateRequiredRate(goal, currentSavings, currentContribution, period, tax, inflation);
      
      // Obter o texto completo da caixa de resposta
      const resultText = document.getElementById('result').innerHTML;
      
      // Criar objeto do cenário
      const scenario = {
        id: Date.now(), // ID único baseado no timestamp
        name: scenarioName,
        goalDescription: goalDescription,
        goal: goal,
        rate: rate,
        rateType: rateType,
        tax: tax,
        inflation: inflation,
        period: period,
        currentSavings: currentSavings,
        currentContribution: currentContribution,
        idealContribution: idealContribution,
        requiredRate: requiredRateResult.annualRate,
        resultUnico: resultUnico,
        resultIdeal: resultIdeal,
        resultAtual: resultAtual,
        resultRentabilidade: requiredRateResult,
        resultText: resultText // Salvar o texto completo da caixa de resposta
      };
      
      // Adicionar o cenário ao array
      scenarios.push(scenario);
      
      // Atualizar a interface
      updateScenariosUI();
      
      // Mostrar a seção de cenários
      document.getElementById('scenariosContainer').style.display = 'block';
      
      // Atualizar a comparação se houver mais de um cenário
      if (scenarios.length > 1) {
        updateComparisonUI();
        generateGeneralAnalysis();
        document.getElementById('comparisonContainer').style.display = 'block';
        document.getElementById('generalAnalysis').style.display = 'block';
      }
    }
    
    // Função para remover um cenário
    function removeScenario(id) {
      // Encontrar o índice do cenário no array
      const index = scenarios.findIndex(s => s.id === id);
      
      // Remover o cenário do array
      if (index !== -1) {
        scenarios.splice(index, 1);
      }
      
      // Atualizar a interface
      updateScenariosUI();
      
      // Atualizar ou esconder a comparação dependendo do número de cenários
      if (scenarios.length > 1) {
        updateComparisonUI();
        generateGeneralAnalysis();
      } else {
        document.getElementById('comparisonContainer').style.display = 'none';
        document.getElementById('generalAnalysis').style.display = 'none';
      }
      
      // Esconder a seção de cenários se não houver nenhum
      if (scenarios.length === 0) {
        document.getElementById('scenariosContainer').style.display = 'none';
      }
    }
    
    // Função para atualizar a interface de cenários
    function updateScenariosUI() {
      const scenariosList = document.getElementById('scenariosList');
      scenariosList.innerHTML = '';
      
      scenarios.forEach((scenario, index) => {
        const scenarioCard = document.createElement('div');
        scenarioCard.className = 'scenario-card';
        scenarioCard.id = `scenario-${scenario.id}`;
        
        // Cabeçalho do cenário
        const scenarioHeader = document.createElement('div');
        scenarioHeader.className = 'scenario-header';
        
        const scenarioTitle = document.createElement('h4');
        scenarioTitle.className = 'scenario-title';
        scenarioTitle.textContent = scenario.name;
        
        const scenarioActions = document.createElement('div');
        scenarioActions.className = 'scenario-actions';
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'scenario-delete';
        deleteButton.textContent = 'Excluir';
        deleteButton.onclick = function() { removeScenario(scenario.id); };
        
        scenarioActions.appendChild(deleteButton);
        scenarioHeader.appendChild(scenarioTitle);
        scenarioHeader.appendChild(scenarioActions);
        
        // Conteúdo do cenário
        const scenarioContent = document.createElement('div');
        scenarioContent.className = 'scenario-content';
        
        // Informações básicas
        const basicInfo = document.createElement('div');
        basicInfo.className = 'scenario-info';
        basicInfo.innerHTML = `
          <p><strong>Valor do Objetivo:</strong> R$ ${formatMoney(scenario.goal)}</p>
          <p><strong>Prazo:</strong> ${scenario.period} meses</p>
          <p><strong>Valor Guardado:</strong> R$ ${formatMoney(scenario.currentSavings)}</p>
        `;
        
        // Informações financeiras
        const financialInfo = document.createElement('div');
        financialInfo.className = 'scenario-info';
        financialInfo.innerHTML = `
          <p><strong>Aporte Mensal Atual:</strong> R$ ${formatMoney(scenario.currentContribution)}</p>
          <p><strong>Aporte Ideal:</strong> R$ ${formatMoney(scenario.idealContribution)}</p>
          <p><strong>Taxa de Juros:</strong> ${(scenario.rate * 100).toFixed(2).replace('.', ',')}% ${scenario.rateType === 'annual' ? 'ao ano' : 'ao mês'}</p>
          <p><strong>Inflação:</strong> ${(scenario.inflation * 100).toFixed(2).replace('.', ',')}%</p>
          <p><strong>Imposto:</strong> ${(scenario.tax * 100).toFixed(2).replace('.', ',')}%</p>
        `;
        
        // Resultados
        const resultsInfo = document.createElement('div');
        resultsInfo.className = 'scenario-info';
        
        const finalValue = scenario.resultAtual.valoresMensais[scenario.period].valorLiquido;
        const goalValue = scenario.resultAtual.valoresMensais[scenario.period].objetivoCorrigido;
        const difference = finalValue - goalValue;
        
        resultsInfo.innerHTML = `
          <p><strong>Valor Final:</strong> R$ ${formatMoney(finalValue)}</p>
          <p><strong>Objetivo Corrigido:</strong> R$ ${formatMoney(goalValue)}</p>
          <p><strong>Diferença:</strong> R$ ${formatMoney(difference)} (${difference >= 0 ? 'superávit' : 'déficit'})</p>
        `;
        
        scenarioContent.appendChild(basicInfo);
        scenarioContent.appendChild(financialInfo);
        scenarioContent.appendChild(resultsInfo);
        
        // Adicionar detalhes completos (texto da caixa de resposta)
        const scenarioDetails = document.createElement('div');
        scenarioDetails.className = 'scenario-details';
        scenarioDetails.innerHTML = scenario.resultText;
        
        scenarioCard.appendChild(scenarioHeader);
        scenarioCard.appendChild(scenarioContent);
        scenarioCard.appendChild(scenarioDetails);
        
        scenariosList.appendChild(scenarioCard);
      });
    }
    
    // Função para atualizar a interface de comparação
    function updateComparisonUI() {
      // Limpar gráfico de comparação existente
      const comparisonChartCanvas = document.getElementById('comparisonChart');
      const existingChart = Chart.getChart(comparisonChartCanvas);
      if (existingChart) {
        existingChart.destroy();
      }
      
      // Preparar dados para o gráfico de comparação
      const labels = scenarios.map(s => s.name);
      const finalValues = scenarios.map(s => s.resultAtual.valoresMensais[s.period].valorLiquido);
      const goalValues = scenarios.map(s => s.resultAtual.valoresMensais[s.period].objetivoCorrigido);
      const totalInvested = scenarios.map(s => s.resultAtual.valoresMensais[s.period].totalInvestido);
      
      // Criar o gráfico de comparação
      new Chart(comparisonChartCanvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Valor Final',
              data: finalValues,
              backgroundColor: 'rgba(40, 167, 69, 0.6)',
              borderColor: 'rgb(40, 167, 69)',
              borderWidth: 1
            },
            {
              label: 'Objetivo Corrigido',
              data: goalValues,
              backgroundColor: 'rgba(111, 66, 193, 0.6)',
              borderColor: 'rgb(111, 66, 193)',
              borderWidth: 1
            },
            {
              label: 'Total Investido',
              data: totalInvested,
              backgroundColor: 'rgba(212, 175, 55, 0.6)',
              borderColor: 'rgb(212, 175, 55)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                  return label;
                }
              }
            }
          }
        }
      });
      
      // Atualizar a tabela de comparação
      const comparisonTableBody = document.getElementById('comparisonTableBody');
      comparisonTableBody.innerHTML = '';
      
      // Encontrar os melhores valores para destacar
      const bestValues = {
        finalValue: Math.max(...scenarios.map(s => s.resultAtual.valoresMensais[s.period].valorLiquido)),
        totalInvested: Math.min(...scenarios.map(s => s.resultAtual.valoresMensais[s.period].totalInvestido)),
        totalJuros: Math.max(...scenarios.map(s => s.resultAtual.valoresMensais[s.period].totalJuros))
      };
      
      scenarios.forEach(scenario => {
        const row = document.createElement('tr');
        
        // Nome do cenário
        const tdName = document.createElement('td');
        tdName.textContent = scenario.name;
        row.appendChild(tdName);
        
        // Valor do objetivo
        const tdGoal = document.createElement('td');
        tdGoal.textContent = `R$ ${formatMoney(scenario.goal)}`;
        row.appendChild(tdGoal);
        
        // Prazo
        const tdPeriod = document.createElement('td');
        tdPeriod.textContent = scenario.period;
        row.appendChild(tdPeriod);
        
        // Valor guardado
        const tdSavings = document.createElement('td');
        tdSavings.textContent = `R$ ${formatMoney(scenario.currentSavings)}`;
        row.appendChild(tdSavings);
        
        // Aporte mensal
        const tdContribution = document.createElement('td');
        tdContribution.textContent = `R$ ${formatMoney(scenario.currentContribution)}`;
        row.appendChild(tdContribution);
        
        // Taxa de juros
        const tdRate = document.createElement('td');
        tdRate.textContent = `${(scenario.rate * 100).toFixed(2).replace('.', ',')}%`;
        row.appendChild(tdRate);
        
        // Valor final
        const finalValue = scenario.resultAtual.valoresMensais[scenario.period].valorLiquido;
        const tdFinalValue = document.createElement('td');
        tdFinalValue.textContent = `R$ ${formatMoney(finalValue)}`;
        if (finalValue === bestValues.finalValue) {
          tdFinalValue.className = 'best-value';
        }
        row.appendChild(tdFinalValue);
        
        // Total investido
        const totalInvested = scenario.resultAtual.valoresMensais[scenario.period].totalInvestido;
        const tdTotalInvested = document.createElement('td');
        tdTotalInvested.textContent = `R$ ${formatMoney(totalInvested)}`;
        if (totalInvested === bestValues.totalInvested) {
          tdTotalInvested.className = 'best-value';
        }
        row.appendChild(tdTotalInvested);
        
        // Total de juros
        const totalJuros = scenario.resultAtual.valoresMensais[scenario.period].totalJuros;
        const tdTotalJuros = document.createElement('td');
        tdTotalJuros.textContent = `R$ ${formatMoney(totalJuros)}`;
        if (totalJuros === bestValues.totalJuros) {
          tdTotalJuros.className = 'best-value';
        }
        row.appendChild(tdTotalJuros);
        
        comparisonTableBody.appendChild(row);
      });
    }
    
    // Função para gerar análise geral automática
    function generateGeneralAnalysis() {
      if (scenarios.length < 2) return;
      
      const generalAnalysisText = document.getElementById('generalAnalysisText');
      let analysis = '';
      
      // Ordenar cenários por valor final líquido (do maior para o menor)
      const sortedByFinalValue = [...scenarios].sort((a, b) => {
        const aFinalValue = a.resultAtual.valoresMensais[a.period].valorLiquido;
        const bFinalValue = b.resultAtual.valoresMensais[b.period].valorLiquido;
        return bFinalValue - aFinalValue;
      });
      
      // Ordenar cenários por diferença entre valor final e objetivo
      const scenariosWithDifference = scenarios.map(s => {
        const finalValue = s.resultAtual.valoresMensais[s.period].valorLiquido;
        const goalValue = s.resultAtual.valoresMensais[s.period].objetivoCorrigido;
        const difference = finalValue - goalValue;
        const percentageDifference = (difference / goalValue) * 100;
        return { ...s, difference, percentageDifference };
      });
      
      const sortedByDifference = [...scenariosWithDifference].sort((a, b) => b.percentageDifference - a.percentageDifference);
      
      // Introdução
      analysis += `<p>Foram simulados ${scenarios.length} cenários diferentes para o objetivo financeiro. A seguir, apresentamos uma análise comparativa das diferentes perspectivas de realização:</p>`;
      
      // Análise do cenário com maior valor final
      const bestFinalValueScenario = sortedByFinalValue[0];
      const bestFinalValue = bestFinalValueScenario.resultAtual.valoresMensais[bestFinalValueScenario.period].valorLiquido;
      
      analysis += `<p><strong>Perspectiva de Maximização de Patrimônio:</strong> O "${bestFinalValueScenario.name}" resulta no maior valor final (R$ ${formatMoney(bestFinalValue)}). `;
      
      if (sortedByFinalValue.length > 1) {
        const secondBestFinalValueScenario = sortedByFinalValue[1];
        const secondBestFinalValue = secondBestFinalValueScenario.resultAtual.valoresMensais[secondBestFinalValueScenario.period].valorLiquido;
        const difference = bestFinalValue - secondBestFinalValue;
        const percentageDifference = (difference / secondBestFinalValue) * 100;
        
        analysis += `Este valor é R$ ${formatMoney(difference)} (${percentageDifference.toFixed(2).replace('.', ',')}%) superior ao segundo melhor cenário "${secondBestFinalValueScenario.name}".</p>`;
      } else {
        analysis += `</p>`;
      }
      
      // Análise do cenário que melhor atinge o objetivo
      const bestMatchScenario = sortedByDifference[0];
      const bestMatchDifference = bestMatchScenario.difference;
      const bestMatchPercentage = bestMatchScenario.percentageDifference;
      
      if (bestMatchDifference >= 0) {
        analysis += `<p><strong>Perspectiva de Realização do Objetivo:</strong> O "${bestMatchScenario.name}" supera o objetivo em R$ ${formatMoney(bestMatchDifference)} (${bestMatchPercentage.toFixed(2).replace('.', ',')}%). `;
      } else {
        // Se todos os cenários não atingem o objetivo, encontrar o que chega mais perto
        const closestScenario = [...scenariosWithDifference]
          .filter(s => s.difference < 0)
          .sort((a, b) => Math.abs(a.difference) - Math.abs(b.difference))[0];
        
        analysis += `<p><strong>Perspectiva de Aproximação do Objetivo:</strong> O "${closestScenario.name}" é o que mais se aproxima do objetivo, ficando R$ ${formatMoney(Math.abs(closestScenario.difference))} abaixo do valor necessário (${Math.abs(closestScenario.percentageDifference).toFixed(2).replace('.', ',')}%). `;
      }
      
      // Verificar se há cenários que não atingem o objetivo
      const scenariosNotReachingGoal = scenariosWithDifference.filter(s => s.difference < 0);
      if (scenariosNotReachingGoal.length > 0) {
        if (scenariosNotReachingGoal.length === scenarios.length) {
          analysis += `Nenhum dos cenários simulados atinge completamente o objetivo financeiro.</p>`;
        } else {
          analysis += `${scenariosNotReachingGoal.length} de ${scenarios.length} cenários não atingem completamente o objetivo financeiro.</p>`;
        }
      } else {
        analysis += `Todos os cenários simulados atingem o objetivo financeiro.</p>`;
      }
      
      // Análise de prazos
      const differentPeriods = [...new Set(scenarios.map(s => s.period))].length > 1;
      
      if (differentPeriods) {
        // Ordenar por prazo (do menor para o maior)
        const sortedByPeriod = [...scenarios].sort((a, b) => a.period - b.period);
        const shortestPeriodScenario = sortedByPeriod[0];
        const longestPeriodScenario = sortedByPeriod[sortedByPeriod.length - 1];
        
        analysis += `<p><strong>Perspectiva de Tempo:</strong> O "${shortestPeriodScenario.name}" tem o menor prazo (${shortestPeriodScenario.period} meses), enquanto "${longestPeriodScenario.name}" tem o maior prazo (${longestPeriodScenario.period} meses). `;
        
        // Verificar se o cenário com menor prazo atinge o objetivo
        const shortestPeriodFinalValue = shortestPeriodScenario.resultAtual.valoresMensais[shortestPeriodScenario.period].valorLiquido;
        const shortestPeriodGoalValue = shortestPeriodScenario.resultAtual.valoresMensais[shortestPeriodScenario.period].objetivoCorrigido;
        
        if (shortestPeriodFinalValue >= shortestPeriodGoalValue) {
          analysis += `O cenário com menor prazo consegue atingir o objetivo, o que pode ser vantajoso se a prioridade for realizar o objetivo mais rapidamente.</p>`;
        } else {
          analysis += `O cenário com menor prazo não consegue atingir o objetivo, indicando que pode ser necessário um prazo maior ou ajustes em outros parâmetros.</p>`;
        }
      }
      
      // Análise de esforço financeiro (aporte mensal)
      const sortedByContribution = [...scenarios].sort((a, b) => a.currentContribution - b.currentContribution);
      const lowestContributionScenario = sortedByContribution[0];
      const highestContributionScenario = sortedByContribution[sortedByContribution.length - 1];
      
      analysis += `<p><strong>Perspectiva de Esforço Financeiro:</strong> O "${lowestContributionScenario.name}" requer o menor aporte mensal (R$ ${formatMoney(lowestContributionScenario.currentContribution)}), enquanto "${highestContributionScenario.name}" requer o maior aporte mensal (R$ ${formatMoney(highestContributionScenario.currentContribution)}). `;
      
      // Verificar se o cenário com menor aporte atinge o objetivo
      const lowestContributionFinalValue = lowestContributionScenario.resultAtual.valoresMensais[lowestContributionScenario.period].valorLiquido;
      const lowestContributionGoalValue = lowestContributionScenario.resultAtual.valoresMensais[lowestContributionScenario.period].objetivoCorrigido;
      
      if (lowestContributionFinalValue >= lowestContributionGoalValue) {
        analysis += `O cenário com menor aporte mensal consegue atingir o objetivo, o que pode ser vantajoso se a prioridade for reduzir o impacto no orçamento mensal.</p>`;
      } else {
        analysis += `O cenário com menor aporte mensal não consegue atingir o objetivo, indicando que pode ser necessário um esforço financeiro maior ou ajustes em outros parâmetros.</p>`;
      }
      
      // Análise de valor inicial
      const sortedByInitialValue = [...scenarios].sort((a, b) => a.currentSavings - b.currentSavings);
      const lowestInitialValueScenario = sortedByInitialValue[0];
      const highestInitialValueScenario = sortedByInitialValue[sortedByInitialValue.length - 1];
      
      if (lowestInitialValueScenario.currentSavings !== highestInitialValueScenario.currentSavings) {
        analysis += `<p><strong>Perspectiva de Valor Inicial:</strong> O "${lowestInitialValueScenario.name}" começa com o menor valor guardado (R$ ${formatMoney(lowestInitialValueScenario.currentSavings)}), enquanto "${highestInitialValueScenario.name}" começa com o maior valor guardado (R$ ${formatMoney(highestInitialValueScenario.currentSavings)}). `;
        
        // Verificar se o cenário com menor valor inicial atinge o objetivo
        const lowestInitialValueFinalValue = lowestInitialValueScenario.resultAtual.valoresMensais[lowestInitialValueScenario.period].valorLiquido;
        const lowestInitialValueGoalValue = lowestInitialValueScenario.resultAtual.valoresMensais[lowestInitialValueScenario.period].objetivoCorrigido;
        
        if (lowestInitialValueFinalValue >= lowestInitialValueGoalValue) {
          analysis += `O cenário com menor valor inicial consegue atingir o objetivo, o que pode ser vantajoso se a prioridade for começar com menos recursos.</p>`;
        } else {
          analysis += `O cenário com menor valor inicial não consegue atingir o objetivo, indicando que pode ser necessário um valor inicial maior ou ajustes em outros parâmetros.</p>`;
        }
      }
      
      generalAnalysisText.innerHTML = analysis;
    }

    function calculateSavings() {
      // Armazenar o texto do objetivo para uso posterior
      goalDescriptionText = document.getElementById('goalDescription').value;
      
      // Resetar os gráficos antes de desenhar novos
      const chartUnico = Chart.getChart("chartUnico");
      if (chartUnico) chartUnico.destroy();
      const chartIdeal = Chart.getChart("chartIdeal");
      if (chartIdeal) chartIdeal.destroy();
      const chartAtual = Chart.getChart("chartAtual");
      if (chartAtual) chartAtual.destroy();
      const chartRentabilidade = Chart.getChart("chartRentabilidade");
      if (chartRentabilidade) chartRentabilidade.destroy();
      
      const goalDescription = document.getElementById('goalDescription').value;
      const goal = parseCurrency(document.getElementById('goal').value);
      const rate = parsePercentage(document.getElementById('rate').value);
      const rateType = document.getElementById('rateType').value;
      const knowsTax = document.getElementById('knowsTax').value;
      const tax = knowsTax === 'yes' ? parsePercentage(document.getElementById('tax').value) : 0.15;
      const knowsInflation = document.getElementById('knowsInflation').value;
      const inflation = knowsInflation === 'yes' ? parsePercentage(document.getElementById('inflation').value) : 0.05;
      const period = parseInt(document.getElementById('period').value);
      const currentSavings = parseCurrency(document.getElementById('currentSavings').value);
      const currentContribution = parseCurrency(document.getElementById('currentContribution').value);

      const monthlyRate = rateType === 'annual' ? Math.pow(1 + rate, 1 / 12) - 1 : rate;
      
      // Calcular o objetivo corrigido pela inflação (anualmente)
      let inflatedGoal = goal;
      const yearsCount = Math.floor(period / 12);
      
      // Aplicar inflação para anos completos
      for (let i = 0; i < yearsCount; i++) {
        inflatedGoal *= (1 + inflation);
      }

      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<p><strong>Reajuste pela Inflação:</strong><br>Valor atual do objetivo: R$ ${formatMoney(goal)}<br>Valor corrigido pela inflação (${(inflation * 100).toFixed(2).replace('.', ',')}%) em ${period} meses: R$ ${formatMoney(inflatedGoal)}</p>`;

      // Cálculo do investimento único necessário
      // Fórmula: PV = VF / (1 + i)^n
      // Onde VF é o valor futuro (objetivo corrigido), i é a taxa, n é o período
      // Considerando o imposto: PV = VF / [(1 + i)^n - imposto * ((1 + i)^n - 1)]
      
      const taxFactor = (1 + monthlyRate) ** period - tax * ((1 + monthlyRate) ** period - 1);
      const investmentNeeded = inflatedGoal / taxFactor;
      
      // Comparação com o valor já guardado
      const difference = investmentNeeded - currentSavings;
      const comparisonText = difference > 0 
        ? `Este valor é <strong>R$ ${formatMoney(difference)} maior</strong> do que o valor que você já tem guardado.`
        : `Este valor é <strong>R$ ${formatMoney(Math.abs(difference))} menor</strong> do que o valor que você já tem guardado.`;
      
      // Cálculo do valor bruto e líquido para o investimento único
      const resultUnico = calculateCompoundInterest(investmentNeeded, 0, monthlyRate, period, tax, goal, inflation);
      
      // Extrair dados para o gráfico (começando do mês 1)
      const brutoUnico = resultUnico.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoUnico = resultUnico.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoUnico = resultUnico.valoresMensais.slice(1).map(m => m.totalInvestido);
      
      resultDiv.innerHTML += `<p><strong>Investimento Único Necessário:</strong><br>Para atingir seu objetivo no prazo desejado, sem poupar mensalmente, você precisaria investir <strong>R$ ${formatMoney(investmentNeeded)}</strong> hoje.<br>${comparisonText}</p>`;
      
      // Mostrar o container do gráfico
      document.getElementById('chartUnicoContainer').style.display = 'block';
      
      // Preencher a tabela de dados
      fillDataTable('tableUnico', resultUnico.valoresMensais, goal, inflation);
      
      // Desenhar o gráfico do investimento único
      drawChart(document.getElementById('chartUnico').getContext('2d'), brutoUnico, liquidoUnico, investidoUnico, '#6f42c1', '#9f75e5', '#4b2882');

      // Cálculo do plano ideal (quanto poupar mensalmente)
      // Fórmula: A = (VF - PV * (1 + i)^n) / ((1 + i)^n - 1) * i
      // Onde A é o aporte mensal, VF é o valor futuro (objetivo), PV é o valor presente (valor já guardado)
      
      let low = 0, high = inflatedGoal, Y = 0;
      let resultIdeal;
      
      for (let i = 0; i < 100; i++) {
        Y = (low + high) / 2;
        resultIdeal = calculateCompoundInterest(currentSavings, Y, monthlyRate, period, tax, goal, inflation);
        
        const valorLiquidoFinal = resultIdeal.valoresMensais[period].valorLiquido;
        const objetivoFinal = resultIdeal.valoresMensais[period].objetivoCorrigido;
        
        if (Math.abs(valorLiquidoFinal - objetivoFinal) < 0.01) break;
        if (valorLiquidoFinal > objetivoFinal) high = Y;
        else low = Y;
      }
      
      // Extrair dados para o gráfico (começando do mês 1)
      const brutoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoIdeal = resultIdeal.valoresMensais.slice(1).map(m => m.totalInvestido);

      resultDiv.innerHTML += `<p><strong>Plano Ideal:</strong><br>Você precisará poupar R$ ${formatMoney(Y)} por mês para atingir seu objetivo corrigido.</p>`;

      // Mostrar o container do gráfico
      document.getElementById('chartIdealContainer').style.display = 'block';
      
      // Preencher a tabela de dados
      fillDataTable('tableIdeal', resultIdeal.valoresMensais, goal, inflation);
      
      // Desenhar o gráfico do plano ideal
      drawChart(document.getElementById('chartIdeal').getContext('2d'), brutoIdeal, liquidoIdeal, investidoIdeal, '#28a745', '#218838', '#046c4e');

      // Cálculo com a poupança atual
      const resultAtual = calculateCompoundInterest(currentSavings, currentContribution, monthlyRate, period, tax, goal, inflation);
      
      // Extrair dados para o gráfico (começando do mês 1)
      const brutoAtual = resultAtual.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoAtual = resultAtual.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoAtual = resultAtual.valoresMensais.slice(1).map(m => m.totalInvestido);
      
      // Verificar se o valor final atinge o objetivo
      const valorFinalAtual = resultAtual.valoresMensais[period].valorLiquido;
      const objetivoFinalAtual = resultAtual.valoresMensais[period].objetivoCorrigido;
      const diferencaAtual = valorFinalAtual - objetivoFinalAtual;
      
      if (diferencaAtual >= 0) {
        resultDiv.innerHTML += `<p><strong>Plano Atual:</strong><br>Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você <strong>conseguirá</strong> atingir seu objetivo no prazo desejado, com um superávit de R$ ${formatMoney(diferencaAtual)}.</p>`;
      } else {
        resultDiv.innerHTML += `<p><strong>Plano Atual:</strong><br>Com seu aporte mensal atual de R$ ${formatMoney(currentContribution)}, você <strong>não conseguirá</strong> atingir seu objetivo no prazo desejado, ficando com um déficit de R$ ${formatMoney(Math.abs(diferencaAtual))}.</p>`;
      }
      
      // Mostrar o container do gráfico
      document.getElementById('chartAtualContainer').style.display = 'block';
      
      // Preencher a tabela de dados
      fillDataTable('tableAtual', resultAtual.valoresMensais, goal, inflation);
      
      // Desenhar o gráfico do plano atual
      drawChart(document.getElementById('chartAtual').getContext('2d'), brutoAtual, liquidoAtual, investidoAtual, '#d4af37', '#f5e2a9', '#b38e2e');

      // Cálculo da rentabilidade necessária
      const requiredRateResult = calculateRequiredRate(goal, currentSavings, currentContribution, period, tax, inflation);
      const requiredAnnualRate = requiredRateResult.annualRate;
      
      // Extrair dados para o gráfico (começando do mês 1)
      const brutoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.totalAcumulado);
      const liquidoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.valorLiquido);
      const investidoRentabilidade = requiredRateResult.valoresMensais.slice(1).map(m => m.totalInvestido);
      
      resultDiv.innerHTML += `<p><strong>Rentabilidade Necessária:</strong><br>Para atingir seu objetivo no prazo desejado com o aporte mensal atual, você precisaria de uma rentabilidade de <strong>${(requiredAnnualRate * 100).toFixed(2).replace('.', ',')}% ao ano</strong>.</p>`;
      
      // Mostrar o container do gráfico
      document.getElementById('chartRentabilidadeContainer').style.display = 'block';
      
      // Preencher a tabela de dados
      fillDataTable('tableRentabilidade', requiredRateResult.valoresMensais, goal, inflation);
      
      // Desenhar o gráfico da rentabilidade necessária
      drawChart(document.getElementById('chartRentabilidade').getContext('2d'), brutoRentabilidade, liquidoRentabilidade, investidoRentabilidade, '#dc3545', '#e35d6a', '#b02a37');

      // Armazenar o texto do resultado para uso posterior
      resultText = resultDiv.innerText;
      
      // Gerar análise automatizada
      generateRecommendation(goalDescription, goal, currentSavings, currentContribution, Y, period, requiredAnnualRate, rate);
      
      // Mostrar o botão de salvar cenário
      document.getElementById('saveScenarioButton').style.display = 'block';
      
      // Se não for o primeiro cenário, mostrar a análise geral se houver mais de um cenário
      if (!isFirstScenario && scenarios.length > 0) {
        // Adicionar automaticamente o cenário atual
        addCurrentScenario();
        
        // Mostrar a análise geral
        document.getElementById('generalAnalysis').style.display = 'block';
      }
    }

    // Inicializar os campos de imposto e inflação
    document.addEventListener('DOMContentLoaded', function() {
      toggleTaxInput('tax', '15,00 %');
      toggleTaxInput('inflation', '5,00 %');
    });
  </script>
</body>
</html>
