<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Financeiro V9 - Registro de Gastos Reais</title> <!-- Versão atualizada -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002d26;
      color: white;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    .saldo-positivo {
         color: #1976d2; /* Azul não brilhante */
    }
    .saldo-negativo {
        color: #c62828; /* Vermelho não brilhante */
    }
    h1 {
      margin: 0 0 20px;
    }
    .cartao-laranja {
        color: #f57c00; /* Laranja não brilhante */
    }
    .conta-amarela {
        color: #fbc02d; /* Amarelo não brilhante */
    }
    .container-principal {
      display: flex;
      width: 400%; /* Ajustado para 4 seções: Lançamentos, Resumo, Mensagens, Gastos Reais */
      transition: transform 0.5s ease;
    }

    .container-resumo-ativo {
      transform: translateX(-25%); /* Mostra Resumo */
    }

    .container-mensagens-ativo {
      transform: translateX(-50%); /* Mostra Mensagens */
    }
    
    .container-gastos-reais-ativo {
      transform: translateX(-75%); /* Mostra Gastos Reais */
    }

    /* Seções */
    .secao-lancamentos,
    .secao-resumo,
    .secao-mensagens,
    .secao-gastos-reais { /* Nova seção */
      width: 25%; /* Cada seção ocupa 1/4 */
      padding: 0 20px;
      box-sizing: border-box;
    }

    /* Estilos para o Modal */
    .modal {
      display: none; /* Escondido por padrão */
      position: fixed; 
      z-index: 100; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      padding-top: 60px;
    }

    .modal-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 10px;
      position: relative;
    }

    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #ffd700;
      text-decoration: none;
      cursor: pointer;
    }

    /* Formulário dentro do Modal */
    .form-section-modal {
      padding: 0; 
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .botoes-formulario {
      grid-column: 1 / -1; 
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .table-container {
      background-color: #014034;
      border-radius: 10px;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #006a56;
      text-align: center;
    }

    th {
      background-color: #006a56;
      color: #ffd700;
      position: sticky;
      top: 0;
      z-index: 5; 
    }
    
    th.descricao-header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        padding-right: 5px; 
    }

    .botao-abrir-modal {
        background-color: #ffd700;
        color: #002d26;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 18px;
        font-weight: bold;
        line-height: 24px; 
        text-align: center;
        cursor: pointer;
        margin-left: 10px;
        padding: 0;
    }

    .botao-abrir-modal:hover {
        background-color: #ffc400;
    }

    .receita { color: #4caf50; }
    .fixa { color: #f44336; }
    .variavel { color: #ff9800; }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }
    .gasto-real { background-color: rgba(0, 150, 136, 0.2); } /* Nova classe para gastos reais */
    .gasto-real-cartao { background-color: rgba(255, 152, 0, 0.2); } /* Nova classe para gastos reais no cartão */

    .botao-lancar {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-lancar:hover {
      background-color: #ffc400;
    }

    /* Botões Fixos */
    .botao-fixo {
      position: fixed;
      z-index: 50;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: opacity 0.3s ease, visibility 0.3s ease;
      opacity: 1;
      visibility: visible;
    }

    .botao-resumo-fixo {
      top: 20px;
      right: 20px;
      background-color: #2196F3;
      color: white;
    }
    
    .botao-mensagens-fixo {
      top: 60px;
      right: 20px;
      background-color: #673ab7;
      color: white;
    }
    
    .botao-gastos-reais-fixo {
      top: 100px;
      right: 20px;
      background-color: #009688;
      color: white;
    }
    
    /* Esconde os botões fixos quando a seção correspondente está ativa */
    .container-resumo-ativo ~ .botao-resumo-fixo,
    .container-mensagens-ativo ~ .botao-mensagens-fixo,
    .container-gastos-reais-ativo ~ .botao-gastos-reais-fixo,
    /* Esconde o botão de mensagens quando o resumo está ativo */
    .container-resumo-ativo ~ .botao-mensagens-fixo,
    .container-resumo-ativo ~ .botao-gastos-reais-fixo,
    /* Esconde o botão de resumo quando as mensagens estão ativas */
    .container-mensagens-ativo ~ .botao-resumo-fixo,
    .container-mensagens-ativo ~ .botao-gastos-reais-fixo,
    /* Esconde os botões quando os gastos reais estão ativos */
    .container-gastos-reais-ativo ~ .botao-resumo-fixo,
    .container-gastos-reais-ativo ~ .botao-mensagens-fixo {
        opacity: 0;
        visibility: hidden;
    }

    .botao-resumo-fixo:hover {
      background-color: #0b7dda;
    }
    
    .botao-mensagens-fixo:hover {
      background-color: #5e35b1;
    }
    
    .botao-gastos-reais-fixo:hover {
      background-color: #00796b;
    }

    .botao-voltar {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .botao-voltar:hover {
      background-color: #e68a00;
    }

    .delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }
    
    .hidden-id {
      display: none;
    }

    .resumo-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }
    
    /* Congelar a primeira coluna (Categoria) - Tabela Resumo */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaResumo thead tr th:first-child {
      background-color: #006a56; 
      z-index: 20; 
    }
    #tabelaResumo tbody tr td:first-child {
      font-weight: bold; 
    }

    /* Congelar a coluna Descrição - Tabela Lançamentos */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: #006a56; 
      z-index: 20;
    }
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; 
    }
    
    /* Congelar a coluna Descrição - Tabela Gastos Reais */
    #tabelaGastosReais thead tr th:nth-child(2),
    #tabelaGastosReais tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaGastosReais thead tr th:nth-child(2) {
      background-color: #006a56; 
      z-index: 20;
    }
    #tabelaGastosReais tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; 
    }

    /* Estilo para células editáveis */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: #014034;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 14px;
      box-sizing: border-box;
    }
    .edit-input:focus {
      outline: 2px solid #ffd700;
    }
    
    /* Estilos para os gráficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .grafico-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      width: calc(50% - 40px);
      min-width: 400px;
      box-sizing: border-box;
    }
    .grafico-titulo {
      text-align: center;
      margin-bottom: 15px;
      color: #ffd700;
      font-size: 16px;
    }
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    .seletor-mes {
      text-align: center;
      margin-bottom: 20px;
    }
    .seletor-mes select {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
      font-weight: bold;
    }
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      width: 100%;
    }
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 14px;
      width: 100%;
    }
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .valor-legenda {
      margin-left: 5px;
      font-weight: bold;
    }
    .descricao-legenda {
      min-width: 120px;
    }
    
    /* Linha de espaçamento na tabela de resumo */
    .spacer-row td {
        height: 10px; /* Altura do espaço */
        padding: 0;
        border: none; /* Remove bordas */
        background-color: #002d26; /* Cor de fundo do corpo */
    }

    /* Estilos para subcategorias e cartões */
    .categoria-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .categoria-select {
      flex: 1;
    }

    .botao-gerenciar {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .botao-gerenciar:hover {
      background-color: #45a049;
    }

    /* Campo de cartão inicialmente oculto, mas com transição suave */
    .cartao-container {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .cartao-container.show {
      display: block;
      opacity: 1;
    }

    /* Modal de gerenciamento genérico */
    .modal-gerenciamento {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      padding-top: 60px;
    }

    .modal-gerenciamento-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 60%;
      max-width: 500px;
      border-radius: 10px;
      position: relative;
    }

    .lista-gerenciamento {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .item-gerenciamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      background-color: #006a56;
      border-radius: 5px;
    }

    .item-gerenciamento-info {
      display: flex;
      flex-direction: column;
    }

    .item-gerenciamento-nome {
      font-weight: bold;
    }

    .item-gerenciamento-detalhe {
      font-size: 12px;
      color: #b0bec5;
    }

    .botoes-item-gerenciamento button {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }

    .botoes-item-gerenciamento button.excluir {
      background-color: #c62828;
    }

    .botoes-item-gerenciamento button:hover {
      opacity: 0.8;
    }

    .novo-item-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Para responsividade */
    }

    .novo-item-input {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
      min-width: 150px; /* Largura mínima */
    }

    .novo-item-input.dia {
      flex: 0 0 80px; /* Largura fixa para dia */
    }

    .botao-adicionar-item {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-adicionar-item:hover {
      background-color: #45a049;
    }

    /* Cores aleatórias para subcategorias */
    .subcategoria-cor-1 { color: #e91e63; }
    .subcategoria-cor-2 { color: #9c27b0; }
    .subcategoria-cor-3 { color: #673ab7; }
    .subcategoria-cor-4 { color: #3f51b5; }
    .subcategoria-cor-5 { color: #2196f3; }
    .subcategoria-cor-6 { color: #00bcd4; }
    .subcategoria-cor-7 { color: #009688; }
    .subcategoria-cor-8 { color: #8bc34a; }
    .subcategoria-cor-9 { color: #cddc39; }
    .subcategoria-cor-10 { color: #ffeb3b; }
    .subcategoria-cor-11 { color: #ff5722; }
    .subcategoria-cor-12 { color: #795548; }

    /* Linha clicável na tabela principal */
    #tabelaLancamentos tbody tr {
      cursor: pointer;
    }
    #tabelaLancamentos tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Linha clicável na tabela de resumo */
    #tabelaResumo tbody tr {
      cursor: pointer;
    }
    #tabelaResumo tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Linha clicável na tabela de gastos reais */
    #tabelaGastosReais tbody tr {
      cursor: pointer;
    }
    #tabelaGastosReais tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Modal de detalhamento */
    .modal-detalhamento {
      display: none;
      position: fixed;
      z-index: 150;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      padding-top: 60px;
    }

    .modal-detalhamento-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 70%;
      max-width: 900px;
      border-radius: 10px;
      position: relative;
    }

    .lista-detalhamento {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .item-detalhamento {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      background-color: #006a56;
      border-radius: 5px;
    }

    .item-detalhamento-info {
      flex: 1;
      text-align: left;
    }

    .item-detalhamento-valores {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    .item-detalhamento-valor {
      font-weight: bold;
      font-size: 16px;
    }

    .item-detalhamento-media {
      font-size: 14px;
      color: #b0bec5;
    }

    .item-detalhamento-percentual {
      color: #ffd700;
      font-size: 14px;
    }

    /* Destaque para campo de cartão quando obrigatório */
    .cartao-container.obrigatorio {
      border: 2px solid #ffd700;
      padding: 10px;
      border-radius: 5px;
      background-color: rgba(255, 215, 0, 0.1);
    }
  
    /* MOD: Estilo para dia de fechamento editável */
    .dia-fechamento-editavel {
      cursor: pointer;
      text-decoration: underline;
      color: #ffd700; /* Cor de destaque */
      font-weight: bold;
    }
    .dia-fechamento-editavel:hover {
      color: #ffec8b; /* Cor mais clara no hover */
    }
    
    /* Estilos para a seção de Gastos Reais */
    .filtros-gastos-reais {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      background-color: #014034;
      padding: 15px;
      border-radius: 10px;
    }
    
    .filtro-grupo {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    
    .filtro-grupo label {
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .filtro-grupo select,
    .filtro-grupo input {
      padding: 8px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
    }
    
    .botao-filtrar {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      align-self: flex-end;
      margin-top: auto;
    }
    
    .botao-filtrar:hover {
      background-color: #45a049;
    }
    
    .indicador-fatura {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .fatura-atual {
      background-color: #f57c00;
      color: white;
    }
    
    .fatura-fechada {
      background-color: #4caf50;
      color: white;
    }
    
    .fatura-futura {
      background-color: #2196f3;
      color: white;
    }
    
    /* Comparação planejado vs real */
    .comparacao-valor {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .valor-planejado {
      font-size: 12px;
      color: #b0bec5;
    }
    
    .valor-real {
      font-weight: bold;
    }
    
    .variacao-positiva {
      color: #4caf50;
    }
    
    .variacao-negativa {
      color: #f44336;
    }
    
    /* Resumo de faturas */
    .resumo-faturas {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }
    
    .card-fatura {
      background-color: #014034;
      border-radius: 10px;
      padding: 15px;
      flex: 1;
      min-width: 250px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .card-fatura-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid #006a56;
      padding-bottom: 10px;
    }
    
    .card-fatura-titulo {
      font-weight: bold;
      color: #ffd700;
    }
    
    .card-fatura-valor {
      font-weight: bold;
      font-size: 18px;
    }
    
    .card-fatura-detalhes {
      font-size: 14px;
      color: #b0bec5;
    }
    
    .card-fatura-itens {
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .card-fatura-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .card-fatura-item-descricao {
      flex: 1;
    }
    
    .card-fatura-item-valor {
      font-weight: bold;
      margin-left: 10px;
    }
    
    /* Estilo para o gráfico de comparação */
    .grafico-comparacao {
      height: 400px;
    }
</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<body>

  <h1>Controle Financeiro</h1>
  
  <!-- Container Principal (Lançamentos, Resumo, Mensagens e Gastos Reais) -->
  <div class="container-principal" id="containerPrincipal">
    <!-- Seção da Tabela de Lançamentos -->
    <div class="secao-lancamentos">
      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModal" class="botao-abrir-modal" onclick="abrirModal()">+</button>
              </th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lançamentos serão inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seção do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th> <!-- Nova coluna Média -->
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo será inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Seção dos Gráficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o mês: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="-2">Médias Mensais</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas e Poupança</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Relação às Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>
        <!-- New Graph 3: Credit Cards -->
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas por Cartão de Crédito</div>
          <div class="grafico">
            <canvas id="graficoCartoesCredito"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaCartoesCredito"></div>
        </div>
        <!-- New Graph 4: Subcategories -->
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas por Subcategoria</div>
          <div class="grafico">
            <canvas id="graficoSubcategorias"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaSubcategorias"></div>
        </div>
      </div>
      <!-- Nova Seção de Insights -->
      <div id="insightsContainer" style="margin-top: 30px; padding: 20px; background-color: #014034; border-radius: 10px;">
        <div class="resumo-titulo">Insights Financeiros</div>
        <div id="insightsContent" style="font-size: 14px; line-height: 1.6;">
          <p>Insights serão gerados aqui...</p>
        </div>
      </div>
    </div> <!-- Fim secao-resumo -->

    <!-- Seção de Mensagens -->
    <div class="secao-mensagens">
      <button class="botao-voltar" onclick="mostrarResumo()">← Voltar para Resumo</button>
      <div class="resumo-titulo">Mensagens e Alertas</div>

      <div class="seletor-data-mensagens" style="text-align: center; margin-bottom: 20px;">
        <label for="dataSimulacao">Simular para data:</label>
        <input type="date" id="dataSimulacao" style="padding: 8px; border-radius: 5px; border: none; background-color: #006a56; color: white; margin-right: 10px;">
        <button class="botao-lancar" style="padding: 8px 15px;" onclick="gerarMensagens()">Gerar Mensagens</button>
        <button class="botao-lancar" style="padding: 8px 15px; background-color: #2196F3; margin-left: 5px;" onclick="gerarMensagensHoje()">Usar Hoje</button>
      </div>

      <div id="mensagensContainer" style="margin-top: 20px;">
        <div class="mensagem-card" style="background-color: #014034; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
          <h3 style="color: #ffd700; margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos do Dia</h3>
          <div id="mensagensDia" style="font-size: 14px; line-height: 1.5;"><p>Selecione uma data e clique em 'Gerar Mensagens'.</p></div>
        </div>
        <div class="mensagem-card" style="background-color: #014034; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
          <h3 style="color: #ffd700; margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos da Semana</h3>
          <div id="mensagensSemana" style="font-size: 14px; line-height: 1.5;"></div>
        </div>
        <div class="mensagem-card" style="background-color: #014034; border-radius: 10px; padding: 15px;">
          <h3 style="color: #ffd700; margin-top: 0; margin-bottom: 10px; font-size: 16px;">Eventos do Mês</h3>
          <div id="mensagensMes" style="font-size: 14px; line-height: 1.5;"></div>
        </div>
      </div>
    </div>
    <!-- Fim da Seção de Mensagens -->
    
    <!-- Nova Seção de Gastos Reais -->
    <div class="secao-gastos-reais">
      <button class="botao-voltar" onclick="mostrarMensagens()">← Voltar para Mensagens</button>
      <div class="resumo-titulo">Registro de Gastos Reais</div>
      
      <!-- Filtros para Gastos Reais -->
      <div class="filtros-gastos-reais">
        <div class="filtro-grupo">
          <label for="filtroMes">Mês:</label>
          <select id="filtroMes">
            <option value="todos">Todos</option>
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroFormaPagamento">Forma de Pagamento:</label>
          <select id="filtroFormaPagamento">
            <option value="todos">Todos</option>
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroCartao">Cartão:</label>
          <select id="filtroCartao">
            <option value="todos">Todos</option>
            <!-- Opções de cartões serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <div class="filtro-grupo">
          <label for="filtroSubcategoria">Subcategoria:</label>
          <select id="filtroSubcategoria">
            <option value="todos">Todos</option>
            <!-- Opções de subcategorias serão preenchidas dinamicamente -->
          </select>
        </div>
        
        <button class="botao-filtrar" onclick="filtrarGastosReais()">Filtrar</button>
      </div>
      
      <!-- Tabela de Gastos Reais -->
      <div class="table-container">
        <table id="tabelaGastosReais">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModalGastoReal" class="botao-abrir-modal" onclick="abrirModalGastoReal()">+</button>
              </th>
              <th>Data</th>
              <th>Valor</th>
              <th>Forma de Pagamento</th>
              <th>Cartão</th>
              <th>Fatura</th>
              <th>Subcategoria</th>
              <th>Observação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="gastosReaisBody">
            <!-- Gastos reais serão inseridos aqui -->
          </tbody>
        </table>
      </div>
      
      <!-- Resumo de Faturas -->
      <div class="resumo-titulo" style="margin-top: 30px;">Resumo de Faturas</div>
      <div class="resumo-faturas" id="resumoFaturas">
        <!-- Cards de faturas serão inseridos aqui -->
      </div>
      
      <!-- Gráfico de Comparação Planejado vs Real -->
      <div class="resumo-titulo" style="margin-top: 30px;">Comparação: Planejado vs Real</div>
      <div class="seletor-mes">
        <label for="mesComparacao">Selecione o mês: </label>
        <select id="mesComparacao" onchange="atualizarGraficoComparacao()">
          <option value="-1">Total Anual</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>
      <div class="grafico-card" style="width: 100%; min-width: 100%;">
        <div class="grafico-titulo">Planejado vs Real</div>
        <div class="grafico grafico-comparacao">
          <canvas id="graficoComparacao"></canvas>
        </div>
      </div>
    </div>
    <!-- Fim da Seção de Gastos Reais -->
  </div>
  
  <!-- Botões Fixos -->
  <button class="botao-fixo botao-resumo-fixo" onclick="mostrarResumo()">Ver Resumo e Análises</button>
  <button class="botao-fixo botao-mensagens-fixo" onclick="mostrarMensagens()">Ver Mensagens</button>
  <button class="botao-fixo botao-gastos-reais-fixo" onclick="mostrarGastosReais()">Ver Gastos Reais</button>

  <!-- Modal do Formulário de Adição de Lançamento -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2>Novo Lançamento</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento" onchange="toggleCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoria">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoria" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainer">
            <label for="cartaoCredito">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCredito" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lançar Item</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Formulário de Edição de Lançamento -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
      <h2>Editar Lançamento</h2>
      <input type="hidden" id="editLancamentoId">
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricaoEdicao">Descrição:</label>
          <input type="text" id="descricaoEdicao" placeholder="Ex: Salário, Luz" />

          <label for="valorEdicao">Valor (R$):</label>
          <input type="text" id="valorEdicao" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamentoEdicao">Tipo de Lançamento:</label>
          <select id="tipoLancamentoEdicao">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="formaPagamentoEdicao" onchange="toggleCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <label for="subcategoriaEdicao">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="subcategoriaEdicao" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>

          <!-- Campo Cartão Edição (inicialmente oculto) -->
          <div class="cartao-container" id="cartaoContainerEdicao">
            <label for="cartaoCreditoEdicao">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="cartaoCreditoEdicao" class="categoria-select">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label for="frequenciaValorEdicao">A cada:</label>
          <input type="number" id="frequenciaValorEdicao" min="1" value="1" />

          <label for="frequenciaTipoEdicao">Unidade de Frequência:</label>
          <select id="frequenciaTipoEdicao">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicialEdicao">Data Inicial:</label>
          <input type="date" id="dataInicialEdicao" />

          <label for="dataFinalEdicao">Data Final:</label>
          <input type="date" id="dataFinalEdicao" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="salvarEdicao()">Salvar Edição</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Novo Modal para Registro de Gasto Real -->
  <div id="modalGastoReal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalGastoReal()">&times;</span>
      <h2>Registrar Gasto Real</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="gastoRealDescricao">Descrição:</label>
          <input type="text" id="gastoRealDescricao" placeholder="Ex: Supermercado, Restaurante" />

          <label for="gastoRealValor">Valor (R$):</label>
          <input type="text" id="gastoRealValor" placeholder="Ex: 150,75" />
          
          <label for="gastoRealData">Data:</label>
          <input type="date" id="gastoRealData" />
          
          <label for="gastoRealFormaPagamento">Forma de Pagamento:</label>
          <select id="gastoRealFormaPagamento" onchange="toggleGastoRealCartaoContainer()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <!-- Campo Cartão para Gasto Real (inicialmente oculto) -->
          <div class="cartao-container" id="gastoRealCartaoContainer">
            <label for="gastoRealCartaoCredito">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="gastoRealCartaoCredito" class="categoria-select" onchange="atualizarFaturaGastoReal()">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
            
            <div id="gastoRealInfoFatura" style="margin-top: 10px; font-size: 14px; color: #b0bec5;">
              <!-- Informações da fatura serão exibidas aqui -->
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="gastoRealSubcategoria">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="gastoRealSubcategoria" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>
          
          <label for="gastoRealLancamento">Lançamento Relacionado (opcional):</label>
          <select id="gastoRealLancamento">
            <option value="">Nenhum</option>
            <!-- Opções de lançamentos serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealObservacao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="registrarGastoReal()">Registrar Gasto</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Edição de Gasto Real -->
  <div id="modalEdicaoGastoReal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalEdicaoGastoReal()">&times;</span>
      <h2>Editar Gasto Real</h2>
      <input type="hidden" id="editGastoRealId">
      <div class="form-section-modal">
        <div class="form-group">
          <label for="gastoRealDescricaoEdicao">Descrição:</label>
          <input type="text" id="gastoRealDescricaoEdicao" placeholder="Ex: Supermercado, Restaurante" />

          <label for="gastoRealValorEdicao">Valor (R$):</label>
          <input type="text" id="gastoRealValorEdicao" placeholder="Ex: 150,75" />
          
          <label for="gastoRealDataEdicao">Data:</label>
          <input type="date" id="gastoRealDataEdicao" />
          
          <label for="gastoRealFormaPagamentoEdicao">Forma de Pagamento:</label>
          <select id="gastoRealFormaPagamentoEdicao" onchange="toggleGastoRealCartaoContainerEdicao()">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

          <!-- Campo Cartão para Gasto Real Edição (inicialmente oculto) -->
          <div class="cartao-container" id="gastoRealCartaoContainerEdicao">
            <label for="gastoRealCartaoCreditoEdicao">Cartão de Crédito:</label>
            <div class="categoria-container">
              <select id="gastoRealCartaoCreditoEdicao" class="categoria-select" onchange="atualizarFaturaGastoRealEdicao()">
                <option value="">Selecione o cartão</option>
              </select>
              <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('cartoes')">Gerenciar Cartões</button>
            </div>
            
            <div id="gastoRealInfoFaturaEdicao" style="margin-top: 10px; font-size: 14px; color: #b0bec5;">
              <!-- Informações da fatura serão exibidas aqui -->
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="gastoRealSubcategoriaEdicao">Subcategoria (opcional):</label>
          <div class="categoria-container">
            <select id="gastoRealSubcategoriaEdicao" class="categoria-select">
              <option value="">Nenhuma</option>
            </select>
            <button type="button" class="botao-gerenciar" onclick="abrirModalGerenciamento('subcategorias')">Gerenciar</button>
          </div>
          
          <label for="gastoRealLancamentoEdicao">Lançamento Relacionado (opcional):</label>
          <select id="gastoRealLancamentoEdicao">
            <option value="">Nenhum</option>
            <!-- Opções de lançamentos serão preenchidas dinamicamente -->
          </select>
          
          <label for="gastoRealObservacaoEdicao">Observação (opcional):</label>
          <input type="text" id="gastoRealObservacaoEdicao" placeholder="Observações adicionais" />
        </div>
        
        <div class="botoes-formulario">
          <button class="botao-lancar" onclick="salvarEdicaoGastoReal()">Salvar Edição</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento Genérico (Subcategorias e Cartões) -->
  <div id="modalGerenciamento" class="modal-gerenciamento">
    <div class="modal-gerenciamento-content">
      <span class="close-button" onclick="fecharModalGerenciamento()">&times;</span>
      <h2 id="tituloModalGerenciamento">Gerenciar</h2>
      
      <div id="formNovoItem">
        <!-- Formulário para adicionar novo item (subcategoria ou cartão) -->
      </div>
      
      <div class="lista-gerenciamento" id="listaGerenciamento">
        <!-- Lista de itens será inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalGerenciamento()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhamento -->
  <div id="modalDetalhamento" class="modal-detalhamento">
    <div class="modal-detalhamento-content">
      <span class="close-button" onclick="fecharModalDetalhamento()">&times;</span>
      <h2 id="tituloDetalhamento">Detalhamento da Categoria</h2>
      
      <div class="lista-detalhamento" id="listaDetalhamento">
        <!-- Lista de itens será inserida aqui -->
      </div>
      
      <div style="text-align: right;">
        <button class="botao-lancar" onclick="fecharModalDetalhamento()">Fechar</button>
      </div>
    </div>
  </div>

<script>
    // Variáveis globais
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let graficoCartoesCreditoInstance = null; // Nova variável para o gráfico de cartões
    let graficoSubcategoriasInstance = null; // Nova variável para o gráfico de subcategorias
    let graficoComparacaoInstance = null; // Nova variável para o gráfico de comparação
    let dadosResumo = null;
    let lancamentos = [];
    let subcategorias = [];
    let cartoes = []; // Variável para cartões
    let gastosReais = []; // Nova variável para gastos reais
    let tipoGerenciamentoAtual = null; // Para saber qual modal de gerenciamento está aberto
    const modal = document.getElementById("modalFormulario");
    const modalEdicao = document.getElementById("modalEdicao");
    const modalGerenciamento = document.getElementById("modalGerenciamento");
    const modalDetalhamento = document.getElementById("modalDetalhamento");
    const modalGastoReal = document.getElementById("modalGastoReal"); // Novo modal
    const modalEdicaoGastoReal = document.getElementById("modalEdicaoGastoReal"); // Novo modal de edição
    const containerPrincipal = document.getElementById("containerPrincipal");
    const botaoResumoFixo = document.querySelector(".botao-resumo-fixo");
    const botaoMensagensFixo = document.querySelector(".botao-mensagens-fixo");
    const botaoGastosReaisFixo = document.querySelector(".botao-gastos-reais-fixo");

    // Funções de Navegação e Exibição (Atualizadas)
    function mostrarResumo() {
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.remove("container-gastos-reais-ativo");
      containerPrincipal.classList.add("container-resumo-ativo");
    }

    function mostrarMensagens() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-gastos-reais-ativo");
      containerPrincipal.classList.add("container-mensagens-ativo");
    }
    
    function mostrarGastosReais() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.add("container-gastos-reais-ativo");
    }

    function voltarParaLancamentos() {
      containerPrincipal.classList.remove("container-resumo-ativo");
      containerPrincipal.classList.remove("container-mensagens-ativo");
      containerPrincipal.classList.remove("container-gastos-reais-ativo");
    }

    // Funções do Modal de Adição de Lançamento (Existente)
    function abrirModal() {
      const today = new Date();
      const currentYear = today.getFullYear();
      if (!document.getElementById("dataInicial").value) {
        document.getElementById("dataInicial").value = `${currentYear}-01-01`;
      }
      if (!document.getElementById("dataFinal").value) {
        document.getElementById("dataFinal").value = `${currentYear}-12-31`;
      }
      toggleCartaoContainer();
      modal.style.display = "block";
    }

    function fecharModal() {
      modal.style.display = "none";
    }

    // Funções do Modal de Edição de Lançamento (Existente)
    function abrirModalEdicao(id) {
      const lancamento = lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      document.getElementById("editLancamentoId").value = id;
      document.getElementById("descricaoEdicao").value = lancamento.descricao;
      document.getElementById("valorEdicao").value = formatarMoedaParaInput(lancamento.valor);
      document.getElementById("tipoLancamentoEdicao").value = lancamento.tipo;
      document.getElementById("formaPagamentoEdicao").value = lancamento.formaPagamento;
      document.getElementById("subcategoriaEdicao").value = lancamento.subcategoria || "";
      document.getElementById("cartaoCreditoEdicao").value = lancamento.cartaoId || ""; // Carrega cartão
      document.getElementById("frequenciaValorEdicao").value = lancamento.frequenciaValor;
      document.getElementById("frequenciaTipoEdicao").value = lancamento.frequenciaTipo;
      document.getElementById("dataInicialEdicao").value = lancamento.dataInicial;
      document.getElementById("dataFinalEdicao").value = lancamento.dataFinal;

      toggleCartaoContainerEdicao();
      modalEdicao.style.display = "block";
    }

    function fecharModalEdicao() {
      modalEdicao.style.display = "none";
    }

    // Funções do Modal de Gerenciamento (Existente)
    function abrirModalGerenciamento(tipo) {
      tipoGerenciamentoAtual = tipo;
      const tituloModal = document.getElementById("tituloModalGerenciamento");
      const formNovoItem = document.getElementById("formNovoItem");
      const listaGerenciamento = document.getElementById("listaGerenciamento");

      listaGerenciamento.innerHTML = ""; // Limpa a lista

      if (tipo === "subcategorias") {
        tituloModal.textContent = "Gerenciar Subcategorias";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome da nova subcategoria" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        subcategorias.forEach(item => adicionarItemNaLista(item));
      } else if (tipo === "cartoes") {
        tituloModal.textContent = "Gerenciar Cartões";
        formNovoItem.innerHTML = `
          <div class="novo-item-container">
            <input type="text" id="novoNomeItem" class="novo-item-input" placeholder="Nome do novo cartão" />
            <input type="number" id="novoDiaVencimento" class="novo-item-input dia" placeholder="Dia Venc." min="1" max="31" />
            <button class="botao-adicionar-item" onclick="adicionarItemGerenciamento()">Adicionar</button>
          </div>
        `;
        cartoes.forEach(item => adicionarItemNaLista(item));
      }
      modalGerenciamento.style.display = "block";
    }

    function fecharModalGerenciamento() {
      modalGerenciamento.style.display = "none";
    }

    // Funções do Modal de Detalhamento (Existente)
    function abrirModalDetalhamento(categoria, cartaoId = null) {
      // ... (código existente) ...
    }

    function fecharModalDetalhamento() {
      modalDetalhamento.style.display = "none";
    }

    // Novas Funções para Modal de Gasto Real
    function abrirModalGastoReal() {
      // Limpar formulário
      document.getElementById("gastoRealDescricao").value = "";
      document.getElementById("gastoRealValor").value = "";
      document.getElementById("gastoRealData").value = new Date().toISOString().split("T")[0]; // Data atual por padrão
      document.getElementById("gastoRealFormaPagamento").value = "conta";
      document.getElementById("gastoRealCartaoCredito").value = "";
      document.getElementById("gastoRealSubcategoria").value = "";
      document.getElementById("gastoRealLancamento").value = "";
      document.getElementById("gastoRealObservacao").value = "";
      
      // Atualizar selects
      atualizarSelect("gastoRealSubcategoria", subcategorias, "Nenhuma");
      atualizarSelect("gastoRealCartaoCredito", cartoes, "Selecione o cartão");
      atualizarSelectLancamentosRelacionados("gastoRealLancamento");
      
      toggleGastoRealCartaoContainer(); // Garante estado inicial correto
      atualizarFaturaGastoReal(); // Atualiza info da fatura
      modalGastoReal.style.display = "block";
    }

    function fecharModalGastoReal() {
      modalGastoReal.style.display = "none";
    }

    // Novas Funções para Modal de Edição de Gasto Real
    function abrirModalEdicaoGastoReal(id) {
      const gasto = gastosReais.find(g => g.id === id);
      if (!gasto) return;

      document.getElementById("editGastoRealId").value = id;
      document.getElementById("gastoRealDescricaoEdicao").value = gasto.descricao;
      document.getElementById("gastoRealValorEdicao").value = formatarMoedaParaInput(gasto.valor);
      document.getElementById("gastoRealDataEdicao").value = gasto.data;
      document.getElementById("gastoRealFormaPagamentoEdicao").value = gasto.formaPagamento;
      document.getElementById("gastoRealCartaoCreditoEdicao").value = gasto.cartaoId || "";
      document.getElementById("gastoRealSubcategoriaEdicao").value = gasto.subcategoria || "";
      document.getElementById("gastoRealLancamentoEdicao").value = gasto.lancamentoId || "";
      document.getElementById("gastoRealObservacaoEdicao").value = gasto.observacao || "";
      
      // Atualizar selects
      atualizarSelect("gastoRealSubcategoriaEdicao", subcategorias, "Nenhuma");
      atualizarSelect("gastoRealCartaoCreditoEdicao", cartoes, "Selecione o cartão");
      atualizarSelectLancamentosRelacionados("gastoRealLancamentoEdicao");
      
      // Tenta manter o valor selecionado se ele ainda existir nos dados
      if (gasto.subcategoria && subcategorias.find(s => s.id == gasto.subcategoria)) {
        document.getElementById("gastoRealSubcategoriaEdicao").value = gasto.subcategoria;
      }
      if (gasto.cartaoId && cartoes.find(c => c.id == gasto.cartaoId)) {
        document.getElementById("gastoRealCartaoCreditoEdicao").value = gasto.cartaoId;
      }
      if (gasto.lancamentoId && lancamentos.find(l => l.id == gasto.lancamentoId)) {
        document.getElementById("gastoRealLancamentoEdicao").value = gasto.lancamentoId;
      }

      toggleGastoRealCartaoContainerEdicao(); // Garante estado inicial correto
      atualizarFaturaGastoRealEdicao(); // Atualiza info da fatura
      modalEdicaoGastoReal.style.display = "block";
    }

    function fecharModalEdicaoGastoReal() {
      modalEdicaoGastoReal.style.display = "none";
    }

    // Função para mostrar/esconder campo de cartão no modal de Gasto Real
    function toggleGastoRealCartaoContainer() {
      const formaPagamento = document.getElementById("gastoRealFormaPagamento").value;
      const cartaoContainer = document.getElementById("gastoRealCartaoContainer");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        document.getElementById("gastoRealCartaoCredito").value = ""; // Limpa seleção
      }
      atualizarFaturaGastoReal(); // Atualiza info da fatura ao mudar forma de pagamento
    }

    // Função para mostrar/esconder campo de cartão no modal de Edição de Gasto Real
    function toggleGastoRealCartaoContainerEdicao() {
      const formaPagamento = document.getElementById("gastoRealFormaPagamentoEdicao").value;
      const cartaoContainer = document.getElementById("gastoRealCartaoContainerEdicao");
      
      if (formaPagamento === "credito") {
        cartaoContainer.style.display = "block";
        cartaoContainer.classList.add("show");
        cartaoContainer.classList.add("obrigatorio");
      } else {
        cartaoContainer.style.display = "none";
        cartaoContainer.classList.remove("show");
        cartaoContainer.classList.remove("obrigatorio");
        document.getElementById("gastoRealCartaoCreditoEdicao").value = ""; // Limpa seleção
      }
      atualizarFaturaGastoRealEdicao(); // Atualiza info da fatura ao mudar forma de pagamento
    }
    
    // Função para atualizar o select de lançamentos relacionados
    function atualizarSelectLancamentosRelacionados(selectId) {
      const select = document.getElementById(selectId);
      const valorAtual = select.value;
      select.innerHTML = `<option value="">Nenhum</option>`;
      
      lancamentos.forEach(item => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.descricao;
        select.appendChild(option);
      });
      
      // Tenta manter o valor selecionado se ele ainda existir nos dados
      if (valorAtual && lancamentos.find(l => l.id == valorAtual)) {
        select.value = valorAtual;
      }
    }

    // Event handlers para cliques nos modais (Atualizado)
    window.onclick = function (event) {
      if (event.target == modal) {
        fecharModal();
      }
      if (event.target == modalEdicao) {
        fecharModalEdicao();
      }
      if (event.target == modalGerenciamento) {
        fecharModalGerenciamento();
      }
      if (event.target == modalDetalhamento) {
        fecharModalDetalhamento();
      }
      if (event.target == modalGastoReal) {
        fecharModalGastoReal();
      }
      if (event.target == modalEdicaoGastoReal) {
        fecharModalEdicaoGastoReal();
      }
    };

    // Função para carregar dados iniciais (Atualizada)
    function carregarDadosIniciais() {
      carregarDadosGerenciamento(); // Carrega subcategorias e cartões
      carregarLancamentos(); // Carrega lançamentos planejados
      carregarGastosReais(); // Carrega gastos reais
      atualizarFiltrosGastosReais(); // Atualiza os filtros da seção de gastos reais
    }
    
    // Função para carregar gastos reais do localStorage
    function carregarGastosReais() {
      gastosReais = JSON.parse(localStorage.getItem("gastosReais") || "[]");
      atualizarTabelaGastosReais();
      atualizarResumoFaturas();
      atualizarGraficoComparacao();
    }
    
    // Função para atualizar a tabela de gastos reais (será implementada)
    function atualizarTabelaGastosReais() {
      // TODO: Implementar a lógica para exibir os gastos reais na tabela
      console.log("Atualizando tabela de gastos reais...");
    }
    
    // Função para registrar um novo gasto real (será implementada)
    function registrarGastoReal() {
      // TODO: Implementar a lógica para pegar dados do modal e salvar
      console.log("Registrando gasto real...");
    }
    
    // Função para salvar edição de gasto real (será implementada)
    function salvarEdicaoGastoReal() {
      // TODO: Implementar a lógica para salvar a edição
      console.log("Salvando edição de gasto real...");
    }
    
    // Função para excluir gasto real (será implementada)
    function excluirGastoReal(id) {
      // TODO: Implementar a lógica para excluir
      console.log(`Excluindo gasto real ID: ${id}`);
    }
    
    // Função para filtrar gastos reais (será implementada)
    function filtrarGastosReais() {
      // TODO: Implementar a lógica de filtragem
      console.log("Filtrando gastos reais...");
      atualizarTabelaGastosReais();
    }
    
    // Função para atualizar os filtros da seção de gastos reais
    function atualizarFiltrosGastosReais() {
      atualizarSelect("filtroCartao", cartoes, "Todos");
      atualizarSelect("filtroSubcategoria", subcategorias, "Todos");
    }
    
    // Função para atualizar o resumo de faturas (será implementada)
    function atualizarResumoFaturas() {
      // TODO: Implementar a lógica para exibir o resumo das faturas
      console.log("Atualizando resumo de faturas...");
    }
    
    // Função para atualizar o gráfico de comparação (será implementada)
    function atualizarGraficoComparacao() {
      // TODO: Implementar a lógica do gráfico
      console.log("Atualizando gráfico de comparação...");
    }
    
    // Função para atualizar a informação da fatura no modal de Gasto Real
    function atualizarFaturaGastoReal() {
      const cartaoId = document.getElementById("gastoRealCartaoCredito").value;
      const dataGastoStr = document.getElementById("gastoRealData").value;
      const infoFaturaDiv = document.getElementById("gastoRealInfoFatura");
      
      if (!cartaoId || !dataGastoStr) {
        infoFaturaDiv.innerHTML = "";
        return;
      }
      
      const cartao = cartoes.find(c => c.id == cartaoId);
      if (!cartao) {
        infoFaturaDiv.innerHTML = "";
        return;
      }
      
      const dataGasto = new Date(dataGastoStr + "T00:00:00");
      const { mesFatura, anoFatura } = determinarFatura(dataGasto, cartao);
      
      const nomeMes = new Date(anoFatura, mesFatura).toLocaleString("pt-BR", { month: "long" });
      infoFaturaDiv.innerHTML = `Este gasto entrará na fatura de <strong>${nomeMes}/${anoFatura}</strong>.`;
    }
    
    // Função para atualizar a informação da fatura no modal de Edição de Gasto Real
    function atualizarFaturaGastoRealEdicao() {
      const cartaoId = document.getElementById("gastoRealCartaoCreditoEdicao").value;
      const dataGastoStr = document.getElementById("gastoRealDataEdicao").value;
      const infoFaturaDiv = document.getElementById("gastoRealInfoFaturaEdicao");
      
      if (!cartaoId || !dataGastoStr) {
        infoFaturaDiv.innerHTML = "";
        return;
      }
      
      const cartao = cartoes.find(c => c.id == cartaoId);
      if (!cartao) {
        infoFaturaDiv.innerHTML = "";
        return;
      }
      
      const dataGasto = new Date(dataGastoStr + "T00:00:00");
      const { mesFatura, anoFatura } = determinarFatura(dataGasto, cartao);
      
      const nomeMes = new Date(anoFatura, mesFatura).toLocaleString("pt-BR", { month: "long" });
      infoFaturaDiv.innerHTML = `Este gasto entrará na fatura de <strong>${nomeMes}/${anoFatura}</strong>.`;
    }
    
    // Função para determinar a fatura de um gasto (será implementada na Fase 3)
    function determinarFatura(dataGasto, cartao) {
      // TODO: Implementar lógica de alocação na Fase 3
      // Por enquanto, retorna o mês/ano do gasto como placeholder
      return { mesFatura: dataGasto.getMonth(), anoFatura: dataGasto.getFullYear() };
    }

    // --- CÓDIGO EXISTENTE (CONTINUA ABAIXO) ---
    // (O restante do código JavaScript original será adicionado depois)


// Funções para Gerenciamento de Gastos Reais

// Função para registrar um novo gasto real
function registrarGastoReal() {
  const descricao = document.getElementById("gastoRealDescricao").value.trim();
  const valorStr = document.getElementById("gastoRealValor").value.trim();
  const data = document.getElementById("gastoRealData").value;
  const formaPagamento = document.getElementById("gastoRealFormaPagamento").value;
  const cartaoId = document.getElementById("gastoRealCartaoCredito").value || null;
  const subcategoria = document.getElementById("gastoRealSubcategoria").value || null;
  const lancamentoId = document.getElementById("gastoRealLancamento").value || null;
  const observacao = document.getElementById("gastoRealObservacao").value.trim() || null;

  if (!descricao || !valorStr || !data) {
    alert("Preencha a descrição, o valor e a data.");
    return;
  }

  if (formaPagamento === "credito" && !cartaoId) {
    alert("Selecione um cartão de crédito para este gasto.");
    return;
  }

  const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
  if (isNaN(valorNumerico)) {
    alert("Valor inválido.");
    return;
  }

  const gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
  const novoId = gastosReaisArray.length > 0 ? Math.max(...gastosReaisArray.map(g => g.id)) + 1 : 1;

  const novoGasto = {
    id: novoId,
    descricao,
    valor: valorNumerico,
    data,
    formaPagamento,
    cartaoId,
    subcategoria,
    lancamentoId,
    observacao
  };

  gastosReaisArray.push(novoGasto);
  localStorage.setItem("gastosReais", JSON.stringify(gastosReaisArray));

  // Limpar formulário
  document.getElementById("gastoRealDescricao").value = "";
  document.getElementById("gastoRealValor").value = "";
  document.getElementById("gastoRealSubcategoria").value = "";
  document.getElementById("gastoRealCartaoCredito").value = "";
  document.getElementById("gastoRealLancamento").value = "";
  document.getElementById("gastoRealObservacao").value = "";

  fecharModalGastoReal();
  carregarGastosReais();
}

// Função para salvar edição de gasto real
function salvarEdicaoGastoReal() {
  const id = parseInt(document.getElementById("editGastoRealId").value);
  const descricao = document.getElementById("gastoRealDescricaoEdicao").value.trim();
  const valorStr = document.getElementById("gastoRealValorEdicao").value.trim();
  const data = document.getElementById("gastoRealDataEdicao").value;
  const formaPagamento = document.getElementById("gastoRealFormaPagamentoEdicao").value;
  const cartaoId = document.getElementById("gastoRealCartaoCreditoEdicao").value || null;
  const subcategoria = document.getElementById("gastoRealSubcategoriaEdicao").value || null;
  const lancamentoId = document.getElementById("gastoRealLancamentoEdicao").value || null;
  const observacao = document.getElementById("gastoRealObservacaoEdicao").value.trim() || null;

  if (!descricao || !valorStr || !data) {
    alert("Preencha a descrição, o valor e a data.");
    return;
  }

  if (formaPagamento === "credito" && !cartaoId) {
    alert("Selecione um cartão de crédito para este gasto.");
    return;
  }

  const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
  if (isNaN(valorNumerico)) {
    alert("Valor inválido.");
    return;
  }

  let gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
  const gastoIndex = gastosReaisArray.findIndex(g => g.id === id);
  
  if (gastoIndex !== -1) {
    gastosReaisArray[gastoIndex] = {
      ...gastosReaisArray[gastoIndex],
      descricao,
      valor: valorNumerico,
      data,
      formaPagamento,
      cartaoId,
      subcategoria,
      lancamentoId,
      observacao
    };
    
    localStorage.setItem("gastosReais", JSON.stringify(gastosReaisArray));
    fecharModalEdicaoGastoReal();
    carregarGastosReais();
  }
}

// Função para excluir gasto real
function excluirGastoReal(id) {
  if (!confirm("Tem certeza que deseja excluir este gasto?")) return;
  
  let gastosReaisArray = JSON.parse(localStorage.getItem("gastosReais") || "[]");
  gastosReaisArray = gastosReaisArray.filter(g => g.id !== id);
  localStorage.setItem("gastosReais", JSON.stringify(gastosReaisArray));
  
  carregarGastosReais();
}

// Função para atualizar a tabela de gastos reais
function atualizarTabelaGastosReais() {
  const tbody = document.getElementById("gastosReaisBody");
  tbody.innerHTML = "";
  
  // Aplicar filtros
  const filtroMes = document.getElementById("filtroMes").value;
  const filtroFormaPagamento = document.getElementById("filtroFormaPagamento").value;
  const filtroCartao = document.getElementById("filtroCartao").value;
  const filtroSubcategoria = document.getElementById("filtroSubcategoria").value;
  
  const gastosFiltrados = gastosReais.filter(gasto => {
    // Filtro por mês
    if (filtroMes !== "todos") {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const mesGasto = dataGasto.getMonth();
      if (parseInt(filtroMes) !== mesGasto) return false;
    }
    
    // Filtro por forma de pagamento
    if (filtroFormaPagamento !== "todos" && gasto.formaPagamento !== filtroFormaPagamento) return false;
    
    // Filtro por cartão
    if (filtroCartao !== "todos" && gasto.cartaoId != filtroCartao) return false;
    
    // Filtro por subcategoria
    if (filtroSubcategoria !== "todos" && gasto.subcategoria != filtroSubcategoria) return false;
    
    return true;
  });
  
  // Ordenar por data (mais recente primeiro)
  gastosFiltrados.sort((a, b) => new Date(b.data) - new Date(a.data));
  
  gastosFiltrados.forEach(gasto => {
    const tr = document.createElement("tr");
    tr.className = gasto.formaPagamento === "credito" ? "gasto-real-cartao" : "gasto-real";
    
    // Obter informações adicionais
    const cartao = gasto.cartaoId ? cartoes.find(c => c.id == gasto.cartaoId) : null;
    const subcategoriaObj = gasto.subcategoria ? subcategorias.find(s => s.id == gasto.subcategoria) : null;
    
    // Determinar fatura se for cartão de crédito
    let faturaInfo = "";
    if (gasto.formaPagamento === "credito" && cartao) {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const { mesFatura, anoFatura } = determinarFatura(dataGasto, cartao);
      const nomeMes = new Date(anoFatura, mesFatura).toLocaleString("pt-BR", { month: "long" });
      faturaInfo = `${nomeMes}/${anoFatura}`;
    }
    
    // Formatar data para exibição
    const dataFormatada = new Date(gasto.data + "T00:00:00").toLocaleDateString("pt-BR");
    
    tr.innerHTML = `
      <td class="hidden-id">${gasto.id}</td>
      <td>${gasto.descricao}</td>
      <td>${dataFormatada}</td>
      <td>${formatarMoeda(gasto.valor)}</td>
      <td>${gasto.formaPagamento === "conta" ? "Conta" : "Cartão de Crédito"}</td>
      <td>${cartao ? cartao.nome : "-"}</td>
      <td>${faturaInfo || "-"}</td>
      <td>${subcategoriaObj ? subcategoriaObj.nome : "-"}</td>
      <td>${gasto.observacao || "-"}</td>
      <td>
        <button class="botao-gerenciar" onclick="abrirModalEdicaoGastoReal(${gasto.id})">Editar</button>
        <button class="delete-btn" onclick="excluirGastoReal(${gasto.id})">Excluir</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
}

// Função para determinar a fatura de um gasto com base na data e no cartão
function determinarFatura(dataGasto, cartao) {
  const diaGasto = dataGasto.getDate();
  const mesGasto = dataGasto.getMonth(); // 0-11
  const anoGasto = dataGasto.getFullYear();
  
  // Obter o dia de fechamento do cartão
  const diaFechamento = cartao.diaFechamento;
  
  // Se o dia do gasto for APÓS o dia do fechamento, vai para a fatura do mês seguinte
  if (diaGasto > diaFechamento) {
    // Gasto após o fechamento, vai para a fatura do próximo mês
    const mesFatura = (mesGasto + 1) % 12;
    const anoFatura = mesFatura === 0 && mesGasto === 11 ? anoGasto + 1 : anoGasto;
    return { mesFatura, anoFatura };
  } else {
    // Gasto antes ou no dia do fechamento, vai para a fatura do mês atual
    return { mesFatura: mesGasto, anoFatura: anoGasto };
  }
}

// Função para atualizar o resumo de faturas
function atualizarResumoFaturas() {
  const resumoFaturasDiv = document.getElementById("resumoFaturas");
  resumoFaturasDiv.innerHTML = "";
  
  // Filtrar apenas gastos de cartão de crédito
  const gastosCartao = gastosReais.filter(gasto => gasto.formaPagamento === "credito" && gasto.cartaoId);
  
  if (gastosCartao.length === 0) {
    resumoFaturasDiv.innerHTML = "<p>Nenhum gasto de cartão de crédito registrado.</p>";
    return;
  }
  
  // Agrupar gastos por cartão e fatura
  const faturasPorCartao = {};
  
  gastosCartao.forEach(gasto => {
    const cartao = cartoes.find(c => c.id == gasto.cartaoId);
    if (!cartao) return;
    
    const dataGasto = new Date(gasto.data + "T00:00:00");
    const { mesFatura, anoFatura } = determinarFatura(dataGasto, cartao);
    const chaveCartao = `${cartao.id}`;
    const chaveFatura = `${anoFatura}-${mesFatura}`;
    
    if (!faturasPorCartao[chaveCartao]) {
      faturasPorCartao[chaveCartao] = {
        cartao: cartao,
        faturas: {}
      };
    }
    
    if (!faturasPorCartao[chaveCartao].faturas[chaveFatura]) {
      faturasPorCartao[chaveCartao].faturas[chaveFatura] = {
        mes: mesFatura,
        ano: anoFatura,
        gastos: [],
        total: 0
      };
    }
    
    faturasPorCartao[chaveCartao].faturas[chaveFatura].gastos.push(gasto);
    faturasPorCartao[chaveCartao].faturas[chaveFatura].total += gasto.valor;
  });
  
  // Obter data atual para comparar faturas
  const hoje = new Date();
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();
  
  // Criar cards para cada cartão e suas faturas mais recentes
  Object.values(faturasPorCartao).forEach(dadosCartao => {
    const { cartao, faturas } = dadosCartao;
    
    // Ordenar faturas por data (mais recente primeiro)
    const faturasOrdenadas = Object.values(faturas).sort((a, b) => {
      if (a.ano !== b.ano) return b.ano - a.ano;
      return b.mes - a.mes;
    });
    
    // Pegar apenas as 3 faturas mais recentes
    const faturasRecentes = faturasOrdenadas.slice(0, 3);
    
    faturasRecentes.forEach(fatura => {
      const { mes, ano, gastos, total } = fatura;
      
      // Determinar status da fatura
      let statusFatura = "";
      let classeStatus = "";
      
      if (ano < anoAtual || (ano === anoAtual && mes < mesAtual)) {
        statusFatura = "Fechada";
        classeStatus = "fatura-fechada";
      } else if (ano === anoAtual && mes === mesAtual) {
        statusFatura = "Atual";
        classeStatus = "fatura-atual";
      } else {
        statusFatura = "Futura";
        classeStatus = "fatura-futura";
      }
      
      // Criar card da fatura
      const nomeMes = new Date(ano, mes).toLocaleString("pt-BR", { month: "long" });
      const cardFatura = document.createElement("div");
      cardFatura.className = "card-fatura";
      
      // Criar cabeçalho do card
      const cardHeader = document.createElement("div");
      cardHeader.className = "card-fatura-header";
      cardHeader.innerHTML = `
        <div class="card-fatura-titulo">
          ${cartao.nome} - ${nomeMes}/${ano}
          <span class="indicador-fatura ${classeStatus}">${statusFatura}</span>
        </div>
        <div class="card-fatura-valor">${formatarMoeda(total)}</div>
      `;
      
      // Criar detalhes da fatura
      const cardDetalhes = document.createElement("div");
      cardDetalhes.className = "card-fatura-detalhes";
      cardDetalhes.innerHTML = `
        <div>Vencimento: dia ${cartao.diaVencimento}</div>
        <div>Fechamento: dia ${cartao.diaFechamento}</div>
        <div>Itens: ${gastos.length}</div>
      `;
      
      // Criar lista de itens
      const cardItens = document.createElement("div");
      cardItens.className = "card-fatura-itens";
      
      // Ordenar gastos por valor (maior para menor)
      const gastosOrdenados = [...gastos].sort((a, b) => b.valor - a.valor);
      
      // Mostrar apenas os 5 maiores gastos
      const gastosTop = gastosOrdenados.slice(0, 5);
      
      gastosTop.forEach(gasto => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "card-fatura-item";
        itemDiv.innerHTML = `
          <div class="card-fatura-item-descricao">${gasto.descricao}</div>
          <div class="card-fatura-item-valor">${formatarMoeda(gasto.valor)}</div>
        `;
        cardItens.appendChild(itemDiv);
      });
      
      // Se houver mais gastos além dos 5 mostrados
      if (gastos.length > 5) {
        const itemDiv = document.createElement("div");
        itemDiv.className = "card-fatura-item";
        itemDiv.innerHTML = `
          <div class="card-fatura-item-descricao">E mais ${gastos.length - 5} itens...</div>
          <div class="card-fatura-item-valor"></div>
        `;
        cardItens.appendChild(itemDiv);
      }
      
      // Montar o card completo
      cardFatura.appendChild(cardHeader);
      cardFatura.appendChild(cardDetalhes);
      cardFatura.appendChild(cardItens);
      
      // Adicionar o card ao container
      resumoFaturasDiv.appendChild(cardFatura);
    });
  });
  
  // Se não houver faturas recentes
  if (resumoFaturasDiv.children.length === 0) {
    resumoFaturasDiv.innerHTML = "<p>Nenhuma fatura recente encontrada.</p>";
  }
}

// Função para atualizar o gráfico de comparação entre planejado e real
function atualizarGraficoComparacao() {
  const ctx = document.getElementById("graficoComparacao").getContext("2d");
  if (graficoComparacaoInstance) graficoComparacaoInstance.destroy();
  
  const mesSelecionado = parseInt(document.getElementById("mesComparacao").value);
  const anoAtual = new Date().getFullYear();
  
  // Preparar dados para o gráfico
  const categorias = ["Receitas", "Despesas Fixas", "Despesas Variáveis", "Cartão de Crédito", "Conta"];
  const dadosPlanejado = [];
  const dadosReal = [];
  
  // Calcular valores planejados
  if (dadosResumo) {
    if (mesSelecionado === -1) {
      // Total anual
      dadosPlanejado.push(dadosResumo.totalReceitas);
      dadosPlanejado.push(dadosResumo.totalFixas);
      dadosPlanejado.push(dadosResumo.totalVariaveis);
      
      // Calcular total de cartão e conta
      const totalCartao = calcularTotalPorFormaPagamento(lancamentos, "credito", anoAtual);
      const totalConta = calcularTotalPorFormaPagamento(lancamentos, "conta", anoAtual);
      dadosPlanejado.push(totalCartao);
      dadosPlanejado.push(totalConta);
    } else {
      // Mês específico
      dadosPlanejado.push(dadosResumo.receitas.meses[mesSelecionado] || 0);
      dadosPlanejado.push(dadosResumo.fixas.meses[mesSelecionado] || 0);
      dadosPlanejado.push(dadosResumo.variaveis.meses[mesSelecionado] || 0);
      
      // Calcular total de cartão e conta para o mês
      const totalCartaoMes = calcularTotalPorFormaPagamentoMes(lancamentos, "credito", mesSelecionado, anoAtual);
      const totalContaMes = calcularTotalPorFormaPagamentoMes(lancamentos, "conta", mesSelecionado, anoAtual);
      dadosPlanejado.push(totalCartaoMes);
      dadosPlanejado.push(totalContaMes);
    }
  } else {
    // Se não houver dados de resumo, preencher com zeros
    dadosPlanejado.push(0, 0, 0, 0, 0);
  }
  
  // Calcular valores reais
  if (mesSelecionado === -1) {
    // Total anual
    const totalReceitasReal = calcularTotalRealPorTipo("receita", null, anoAtual);
    const totalFixasReal = calcularTotalRealPorTipo("fixa", null, anoAtual);
    const totalVariaveisReal = calcularTotalRealPorTipo("variavel", null, anoAtual);
    const totalCartaoReal = calcularTotalRealPorFormaPagamento("credito", null, anoAtual);
    const totalContaReal = calcularTotalRealPorFormaPagamento("conta", null, anoAtual);
    
    dadosReal.push(totalReceitasReal);
    dadosReal.push(totalFixasReal);
    dadosReal.push(totalVariaveisReal);
    dadosReal.push(totalCartaoReal);
    dadosReal.push(totalContaReal);
  } else {
    // Mês específico
    const totalReceitasRealMes = calcularTotalRealPorTipo("receita", mesSelecionado, anoAtual);
    const totalFixasRealMes = calcularTotalRealPorTipo("fixa", mesSelecionado, anoAtual);
    const totalVariaveisRealMes = calcularTotalRealPorTipo("variavel", mesSelecionado, anoAtual);
    const totalCartaoRealMes = calcularTotalRealPorFormaPagamento("credito", mesSelecionado, anoAtual);
    const totalContaRealMes = calcularTotalRealPorFormaPagamento("conta", mesSelecionado, anoAtual);
    
    dadosReal.push(totalReceitasRealMes);
    dadosReal.push(totalFixasRealMes);
    dadosReal.push(totalVariaveisRealMes);
    dadosReal.push(totalCartaoRealMes);
    dadosReal.push(totalContaRealMes);
  }
  
  // Criar o gráfico
  graficoComparacaoInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: categorias,
      datasets: [
        {
          label: "Planejado",
          data: dadosPlanejado,
          backgroundColor: "rgba(33, 150, 243, 0.7)",
          borderColor: "rgba(33, 150, 243, 1)",
          borderWidth: 1
        },
        {
          label: "Real",
          data: dadosReal,
          backgroundColor: "rgba(76, 175, 80, 0.7)",
          borderColor: "rgba(76, 175, 80, 1)",
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatarMoeda(value);
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.dataset.label || "";
              const value = context.raw || 0;
              return `${label}: ${formatarMoeda(value)}`;
            }
          }
        },
        legend: {
          position: "top"
        }
      }
    }
  });
}

// Função para calcular o total por forma de pagamento (anual)
function calcularTotalPorFormaPagamento(lancamentosArray, formaPagamento, ano) {
  let total = 0;
  
  lancamentosArray.filter(l => l.formaPagamento === formaPagamento && l.tipo !== "receita").forEach(lancamento => {
    const ocorrencias = calcularOcorrencias(lancamento, ano);
    
    if (lancamento.valoresManuais && lancamento.valoresManuais.some(v => v !== null)) {
      total += lancamento.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
      
      for (let i = 0; i < 12; i++) {
        if (lancamento.valoresManuais[i] === null) {
          const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
          total += lancamento.valor * ocorrenciasMesSemManual.length;
        }
      }
    } else {
      total += lancamento.valor * ocorrencias.length;
    }
  });
  
  return total;
}

// Função para calcular o total por forma de pagamento (mensal)
function calcularTotalPorFormaPagamentoMes(lancamentosArray, formaPagamento, mes, ano) {
  let total = 0;
  
  lancamentosArray.filter(l => l.formaPagamento === formaPagamento && l.tipo !== "receita").forEach(lancamento => {
    const ocorrencias = calcularOcorrencias(lancamento, ano);
    const ocorrenciasMes = ocorrencias.filter(d => d.getMonth() === mes);
    
    if (lancamento.valoresManuais && lancamento.valoresManuais[mes] !== null) {
      total += lancamento.valoresManuais[mes];
    } else {
      total += lancamento.valor * ocorrenciasMes.length;
    }
  });
  
  return total;
}

// Função para calcular o total real por tipo (anual ou mensal)
function calcularTotalRealPorTipo(tipo, mes, ano) {
  // Primeiro, precisamos mapear os gastos reais para os tipos de lançamento
  const gastosComTipo = gastosReais.map(gasto => {
    // Se o gasto tem um lançamento relacionado, usamos o tipo dele
    if (gasto.lancamentoId) {
      const lancamentoRelacionado = lancamentos.find(l => l.id == gasto.lancamentoId);
      if (lancamentoRelacionado) {
        return { ...gasto, tipoLancamento: lancamentoRelacionado.tipo };
      }
    }
    
    // Se não tem lançamento relacionado, inferimos o tipo:
    // - Receitas são sempre do tipo "receita"
    // - Despesas em cartão são consideradas "variáveis" por padrão
    // - Despesas em conta sem subcategoria são consideradas "variáveis" por padrão
    if (gasto.valor < 0) {
      return { ...gasto, tipoLancamento: "receita" };
    } else if (gasto.formaPagamento === "credito") {
      return { ...gasto, tipoLancamento: "variavel" };
    } else {
      return { ...gasto, tipoLancamento: "variavel" };
    }
  });
  
  // Agora filtramos por tipo e, opcionalmente, por mês
  return gastosComTipo
    .filter(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const mesGasto = dataGasto.getMonth();
      const anoGasto = dataGasto.getFullYear();
      
      const tipoMatch = gasto.tipoLancamento === tipo;
      const mesMatch = mes === null || mesGasto === mes;
      const anoMatch = anoGasto === ano;
      
      return tipoMatch && mesMatch && anoMatch;
    })
    .reduce((total, gasto) => total + gasto.valor, 0);
}

// Função para calcular o total real por forma de pagamento (anual ou mensal)
function calcularTotalRealPorFormaPagamento(formaPagamento, mes, ano) {
  return gastosReais
    .filter(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const mesGasto = dataGasto.getMonth();
      const anoGasto = dataGasto.getFullYear();
      
      const formaPagamentoMatch = gasto.formaPagamento === formaPagamento;
      const mesMatch = mes === null || mesGasto === mes;
      const anoMatch = anoGasto === ano;
      
      return formaPagamentoMatch && mesMatch && anoMatch;
    })
    .reduce((total, gasto) => total + gasto.valor, 0);
}

// Funções para Alocação de Gastos em Faturas de Cartão

// Função aprimorada para determinar a fatura de um gasto com base na data e no cartão
function determinarFatura(dataGasto, cartao) {
  const diaGasto = dataGasto.getDate();
  const mesGasto = dataGasto.getMonth(); // 0-11
  const anoGasto = dataGasto.getFullYear();
  
  // Obter o dia de fechamento do cartão (pode ser manual ou calculado)
  const diaFechamento = cartao.diaFechamento;
  
  // Se o dia do gasto for APÓS o dia do fechamento, vai para a fatura do mês seguinte
  if (diaGasto > diaFechamento) {
    // Gasto após o fechamento, vai para a fatura do próximo mês
    const mesFatura = (mesGasto + 1) % 12;
    const anoFatura = mesFatura === 0 && mesGasto === 11 ? anoGasto + 1 : anoGasto;
    return { 
      mesFatura, 
      anoFatura,
      dataFechamento: new Date(anoGasto, mesGasto, diaFechamento),
      dataVencimento: new Date(anoFatura, mesFatura, cartao.diaVencimento),
      status: determinarStatusFatura(mesFatura, anoFatura)
    };
  } else {
    // Gasto antes ou no dia do fechamento, vai para a fatura do mês atual
    return { 
      mesFatura: mesGasto, 
      anoFatura: anoGasto,
      dataFechamento: new Date(anoGasto, mesGasto, diaFechamento),
      dataVencimento: new Date(anoGasto, mesGasto, cartao.diaVencimento),
      status: determinarStatusFatura(mesGasto, anoGasto)
    };
  }
}

// Função para determinar o status de uma fatura (aberta, fechada, paga)
function determinarStatusFatura(mesFatura, anoFatura) {
  const hoje = new Date();
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();
  
  if (anoFatura < anoAtual || (anoFatura === anoAtual && mesFatura < mesAtual)) {
    return "fechada"; // Fatura de meses anteriores
  } else if (anoFatura === anoAtual && mesFatura === mesAtual) {
    return "atual"; // Fatura do mês atual
  } else {
    return "futura"; // Fatura de meses futuros
  }
}

// Função para obter todas as faturas de todos os cartões
function obterTodasFaturas() {
  // Filtrar apenas gastos de cartão de crédito
  const gastosCartao = gastosReais.filter(gasto => gasto.formaPagamento === "credito" && gasto.cartaoId);
  
  if (gastosCartao.length === 0) {
    return [];
  }
  
  // Agrupar gastos por cartão e fatura
  const faturasPorCartao = {};
  
  gastosCartao.forEach(gasto => {
    const cartao = cartoes.find(c => c.id == gasto.cartaoId);
    if (!cartao) return;
    
    const dataGasto = new Date(gasto.data + "T00:00:00");
    const { mesFatura, anoFatura, dataFechamento, dataVencimento, status } = determinarFatura(dataGasto, cartao);
    const chaveCartao = `${cartao.id}`;
    const chaveFatura = `${anoFatura}-${mesFatura}`;
    
    if (!faturasPorCartao[chaveCartao]) {
      faturasPorCartao[chaveCartao] = {
        cartao: cartao,
        faturas: {}
      };
    }
    
    if (!faturasPorCartao[chaveCartao].faturas[chaveFatura]) {
      faturasPorCartao[chaveCartao].faturas[chaveFatura] = {
        mes: mesFatura,
        ano: anoFatura,
        dataFechamento: dataFechamento,
        dataVencimento: dataVencimento,
        status: status,
        gastos: [],
        total: 0
      };
    }
    
    faturasPorCartao[chaveCartao].faturas[chaveFatura].gastos.push(gasto);
    faturasPorCartao[chaveCartao].faturas[chaveFatura].total += gasto.valor;
  });
  
  // Converter para array de faturas
  const todasFaturas = [];
  
  Object.values(faturasPorCartao).forEach(dadosCartao => {
    const { cartao, faturas } = dadosCartao;
    
    Object.values(faturas).forEach(fatura => {
      todasFaturas.push({
        cartaoId: cartao.id,
        cartaoNome: cartao.nome,
        mes: fatura.mes,
        ano: fatura.ano,
        dataFechamento: fatura.dataFechamento,
        dataVencimento: fatura.dataVencimento,
        status: fatura.status,
        gastos: fatura.gastos,
        total: fatura.total
      });
    });
  });
  
  // Ordenar por data de vencimento (mais próxima primeiro)
  todasFaturas.sort((a, b) => a.dataVencimento - b.dataVencimento);
  
  return todasFaturas;
}

// Função aprimorada para atualizar o resumo de faturas
function atualizarResumoFaturas() {
  const resumoFaturasDiv = document.getElementById("resumoFaturas");
  resumoFaturasDiv.innerHTML = "";
  
  const todasFaturas = obterTodasFaturas();
  
  if (todasFaturas.length === 0) {
    resumoFaturasDiv.innerHTML = "<p>Nenhum gasto de cartão de crédito registrado.</p>";
    return;
  }
  
  // Agrupar faturas por status
  const faturasPorStatus = {
    atual: [],
    futura: [],
    fechada: []
  };
  
  todasFaturas.forEach(fatura => {
    if (faturasPorStatus[fatura.status]) {
      faturasPorStatus[fatura.status].push(fatura);
    }
  });
  
  // Priorizar faturas atuais, depois futuras, depois fechadas
  const ordemExibicao = ["atual", "futura", "fechada"];
  
  // Limitar a 2 faturas por status
  ordemExibicao.forEach(status => {
    const faturas = faturasPorStatus[status].slice(0, 2);
    
    faturas.forEach(fatura => {
      // Criar card da fatura
      const nomeMes = new Date(fatura.ano, fatura.mes).toLocaleString("pt-BR", { month: "long" });
      const cardFatura = document.createElement("div");
      cardFatura.className = "card-fatura";
      cardFatura.onclick = () => filtrarGastosPorFatura(fatura.cartaoId, fatura.mes, fatura.ano);
      
      // Definir classe de status
      let classeStatus = "";
      let textoStatus = "";
      
      switch (fatura.status) {
        case "atual":
          classeStatus = "fatura-atual";
          textoStatus = "Atual";
          break;
        case "fechada":
          classeStatus = "fatura-fechada";
          textoStatus = "Fechada";
          break;
        case "futura":
          classeStatus = "fatura-futura";
          textoStatus = "Futura";
          break;
      }
      
      // Criar cabeçalho do card
      const cardHeader = document.createElement("div");
      cardHeader.className = "card-fatura-header";
      cardHeader.innerHTML = `
        <div class="card-fatura-titulo">
          ${fatura.cartaoNome} - ${nomeMes}/${fatura.ano}
          <span class="indicador-fatura ${classeStatus}">${textoStatus}</span>
        </div>
        <div class="card-fatura-valor">${formatarMoeda(fatura.total)}</div>
      `;
      
      // Formatar datas
      const dataFechamentoFormatada = fatura.dataFechamento.toLocaleDateString("pt-BR");
      const dataVencimentoFormatada = fatura.dataVencimento.toLocaleDateString("pt-BR");
      
      // Criar detalhes da fatura
      const cardDetalhes = document.createElement("div");
      cardDetalhes.className = "card-fatura-detalhes";
      cardDetalhes.innerHTML = `
        <div>Fechamento: ${dataFechamentoFormatada}</div>
        <div>Vencimento: ${dataVencimentoFormatada}</div>
        <div>Itens: ${fatura.gastos.length}</div>
      `;
      
      // Criar lista de itens
      const cardItens = document.createElement("div");
      cardItens.className = "card-fatura-itens";
      
      // Ordenar gastos por valor (maior para menor)
      const gastosOrdenados = [...fatura.gastos].sort((a, b) => b.valor - a.valor);
      
      // Mostrar apenas os 5 maiores gastos
      const gastosTop = gastosOrdenados.slice(0, 5);
      
      gastosTop.forEach(gasto => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "card-fatura-item";
        itemDiv.innerHTML = `
          <div class="card-fatura-item-descricao">${gasto.descricao}</div>
          <div class="card-fatura-item-valor">${formatarMoeda(gasto.valor)}</div>
        `;
        cardItens.appendChild(itemDiv);
      });
      
      // Se houver mais gastos além dos 5 mostrados
      if (fatura.gastos.length > 5) {
        const itemDiv = document.createElement("div");
        itemDiv.className = "card-fatura-item";
        itemDiv.innerHTML = `
          <div class="card-fatura-item-descricao">E mais ${fatura.gastos.length - 5} itens...</div>
          <div class="card-fatura-item-valor"></div>
        `;
        cardItens.appendChild(itemDiv);
      }
      
      // Montar o card completo
      cardFatura.appendChild(cardHeader);
      cardFatura.appendChild(cardDetalhes);
      cardFatura.appendChild(cardItens);
      
      // Adicionar o card ao container
      resumoFaturasDiv.appendChild(cardFatura);
    });
  });
  
  // Se não houver faturas recentes
  if (resumoFaturasDiv.children.length === 0) {
    resumoFaturasDiv.innerHTML = "<p>Nenhuma fatura recente encontrada.</p>";
  }
}

// Função para filtrar gastos por fatura específica
function filtrarGastosPorFatura(cartaoId, mes, ano) {
  // Atualizar os filtros na interface
  document.getElementById("filtroFormaPagamento").value = "credito";
  document.getElementById("filtroCartao").value = cartaoId;
  document.getElementById("filtroMes").value = mes;
  
  // Aplicar os filtros
  filtrarGastosReais();
  
  // Mostrar a seção de gastos reais
  mostrarGastosReais();
  
  // Adicionar mensagem informativa
  const cartao = cartoes.find(c => c.id == cartaoId);
  const nomeMes = new Date(ano, mes).toLocaleString("pt-BR", { month: "long" });
  
  alert(`Mostrando gastos da fatura de ${nomeMes}/${ano} do cartão ${cartao ? cartao.nome : 'desconhecido'}.`);
}

// Função para atualizar a informação da fatura no modal de Gasto Real
function atualizarFaturaGastoReal() {
  const cartaoId = document.getElementById("gastoRealCartaoCredito").value;
  const dataGastoStr = document.getElementById("gastoRealData").value;
  const infoFaturaDiv = document.getElementById("gastoRealInfoFatura");
  
  if (!cartaoId || !dataGastoStr) {
    infoFaturaDiv.innerHTML = "";
    return;
  }
  
  const cartao = cartoes.find(c => c.id == cartaoId);
  if (!cartao) {
    infoFaturaDiv.innerHTML = "";
    return;
  }
  
  const dataGasto = new Date(dataGastoStr + "T00:00:00");
  const { mesFatura, anoFatura, dataFechamento, dataVencimento } = determinarFatura(dataGasto, cartao);
  
  const nomeMes = new Date(anoFatura, mesFatura).toLocaleString("pt-BR", { month: "long" });
  const dataFechamentoFormatada = dataFechamento.toLocaleDateString("pt-BR");
  const dataVencimentoFormatada = dataVencimento.toLocaleDateString("pt-BR");
  
  infoFaturaDiv.innerHTML = `
    <div>Este gasto entrará na fatura de <strong>${nomeMes}/${anoFatura}</strong>.</div>
    <div>Fechamento: ${dataFechamentoFormatada}</div>
    <div>Vencimento: ${dataVencimentoFormatada}</div>
  `;
}

// Função para atualizar a informação da fatura no modal de Edição de Gasto Real
function atualizarFaturaGastoRealEdicao() {
  const cartaoId = document.getElementById("gastoRealCartaoCreditoEdicao").value;
  const dataGastoStr = document.getElementById("gastoRealDataEdicao").value;
  const infoFaturaDiv = document.getElementById("gastoRealInfoFaturaEdicao");
  
  if (!cartaoId || !dataGastoStr) {
    infoFaturaDiv.innerHTML = "";
    return;
  }
  
  const cartao = cartoes.find(c => c.id == cartaoId);
  if (!cartao) {
    infoFaturaDiv.innerHTML = "";
    return;
  }
  
  const dataGasto = new Date(dataGastoStr + "T00:00:00");
  const { mesFatura, anoFatura, dataFechamento, dataVencimento } = determinarFatura(dataGasto, cartao);
  
  const nomeMes = new Date(anoFatura, mesFatura).toLocaleString("pt-BR", { month: "long" });
  const dataFechamentoFormatada = dataFechamento.toLocaleDateString("pt-BR");
  const dataVencimentoFormatada = dataVencimento.toLocaleDateString("pt-BR");
  
  infoFaturaDiv.innerHTML = `
    <div>Este gasto entrará na fatura de <strong>${nomeMes}/${anoFatura}</strong>.</div>
    <div>Fechamento: ${dataFechamentoFormatada}</div>
    <div>Vencimento: ${dataVencimentoFormatada}</div>
  `;
}

// Função para adicionar filtro por fatura na interface
function adicionarFiltroFatura() {
  // Obter todas as faturas disponíveis
  const todasFaturas = obterTodasFaturas();
  
  // Criar o select de filtro por fatura
  const filtroFaturaSelect = document.getElementById("filtroFatura");
  filtroFaturaSelect.innerHTML = '<option value="todas">Todas as Faturas</option>';
  
  // Agrupar faturas por cartão
  const faturasPorCartao = {};
  
  todasFaturas.forEach(fatura => {
    if (!faturasPorCartao[fatura.cartaoId]) {
      faturasPorCartao[fatura.cartaoId] = [];
    }
    
    faturasPorCartao[fatura.cartaoId].push(fatura);
  });
  
  // Adicionar opções agrupadas por cartão
  Object.entries(faturasPorCartao).forEach(([cartaoId, faturas]) => {
    const cartao = cartoes.find(c => c.id == cartaoId);
    if (!cartao) return;
    
    const optgroup = document.createElement("optgroup");
    optgroup.label = cartao.nome;
    
    // Ordenar faturas por data (mais recente primeiro)
    faturas.sort((a, b) => {
      if (a.ano !== b.ano) return b.ano - a.ano;
      return b.mes - a.mes;
    });
    
    faturas.forEach(fatura => {
      const nomeMes = new Date(fatura.ano, fatura.mes).toLocaleString("pt-BR", { month: "long" });
      const option = document.createElement("option");
      option.value = `${cartaoId}-${fatura.mes}-${fatura.ano}`;
      option.textContent = `${nomeMes}/${fatura.ano} (${formatarMoeda(fatura.total)})`;
      optgroup.appendChild(option);
    });
    
    filtroFaturaSelect.appendChild(optgroup);
  });
}

// Função para aplicar filtro por fatura
function aplicarFiltroFatura() {
  const filtroFatura = document.getElementById("filtroFatura").value;
  
  if (filtroFatura === "todas") {
    // Limpar outros filtros relacionados
    document.getElementById("filtroFormaPagamento").value = "todos";
    document.getElementById("filtroCartao").value = "todos";
    document.getElementById("filtroMes").value = "todos";
    
    // Aplicar filtros
    filtrarGastosReais();
    return;
  }
  
  // Extrair informações da fatura selecionada
  const [cartaoId, mes, ano] = filtroFatura.split("-");
  
  // Atualizar os outros filtros
  document.getElementById("filtroFormaPagamento").value = "credito";
  document.getElementById("filtroCartao").value = cartaoId;
  document.getElementById("filtroMes").value = mes;
  
  // Aplicar filtros
  filtrarGastosReais();
}

// Funções para Integração com a Interface Existente

// Função para atualizar o resumo financeiro incluindo comparação entre planejado e real
function atualizarResumoFinanceiroComComparacao(lancamentos, gastosReais, ano) {
  const resumoBody = document.getElementById("resumoBody");
  resumoBody.innerHTML = "";

  // Calcular dados planejados (código existente)
  const receitas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "receita"), ano);
  const fixas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "fixa"), ano);
  const variaveis = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "variavel"), ano);
  const cartaoTotal = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "credito" && l.tipo !== "receita"), ano);
  const conta = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "conta" && l.tipo !== "receita"), ano);
  const subcategoriasResumo = calcularTotaisPorSubcategoria(lancamentos, ano);
  const cartoesResumo = calcularTotaisPorCartao(lancamentos, ano);

  // Calcular total agregado dos cartões
  const cartaoTotalAgregado = { meses: Array(12).fill(0), total: 0 };
  Object.values(cartoesResumo).forEach(dadosCartao => {
    if (dadosCartao && dadosCartao.meses) {
      for (let i = 0; i < 12; i++) {
        cartaoTotalAgregado.meses[i] += dadosCartao.meses[i] || 0;
      }
      cartaoTotalAgregado.total += dadosCartao.total || 0;
    }
  });
  const mediaCartaoTotalAgregado = cartaoTotalAgregado.total / 12;

  const totalReceitas = receitas.total;
  const totalFixas = fixas.total;
  const totalVariaveis = variaveis.total;
  const totalDespesas = totalFixas + totalVariaveis;
  const saldo = totalReceitas - totalDespesas;
  
  const mediaReceitas = totalReceitas / 12;
  const mediaFixas = totalFixas / 12;
  const mediaVariaveis = totalVariaveis / 12;
  const mediaTotalDespesas = totalDespesas / 12;
  const mediaSaldo = saldo / 12;
  const mediaConta = conta.total / 12;
  
  // Calcular dados reais
  const receitasReais = calcularTotaisReaisPorMes("receita", ano);
  const fixasReais = calcularTotaisReaisPorMes("fixa", ano);
  const variaveisReais = calcularTotaisReaisPorMes("variavel", ano);
  const cartaoReais = calcularTotaisReaisPorFormaPagamentoMes("credito", ano);
  const contaReais = calcularTotaisReaisPorFormaPagamentoMes("conta", ano);
  
  const totalReceitasReais = receitasReais.total;
  const totalFixasReais = fixasReais.total;
  const totalVariaveisReais = variaveisReais.total;
  const totalDespesasReais = totalFixasReais + totalVariaveisReais;
  const saldoReal = totalReceitasReais - totalDespesasReais;
  
  const mediaReceitasReais = totalReceitasReais / 12;
  const mediaFixasReais = totalFixasReais / 12;
  const mediaVariaveisReais = totalVariaveisReais / 12;
  const mediaTotalDespesasReais = totalDespesasReais / 12;
  const mediaSaldoReal = saldoReal / 12;
  const mediaCartaoReais = cartaoReais.total / 12;
  const mediaContaReais = contaReais.total / 12;
  
  const spacerRowHTML = `<tr class="spacer-row"><td colspan="15"></td></tr>`;

  // Função para criar células de comparação
  function criarCelulaComparacao(valorPlanejado, valorReal) {
    if (valorReal === 0 || valorReal === undefined) {
      return `<td>${formatarMoeda(valorPlanejado)}</td>`;
    }
    
    const variacao = valorReal - valorPlanejado;
    const percentual = valorPlanejado !== 0 ? (variacao / Math.abs(valorPlanejado)) * 100 : 0;
    const classeVariacao = variacao > 0 ? "variacao-positiva" : (variacao < 0 ? "variacao-negativa" : "");
    const sinalVariacao = variacao > 0 ? "+" : "";
    
    return `
      <td class="comparacao-valor">
        <div class="valor-real">${formatarMoeda(valorReal)}</div>
        <div class="valor-planejado ${classeVariacao}">
          ${formatarMoeda(valorPlanejado)} (${sinalVariacao}${percentual.toFixed(1)}%)
        </div>
      </td>
    `;
  }

  // Função para criar linha de comparação
  function criarLinhaComparacao(titulo, valoresPlanejados, valoresReais, classe = "", onclick = "") {
    const onclickAttr = onclick ? `onclick="${onclick}"` : `onclick="event.stopPropagation()"`;
    
    let html = `<tr class="${classe}" ${onclickAttr}><td>${titulo}</td>`;
    
    // Células para cada mês
    for (let i = 0; i < 12; i++) {
      const valorPlanejado = valoresPlanejados.meses[i] || 0;
      const valorReal = valoresReais.meses[i] || 0;
      html += criarCelulaComparacao(valorPlanejado, valorReal);
    }
    
    // Célula para total
    html += criarCelulaComparacao(valoresPlanejados.total, valoresReais.total);
    
    // Célula para média
    const mediaPlanejada = valoresPlanejados.total / 12;
    const mediaReal = valoresReais.total / 12;
    html += criarCelulaComparacao(mediaPlanejada, mediaReal);
    
    html += `</tr>`;
    return html;
  }

  // Montar o HTML do resumo com comparação
  let subcategoriasHTML = "";
  if (Object.keys(subcategoriasResumo).length > 0) {
    subcategoriasHTML = spacerRowHTML;
    Object.entries(subcategoriasResumo).forEach(([nome, dados], index) => {
      const corClass = obterCorSubcategoria(index);
      const media = dados.total / 12;
      subcategoriasHTML += `
        <tr class="${corClass}" onclick="abrirModalDetalhamento('${nome}')">
          <td>${nome}</td>
          ${dados.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(dados.total)}</td>
          <td>${formatarMoeda(media)}</td>
        </tr>
      `;
    });
  }

  let cartoesHTML = "";
  if (Object.keys(cartoesResumo).length > 0) {
    cartoesHTML = spacerRowHTML;
    Object.entries(cartoesResumo).forEach(([id, dados]) => {
      const media = dados.total / 12;
      cartoesHTML += `
        <tr class="cartao-laranja" onclick="abrirModalDetalhamento('${dados.nome}', ${id})">
          <td>${dados.nome}</td>
          ${dados.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(dados.total)}</td>
          <td>${formatarMoeda(media)}</td>
        </tr>
      `;
    });
  }

  resumoBody.innerHTML = `
    ${criarLinhaComparacao("Receitas", receitas, receitasReais, "receita", "abrirModalDetalhamento('Receitas')")}
    ${spacerRowHTML} 
    ${criarLinhaComparacao("Despesas Fixas", fixas, fixasReais, "fixa", "abrirModalDetalhamento('Despesas Fixas')")}
    ${criarLinhaComparacao("Despesas Variáveis", variaveis, variaveisReais, "variavel", "abrirModalDetalhamento('Despesas Variáveis')")}
    <tr onclick="event.stopPropagation()">
      <td>Total Despesas</td>
      ${Array(12).fill(0).map((_, i) => {
        const mesPlanejado = (fixas.meses[i] || 0) + (variaveis.meses[i] || 0);
        const mesReal = (fixasReais.meses[i] || 0) + (variaveisReais.meses[i] || 0);
        return criarCelulaComparacao(mesPlanejado, mesReal);
      }).join("")}
      ${criarCelulaComparacao(totalDespesas, totalDespesasReais)}
      ${criarCelulaComparacao(mediaTotalDespesas, mediaTotalDespesasReais)}
    </tr>
    ${spacerRowHTML}
    <tr onclick="event.stopPropagation()"> 
      <td class="saldo-positivo">Potencial de Investimento</td>
      ${Array(12).fill(0).map((_, i) => {
        const mesSaldoPlanejado = (receitas.meses[i] || 0) - (fixas.meses[i] || 0) - (variaveis.meses[i] || 0);
        const mesSaldoReal = (receitasReais.meses[i] || 0) - (fixasReais.meses[i] || 0) - (variaveisReais.meses[i] || 0);
        const classeCor = mesSaldoPlanejado >= 0 ? "saldo-positivo" : "saldo-negativo";
        return `<td class="${classeCor}">${criarCelulaComparacao(mesSaldoPlanejado, mesSaldoReal)}</td>`;
      }).join("")}
      <td class="${saldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${criarCelulaComparacao(saldo, saldoReal)}</td>
      <td class="${mediaSaldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${criarCelulaComparacao(mediaSaldo, mediaSaldoReal)}</td>
    </tr>
    ${cartoesHTML}
    ${spacerRowHTML}
    ${criarLinhaComparacao("Cartão de Crédito (Total)", cartaoTotalAgregado, cartaoReais, "cartao-laranja", "abrirModalDetalhamento('Cartão de Crédito (Total)')")}
    ${criarLinhaComparacao("Conta", conta, contaReais, "conta-amarela", "abrirModalDetalhamento('Conta')")}
    ${subcategoriasHTML}
  `;

  dadosResumo = {
    receitas: receitas,
    fixas: fixas,
    variaveis: variaveis,
    totalReceitas: totalReceitas,
    totalFixas: totalFixas,
    totalVariaveis: totalVariaveis,
    totalDespesas: totalDespesas,
    saldo: saldo,
    mediaReceitas: mediaReceitas,
    mediaFixas: mediaFixas,
    mediaVariaveis: mediaVariaveis,
    mediaSaldo: mediaSaldo,
    lancamentos: lancamentos,
    // Adicionar dados reais ao resumo
    receitasReais: receitasReais,
    fixasReais: fixasReais,
    variaveisReais: variaveisReais,
    totalReceitasReais: totalReceitasReais,
    totalFixasReais: totalFixasReais,
    totalVariaveisReais: totalVariaveisReais,
    totalDespesasReais: totalDespesasReais,
    saldoReal: saldoReal,
    mediaReceitasReais: mediaReceitasReais,
    mediaFixasReais: mediaFixasReais,
    mediaVariaveisReais: mediaVariaveisReais,
    mediaSaldoReal: mediaSaldoReal,
    gastosReais: gastosReais
  };

  atualizarGraficos();
  gerarInsightsFinanceiros(dadosResumo);
}

// Função para calcular totais reais por tipo e mês
function calcularTotaisReaisPorMes(tipo, ano) {
  const resultado = {
    meses: Array(12).fill(0),
    total: 0
  };
  
  // Mapear os gastos reais para os tipos de lançamento
  const gastosComTipo = gastosReais.map(gasto => {
    // Se o gasto tem um lançamento relacionado, usamos o tipo dele
    if (gasto.lancamentoId) {
      const lancamentoRelacionado = lancamentos.find(l => l.id == gasto.lancamentoId);
      if (lancamentoRelacionado) {
        return { ...gasto, tipoLancamento: lancamentoRelacionado.tipo };
      }
    }
    
    // Se não tem lançamento relacionado, inferimos o tipo
    if (gasto.valor < 0) {
      return { ...gasto, tipoLancamento: "receita" };
    } else if (gasto.formaPagamento === "credito") {
      return { ...gasto, tipoLancamento: "variavel" };
    } else {
      return { ...gasto, tipoLancamento: "variavel" };
    }
  });
  
  // Filtrar por tipo e ano
  gastosComTipo
    .filter(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const anoGasto = dataGasto.getFullYear();
      return gasto.tipoLancamento === tipo && anoGasto === ano;
    })
    .forEach(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const mesGasto = dataGasto.getMonth();
      
      resultado.meses[mesGasto] += gasto.valor;
      resultado.total += gasto.valor;
    });
  
  return resultado;
}

// Função para calcular totais reais por forma de pagamento e mês
function calcularTotaisReaisPorFormaPagamentoMes(formaPagamento, ano) {
  const resultado = {
    meses: Array(12).fill(0),
    total: 0
  };
  
  gastosReais
    .filter(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const anoGasto = dataGasto.getFullYear();
      return gasto.formaPagamento === formaPagamento && anoGasto === ano;
    })
    .forEach(gasto => {
      const dataGasto = new Date(gasto.data + "T00:00:00");
      const mesGasto = dataGasto.getMonth();
      
      resultado.meses[mesGasto] += gasto.valor;
      resultado.total += gasto.valor;
    });
  
  return resultado;
}

// Função para atualizar os gráficos incluindo dados reais
function atualizarGraficosComDadosReais() {
  if (!dadosResumo) return;
  const mesSelecionado = parseInt(document.getElementById("mesSelecionado").value);
  
  // Dados planejados
  let receitaPlanejada, fixasPlanejadas, variaveisPlanejadas, saldoPlanejado;
  
  // Dados reais
  let receitaReal, fixasReais, variaveisReais, saldoReal;

  if (mesSelecionado === -1) {
    // Total anual
    receitaPlanejada = dadosResumo.totalReceitas;
    fixasPlanejadas = dadosResumo.totalFixas;
    variaveisPlanejadas = dadosResumo.totalVariaveis;
    saldoPlanejado = dadosResumo.saldo;
    
    receitaReal = dadosResumo.totalReceitasReais || 0;
    fixasReais = dadosResumo.totalFixasReais || 0;
    variaveisReais = dadosResumo.totalVariaveisReais || 0;
    saldoReal = dadosResumo.saldoReal || 0;
  } else if (mesSelecionado === -2) {
    // Médias mensais
    receitaPlanejada = dadosResumo.mediaReceitas;
    fixasPlanejadas = dadosResumo.mediaFixas;
    variaveisPlanejadas = dadosResumo.mediaVariaveis;
    saldoPlanejado = dadosResumo.mediaSaldo;
    
    receitaReal = dadosResumo.mediaReceitasReais || 0;
    fixasReais = dadosResumo.mediaFixasReais || 0;
    variaveisReais = dadosResumo.mediaVariaveisReais || 0;
    saldoReal = dadosResumo.mediaSaldoReal || 0;
  } else {
    // Mês específico
    receitaPlanejada = dadosResumo.receitas.meses[mesSelecionado] || 0;
    fixasPlanejadas = dadosResumo.fixas.meses[mesSelecionado] || 0;
    variaveisPlanejadas = dadosResumo.variaveis.meses[mesSelecionado] || 0;
    saldoPlanejado = receitaPlanejada - fixasPlanejadas - variaveisPlanejadas;
    
    receitaReal = dadosResumo.receitasReais?.meses[mesSelecionado] || 0;
    fixasReais = dadosResumo.fixasReais?.meses[mesSelecionado] || 0;
    variaveisReais = dadosResumo.variaveisReais?.meses[mesSelecionado] || 0;
    saldoReal = receitaReal - fixasReais - variaveisReais;
  }

  // Atualizar gráficos com dados planejados e reais
  atualizarGraficoDespesasPoupancaComComparacao(
    fixasPlanejadas, variaveisPlanejadas, saldoPlanejado,
    fixasReais, variaveisReais, saldoReal
  );
  
  atualizarGraficoDespesasReceitasComComparacao(
    receitaPlanejada, receitaReal, mesSelecionado
  );
  
  // Manter os outros gráficos existentes
  atualizarGraficoCartoesCredito(mesSelecionado);
  atualizarGraficoSubcategorias(mesSelecionado);
}

// Função para atualizar o gráfico de despesas e poupança com comparação
function atualizarGraficoDespesasPoupancaComComparacao(
  fixasPlanejadas, variaveisPlanejadas, saldoPlanejado,
  fixasReais, variaveisReais, saldoReal
) {
  const ctx = document.getElementById("graficoDespesasPoupanca").getContext("2d");
  if (graficoDespesasPoupanca) graficoDespesasPoupanca.destroy();
  
  // Calcular totais
  const totalPlanejado = fixasPlanejadas + variaveisPlanejadas + Math.max(0, saldoPlanejado);
  const totalReal = fixasReais + variaveisReais + Math.max(0, saldoReal);
  
  // Preparar dados para o gráfico
  const labels = ["Despesas Fixas", "Despesas Variáveis", "Potencial de Investimento"];
  const dataPlanejado = [fixasPlanejadas, variaveisPlanejadas, Math.max(0, saldoPlanejado)];
  const dataReal = [fixasReais, variaveisReais, Math.max(0, saldoReal)];
  const backgroundColorsPlanejado = ["rgba(244, 67, 54, 0.7)", "rgba(255, 152, 0, 0.7)", "rgba(25, 118, 210, 0.7)"];
  const backgroundColorsReal = ["rgba(244, 67, 54, 1)", "rgba(255, 152, 0, 1)", "rgba(25, 118, 210, 1)"];
  
  // Filtrar categorias com valores zero
  const filteredLabels = [];
  const filteredDataPlanejado = [];
  const filteredDataReal = [];
  const filteredColorsPlanejado = [];
  const filteredColorsReal = [];
  
  for (let i = 0; i < labels.length; i++) {
    if (dataPlanejado[i] > 0 || dataReal[i] > 0) {
      filteredLabels.push(labels[i]);
      filteredDataPlanejado.push(dataPlanejado[i]);
      filteredDataReal.push(dataReal[i]);
      filteredColorsPlanejado.push(backgroundColorsPlanejado[i]);
      filteredColorsReal.push(backgroundColorsReal[i]);
    }
  }
  
  // Se não houver dados, mostrar mensagem
  if (filteredLabels.length === 0) {
    document.getElementById("legendaDespesasPoupanca").innerHTML = "<p style=\"text-align:center;\">Sem dados para exibir.</p>";
    return;
  }
  
  // Calcular percentuais
  const percentuaisPlanejado = totalPlanejado > 0 ? 
    filteredDataPlanejado.map(val => ((val / totalPlanejado) * 100).toFixed(1) + "%") : 
    filteredDataPlanejado.map(() => "0%");
  
  const percentuaisReal = totalReal > 0 ? 
    filteredDataReal.map(val => ((val / totalReal) * 100).toFixed(1) + "%") : 
    filteredDataReal.map(() => "0%");
  
  // Criar legenda com comparação
  const legendaHTML = filteredLabels.map((label, i) => `
    <div class="item-legenda">
      <div class="cor-legenda" style="background-color: ${filteredColorsPlanejado[i]}"></div>
      <span class="descricao-legenda">${label}</span>
      <span class="valor-legenda">
        <span class="valor-real">${formatarMoeda(filteredDataReal[i])}</span>
        <span class="valor-planejado">${formatarMoeda(filteredDataPlanejado[i])}</span>
      </span>
      <span>(${percentuaisReal[i]} / ${percentuaisPlanejado[i]})</span>
    </div>
  `).join("");
  
  document.getElementById("legendaDespesasPoupanca").innerHTML = `
    <div style="text-align:center; margin-bottom: 10px;">
      <span style="margin-right: 15px;"><span style="display:inline-block; width:10px; height:10px; background-color:rgba(76,175,80,0.7); margin-right:5px;"></span> Real</span>
      <span><span style="display:inline-block; width:10px; height:10px; background-color:rgba(33,150,243,0.7); margin-right:5px;"></span> Planejado</span>
    </div>
    ${legendaHTML}
  `;
  
  // Criar o gráfico
  graficoDespesasPoupanca = new Chart(ctx, {
    type: "pie",
    data: {
      labels: filteredLabels,
      datasets: [
        {
          label: "Planejado",
          data: filteredDataPlanejado,
          backgroundColor: filteredColorsPlanejado,
          borderWidth: 1,
          borderColor: "#014034"
        },
        {
          label: "Real",
          data: filteredDataReal,
          backgroundColor: filteredColorsReal,
          borderWidth: 1,
          borderColor: "#014034"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const datasetLabel = context.dataset.label || "";
              const label = context.label || "";
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
              return `${datasetLabel} - ${label}: ${formatarMoeda(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Função para atualizar o gráfico de despesas em relação às receitas com comparação
function atualizarGraficoDespesasReceitasComComparacao(receitaPlanejada, receitaReal, mesSelecionado) {
  const ctx = document.getElementById("graficoDespesasReceitas").getContext("2d");
  if (graficoDespesasReceitas) graficoDespesasReceitas.destroy();

  const anoAtual = new Date().getFullYear();
  
  // Preparar dados para o gráfico
  const despesasAgrupadasPlanejado = {};
  const despesasAgrupadasReal = {};
  
  // Processar lançamentos planejados
  const todasDespesas = dadosResumo.lancamentos.filter((l) => l.tipo !== "receita");
  todasDespesas.forEach((despesa) => {
    let valorDespesa = 0;

    if (mesSelecionado === -2) {
      // Média mensal
      let totalAnualDespesa = 0;
      if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
        totalAnualDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
        const ocorrencias = calcularOcorrencias(despesa, anoAtual);
        for (let i = 0; i < 12; i++) {
          if (despesa.valoresManuais[i] === null) {
            const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
            totalAnualDespesa += despesa.valor * ocorrenciasMesSemManual.length;
          }
        }
      } else {
        const ocorrencias = calcularOcorrencias(despesa, anoAtual);
        totalAnualDespesa = despesa.valor * ocorrencias.length;
      }
      valorDespesa = totalAnualDespesa / 12;
    } else if (mesSelecionado === -1) {
      // Total anual
      if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
        valorDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
        const ocorrencias = calcularOcorrencias(despesa, anoAtual);
        for(let i=0; i<12; i++){
          if(despesa.valoresManuais[i] === null){ 
            const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
            valorDespesa += despesa.valor * ocorrenciasMesSemManual.length;
          }
        }
      } else {
        const ocorrencias = calcularOcorrencias(despesa, anoAtual);
        valorDespesa = despesa.valor * ocorrencias.length;
      }
    } else {
      // Mês específico
      const ocorrencias = calcularOcorrencias(despesa, anoAtual);
      const temOcorrenciaNoMes = ocorrencias.some((d) => d.getMonth() === mesSelecionado);
      const temValorManualNoMes = despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null;
      
      if(temOcorrenciaNoMes || temValorManualNoMes){
        if (despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null) {
          valorDespesa = despesa.valoresManuais[mesSelecionado];
        } else {
          const ocorrenciasNoMes = ocorrencias.filter((d) => d.getMonth() === mesSelecionado);
          valorDespesa = despesa.valor * ocorrenciasNoMes.length;
        }
      }
    }

    if (valorDespesa > 0) {
      const key = despesa.descricao;
      if (!despesasAgrupadasPlanejado[key]) {
        despesasAgrupadasPlanejado[key] = { valor: 0, tipo: despesa.tipo, formaPagamento: despesa.formaPagamento };
      }
      despesasAgrupadasPlanejado[key].valor += valorDespesa;
    }
  });
  
  // Processar gastos reais
  gastosReais.forEach((gasto) => {
    let valorGasto = 0;
    const dataGasto = new Date(gasto.data + "T00:00:00");
    const mesGasto = dataGasto.getMonth();
    const anoGasto = dataGasto.getFullYear();
    
    if (mesSelecionado === -2) {
      // Média mensal (consideramos apenas gastos do ano atual)
      if (anoGasto === anoAtual) {
        valorGasto = gasto.valor / 12;
      }
    } else if (mesSelecionado === -1) {
      // Total anual (consideramos apenas gastos do ano atual)
      if (anoGasto === anoAtual) {
        valorGasto = gasto.valor;
      }
    } else {
      // Mês específico
      if (mesGasto === mesSelecionado && anoGasto === anoAtual) {
        valorGasto = gasto.valor;
      }
    }
    
    if (valorGasto > 0) {
      const key = gasto.descricao;
      if (!despesasAgrupadasReal[key]) {
        despesasAgrupadasReal[key] = { 
          valor: 0, 
          tipo: gasto.lancamentoId ? 
            (lancamentos.find(l => l.id == gasto.lancamentoId)?.tipo || "variavel") : 
            "variavel",
          formaPagamento: gasto.formaPagamento
        };
      }
      despesasAgrupadasReal[key].valor += valorGasto;
    }
  });
  
  // Ordenar despesas por valor
  const despesasOrdenadasPlanejado = Object.entries(despesasAgrupadasPlanejado)
    .map(([descricao, info]) => ({ descricao, ...info }))
    .sort((a, b) => b.valor - a.valor);
  
  const despesasOrdenadasReal = Object.entries(despesasAgrupadasReal)
    .map(([descricao, info]) => ({ descricao, ...info }))
    .sort((a, b) => b.valor - a.valor);
  
  // Limitar a 10 maiores despesas para cada conjunto
  const limiteGrafico = 10;
  const despesasPlanejadoTop = despesasOrdenadasPlanejado.slice(0, limiteGrafico);
  const despesasRealTop = despesasOrdenadasReal.slice(0, limiteGrafico);
  
  // Combinar as listas para ter todas as descrições únicas
  const todasDescricoes = new Set([
    ...despesasPlanejadoTop.map(d => d.descricao),
    ...despesasRealTop.map(d => d.descricao)
  ]);
  
  // Preparar dados para o gráfico
  const labels = Array.from(todasDescricoes);
  const dataPlanejado = labels.map(label => {
    const despesa = despesasAgrupadasPlanejado[label];
    return despesa ? despesa.valor : 0;
  });
  const dataReal = labels.map(label => {
    const despesa = despesasAgrupadasReal[label];
    return despesa ? despesa.valor : 0;
  });
  
  // Cores para o gráfico
  const backgroundColorsPlanejado = labels.map(label => {
    const despesa = despesasAgrupadasPlanejado[label];
    if (!despesa) return "rgba(33, 150, 243, 0.7)"; // Azul para planejado
    return despesa.tipo === "fixa" ? "rgba(244, 67, 54, 0.7)" : "rgba(255, 152, 0, 0.7)";
  });
  
  const backgroundColorsReal = labels.map(label => {
    const despesa = despesasAgrupadasReal[label];
    if (!despesa) return "rgba(76, 175, 80, 0.7)"; // Verde para real
    return despesa.tipo === "fixa" ? "rgba(244, 67, 54, 1)" : "rgba(255, 152, 0, 1)";
  });
  
  // Criar o gráfico
  graficoDespesasReceitas = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Planejado",
          data: dataPlanejado,
          backgroundColor: backgroundColorsPlanejado,
          borderColor: backgroundColorsPlanejado.map(color => color.replace("0.7", "1")),
          borderWidth: 1
        },
        {
          label: "Real",
          data: dataReal,
          backgroundColor: backgroundColorsReal,
          borderColor: backgroundColorsReal,
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatarMoeda(value);
            }
          }
        }
      },
      plugins: {
        legend: {
          position: "top",
          labels: {
            usePointStyle: true,
            padding: 20
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.dataset.label || "";
              const value = context.raw || 0;
              const percentual = receitaPlanejada > 0 ? ((value / receitaPlanejada) * 100).toFixed(1) : 0;
              return `${label}: ${formatarMoeda(value)} (${percentual}% da receita)`;
            }
          }
        }
      }
    }
  });
  
  // Atualizar legenda
  const legendaHTML = `
    <div style="text-align:center; margin-bottom: 10px;">
      <div>Receita ${mesSelecionado === -2 ? "Média" : (mesSelecionado === -1 ? "Anual" : "do Mês")}:</div>
      <div style="font-weight:bold; margin-bottom:5px;">
        <span class="valor-real">${formatarMoeda(receitaReal)}</span>
        <span class="valor-planejado">(Planejado: ${formatarMoeda(receitaPlanejada)})</span>
      </div>
      <div>O gráfico mostra as ${limiteGrafico} maiores despesas.</div>
    </div>
  `;
  
  document.getElementById("legendaDespesasReceitas").innerHTML = legendaHTML;
}

// Função para gerar insights financeiros aprimorados
function gerarInsightsFinanceirosAprimorados(dadosResumo) {
  if (!dadosResumo) return;
  
  const insightsContent = document.getElementById("insightsContent");
  let insights = [];
  
  // Insight 1: Comparação entre receitas planejadas e reais
  const diferencaReceitas = dadosResumo.totalReceitasReais - dadosResumo.totalReceitas;
  const percentualDiferencaReceitas = dadosResumo.totalReceitas > 0 ? 
    (diferencaReceitas / dadosResumo.totalReceitas) * 100 : 0;
  
  if (Math.abs(percentualDiferencaReceitas) > 5) {
    const textoComparacao = diferencaReceitas > 0 ? "maior" : "menor";
    insights.push(`<p><strong>Receitas:</strong> O valor real está ${Math.abs(percentualDiferencaReceitas).toFixed(1)}% ${textoComparacao} que o planejado. ${diferencaReceitas > 0 ? "Isso é positivo!" : "Isso pode indicar um problema de receita."}</p>`);
  } else {
    insights.push(`<p><strong>Receitas:</strong> Os valores reais estão próximos do planejado (diferença de ${Math.abs(percentualDiferencaReceitas).toFixed(1)}%).</p>`);
  }
  
  // Insight 2: Comparação entre despesas planejadas e reais
  const diferencaDespesas = dadosResumo.totalDespesasReais - dadosResumo.totalDespesas;
  const percentualDiferencaDespesas = dadosResumo.totalDespesas > 0 ? 
    (diferencaDespesas / dadosResumo.totalDespesas) * 100 : 0;
  
  if (Math.abs(percentualDiferencaDespesas) > 5) {
    const textoComparacao = diferencaDespesas > 0 ? "maior" : "menor";
    insights.push(`<p><strong>Despesas:</strong> O valor real está ${Math.abs(percentualDiferencaDespesas).toFixed(1)}% ${textoComparacao} que o planejado. ${diferencaDespesas > 0 ? "Isso pode indicar gastos acima do orçamento." : "Isso é positivo para sua economia!"}</p>`);
  } else {
    insights.push(`<p><strong>Despesas:</strong> Os valores reais estão próximos do planejado (diferença de ${Math.abs(percentualDiferencaDespesas).toFixed(1)}%).</p>`);
  }
  
  // Insight 3: Análise do saldo
  const diferencaSaldo = dadosResumo.saldoReal - dadosResumo.saldo;
  const percentualDiferencaSaldo = dadosResumo.saldo > 0 ? 
    (diferencaSaldo / Math.abs(dadosResumo.saldo)) * 100 : 0;
  
  if (dadosResumo.saldoReal < 0 && dadosResumo.saldo >= 0) {
    insights.push(`<p><strong>Saldo:</strong> Atenção! O saldo real está negativo (${formatarMoeda(dadosResumo.saldoReal)}), enquanto o planejado era positivo (${formatarMoeda(dadosResumo.saldo)}).</p>`);
  } else if (dadosResumo.saldoReal >= 0 && dadosResumo.saldo < 0) {
    insights.push(`<p><strong>Saldo:</strong> Parabéns! O saldo real está positivo (${formatarMoeda(dadosResumo.saldoReal)}), enquanto o planejado era negativo (${formatarMoeda(dadosResumo.saldo)}).</p>`);
  } else if (Math.abs(percentualDiferencaSaldo) > 10) {
    const textoComparacao = diferencaSaldo > 0 ? "melhor" : "pior";
    insights.push(`<p><strong>Saldo:</strong> O saldo real está ${Math.abs(percentualDiferencaSaldo).toFixed(1)}% ${textoComparacao} que o planejado.</p>`);
  } else {
    insights.push(`<p><strong>Saldo:</strong> O saldo real está próximo do planejado (diferença de ${Math.abs(percentualDiferencaSaldo).toFixed(1)}%).</p>`);
  }
  
  // Insight 4: Análise de cartões de crédito
  const faturas = obterTodasFaturas();
  const faturasAtuais = faturas.filter(f => f.status === "atual");
  
  if (faturasAtuais.length > 0) {
    const totalFaturasAtuais = faturasAtuais.reduce((sum, f) => sum + f.total, 0);
    insights.push(`<p><strong>Cartões de Crédito:</strong> Você tem ${faturasAtuais.length} fatura${faturasAtuais.length > 1 ? 's' : ''} em aberto totalizando ${formatarMoeda(totalFaturasAtuais)}.</p>`);
  }
  
  // Insight 5: Categorias com maior diferença entre planejado e real
  const categoriasComDiferenca = [];
  
  // Comparar receitas
  categoriasComDiferenca.push({
    nome: "Receitas",
    planejado: dadosResumo.totalReceitas,
    real: dadosResumo.totalReceitasReais,
    diferenca: dadosResumo.totalReceitasReais - dadosResumo.totalReceitas
  });
  
  // Comparar despesas fixas
  categoriasComDiferenca.push({
    nome: "Despesas Fixas",
    planejado: dadosResumo.totalFixas,
    real: dadosResumo.totalFixasReais,
    diferenca: dadosResumo.totalFixasReais - dadosResumo.totalFixas
  });
  
  // Comparar despesas variáveis
  categoriasComDiferenca.push({
    nome: "Despesas Variáveis",
    planejado: dadosResumo.totalVariaveis,
    real: dadosResumo.totalVariaveisReais,
    diferenca: dadosResumo.totalVariaveisReais - dadosResumo.totalVariaveis
  });
  
  // Ordenar por diferença absoluta
  categoriasComDiferenca.sort((a, b) => Math.abs(b.diferenca) - Math.abs(a.diferenca));
  
  // Pegar a categoria com maior diferença
  const categoriaMaiorDiferenca = categoriasComDiferenca[0];
  if (categoriaMaiorDiferenca && Math.abs(categoriaMaiorDiferenca.diferenca) > 0) {
    const percentualDiferenca = categoriaMaiorDiferenca.planejado > 0 ? 
      (categoriaMaiorDiferenca.diferenca / categoriaMaiorDiferenca.planejado) * 100 : 0;
    
    if (Math.abs(percentualDiferenca) > 10) {
      const textoComparacao = categoriaMaiorDiferenca.diferenca > 0 ? "maior" : "menor";
      insights.push(`<p><strong>Maior Diferença:</strong> ${categoriaMaiorDiferenca.nome} tem a maior diferença entre planejado e real, com valor real ${Math.abs(percentualDiferenca).toFixed(1)}% ${textoComparacao} que o planejado.</p>`);
    }
  }
  
  // Insight 6: Recomendações
  if (dadosResumo.saldoReal < 0) {
    insights.push(`<p><strong>Recomendação:</strong> Seu saldo real está negativo. Considere revisar seus gastos, especialmente em categorias que excederam o planejado.</p>`);
  } else if (dadosResumo.saldoReal < dadosResumo.saldo && dadosResumo.saldo > 0) {
    insights.push(`<p><strong>Recomendação:</strong> Seu saldo real está abaixo do planejado. Verifique as categorias com maior diferença para identificar oportunidades de economia.</p>`);
  } else if (dadosResumo.saldoReal > dadosResumo.saldo) {
    insights.push(`<p><strong>Recomendação:</strong> Seu saldo real está acima do planejado. Considere direcionar o excedente para investimentos ou reserva de emergência.</p>`);
  }
  
  // Exibir insights
  insightsContent.innerHTML = insights.join("");
}

</script>
</body>
</html>
