<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle Financeiro V5</title> <!-- Versão atualizada -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002d26;
      color: white;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    .saldo-positivo {
         color: #1976d2; /* Azul não brilhante */
    }
    .saldo-negativo {
        color: #c62828; /* Vermelho não brilhante */
    }
    h1 {
      margin: 0 0 20px;
    }
    .cartao-laranja {
        color: #f57c00; /* Laranja não brilhante */
    }
    .conta-amarela {
        color: #fbc02d; /* Amarelo não brilhante */
    }
    .container-principal {
      display: flex;
      width: 200%; /* Mantido para o slide do resumo */
      transition: transform 0.5s ease;
    }

    .container-ativo {
      transform: translateX(-50%); /* Mantido para mostrar o resumo */
    }

    /* Nova seção para conter apenas a tabela de lançamentos */
    .secao-lancamentos {
      width: 50%; /* Ocupa metade do container principal */
      padding-right: 20px;
      box-sizing: border-box;
    }

    .secao-resumo {
      width: 50%; /* Ocupa a outra metade */
      padding-left: 20px;
      box-sizing: border-box;
    }

    /* Estilos para o Modal */
    .modal {
      display: none; /* Escondido por padrão */
      position: fixed; 
      z-index: 100; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      padding-top: 60px;
    }

    .modal-content {
      background-color: #014034;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 10px;
      position: relative;
    }

    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #ffd700;
      text-decoration: none;
      cursor: pointer;
    }

    /* Formulário dentro do Modal */
    .form-section-modal {
      padding: 0; 
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .botoes-formulario {
      grid-column: 1 / -1; 
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .table-container {
      background-color: #014034;
      border-radius: 10px;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      color: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #006a56;
      text-align: center;
    }

    th {
      background-color: #006a56;
      color: #ffd700;
      position: sticky;
      top: 0;
      z-index: 5; 
    }
    
    th.descricao-header {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        padding-right: 5px; 
    }

    .botao-abrir-modal {
        background-color: #ffd700;
        color: #002d26;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 18px;
        font-weight: bold;
        line-height: 24px; 
        text-align: center;
        cursor: pointer;
        margin-left: 10px;
        padding: 0;
    }

    .botao-abrir-modal:hover {
        background-color: #ffc400;
    }

    .receita { color: #4caf50; }
    .fixa { color: #f44336; }
    .variavel { color: #ff9800; }
    .cartao-credito { background-color: rgba(0, 106, 86, 0.3); }

    .botao-lancar {
      background-color: #ffd700;
      color: #002d26;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .botao-lancar:hover {
      background-color: #ffc400;
    }

    /* Botão Resumo Fixo */
    .botao-resumo-fixo {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 50;
      background-color: #2196F3;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: opacity 0.3s ease, visibility 0.3s ease; /* Adiciona transição */
      opacity: 1;
      visibility: visible;
    }
    
    /* Esconde o botão quando o resumo está ativo */
    .container-ativo ~ .botao-resumo-fixo {
        opacity: 0;
        visibility: hidden;
    }

    .botao-resumo-fixo:hover {
      background-color: #0b7dda;
    }

    .botao-voltar {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .botao-voltar:hover {
      background-color: #e68a00;
    }

    .delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }
    
    .hidden-id {
      display: none;
    }

    .resumo-titulo {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffd700;
      text-align: center;
    }
    
    /* Congelar a primeira coluna (Categoria) - Tabela Resumo */
    #tabelaResumo thead tr th:first-child,
    #tabelaResumo tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaResumo thead tr th:first-child {
      background-color: #006a56; 
      z-index: 20; 
    }
    #tabelaResumo tbody tr td:first-child {
      font-weight: bold; 
    }

    /* Congelar a coluna Descrição - Tabela Lançamentos */
    #tabelaLancamentos thead tr th:nth-child(2),
    #tabelaLancamentos tbody tr td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: #014034; 
    }
    #tabelaLancamentos thead tr th:nth-child(2) {
      background-color: #006a56; 
      z-index: 20;
    }
    #tabelaLancamentos tbody tr td:nth-child(2) {
      white-space: nowrap;
      min-width: 150px; 
    }

    /* Estilo para células editáveis */
    td.editable {
      cursor: pointer;
      position: relative;
    }
    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .edit-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background-color: #014034;
      color: white;
      text-align: center;
      padding: 0;
      margin: 0;
      font-size: 14px;
      box-sizing: border-box;
    }
    .edit-input:focus {
      outline: 2px solid #ffd700;
    }
    
    /* Estilos para os gráficos */
    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .grafico-card {
      background-color: #014034;
      border-radius: 10px;
      padding: 20px;
      width: calc(50% - 40px);
      min-width: 400px;
      box-sizing: border-box;
    }
    .grafico-titulo {
      text-align: center;
      margin-bottom: 15px;
      color: #ffd700;
      font-size: 16px;
    }
    .grafico {
      width: 100%;
      height: 300px;
      position: relative;
    }
    .seletor-mes {
      text-align: center;
      margin-bottom: 20px;
    }
    .seletor-mes select {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #006a56;
      color: white;
      font-weight: bold;
    }
    .legenda-grafico {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      width: 100%;
    }
    .item-legenda {
      display: flex;
      align-items: center;
      font-size: 14px;
      width: 100%;
    }
    .cor-legenda {
      width: 15px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .valor-legenda {
      margin-left: 5px;
      font-weight: bold;
    }
    .descricao-legenda {
      min-width: 120px;
    }
    
    /* Linha de espaçamento na tabela de resumo */
    .spacer-row td {
        height: 10px; /* Altura do espaço */
        padding: 0;
        border: none; /* Remove bordas */
        background-color: #002d26; /* Cor de fundo do corpo */
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Controle Financeiro</h1>
  
  <!-- Container Principal (Lançamentos e Resumo) -->
  <div class="container-principal" id="containerPrincipal">
    <!-- Seção da Tabela de Lançamentos -->
    <div class="secao-lancamentos">
      <div class="table-container">
        <table id="tabelaLancamentos">
          <thead>
            <tr>
              <th class="hidden-id">ID</th>
              <th class="descricao-header">
                <span>Descrição</span>
                <button id="botaoAbrirModal" class="botao-abrir-modal" onclick="abrirModal()">+</button>
              </th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <!-- Lançamentos serão inseridos aqui -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seção do Resumo -->
    <div class="secao-resumo">
      <button class="botao-voltar" onclick="voltarParaLancamentos()">← Voltar para Lançamentos</button>
      
      <div class="resumo-titulo">Resumo Financeiro</div>
      
      <div class="table-container">
        <table id="tabelaResumo">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Jan</th>
              <th>Fev</th>
              <th>Mar</th>
              <th>Abr</th>
              <th>Mai</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Ago</th>
              <th>Set</th>
              <th>Out</th>
              <th>Nov</th>
              <th>Dez</th>
              <th>Total</th>
              <th>Média</th> <!-- Nova coluna Média -->
            </tr>
          </thead>
          <tbody id="resumoBody">
            <!-- Resumo será inserido aqui -->
          </tbody>
        </table>
      </div>

      <!-- Seção dos Gráficos -->
      <div class="seletor-mes">
        <label for="mesSelecionado">Selecione o mês: </label>
        <select id="mesSelecionado" onchange="atualizarGraficos()">
          <option value="-1">Total Anual</option>
          <option value="-2">Médias Mensais</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>

      <div class="graficos-container">
        <div class="grafico-card">
          <div class="grafico-titulo">Distribuição de Despesas e Poupança</div>
          <div class="grafico">
            <canvas id="graficoDespesasPoupanca"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasPoupanca"></div>
        </div>
        
        <div class="grafico-card">
          <div class="grafico-titulo">Despesas em Relação às Receitas</div>
          <div class="grafico">
            <canvas id="graficoDespesasReceitas"></canvas>
          </div>
          <div class="legenda-grafico" id="legendaDespesasReceitas"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botão Resumo Fixo (movido para fora do container principal para CSS funcionar) -->
  <button class="botao-resumo-fixo" onclick="mostrarResumo()">Ver Resumo e Análises</button>

  <!-- Modal do Formulário -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModal()">&times;</span>
      <h2>Novo Lançamento</h2>
      <div class="form-section-modal">
        <div class="form-group">
          <label for="descricao">Descrição:</label>
          <input type="text" id="descricao" placeholder="Ex: Salário, Luz" />

          <label for="valor">Valor (R$):</label>
          <input type="text" id="valor" placeholder="Ex: 1.500,00" />
          
          <label for="tipoLancamento">Tipo de Lançamento:</label>
          <select id="tipoLancamento">
            <option value="receita">Receita</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>

          <label for="formaPagamento">Forma de Pagamento:</label>
          <select id="formaPagamento">
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          </select>

        </div>

        <div class="form-group">
          <label for="frequenciaValor">A cada:</label>
          <input type="number" id="frequenciaValor" min="1" value="1" />

          <label for="frequenciaTipo">Unidade de Frequência:</label>
          <select id="frequenciaTipo">
            <option value="unico">não se repete</option>
            <option value="dias">dias</option>
            <option value="dias_uteis">dias úteis</option>
            <option value="segunda">segunda</option>
            <option value="terca">terça</option>
            <option value="quarta">quarta</option>
            <option value="quinta">quinta</option>
            <option value="sexta">sexta</option>
            <option value="semanas">semanas</option>
            <option value="quinzenas">quinzenas</option>
            <option value="meses" selected>meses</option>
            <option value="anos">anos</option>
          </select>

          <label for="dataInicial">Data Inicial:</label>
          <input type="date" id="dataInicial" />

          <label for="dataFinal">Data Final:</label>
          <input type="date" id="dataFinal" />
        </div>
        <div class="botoes-formulario">
            <button class="botao-lancar" onclick="adicionarLancamento()">Lançar Item</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variáveis globais
    let graficoDespesasPoupanca = null;
    let graficoDespesasReceitas = null;
    let dadosResumo = null;
    let lancamentos = [];
    const modal = document.getElementById("modalFormulario");
    const containerPrincipal = document.getElementById("containerPrincipal");
    const botaoResumoFixo = document.querySelector(".botao-resumo-fixo"); // Seleciona o botão

    // Funções do Modal
    function abrirModal() {
      const today = new Date();
      const currentYear = today.getFullYear();
      if (!document.getElementById("dataInicial").value) {
        document.getElementById("dataInicial").value = `${currentYear}-01-01`;
      }
      if (!document.getElementById("dataFinal").value) {
        document.getElementById("dataFinal").value = `${currentYear}-12-31`;
      }
      modal.style.display = "block";
    }

    function fecharModal() {
      modal.style.display = "none";
    }

    window.onclick = function (event) {
      if (event.target == modal) {
        fecharModal();
      }
    };

    // Funções de Navegação e Exibição
    function mostrarResumo() {
      containerPrincipal.classList.add("container-ativo");
    }

    function voltarParaLancamentos() {
      containerPrincipal.classList.remove("container-ativo");
    }

    // Funções de Formatação e Cálculo
    function formatarMoeda(valor) {
      const numero = typeof valor === "number" ? valor : parseFloat(String(valor).replace(/[^\d,-]/g, "").replace(",", "."));
      if (isNaN(numero)) return "R$ 0,00";
      return numero.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function calcularOcorrencias(lancamento, ano) {
      const startDate = new Date(lancamento.dataInicial + "T00:00:00");
      const endDate = new Date(lancamento.dataFinal + "T00:00:00");
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        console.error("Datas inválidas para o lançamento:", lancamento);
        return [];
      }
      const ocorrencias = [];
      if (lancamento.frequenciaTipo === "unico") {
        if (startDate.getFullYear() === ano) {
          ocorrencias.push(new Date(startDate));
        }
        return ocorrencias;
      }
      const inicioAno = new Date(`${ano}-01-01T00:00:00`);
      const fimAno = new Date(`${ano}-12-31T00:00:00`);
      const dataInicioCalculo = startDate > inicioAno ? startDate : inicioAno;
      const dataFimCalculo = endDate < fimAno ? endDate : fimAno;
      if (dataInicioCalculo > dataFimCalculo) return ocorrencias;
      let currentDate = new Date(dataInicioCalculo);
      let safetyBreak = 0; // Safety break
      while (currentDate <= dataFimCalculo && safetyBreak < 500) {
        if (currentDate >= startDate && currentDate <= endDate && currentDate.getFullYear() === ano) {
          ocorrencias.push(new Date(currentDate));
        }
        const currentDayOfMonth = currentDate.getDate();
        let dataAnterior = new Date(currentDate);
        switch (lancamento.frequenciaTipo) {
          case "dias": currentDate.setDate(currentDate.getDate() + lancamento.frequenciaValor); break;
          case "dias_uteis":
            let diasAdicionados = 0;
            while (diasAdicionados < lancamento.frequenciaValor) {
              currentDate.setDate(currentDate.getDate() + 1);
              if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) diasAdicionados++;
            }
            break;
          case "meses":
            currentDate.setMonth(currentDate.getMonth() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "anos":
            currentDate.setFullYear(currentDate.getFullYear() + lancamento.frequenciaValor);
            if (currentDate.getDate() !== currentDayOfMonth) currentDate.setDate(0);
            break;
          case "semanas": currentDate.setDate(currentDate.getDate() + 7 * lancamento.frequenciaValor); break;
          case "quinzenas": currentDate.setDate(currentDate.getDate() + 15 * lancamento.frequenciaValor); break;
          case "segunda": case "terca": case "quarta": case "quinta": case "sexta":
            const diaSemana = { segunda: 1, terca: 2, quarta: 3, quinta: 4, sexta: 5 };
            const diaAlvo = diaSemana[lancamento.frequenciaTipo];
            do { currentDate.setDate(currentDate.getDate() + 1); } while (currentDate.getDay() !== diaAlvo);
            if (lancamento.frequenciaValor > 1) currentDate.setDate(currentDate.getDate() + 7 * (lancamento.frequenciaValor - 1));
            break;
          default:
            console.warn("Tipo de frequência desconhecido:", lancamento.frequenciaTipo);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        if (currentDate.getTime() === dataAnterior.getTime()) {
          console.error("Loop infinito detectado em calcularOcorrencias", lancamento);
          break;
        }
        safetyBreak++;
        if (safetyBreak >= 500) console.error("Safety break atingido em calcularOcorrencias", lancamento);
      }
      return ocorrencias;
    }
    
    function calcularTotaisPorCategoria(lancamentosCategoria, ano) {
      const meses = Array(12).fill(0);
      
      lancamentosCategoria.forEach(l => {
        const ocorrencias = calcularOcorrencias(l, ano);
        // Para cada mês do ano
        for (let index = 0; index < 12; index++) {
          // Verifica se há valor manual para este mês específico
          if (l.valoresManuais && l.valoresManuais[index] !== null) {
            meses[index] += l.valoresManuais[index];
          } else {
            // Senão, verifica quantas ocorrências calculadas existem neste mês
            const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
            if (ocorrenciasNoMes.length > 0) {
              // Adiciona o valor base multiplicado pelo número de ocorrências no mês
              meses[index] += l.valor * ocorrenciasNoMes.length; 
            }
          }
        }
      });
      
      const total = meses.reduce((sum, val) => sum + val, 0);
      return { meses, total };
    }

    // Funções de Atualização da Interface
    function atualizarResumoFinanceiro(lancamentos, ano) {
      const resumoBody = document.getElementById("resumoBody");
      resumoBody.innerHTML = "";

      const receitas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "receita"), ano);
      const fixas = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "fixa"), ano);
      const variaveis = calcularTotaisPorCategoria(lancamentos.filter((l) => l.tipo === "variavel"), ano);
      const cartao = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "credito" && l.tipo !== "receita"), ano);
      const conta = calcularTotaisPorCategoria(lancamentos.filter((l) => l.formaPagamento === "conta" && l.tipo !== "receita"), ano);

      const totalReceitas = receitas.total;
      const totalFixas = fixas.total;
      const totalVariaveis = variaveis.total;
      const totalDespesas = totalFixas + totalVariaveis;
      const saldo = totalReceitas - totalDespesas;
      
      // Calcula médias
      const mediaReceitas = totalReceitas / 12;
      const mediaFixas = totalFixas / 12;
      const mediaVariaveis = totalVariaveis / 12;
      const mediaTotalDespesas = totalDespesas / 12;
      const mediaSaldo = saldo / 12;
      const mediaCartao = cartao.total / 12;
      const mediaConta = conta.total / 12;
      
      // Linha de espaçamento (HTML string)
      const spacerRowHTML = `<tr class="spacer-row"><td colspan="15"></td></tr>`; // Colspan = 1 (Cat) + 12 (Meses) + 1 (Total) + 1 (Média)

      resumoBody.innerHTML = `
        <tr class="receita">
          <td>Receitas</td>
          ${receitas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalReceitas)}</td>
          <td>${formatarMoeda(mediaReceitas)}</td>
        </tr>
        ${spacerRowHTML} 
        <tr class="fixa">
          <td>Despesas Fixas</td>
          ${fixas.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalFixas)}</td>
          <td>${formatarMoeda(mediaFixas)}</td>
        </tr>
        <tr class="variavel">
          <td>Despesas Variáveis</td>
          ${variaveis.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(totalVariaveis)}</td>
          <td>${formatarMoeda(mediaVariaveis)}</td>
        </tr>
        <tr>
          <td>Total Despesas</td>
          ${Array(12).fill(0).map((_, i) => {
            const mesTotal = (fixas.meses[i] || 0) + (variaveis.meses[i] || 0);
            return `<td>${formatarMoeda(mesTotal)}</td>`;
          }).join("")}
          <td>${formatarMoeda(totalDespesas)}</td>
          <td>${formatarMoeda(mediaTotalDespesas)}</td>
        </tr>
        ${spacerRowHTML}
        <tr> 
          <td class="saldo-positivo">Potencial de Investimento</td> <!-- Sempre azul -->
          ${Array(12).fill(0).map((_, i) => {
            const mesSaldo = (receitas.meses[i] || 0) - (fixas.meses[i] || 0) - (variaveis.meses[i] || 0);
            const classeCor = mesSaldo >= 0 ? "saldo-positivo" : "saldo-negativo";
            return `<td class="${classeCor}">${formatarMoeda(mesSaldo)}</td>`;
          }).join("")}
          <td class="${saldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(saldo)}</td>
          <td class="${mediaSaldo >= 0 ? "saldo-positivo" : "saldo-negativo"}">${formatarMoeda(mediaSaldo)}</td>
        </tr>
        ${spacerRowHTML}
        <tr class="cartao-laranja">
          <td>Cartão de Crédito</td>
          ${cartao.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(cartao.total)}</td>
          <td>${formatarMoeda(mediaCartao)}</td>
        </tr>
        <tr class="conta-amarela">
          <td>Conta</td>
          ${conta.meses.map((m) => `<td>${formatarMoeda(m)}</td>`).join("")}
          <td>${formatarMoeda(conta.total)}</td>
          <td>${formatarMoeda(mediaConta)}</td>
        </tr>
      `;

      dadosResumo = {
        receitas: receitas,
        fixas: fixas,
        variaveis: variaveis,
        totalReceitas: totalReceitas,
        totalFixas: totalFixas,
        totalVariaveis: totalVariaveis,
        totalDespesas: totalDespesas,
        saldo: saldo,
        mediaReceitas: mediaReceitas, // Adicionado
        mediaFixas: mediaFixas,       // Adicionado
        mediaVariaveis: mediaVariaveis, // Adicionado
        mediaSaldo: mediaSaldo,       // Adicionado
        lancamentos: lancamentos,
      };

      atualizarGraficos();
    }

    function atualizarGraficos() {
      if (!dadosResumo) return;
      const mesSelecionado = parseInt(document.getElementById("mesSelecionado").value);
      let receitaPeriodo, fixasPeriodo, variaveisPeriodo, saldoPeriodo;

      if (mesSelecionado === -1) { // Total Anual
        receitaPeriodo = dadosResumo.totalReceitas;
        fixasPeriodo = dadosResumo.totalFixas;
        variaveisPeriodo = dadosResumo.totalVariaveis;
        saldoPeriodo = dadosResumo.saldo;
      } else if (mesSelecionado === -2) { // Médias Mensais
        receitaPeriodo = dadosResumo.mediaReceitas;
        fixasPeriodo = dadosResumo.mediaFixas;
        variaveisPeriodo = dadosResumo.mediaVariaveis;
        saldoPeriodo = dadosResumo.mediaSaldo;
      } else { // Mês específico
        receitaPeriodo = dadosResumo.receitas.meses[mesSelecionado] || 0;
        fixasPeriodo = dadosResumo.fixas.meses[mesSelecionado] || 0;
        variaveisPeriodo = dadosResumo.variaveis.meses[mesSelecionado] || 0;
        saldoPeriodo = receitaPeriodo - fixasPeriodo - variaveisPeriodo;
      }

      atualizarGraficoDespesasPoupanca(fixasPeriodo, variaveisPeriodo, saldoPeriodo);
      // Passa o valor original de mesSelecionado para a função do segundo gráfico decidir como agregar
      atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado);
    }

    function atualizarGraficoDespesasPoupanca(fixas, variaveis, saldo) {
      const ctx = document.getElementById("graficoDespesasPoupanca").getContext("2d");
      if (graficoDespesasPoupanca) graficoDespesasPoupanca.destroy();
      const total = fixas + variaveis + Math.max(0, saldo);
      const labels = [];
      const data = [];
      const backgroundColors = [];
      if (fixas > 0) { labels.push("Despesas Fixas"); data.push(fixas); backgroundColors.push("#f44336"); }
      if (variaveis > 0) { labels.push("Despesas Variáveis"); data.push(variaveis); backgroundColors.push("#ff9800"); }
      if (saldo > 0) { labels.push("Potencial de Investimento"); data.push(saldo); backgroundColors.push("#1976d2"); } // Cor alterada para azul
      if (data.length === 0) {
        document.getElementById("legendaDespesasPoupanca").innerHTML = "<p style=\"text-align:center;\">Sem dados para exibir.</p>";
        return;
      }
      const percentuais = total > 0 ? data.map((val) => ((val / total) * 100).toFixed(1) + "%") : data.map(() => "0%");
      const legendaHTML = labels.map((label, i) => `
        <div class="item-legenda">
          <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
          <span class="descricao-legenda">${label}</span>
          <span class="valor-legenda">${formatarMoeda(data[i])}</span>
          <span>(${percentuais[i]})</span>
        </div>
      `).join("");
      document.getElementById("legendaDespesasPoupanca").innerHTML = legendaHTML;
      graficoDespesasPoupanca = new Chart(ctx, {
        type: "pie",
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const currentTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = currentTotal > 0 ? Math.round((value / currentTotal) * 100) : 0;
                  return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    function atualizarGraficoDespesasReceitas(receitaPeriodo, mesSelecionado) {
      const ctx = document.getElementById("graficoDespesasReceitas").getContext("2d");
      if (graficoDespesasReceitas) graficoDespesasReceitas.destroy();

      const despesasAgrupadas = {};
      const anoAtual = new Date().getFullYear();

      // Filtra apenas as despesas
      const todasDespesas = dadosResumo.lancamentos.filter((l) => l.tipo !== "receita");

      todasDespesas.forEach((despesa) => {
        let valorDespesa = 0;

        if (mesSelecionado === -2) { // Médias Mensais
          // Calcula o total anual da despesa
          let totalAnualDespesa = 0;
          if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
            totalAnualDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            for (let i = 0; i < 12; i++) {
              if (despesa.valoresManuais[i] === null) {
                const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
                totalAnualDespesa += despesa.valor * ocorrenciasMesSemManual.length;
              }
            }
          } else {
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            totalAnualDespesa = despesa.valor * ocorrencias.length;
          }
          valorDespesa = totalAnualDespesa / 12; // Calcula a média mensal

        } else if (mesSelecionado === -1) { // Total Anual
          // Lógica existente para Total Anual
          if (despesa.valoresManuais && despesa.valoresManuais.some((v) => v !== null)) {
             valorDespesa = despesa.valoresManuais.reduce((sum, val) => sum + (val !== null ? val : 0), 0);
             const ocorrencias = calcularOcorrencias(despesa, anoAtual);
             for(let i=0; i<12; i++){
                 if(despesa.valoresManuais[i] === null){ 
                     const ocorrenciasMesSemManual = ocorrencias.filter(d => d.getMonth() === i);
                     valorDespesa += despesa.valor * ocorrenciasMesSemManual.length;
                 }
             }
          } else {
            const ocorrencias = calcularOcorrencias(despesa, anoAtual);
            valorDespesa = despesa.valor * ocorrencias.length;
          }
        } else { // Mês Específico
           // Lógica existente para Mês Específico
           const ocorrencias = calcularOcorrencias(despesa, anoAtual);
           const temOcorrenciaNoMes = ocorrencias.some((d) => d.getMonth() === mesSelecionado);
           const temValorManualNoMes = despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null;
           
           // Só processa se houver ocorrência ou valor manual no mês selecionado
           if(temOcorrenciaNoMes || temValorManualNoMes){
                if (despesa.valoresManuais && despesa.valoresManuais[mesSelecionado] !== null) {
                    valorDespesa = despesa.valoresManuais[mesSelecionado];
                } else {
                    const ocorrenciasNoMes = ocorrencias.filter((d) => d.getMonth() === mesSelecionado);
                    valorDespesa = despesa.valor * ocorrenciasNoMes.length;
                }
           }
        }

        // Agrupa por descrição se o valor for maior que zero
        if (valorDespesa > 0) {
          const key = despesa.descricao;
          if (!despesasAgrupadas[key]) {
            despesasAgrupadas[key] = { valor: 0, tipo: despesa.tipo, formaPagamento: despesa.formaPagamento };
          }
          despesasAgrupadas[key].valor += valorDespesa;
        }
      });

      // Continua com a lógica de plotagem do gráfico (labels, data, backgroundColors...)
      const labels = [];
      const data = [];
      const backgroundColors = [];
      const tipos = [];
      const despesasOrdenadas = Object.entries(despesasAgrupadas).map(([descricao, info]) => ({ descricao, ...info })).sort((a, b) => b.valor - a.valor);
      const limiteGrafico = 10;
      const despesasParaGrafico = despesasOrdenadas.slice(0, limiteGrafico);
      let outrasDespesas = despesasOrdenadas.slice(limiteGrafico).reduce((sum, d) => sum + d.valor, 0);

      despesasParaGrafico.forEach((d) => {
        labels.push(d.descricao);
        data.push(d.valor);
        // Mantém a lógica de cores original
        if (d.tipo === "fixa") backgroundColors.push(d.formaPagamento === "credito" ? "#c62828" : "#f44336");
        else backgroundColors.push(d.formaPagamento === "credito" ? "#f57c00" : "#ff9800");
        tipos.push(d.tipo);
      });

      if (outrasDespesas > 0) {
        labels.push("Outras Despesas");
        data.push(outrasDespesas);
        backgroundColors.push("#757575");
        tipos.push("variavel");
      }

      const totalDespesasPeriodo = data.reduce((sum, val) => sum + val, 0);
      const restante = Math.max(0, receitaPeriodo - totalDespesasPeriodo);

      if (data.length === 0 && restante <= 0) {
        document.getElementById("legendaDespesasReceitas").innerHTML = "<p style=\"text-align:center;\">Sem despesas para exibir neste período.</p>";
        if (graficoDespesasReceitas) {
          graficoDespesasReceitas.destroy();
          graficoDespesasReceitas = null;
        }
        return;
      }

      // Adiciona o 'Restante' apenas se houver despesas ou se o restante for positivo
      if (restante > 0 || data.length > 0) {
         labels.push("Restante (Receita - Despesas)");
         data.push(restante);
         backgroundColors.push("#1976d2"); // Cor azul para o restante
         tipos.push("receita"); // Usa 'receita' como tipo para a legenda
      }

      // Recalcula percentuais com base na receita do período (total anual, média ou mensal)
      const percentuais = receitaPeriodo > 0 ? data.map((val) => ((val / receitaPeriodo) * 100).toFixed(1) + "%") : data.map(() => "0%");

      const legendaHTML = labels.map((label, i) => {
        const tipo = tipos[i];
        // Define a classe de cor baseada no tipo (fixa, variavel, receita para o restante)
        const classeCor = tipo === "fixa" ? "fixa" : tipo === "variavel" ? "variavel" : "receita"; 
        const percentualExibido = receitaPeriodo > 0 ? `(${percentuais[i]})` : "";
        return `
          <div class="item-legenda">
            <div class="cor-legenda" style="background-color: ${backgroundColors[i]}"></div>
            <span class="descricao-legenda ${classeCor}">${label}</span>
            <span class="valor-legenda">${formatarMoeda(data[i])}</span>
            <span>${percentualExibido}</span>
          </div>
        `;
      }).join("");
      document.getElementById("legendaDespesasReceitas").innerHTML = legendaHTML;

      // Cria ou atualiza o gráfico
      graficoDespesasReceitas = new Chart(ctx, {
        type: "pie", // Mantido como pie
        data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, borderWidth: 1, borderColor: "#014034" }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  // Usa o array de percentuais calculado anteriormente
                  const percentage = percentuais[context.dataIndex] || "0%"; 
                  const percentualExibido = receitaPeriodo > 0 ? `(${percentage})` : "";
                  return `${label}: ${formatarMoeda(value)} ${percentualExibido}`;
                },
              },
            },
          },
        },
      });
    }

    // Funções de Manipulação de Dados (LocalStorage)
    function adicionarLancamento() {
      const descricaoInput = document.getElementById("descricao");
      const valorInput = document.getElementById("valor");
      const formaPagamentoSelect = document.getElementById("formaPagamento");
      const tipoSelect = document.getElementById("tipoLancamento");
      const frequenciaValorInput = document.getElementById("frequenciaValor");
      const frequenciaTipoSelect = document.getElementById("frequenciaTipo");
      const dataInicialInput = document.getElementById("dataInicial");
      const dataFinalInput = document.getElementById("dataFinal");
      const descricao = descricaoInput.value.trim();
      const valorStr = valorInput.value.trim();
      const formaPagamento = formaPagamentoSelect.value;
      const tipo = tipoSelect.value;
      const frequenciaValor = parseInt(frequenciaValorInput.value) || 1;
      const frequenciaTipo = frequenciaTipoSelect.value;
      let dataInicial = dataInicialInput.value;
      let dataFinal = dataFinalInput.value;
      if (!descricao || !valorStr) {
        alert("Preencha a descrição e o valor.");
        return;
      }
      if (tipo === "receita" && formaPagamento !== "conta") {
        alert("Receitas devem ser lançadas apenas como \"Conta\"");
        formaPagamentoSelect.value = "conta";
        return;
      }
      const valorNumerico = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
      if (isNaN(valorNumerico)) {
        alert("Valor inválido.");
        return;
      }
      const currentYear = new Date().getFullYear();
      if (!dataInicial) dataInicial = `${currentYear}-01-01`;
      if (!dataFinal) dataFinal = `${currentYear}-12-31`;
      let lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const novoId = lancamentos.length > 0 ? Math.max(...lancamentos.map((l) => l.id)) + 1 : 1;
      lancamentos.push({
        id: novoId,
        descricao,
        valor: valorNumerico,
        formaPagamento,
        tipo,
        frequenciaValor,
        frequenciaTipo,
        dataInicial,
        dataFinal,
        valoresManuais: Array(12).fill(null),
      });
      localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
      descricaoInput.value = "";
      valorInput.value = "";
      fecharModal();
      carregarLancamentos();
    }

    function carregarLancamentos() {
      const tabelaBody = document.getElementById("tabelaBody");
      tabelaBody.innerHTML = "";
      lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const currentYear = new Date().getFullYear();
      const lancamentosOrdenados = ordenarLancamentos(lancamentos);
      lancamentosOrdenados.forEach((l) => {
        const tr = document.createElement("tr");
        if (l.formaPagamento === "credito" && l.tipo !== "receita") tr.classList.add("cartao-credito");
        if (!l.valoresManuais) l.valoresManuais = Array(12).fill(null);
        const meses = Array(12).fill(0);
        const ocorrencias = calcularOcorrencias(l, currentYear);
        // Calcula valor para cada mês (considerando manual ou ocorrências)
        for (let index = 0; index < 12; index++) {
            if (l.valoresManuais[index] !== null) {
                meses[index] = l.valoresManuais[index];
            } else {
                const ocorrenciasNoMes = ocorrencias.filter(data => data.getMonth() === index);
                meses[index] = l.valor * ocorrenciasNoMes.length;
            }
        }
        
        const total = meses.reduce((sum, val) => sum + val, 0);
        const media = total / 12;
        tr.innerHTML = `
          <td class="hidden-id">${l.id}</td>
          <td class="${l.tipo}">${l.descricao}</td>
          ${meses.map((m, index) => `
            <td class="editable" data-id="${l.id}" data-month="${index}">
              ${formatarMoeda(m)} 
            </td>
          `).join("")}
          <td>${formatarMoeda(total)}</td>
          <td>${formatarMoeda(media)}</td>
          <td><button class="delete-btn" onclick="excluirLancamento(${l.id})">Excluir</button></td>
        `;
        tabelaBody.appendChild(tr);
      });
      document.querySelectorAll(".editable").forEach((cell) => {
        cell.addEventListener("click", function () {
          if (!this.querySelector(".edit-input")) {
            iniciarEdicao(this);
          }
        });
      });
      atualizarResumoFinanceiro(lancamentos, currentYear);
    }

    function excluirLancamento(id) {
      if (confirm("Tem certeza que deseja excluir este lançamento?")) {
        let lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
        lancamentos = lancamentos.filter((l) => l.id !== id);
        localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
        carregarLancamentos();
      }
    }

    function iniciarEdicao(cell) {
      const id = parseInt(cell.getAttribute("data-id"));
      const month = parseInt(cell.getAttribute("data-month"));
      const currentValueText = cell.textContent.trim();
      const valorNumericoAtual = parseFloat(currentValueText.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
      const valorParaInput = valorNumericoAtual.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(".", "");
      cell.innerHTML = "";
      const input = document.createElement("input");
      input.type = "text";
      input.className = "edit-input";
      input.value = valorParaInput;
      input.addEventListener("input", function () {
        let v = this.value.replace(/[^\d]/g, "");
        if (!v) { this.value = ""; return; }
        if (v.length < 3) v = v.padStart(3, "0");
        let inteiro = v.slice(0, -2).replace(/^0+/, "") || "0";
        const decimal = v.slice(-2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + decimal;
      });
      cell.appendChild(input);
      input.focus();
      input.select();
      const blurHandler = () => {
        finalizarEdicao(input, id, month, cell);
        input.removeEventListener("blur", blurHandler);
      };
      input.addEventListener("blur", blurHandler);
      input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          input.removeEventListener("blur", blurHandler);
          finalizarEdicao(input, id, month, cell);
        }
      });
      input.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          input.removeEventListener("blur", blurHandler);
          cell.innerHTML = currentValueText;
        }
      });
    }

    function finalizarEdicao(input, id, month, cell) {
      const novoValorStr = input.value.trim();
      let lancamentos = JSON.parse(localStorage.getItem("lancamentos") || "[]");
      const lancamento = lancamentos.find((l) => l.id === id);
      if (lancamento) {
        let valorNumerico = 0;
        if (novoValorStr && novoValorStr !== "-") {
          valorNumerico = parseFloat(novoValorStr.replace(/\./g, "").replace(",", "."));
          if (isNaN(valorNumerico)) valorNumerico = 0;
        }
        if (!lancamento.valoresManuais) lancamento.valoresManuais = Array(12).fill(null);
        lancamento.valoresManuais[month] = valorNumerico;
        localStorage.setItem("lancamentos", JSON.stringify(lancamentos));
        carregarLancamentos();
      } else {
        cell.innerHTML = formatarMoeda(0);
      }
    }

    function ordenarLancamentos(lancamentos) {
      const entradas = lancamentos.filter((l) => l.tipo === "receita").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const fixasNaoCredito = lancamentos.filter((l) => l.tipo === "fixa" && l.formaPagamento !== "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const fixasCredito = lancamentos.filter((l) => l.tipo === "fixa" && l.formaPagamento === "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const variaveisNaoCredito = lancamentos.filter((l) => l.tipo === "variavel" && l.formaPagamento !== "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      const variaveisCredito = lancamentos.filter((l) => l.tipo === "variavel" && l.formaPagamento === "credito").sort((a, b) => a.descricao.localeCompare(b.descricao));
      return [...entradas, ...fixasNaoCredito, ...fixasCredito, ...variaveisNaoCredito, ...variaveisCredito];
    }

    // Inicialização
    document.addEventListener("DOMContentLoaded", function () {
      carregarLancamentos();
      document.getElementById("valor").addEventListener("input", function () {
        let v = this.value.replace(/[^\d]/g, "");
        if (!v) { this.value = ""; return; }
        if (v.length < 3) v = v.padStart(3, "0");
        let inteiro = v.slice(0, -2).replace(/^0+/, "") || "0";
        const decimal = v.slice(-2);
        this.value = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + decimal;
      });
      // *** CORREÇÃO APLICADA AQUI (v5) ***
      document.getElementById("tipoLancamento").addEventListener("change", function () {
        const formaPagamentoSelect = document.getElementById("formaPagamento");
        if (this.value === "receita") {
          formaPagamentoSelect.innerHTML = `<option value="conta">Conta</option>`; // Corrigido
          formaPagamentoSelect.value = "conta"; // Garantir seleção
        } else {
          const valorAtual = formaPagamentoSelect.value;
          formaPagamentoSelect.innerHTML = `
            <option value="conta">Conta</option>
            <option value="credito">Cartão de Crédito</option>
          `;
          if (valorAtual === "conta" || valorAtual === "credito") {
            formaPagamentoSelect.value = valorAtual;
          } else {
            formaPagamentoSelect.value = "conta";
          }
        }
      });
      document.getElementById("tipoLancamento").dispatchEvent(new Event("change"));
    });

  </script>
</body>
</html>
