<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Múltiplos Objetivos</title>
  <link rel="icon" href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --verde-esmeralda: #046c4e;
      --verde-esmeralda-escuro: #034e38;
      --verde-claro: #28a745;
      --verde-medio: #218838;
      --dourado: #d4af37;
      --dourado-claro: #f5e2a9;
      --dourado-escuro: #b38e2e;
      --roxo: #6f42c1;
      --roxo-claro: #9f75e5;
      --roxo-escuro: #4b2882;
      --fundo-claro: #f9f9f9;
      --fundo-container: #ffffff;
      --vermelho-translucido: rgba(255, 0, 0, 0.1);
      --azul-translucido: rgba(0, 0, 255, 0.1);
      --roxo-translucido: rgba(111, 66, 193, 0.1);
      --cinza-claro: #e9ecef;
      --cinza-medio: #ced4da;
      --cinza-escuro: #6c757d;
      --verde-destaque: rgba(4, 108, 78, 0.1);
      --vermelho-destaque: rgba(220, 53, 69, 0.1);
      --sombra-padrao: 0 4px 12px rgba(0,0,0,0.1);
      --borda-arredondada: 8px;
      --espacamento-padrao: 20px;
      --transicao-padrao: all 0.3s ease;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      padding: var(--espacamento-padrao);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      margin-bottom: var(--espacamento-padrao);
      font-weight: 600;
      line-height: 1.3;
    }
    h1 {
      color: var(--verde-esmeralda-escuro);
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 1.5rem;
      border-bottom: 3px solid var(--dourado);
      padding-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    form {
      background-color: var(--fundo-container);
      padding: var(--espacamento-padrao);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
      margin-bottom: var(--espacamento-padrao);
      border: 1px solid var(--cinza-claro);
    }
    .result {
      margin-top: var(--espacamento-padrao);
      padding: var(--espacamento-padrao);
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation {
      margin: var(--espacamento-padrao) 0;
      padding: var(--espacamento-padrao);
      border: 2px solid var(--verde-esmeralda);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .recommendation h3 {
      color: var(--verde-esmeralda-escuro);
      margin-top: 0;
      border-bottom: 2px solid var(--dourado);
      padding-bottom: 10px;
      font-size: 1.4rem;
    }
    .whatsapp-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      background-color: var(--verde-esmeralda);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .whatsapp-button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .save-scenario-button, .analyze-scenario-button, .new-scenario-button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: var(--espacamento-padrao) 0;
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--sombra-padrao);
      transition: var(--transicao-padrao);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .save-scenario-button { background-color: var(--dourado); }
    .save-scenario-button:hover { background-color: var(--dourado-escuro); transform: translateY(-2px); }
    .analyze-scenario-button { background-color: var(--verde-esmeralda); }
    .analyze-scenario-button:hover { background-color: var(--verde-esmeralda-escuro); transform: translateY(-2px); }
    .new-scenario-button { background-color: var(--dourado); }
    .new-scenario-button:hover { background-color: var(--dourado-escuro); transform: translateY(-2px); }

    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--verde-esmeralda-escuro);
    }
    .row {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
    }
    .row > div {
      flex: 1;
      min-width: 150px; /* Prevent fields from becoming too narrow */
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid var(--cinza-medio);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
      font-size: 1rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--dourado);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    textarea {
      min-height: 80px; /* Reduced height */
      resize: vertical;
    }
    button {
      margin-top: 20px;
      padding: 14px;
      background-color: var(--verde-esmeralda);
      color: white;
      border: none;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 1rem;
      transition: var(--transicao-padrao);
      letter-spacing: 0.5px;
    }
    button:hover {
      background-color: var(--verde-esmeralda-escuro);
      transform: translateY(-2px);
    }
    .chart-container {
      margin-top: 30px;
      position: relative;
      border: 2px solid var(--dourado-claro);
      border-radius: var(--borda-arredondada);
      padding: 20px;
      background-color: var(--fundo-container);
      box-shadow: var(--sombra-padrao);
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      color: var(--verde-esmeralda-escuro);
      font-size: 1.2rem;
      border-bottom: 1px solid var(--dourado);
      padding-bottom: 10px;
    }
    .chart-nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .chart-nav button {
      padding: 10px 20px;
      margin-top: 0;
      width: auto;
      font-size: 0.9rem;
      background-color: var(--dourado);
      border-radius: var(--borda-arredondada);
      transition: var(--transicao-padrao);
    }
    .chart-nav button:hover {
      background-color: var(--dourado-escuro);
    }
    .chart-content {
      display: flex;
      overflow: hidden;
      position: relative;
      height: 400px;
      border: 1px solid var(--cinza-claro);
      border-radius: var(--borda-arredondada);
      background-color: var(--fundo-container);
    }
    .chart-slide {
      flex: 0 0 100%;
      transition: transform 0.3s ease;
    }
    .table-slide {
      flex: 0 0 100%;
      overflow-x: auto;
      overflow-y: auto;
      padding: 15px;
      background-color: var(--fundo-container);
      max-height: 400px; /* Limit table height */
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      min-width: 800px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .data-table th, .data-table td {
      border: 1px solid var(--cinza-claro);
      padding: 10px;
      text-align: right;
      white-space: nowrap;
    }
    .data-table th {
      background-color: var(--verde-esmeralda);
      color: white;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table tr:nth-child(even) {
      background-color: var(--verde-destaque);
    }
    .data-table tr:hover {
      background-color: var(--dourado-claro);
    }
    .scenarios-container {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--dourado);
      background-color: var(--fundo-container);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
    }
    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--verde-esmeralda);
      padding-bottom: 10px;
    }
    .scenarios-header h3 {
      color: var(--verde-esmeralda-escuro);
      margin: 0;
      font-size: 1.4rem;
    }
    .scenario-card {
      border: 1px solid var(--cinza-medio);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--cinza-claro);
      position: relative;
    }
    .scenario-card.active {
      border: 2px solid var(--verde-esmeralda);
      background-color: white;
    }
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .scenario-title {
      font-weight: bold;
      color: var(--verde-esmeralda);
      margin: 0;
    }
    .scenario-actions {
      display: flex;
      gap: 10px;
    }
    .scenario-actions button {
      padding: 5px 10px;
      margin: 0;
      width: auto;
      font-size: 12px;
    }
    .scenario-delete {
      background-color: #dc3545;
    }
    .scenario-delete:hover {
      background-color: #c82333;
    }
    .scenario-select {
      background-color: var(--dourado);
    }
    .scenario-select:hover {
      background-color: var(--dourado-escuro);
    }
    .scenario-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .scenario-info {
      flex: 1;
      min-width: 200px;
    }
    .scenario-info p {
      margin: 5px 0;
    }
    .scenario-info strong {
      color: var(--verde-esmeralda);
    }
    .scenario-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--fundo-claro);
      border-radius: 5px;
      font-size: 14px;
    }
    .scenario-details ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .scenario-details li {
      margin-bottom: 5px;
    }
    /* Estilos para comparação de cenários */
    .comparison-container {
      margin-top: 30px;
      border: 2px solid var(--roxo);
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    .comparison-header {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }
    .comparison-chart-container {
      height: 400px;
      margin: 20px 0;
    }
    #comparisonTableContainer {
      overflow-x: auto; /* Habilitar rolagem horizontal */
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 900px; /* Garantir largura mínima para forçar rolagem se necessário */
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      white-space: nowrap; /* Evitar quebra de linha nas células */
    }
    .comparison-table th {
      background-color: var(--roxo-translucido);
      color: var(--roxo-escuro);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .comparison-table tr:nth-child(even) {
      background-color: var(--fundo-claro);
    }
    .comparison-table .best-value {
      font-weight: bold;
      color: var(--verde-esmeralda);
      background-color: var(--verde-destaque);
    }
    .comparison-table .worst-value {
      font-weight: bold;
      color: #dc3545;
      background-color: var(--vermelho-destaque);
    }
    .general-analysis {
      margin-top: 30px;
      padding: 20px;
      border: 2px solid var(--roxo);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .general-analysis h3 {
      color: var(--roxo);
      margin-top: 0;
      border-bottom: 1px solid var(--dourado-claro);
      padding-bottom: 10px;
      text-align: center;
    }

    /* Estilos para a seção de múltiplos objetivos */
    .objectives-section {
      background-color: var(--fundo-container);
      padding: var(--espacamento-padrao);
      border-radius: var(--borda-arredondada);
      box-shadow: var(--sombra-padrao);
      margin-bottom: var(--espacamento-padrao);
      border: 1px solid var(--cinza-claro);
    }
    .objectives-section h3 {
      color: var(--verde-esmeralda);
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--dourado);
      padding-bottom: 10px;
    }
    .objective-input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end; /* Align items to bottom for button */
      margin-bottom: 15px;
    }
    .objective-input-group > div {
      flex: 1;
      min-width: 120px;
    }
    .objective-input-group button {
      flex-basis: 100px; /* Fixed width for button */
      margin-top: 0; /* Remove default top margin */
      padding: 12px; /* Match input padding */
      height: 46px; /* Match input height */
      font-size: 0.9rem;
      width: auto;
    }
    #objectivesList {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--cinza-medio);
      border-radius: var(--borda-arredondada);
      padding: 10px;
    }
    .objective-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--cinza-claro);
      background-color: var(--fundo-claro);
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .objective-item:last-child {
      border-bottom: none;
    }
    .objective-item span {
      flex-grow: 1;
      margin-right: 10px;
      font-size: 0.9rem;
    }
    .objective-item button {
      padding: 4px 8px;
      margin: 0;
      width: auto;
      font-size: 0.8rem;
      background-color: #dc3545;
      line-height: 1;
    }
    .objective-item button:hover {
      background-color: #c82333;
    }

  </style>
</head>
<body>
  <h1>Calculadora de Múltiplos Objetivos</h1>

  <!-- Seção para Adicionar/Gerenciar Objetivos -->
  <div class="objectives-section">
    <h3>Seus Objetivos</h3>
    <div class="objective-input-group">
      <div>
        <label for="newObjectiveDescription">Descrição</label>
        <input type="text" id="newObjectiveDescription" placeholder="Ex: Viagem Europa">
      </div>
      <div>
        <label for="newObjectiveValue">Valor (R$)</label>
        <input type="text" id="newObjectiveValue" placeholder="R$ 15.000,00" oninput="formatCurrency(this)">
      </div>
      <div>
        <label for="newObjectivePeriod">Prazo (meses)</label>
        <input type="number" id="newObjectivePeriod" placeholder="24">
      </div>
      <button type="button" onclick="addObjective()">Adicionar</button>
    </div>
    <div id="objectivesListContainer">
      <label>Objetivos Adicionados:</label>
      <div id="objectivesList">
        <!-- Objetivos serão listados aqui -->
        <p style="text-align: center; color: var(--cinza-escuro);">Nenhum objetivo adicionado ainda.</p>
      </div>
    </div>
  </div>

  <!-- Formulário Principal com Parâmetros Financeiros Comuns -->
  <form id="savingsForm" onsubmit="event.preventDefault(); calculateSavings();">
    <h3>Parâmetros Financeiros</h3>

    <label for="currentSavings">Valor já Guardado (R$):</label>
    <input type="text" id="currentSavings" required oninput="formatCurrency(this)">

    <label for="currentContribution">Quanto você poupa atualmente por mês (R$):</label>
    <input type="text" id="currentContribution" required oninput="formatCurrency(this)">

    <div class="row">
      <div>
        <label for="rate">Taxa de Juros (%):</label>
        <input type="text" id="rate" required oninput="formatPercentage(this)">
      </div>
      <div>
        <label for="rateType">Tipo de Taxa:</label>
        <select id="rateType">
          <option value="annual">Anual</option>
          <option value="monthly">Mensal</option>
        </select>
      </div>
    </div>

    <label>Você sabe a alíquota de imposto sobre o rendimento?</label>
    <div class="row">
      <div>
        <select id="knowsTax" onchange="toggleTaxInput('tax', '15,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="tax" placeholder="15,00 %" value="15,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <label>Você sabe a taxa de inflação anual?</label>
    <div class="row">
      <div>
        <select id="knowsInflation" onchange="toggleTaxInput('inflation', '5,00 %')">
          <option value="no">Não</option>
          <option value="yes">Sim</option>
        </select>
      </div>
      <div>
        <input type="text" id="inflation" placeholder="5,00 %" value="5,00 %" oninput="formatPercentage(this)" disabled>
      </div>
    </div>

    <button type="submit">Calcular Cenário</button>
  </form>

  <div id="result" class="result" style="display: none;"></div>

  <div id="recommendation" class="recommendation" style="display: none;">
    <h3>Análise Automatizada</h3>
    <div id="recommendationText"></div>
  </div>

  <!-- Botões para salvar cenário, analisar cenários e simular outro cenário -->
  <div class="row" style="margin-top: 20px;">
    <div style="flex: 1; margin-right: 10px;">
      <button id="saveScenarioButton" class="save-scenario-button" type="button" onclick="addCurrentScenario()" style="display: none;">
        SALVAR CENÁRIO
      </button>
    </div>
    <div style="flex: 1; margin-left: 10px; margin-right: 10px;">
      <button id="analyzeScenarioButton" class="analyze-scenario-button" type="button" onclick="analyzeScenarios()" style="display: none;">
        ANALISAR CENÁRIOS
      </button>
    </div>
    <div style="flex: 1; margin-left: 10px;">
      <button id="newScenarioButton" class="new-scenario-button" type="button" onclick="prepareNewScenario()" style="display: none;">
        LIMPAR PARA NOVO CÁLCULO
      </button>
    </div>
  </div>

  <!-- Botão WhatsApp para análise personalizada - sempre visível após cálculo -->
  <a id="whatsappButton" href="#" class="whatsapp-button" onclick="openWhatsAppChat()" style="display: none;">
    AVANÇAR PARA ANÁLISE PERSONALIZADA
  </a>

  <!-- Container Único para Gráfico/Tabela de Projeção -->
  <div id="projectionChartContainer" class="chart-container" style="display: none;">
    <div class="chart-title">Evolução da Projeção Financeira</div>
    <div class="chart-nav">
      <button type="button" onclick="showChartSlide('Projection', 'chart')">Gráfico</button>
      <button type="button" onclick="showChartSlide('Projection', 'table')">Memória de Cálculo</button>
    </div>
    <div class="chart-content">
      <div id="chartProjectionSlide" class="chart-slide">
        <canvas id="chartProjection"></canvas>
      </div>
      <div id="tableProjectionSlide" class="table-slide" style="display: none;">
        <table id="tableProjection" class="data-table">
          <thead>
            <tr>
              <th scope="col">Mês</th>
              <th scope="col">Total Investido</th>
              <th scope="col">Juros</th>
              <th scope="col">Total Juros</th>
              <th scope="col">Total Acumulado</th>
              <th scope="col">Imposto</th>
              <th scope="col">Valor Líquido</th>
              <!-- <th scope="col">Objetivo Corrigido</th> Coluna removida/adaptada -->
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Container para Cenários Salvos -->
  <div id="scenariosContainer" class="scenarios-container" style="display: none;">
    <div class="scenarios-header">
      <h3>Cenários Salvos</h3>
    </div>
    <div id="scenariosList"></div>
  </div>

  <!-- Container para Comparação de Cenários -->
  <div id="comparisonContainer" class="comparison-container" style="display: none;">
    <h3 class="comparison-header">Comparação de Cenários</h3>
    <div id="comparisonChartContainer" class="comparison-chart-container">
      <canvas id="comparisonChart"></canvas>
    </div>
    <div id="comparisonTableContainer">
      <table id="comparisonTable" class="comparison-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Container para Análise Geral -->
   <div id="generalAnalysis" class="general-analysis" style="display: none;">
    <h3>Análise Geral dos Cenários</h3>
    <div id="generalAnalysisText"></div>
  </div>


  <script>
    // --- Variáveis Globais ---
    let objectives = []; // Array para armazenar os múltiplos objetivos
    let scenarios = []; // Array para armazenar os cenários salvos
    let scenarioCounter = 1; // Contador para nomeação automática de cenários
    let currentCalculationData = null; // Armazena os dados do cálculo atual
    let projectionChart = null; // Referência para o gráfico de projeção
    let comparisonChart = null; // Referência para o gráfico de comparação

    // --- Funções de Formatação e Utilitários ---
    function formatCurrency(input) {
      let value = input.value.replace(/\D/g, "");
      value = (parseFloat(value) / 100).toFixed(2);
      if (isNaN(value) || value === "NaN") value = "0.00";
      input.value = "R$ " + parseFloat(value).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function formatPercentage(input) {
      let value = input.value.replace(/[^\d,]/g, "").replace(",", "."); // Permite vírgula como decimal
      value = parseFloat(value);
      if (isNaN(value)) value = 0;
      // Formata com duas casas decimais e vírgula
      input.value = value.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
    }

    function toggleTaxInput(id, defaultValue) {
      const selectElementId = id === "tax" ? "knowsTax" : "knowsInflation";
      const select = document.getElementById(selectElementId);
      const input = document.getElementById(id);
      if (select.value === "yes") {
        input.disabled = false;
        input.value = ""; // Limpa o valor se o usuário sabe
        input.placeholder = defaultValue; // Mantém o placeholder como guia
      } else {
        input.disabled = true;
        input.value = defaultValue; // Define o valor padrão se o usuário não sabe
      }
    }

    function parseCurrency(value) {
      if (typeof value !== 'string') return 0;
      return parseFloat(value.replace(/R\$\s?/g, "").replace(/\./g, "").replace(",", ".")) || 0;
    }

    function parsePercentage(value) {
       if (typeof value !== 'string') return 0;
      return parseFloat(value.replace(/%\s?/g, "").replace(",", ".")) / 100 || 0;
    }

    function formatMoney(value) {
        if (typeof value !== 'number' || isNaN(value)) {
            return "R$ 0,00";
        }
        return "R$ " + value.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function showChartSlide(containerId, slideType) {
      const chartSlide = document.getElementById(`chart${containerId}Slide`);
      const tableSlide = document.getElementById(`table${containerId}Slide`);

      if (slideType === "chart") {
        chartSlide.style.display = "block";
        tableSlide.style.display = "none";
      } else {
        chartSlide.style.display = "none";
        tableSlide.style.display = "block";
      }
    }

    // --- Funções de Gerenciamento de Objetivos ---
    function addObjective() {
      const descriptionInput = document.getElementById("newObjectiveDescription");
      const valueInput = document.getElementById("newObjectiveValue");
      const periodInput = document.getElementById("newObjectivePeriod");

      const description = descriptionInput.value.trim();
      const value = parseCurrency(valueInput.value);
      const period = parseInt(periodInput.value);

      if (!description) {
        alert("Por favor, insira uma descrição para o objetivo.");
        return;
      }
      if (isNaN(value) || value <= 0) {
        alert("Por favor, insira um valor válido para o objetivo.");
        return;
      }
      if (isNaN(period) || period <= 0) {
        alert("Por favor, insira um prazo válido (em meses) para o objetivo.");
        return;
      }

      objectives.push({ description, value, period });
      displayObjectives();

      // Limpar campos
      descriptionInput.value = "";
      valueInput.value = "";
      periodInput.value = "";
    }

    function deleteObjective(index) {
      objectives.splice(index, 1);
      displayObjectives();
    }

    function displayObjectives() {
      const listDiv = document.getElementById("objectivesList");
      listDiv.innerHTML = ""; // Limpar lista

      if (objectives.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: var(--cinza-escuro);">Nenhum objetivo adicionado ainda.</p>';
        return;
      }

      objectives.forEach((obj, index) => {
        const item = document.createElement("div");
        item.className = "objective-item";
        item.innerHTML = `
          <span>${obj.description} - ${formatMoney(obj.value)} em ${obj.period} meses</span>
          <button type="button" onclick="deleteObjective(${index})">Excluir</button>
        `;
        listDiv.appendChild(item);
      });
    }

    // --- Funções de Cálculo ---
    function calculateCompoundInterest(initialValue, monthlyContribution, monthlyRate, maxMonths, tax, annualInflation) {
      let totalValue = initialValue;
      let totalInvested = initialValue;
      let totalJuros = 0;
      let valoresMensais = [];
      const monthlyInflation = Math.pow(1 + annualInflation, 1/12) - 1;

      // Registrar valores iniciais (mês 0)
      valoresMensais.push({
        month: 0,
        juros: 0,
        totalInvestido: totalInvested,
        totalJuros: 0,
        imposto: 0,
        valorLiquido: totalValue,
        totalAcumulado: totalValue
      });

      for (let month = 1; month <= maxMonths; month++) {
        const jurosDoMes = totalValue * monthlyRate;
        totalJuros += jurosDoMes;
        totalValue += jurosDoMes + monthlyContribution;
        totalInvested += monthlyContribution;

        const impostoTotal = totalJuros * tax;
        const valorLiquido = totalValue - impostoTotal;

        valoresMensais.push({
          month: month,
          juros: jurosDoMes,
          totalInvestido: totalInvested,
          totalJuros: totalJuros,
          imposto: impostoTotal,
          valorLiquido: valorLiquido,
          totalAcumulado: totalValue
        });
      }

      return {
        finalValue: totalValue,
        totalInvested: totalInvested,
        totalJuros: totalJuros,
        totalImposto: totalJuros * tax,
        valoresMensais: valoresMensais
      };
    }

    function calculateSavings() {
      // Validar se há objetivos
      if (objectives.length === 0) {
        alert("Por favor, adicione pelo menos um objetivo antes de calcular.");
        return;
      }

      // Obter parâmetros financeiros comuns
      const currentSavings = parseCurrency(document.getElementById("currentSavings").value);
      const currentContribution = parseCurrency(document.getElementById("currentContribution").value);
      let rate = parsePercentage(document.getElementById("rate").value);
      const rateType = document.getElementById("rateType").value;
      const tax = parsePercentage(document.getElementById("tax").value);
      const inflation = parsePercentage(document.getElementById("inflation").value);

      // Converter taxa para mensal se for anual
      const monthlyRate = rateType === "annual" ? Math.pow(1 + rate, 1/12) - 1 : rate;

      // Determinar o período máximo de simulação baseado nos objetivos
      const maxPeriod = Math.max(...objectives.map(o => o.period), 0);
      if (maxPeriod <= 0) {
          alert("Erro ao determinar o prazo máximo dos objetivos.");
          return;
      }

      // Calcular a projeção financeira
      const projection = calculateCompoundInterest(currentSavings, currentContribution, monthlyRate, maxPeriod, tax, inflation);
      const valoresMensais = projection.valoresMensais;

      // Analisar atingimento de cada objetivo
      let resultHTML = "<h4>Resultado da Projeção:</h4>";
      let allGoalsMet = true;
      let recommendationDetails = [];

      objectives.forEach(obj => {
        const targetMonth = obj.period;
        let objectiveMet = false;
        let monthMet = -1;
        let finalNetValueForObjective = 0;

        if (targetMonth < valoresMensais.length) {
          const monthlyInflation = Math.pow(1 + inflation, 1/12) - 1;
          const inflatedObjectiveValue = obj.value * Math.pow(1 + monthlyInflation, targetMonth);
          finalNetValueForObjective = valoresMensais[targetMonth].valorLiquido;

          if (finalNetValueForObjective >= inflatedObjectiveValue) {
            objectiveMet = true;
            // Encontrar o mês exato em que foi atingido (opcional, mas bom ter)
            for(let m = 1; m <= targetMonth; m++) {
                const currentInflatedValue = obj.value * Math.pow(1 + monthlyInflation, m);
                if (valoresMensais[m].valorLiquido >= currentInflatedValue) {
                    monthMet = m;
                    break;
                }
            }
          } else {
            allGoalsMet = false;
          }

          resultHTML += `<p><strong>${obj.description}:</strong> `;
          if (objectiveMet) {
            resultHTML += `<span style="color: var(--verde-esmeralda);">Atingido!</span> (Valor líquido no mês ${targetMonth}: ${formatMoney(finalNetValueForObjective)} vs Objetivo corrigido: ${formatMoney(inflatedObjectiveValue)}). Atingido no mês ${monthMet}.</p>`;
          } else {
            resultHTML += `<span style="color: #dc3545;">Não Atingido.</span> (Valor líquido no mês ${targetMonth}: ${formatMoney(finalNetValueForObjective)} vs Objetivo corrigido: ${formatMoney(inflatedObjectiveValue)}). Faltam ${formatMoney(inflatedObjectiveValue - finalNetValueForObjective)}.</p>`;
          }
          recommendationDetails.push({ description: obj.description, met: objectiveMet, period: targetMonth, netValue: finalNetValueForObjective, targetValue: inflatedObjectiveValue });
        } else {
           resultHTML += `<p><strong>${obj.description}:</strong> Erro - Prazo do objetivo (${targetMonth} meses) excede a simulação.</p>`;
           allGoalsMet = false;
           recommendationDetails.push({ description: obj.description, met: false, period: targetMonth, netValue: 0, targetValue: obj.value });
        }
      });

      resultHTML += `<p><strong>Projeção Final (${maxPeriod} meses):</strong> Valor Líquido ${formatMoney(valoresMensais[maxPeriod].valorLiquido)} (Total Investido: ${formatMoney(valoresMensais[maxPeriod].totalInvestido)}, Juros Brutos: ${formatMoney(valoresMensais[maxPeriod].totalJuros)}, Imposto Estimado: ${formatMoney(valoresMensais[maxPeriod].imposto)})</p>`;

      document.getElementById("result").innerHTML = resultHTML;
      document.getElementById("result").style.display = "block";

      // Gerar recomendação
      generateRecommendation(recommendationDetails, currentContribution);

      // Desenhar gráfico e preencher tabela de projeção
      drawProjectionChart(valoresMensais);
      fillDataTable("tableProjection", valoresMensais);
      document.getElementById("projectionChartContainer").style.display = "block";
      showChartSlide('Projection', 'chart'); // Mostrar gráfico por padrão

      // Armazenar dados do cálculo atual para salvar cenário
      currentCalculationData = {
        objectives: JSON.parse(JSON.stringify(objectives)), // Deep copy
        currentSavings,
        currentContribution,
        rate: rateType === "annual" ? rate : monthlyRate, // Salvar a taxa original informada
        rateType,
        tax,
        inflation,
        calculationResult: projection, // Salvar os resultados calculados
        maxPeriod // Salvar o período máximo usado
      };

      // Mostrar botões de ação
      document.getElementById("saveScenarioButton").style.display = "block";
      document.getElementById("newScenarioButton").style.display = "block";
      document.getElementById("whatsappButton").style.display = "block";
      if (scenarios.length >= 1) { // Mostrar botão de análise se já houver cenários salvos
          document.getElementById("analyzeScenarioButton").style.display = "block";
      }
    }

    // --- Funções de Análise e Recomendação ---
    function generateRecommendation(objectiveResults, currentContribution) {
      const recommendationDiv = document.getElementById("recommendation");
      const recommendationText = document.getElementById("recommendationText");
      let analysis = "";
      let needsImprovement = false;

      objectiveResults.forEach(res => {
        if (!res.met) {
          needsImprovement = true;
          analysis += `<p><strong>${res.description}:</strong> O objetivo não foi atingido no prazo de ${res.period} meses. O valor líquido projetado é de ${formatMoney(res.netValue)}, enquanto o objetivo corrigido pela inflação seria ${formatMoney(res.targetValue)}. Seria necessário um valor adicional de ${formatMoney(res.targetValue - res.netValue)}.</p>`;
        }
      });

      if (!needsImprovement) {
        analysis += "<p><strong>Parabéns!</strong> Com os parâmetros atuais, todos os seus objetivos são atingidos dentro dos prazos definidos.</p>";
      } else {
        analysis += "<p><strong>Pontos de Atenção:</strong></p><ul>";
        if (currentContribution <= 0) {
            analysis += "<li>Iniciar aportes mensais é fundamental.</li>";
        } else {
            analysis += `<li>Avalie aumentar o aporte mensal atual de ${formatMoney(currentContribution)}.</li>`;
        }
        analysis += "<li>Considere buscar investimentos com maior rentabilidade (lembre-se que maior rentabilidade geralmente implica maior risco).</li>";
        analysis += "<li>Reavalie os prazos ou valores dos objetivos não atingidos, se possível.</li>";
        analysis += "</ul>";
      }

      recommendationText.innerHTML = analysis;
      recommendationDiv.style.display = "block";
    }

    // --- Funções de Gráficos e Tabelas ---
    function drawProjectionChart(valoresMensais) {
      const ctx = document.getElementById("chartProjection").getContext("2d");
      const labels = valoresMensais.map(v => v.month);
      const bruto = valoresMensais.map(v => v.totalAcumulado);
      const liquido = valoresMensais.map(v => v.valorLiquido);
      const investido = valoresMensais.map(v => v.totalInvestido);

      // Destruir gráfico existente se houver
      if (projectionChart) {
        projectionChart.destroy();
      }

      projectionChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Valor Bruto",
              data: bruto,
              borderColor: "rgba(4, 108, 78, 0.8)", // Verde Esmeralda
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.1
            },
            {
              label: "Valor Líquido (após IR)",
              data: liquido,
              borderColor: "rgba(212, 175, 55, 0.8)", // Dourado
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.1
            },
            {
              label: "Total Investido",
              data: investido,
              borderColor: "rgba(111, 66, 193, 0.6)", // Roxo
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatMoney(value);
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Meses'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += formatMoney(context.parsed.y);
                  }
                  return label;
                }
              }
            },
            legend: {
                position: 'top',
            }
          }
        }
      });
    }

    function fillDataTable(tableId, data) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = ""; // Limpar tabela

      // Começar do mês 1
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.month}</td>
          <td>${formatMoney(row.totalInvestido)}</td>
          <td>${formatMoney(row.juros)}</td>
          <td>${formatMoney(row.totalJuros)}</td>
          <td>${formatMoney(row.totalAcumulado)}</td>
          <td>${formatMoney(row.imposto)}</td>
          <td>${formatMoney(row.valorLiquido)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // --- Funções de Gerenciamento de Cenários ---
    function addCurrentScenario() {
      if (!currentCalculationData) {
        alert("Nenhum cálculo foi realizado para salvar como cenário.");
        return;
      }

      const scenarioData = {
        name: `Cenário ${scenarioCounter++}`,
        ...currentCalculationData // Inclui objectives, parâmetros financeiros, resultados
      };

      scenarios.push(scenarioData);
      displayScenarios();

      // Mostrar o botão de analisar cenários se houver mais de um cenário
      if (scenarios.length >= 1) { // Mudado para >= 1 para mostrar sempre que houver cenário salvo
        document.getElementById("analyzeScenarioButton").style.display = "block";
      }

      alert("Cenário salvo com sucesso!");
    }

    function displayScenarios() {
      const scenariosContainer = document.getElementById("scenariosContainer");
      const scenariosListDiv = document.getElementById("scenariosList");
      scenariosListDiv.innerHTML = ""; // Limpar lista

      if (scenarios.length === 0) {
        scenariosContainer.style.display = "none";
        return;
      }

      scenariosContainer.style.display = "block";

      scenarios.forEach((scenario, index) => {
        const card = document.createElement("div");
        card.className = "scenario-card";

        let objectivesSummary = "Nenhum";
        if (scenario.objectives && scenario.objectives.length > 0) {
            objectivesSummary = scenario.objectives.map(o => o.description).join(', ');
            if (objectivesSummary.length > 50) { // Limitar tamanho do resumo
                objectivesSummary = objectivesSummary.substring(0, 47) + '...';
            }
        }

        // Calcular status geral dos objetivos para este cenário
        let scenarioAllGoalsMet = true;
        let objectivesStatusHTML = "<ul>";
        if (scenario.objectives && scenario.calculationResult) {
            const valoresMensais = scenario.calculationResult.valoresMensais;
            const annualInflation = scenario.inflation;
            const monthlyInflation = Math.pow(1 + annualInflation, 1/12) - 1;

            scenario.objectives.forEach(obj => {
                const targetMonth = obj.period;
                let objectiveMet = false;
                if (targetMonth < valoresMensais.length) {
                    const inflatedObjectiveValue = obj.value * Math.pow(1 + monthlyInflation, targetMonth);
                    if (valoresMensais[targetMonth].valorLiquido >= inflatedObjectiveValue) {
                        objectiveMet = true;
                    }
                }
                if (!objectiveMet) scenarioAllGoalsMet = false;
                objectivesStatusHTML += `<li>${obj.description}: <span style="color: ${objectiveMet ? 'var(--verde-esmeralda)' : '#dc3545'}">${objectiveMet ? 'Atingido' : 'Não Atingido'}</span></li>`;
            });
        } else {
            scenarioAllGoalsMet = false; // Considerar não atingido se não houver dados
            objectivesStatusHTML += "<li>Dados de objetivos ou cálculo indisponíveis.</li>";
        }
        objectivesStatusHTML += "</ul>";


        card.innerHTML = `
          <div class="scenario-header">
            <h4 class="scenario-title">${scenario.name}</h4>
            <div class="scenario-actions">
              <button type="button" class="scenario-select" onclick="selectScenario(${index})">Carregar</button>
              <button type="button" class="scenario-delete" onclick="deleteScenario(${index})">Excluir</button>
            </div>
          </div>
          <div class="scenario-content">
            <div class="scenario-info">
              <p><strong>Guardado:</strong> ${formatMoney(scenario.currentSavings)}</p>
              <p><strong>Aporte:</strong> ${formatMoney(scenario.currentContribution)}</p>
              <p><strong>Taxa:</strong> ${(scenario.rate * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}% ${scenario.rateType === 'annual' ? 'a.a.' : 'a.m.'}</p>
              <p><strong>Inflação:</strong> ${(scenario.inflation * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%</p>
              <p><strong>Imposto:</strong> ${(scenario.tax * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%</p>
              <p><strong>Status Geral:</strong> <span style="font-weight: bold; color: ${scenarioAllGoalsMet ? 'var(--verde-esmeralda)' : '#dc3545'}">${scenarioAllGoalsMet ? 'Todos Objetivos Atingidos' : 'Objetivos Pendentes'}</span></p>
            </div>
            <div class="scenario-details">
              <strong>Objetivos:</strong>
              ${objectivesStatusHTML}
            </div>
          </div>
        `;
        scenariosListDiv.appendChild(card);
      });
    }

    function selectScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      const scenario = scenarios[index];

      // Restaurar objetivos
      objectives = JSON.parse(JSON.stringify(scenario.objectives || [])); // Deep copy
      displayObjectives();

      // Restaurar parâmetros financeiros
      document.getElementById("currentSavings").value = formatMoney(scenario.currentSavings);
      formatCurrency(document.getElementById("currentSavings"));
      document.getElementById("currentContribution").value = formatMoney(scenario.currentContribution);
      formatCurrency(document.getElementById("currentContribution"));
      document.getElementById("rate").value = (scenario.rate * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
      formatPercentage(document.getElementById("rate"));
      document.getElementById("rateType").value = scenario.rateType;
      document.getElementById("tax").value = (scenario.tax * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
      formatPercentage(document.getElementById("tax"));
      document.getElementById("inflation").value = (scenario.inflation * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " %";
      formatPercentage(document.getElementById("inflation"));

      // Habilitar/desabilitar campos de taxa/inflação baseado no 'knows'
      document.getElementById("knowsTax").value = scenario.tax > 0 ? "yes" : "no"; // Simplificação: assume 'yes' se taxa > 0
      toggleTaxInput("tax", "15,00 %");
      document.getElementById("knowsInflation").value = scenario.inflation > 0 ? "yes" : "no"; // Simplificação
      toggleTaxInput("inflation", "5,00 %");

      // Limpar resultados anteriores e recalcular
      clearResults();
      calculateSavings(); // Recalcula com os dados carregados

      // Rolar para o topo do formulário
      document.getElementById("savingsForm").scrollIntoView({ behavior: 'smooth' });
      alert(`Cenário "${scenario.name}" carregado. Os resultados foram recalculados.`);
    }

    function deleteScenario(index) {
      if (index < 0 || index >= scenarios.length) return;
      const scenarioName = scenarios[index].name;
      if (confirm(`Tem certeza que deseja excluir o "${scenarioName}"?`)) {
        scenarios.splice(index, 1);
        displayScenarios();
        // Esconder botão de análise se não houver mais cenários suficientes
        if (scenarios.length < 1) {
          document.getElementById("analyzeScenarioButton").style.display = "none";
          document.getElementById("comparisonContainer").style.display = "none";
          document.getElementById("generalAnalysis").style.display = "none";
        }
         // Se houver apenas 1 cenário, esconder análise mas manter botão visível
        if (scenarios.length === 1) {
             document.getElementById("comparisonContainer").style.display = "none";
             document.getElementById("generalAnalysis").style.display = "none";
        }
        alert(`"${scenarioName}" excluído.`);
      }
    }

    function prepareNewScenario() {
        // Limpar objetivos
        objectives = [];
        displayObjectives();

        // Limpar campos do formulário principal (opcional, pode manter para facilitar)
        // document.getElementById("savingsForm").reset(); // Cuidado: reseta selects também
        document.getElementById("currentSavings").value = "";
        document.getElementById("currentContribution").value = "";
        document.getElementById("rate").value = "";
        // Manter taxas padrão IR/Inflação
        document.getElementById("knowsTax").value = "no";
        toggleTaxInput('tax', '15,00 %');
        document.getElementById("knowsInflation").value = "no";
        toggleTaxInput('inflation', '5,00 %');

        // Limpar resultados
        clearResults();

        // Focar no primeiro campo de objetivo
        document.getElementById("newObjectiveDescription").focus();
        alert("Campos de objetivos e resultados limpos. Pronto para um novo cálculo.");
    }

    function clearResults() {
        document.getElementById("result").style.display = "none";
        document.getElementById("result").innerHTML = "";
        document.getElementById("recommendation").style.display = "none";
        document.getElementById("recommendationText").innerHTML = "";
        document.getElementById("projectionChartContainer").style.display = "none";
        document.getElementById("whatsappButton").style.display = "none";
        document.getElementById("saveScenarioButton").style.display = "none";
        document.getElementById("newScenarioButton").style.display = "none";
        // Não esconder o botão de análise aqui, pois depende dos cenários salvos
        currentCalculationData = null;
        if (projectionChart) {
            projectionChart.destroy();
            projectionChart = null;
        }
    }

    // --- Funções de Comparação de Cenários ---
    function analyzeScenarios() {
      if (scenarios.length < 2) {
        alert("É necessário ter pelo menos 2 cenários salvos para comparar.");
        return;
      }

      updateComparisonChart();
      updateComparisonTable();
      generateGeneralAnalysis();

      document.getElementById("comparisonContainer").style.display = "block";
      document.getElementById("generalAnalysis").style.display = "block";
      document.getElementById("comparisonContainer").scrollIntoView({ behavior: 'smooth' });
    }

    function updateComparisonChart() {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const maxPeriodOverall = Math.max(...scenarios.map(s => s.maxPeriod), 0);
        const labels = Array.from({ length: maxPeriodOverall + 1 }, (_, i) => i);
        const datasets = [];
        const colors = [
            'rgba(4, 108, 78, 0.8)',   // Verde Esmeralda
            'rgba(212, 175, 55, 0.8)', // Dourado
            'rgba(111, 66, 193, 0.8)', // Roxo
            'rgba(220, 53, 69, 0.8)',  // Vermelho
            'rgba(0, 123, 255, 0.8)', // Azul
            'rgba(255, 193, 7, 0.8)',  // Amarelo
            'rgba(108, 117, 125, 0.8)' // Cinza
        ];

        scenarios.forEach((scenario, index) => {
            const color = colors[index % colors.length];
            const data = new Array(maxPeriodOverall + 1).fill(null);
            if (scenario.calculationResult && scenario.calculationResult.valoresMensais) {
                scenario.calculationResult.valoresMensais.forEach((val, month) => {
                    if (month <= maxPeriodOverall) {
                        data[month] = val.valorLiquido;
                    }
                });
            }

            datasets.push({
                label: scenario.name,
                data: data,
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                tension: 0.1
            });
        });

        if (comparisonChart) {
            comparisonChart.destroy();
        }

        comparisonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return formatMoney(value); }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += formatMoney(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    function updateComparisonTable() {
        const table = document.getElementById('comparisonTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (scenarios.length === 0) return;

        // Cabeçalho
        let headerRow = '<tr><th>Métrica</th>';
        scenarios.forEach(s => headerRow += `<th>${s.name}</th>`);
        headerRow += '</tr>';
        thead.innerHTML = headerRow;

        // Linhas de Dados
        const metrics = [
            { key: 'currentSavings', label: 'Valor Guardado', format: formatMoney },
            { key: 'currentContribution', label: 'Aporte Mensal', format: formatMoney },
            { key: 'rate', label: 'Taxa Juros', format: (v, s) => `${(v * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}% ${s.rateType === 'annual' ? 'a.a.' : 'a.m.'}` },
            { key: 'inflation', label: 'Inflação Anual', format: v => `${(v * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%` },
            { key: 'tax', label: 'Imposto (IR)', format: v => `${(v * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%` },
            { key: 'finalNetValue', label: 'Valor Líquido Final', format: formatMoney, calc: s => s.calculationResult?.valoresMensais[s.maxPeriod]?.valorLiquido ?? 0 },
            { key: 'totalInvested', label: 'Total Investido Final', format: formatMoney, calc: s => s.calculationResult?.valoresMensais[s.maxPeriod]?.totalInvestido ?? 0 },
            { key: 'totalInterest', label: 'Juros Brutos Finais', format: formatMoney, calc: s => s.calculationResult?.valoresMensais[s.maxPeriod]?.totalJuros ?? 0 },
            { key: 'goalsMetStatus', label: 'Status Objetivos', format: (v, s) => {
                let allMet = true;
                if (!s.objectives || s.objectives.length === 0) return 'N/A';
                const annualInflation = s.inflation;
                const monthlyInflation = Math.pow(1 + annualInflation, 1/12) - 1;
                s.objectives.forEach(obj => {
                    const targetMonth = obj.period;
                    if (targetMonth >= s.calculationResult.valoresMensais.length || s.calculationResult.valoresMensais[targetMonth].valorLiquido < (obj.value * Math.pow(1 + monthlyInflation, targetMonth))) {
                        allMet = false;
                    }
                });
                return allMet ? '<span style="color: var(--verde-esmeralda);">Todos Atingidos</span>' : '<span style="color: #dc3545;">Pendentes</span>';
            } }
        ];

        metrics.forEach(metric => {
            let row = `<tr><td>${metric.label}</td>`;
            const values = scenarios.map(s => metric.calc ? metric.calc(s) : s[metric.key]);

            // Para métricas numéricas, encontrar melhor/pior
            let bestValue = -Infinity, worstValue = Infinity;
            let isNumeric = values.every(v => typeof v === 'number');
            if (isNumeric && metric.key !== 'tax' && metric.key !== 'inflation') { // Maximizar (exceto imposto/inflação)
                bestValue = Math.max(...values);
                worstValue = Math.min(...values);
            } else if (isNumeric && (metric.key === 'tax' || metric.key === 'inflation')) { // Minimizar
                bestValue = Math.min(...values);
                worstValue = Math.max(...values);
            }

            scenarios.forEach((s, index) => {
                const value = values[index];
                let formattedValue = metric.format(value, s);
                let className = '';
                if (isNumeric && values.length > 1) {
                    if (value === bestValue) className = 'best-value';
                    else if (value === worstValue) className = 'worst-value';
                }
                row += `<td class="${className}">${formattedValue}</td>`;
            });
            row += '</tr>';
            tbody.innerHTML += row;
        });
    }

    function generateGeneralAnalysis() {
        const analysisDiv = document.getElementById('generalAnalysisText');
        let text = "<p>Comparando os cenários:</p><ul>";

        if (scenarios.length < 2) {
            analysisDiv.innerHTML = "<p>Adicione pelo menos dois cenários para gerar uma análise comparativa.</p>";
            return;
        }

        // Encontrar cenário com maior valor líquido final
        let bestFinalValue = -Infinity;
        let bestFinalValueScenario = null;
        scenarios.forEach(s => {
            const finalValue = s.calculationResult?.valoresMensais[s.maxPeriod]?.valorLiquido ?? 0;
            if (finalValue > bestFinalValue) {
                bestFinalValue = finalValue;
                bestFinalValueScenario = s;
            }
        });
        if (bestFinalValueScenario) {
            text += `<li>O <strong>${bestFinalValueScenario.name}</strong> apresenta o maior valor líquido final projetado (${formatMoney(bestFinalValue)}).</li>`;
        }

        // Encontrar cenário que atinge todos os objetivos (se houver)
        const allGoalsMetScenarios = scenarios.filter(s => {
            if (!s.objectives || s.objectives.length === 0) return false;
            let allMet = true;
            const annualInflation = s.inflation;
            const monthlyInflation = Math.pow(1 + annualInflation, 1/12) - 1;
            s.objectives.forEach(obj => {
                const targetMonth = obj.period;
                 if (targetMonth >= s.calculationResult.valoresMensais.length || s.calculationResult.valoresMensais[targetMonth].valorLiquido < (obj.value * Math.pow(1 + monthlyInflation, targetMonth))) {
                    allMet = false;
                }
            });
            return allMet;
        });

        if (allGoalsMetScenarios.length > 0) {
            text += `<li>Os cenários: <strong>${allGoalsMetScenarios.map(s => s.name).join(', ')}</strong> atingem todos os objetivos definidos.</li>`;
        } else {
            text += `<li>Nenhum dos cenários atuais atinge todos os objetivos definidos nos prazos estipulados.</li>`;
        }

        // Comparar Aportes
        let highestContribution = -Infinity, lowestContribution = Infinity;
        let highestContributionScenario = null, lowestContributionScenario = null;
        scenarios.forEach(s => {
            if (s.currentContribution > highestContribution) { highestContribution = s.currentContribution; highestContributionScenario = s; }
            if (s.currentContribution < lowestContribution) { lowestContribution = s.currentContribution; lowestContributionScenario = s; }
        });
        if (highestContributionScenario && lowestContributionScenario && highestContribution !== lowestContribution) {
             text += `<li>O aporte mensal varia de ${formatMoney(lowestContribution)} (${lowestContributionScenario.name}) a ${formatMoney(highestContribution)} (${highestContributionScenario.name}).</li>`;
        }

        text += "</ul><p>Analise a tabela e o gráfico acima para mais detalhes sobre as diferenças entre os parâmetros e resultados de cada cenário.</p>";
        analysisDiv.innerHTML = text;
    }


    // --- Função de Integração WhatsApp ---
    async function openWhatsAppChat() {
      let objectivesText = "Objetivos:\n";
      if (objectives.length > 0) {
        objectives.forEach(obj => {
          objectivesText += `- ${obj.description}: ${formatMoney(obj.value)} em ${obj.period} meses\n`;
        });
      } else {
        objectivesText = "Nenhum objetivo definido.\n";
      }

      let parametersText = "Parâmetros Financeiros:\n";
      if (currentCalculationData) {
         parametersText += `  - Valor Guardado: ${formatMoney(currentCalculationData.currentSavings)}\n`;
         parametersText += `  - Aporte Mensal: ${formatMoney(currentCalculationData.currentContribution)}\n`;
         parametersText += `  - Taxa Juros: ${(currentCalculationData.rate * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}% ${currentCalculationData.rateType === "annual" ? "a.a." : "a.m."}\n`;
         parametersText += `  - Inflação: ${(currentCalculationData.inflation * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%\n`;
         parametersText += `  - Imposto: ${(currentCalculationData.tax * 100).toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2})}%\n`;
      } else {
          parametersText = "Parâmetros financeiros não calculados.\n";
      }

      // Tenta pegar a descrição geral do primeiro objetivo como contexto, se existir
      const goalContext = objectives.length > 0 ? objectives[0].description : "(Objetivo não descrito)";

      const message = `Oi Hugo, queria tua ajuda com meus objetivos:\n${goalContext}\n\n${objectivesText}\n${parametersText}\nEstou usando a calculadora que você criou.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://api.whatsapp.com/send?phone=5581994297920&text=${encodedMessage}`;
      window.open(whatsappUrl, "_blank");
    }

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', (event) => {
        // Inicializar exibição de objetivos (vazia no início)
        displayObjectives();
        // Configurar valores padrão para IR e Inflação
        toggleTaxInput('tax', '15,00 %');
        toggleTaxInput('inflation', '5,00 %');
    });

  </script>
</body>
</html>
